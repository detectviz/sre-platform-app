openapi: 3.1.0
info:
  title: SRE 平台 API 契約
  version: 2.28.0
  description: |
    # 版本 2.28.0
    - **UI/UX 重大優化**: 在告警規則建立精靈中，將「選擇監控目標類型」與「選擇範本」兩個動作，整合成一個單一、直觀的整合式範本市集介面，大幅簡化了規則建立的初始流程。

    # 版本 2.27.0
    - **UI/UX 優化**: 在告警規則建立精靈中，將範本選擇從卡片網格改為可搜尋的下拉式選單，以提升在大量範本中的選擇效率。

    # 版本 2.25.0
    - **新增**: 在 `POST /incidents/{incident_id}/actions` 端點中增加了 `add_note` 和 `delete_note` 操作，以支援在事件時間軸上新增和刪除備註的功能。

    # 版本 2.17.0
    - **重大重構**: 為平台所有主要模組新增了 `/.../options` API 端點，將所有 UI 相關的硬編碼資料 (如篩選條件、狀態顏色、標籤等) 全部遷移至由 API 動態提供。此舉實現了前端 UI 與業務邏輯的完全解耦，大幅提升了系統的可維護性與擴展性。

    # 版本 2.7.0
    - **新增**: 建立了 GitHub Actions 工作流程，用於在每次推送到 `main` 分支時自動將專案部署到 GitHub Pages，實現 CI/CD。

    # 版本 2.6.0
    - **新增**: 為主要列表頁面 (告警規則、靜音規則、通知策略等) 增加了後端篩選與搜尋功能。
    - **新增**: 完成了告警規則測試、規則範本、通知管道測試、自動化重試等核心功能的 API 端點。
    - **新增**: 為 CSV 匯入功能增加了對應的 API 端點。

    本文件定義 SRE 平台前後端之間的資料契約，作為後端開發的唯一真實來源 (SSOT)。
servers:
  - url: http://localhost:4000/api/v1
    description: 本地 Mock 伺服器
tags:
  - name: 認證與個人設定
    description: 登入、個人資訊與偏好設定。
  - name: AI Copilot
    description: 整合平台所有 AI 驅動的功能。
  - name: 儀表板
    description: 儀表板的 CRUD 與戰情室設定。
  - name: 事故管理 (Incidents)
    description: 事故列表、詳情、狀態變更。
  - name: 告警規則 (Grafana 代理)
    description: 告警偵測規則設定 (代理 Grafana API)。
  - name: 靜音規則
    description: 平台增值的週期性事件靜音規則。
  - name: 資源管理
    description: 資源、資源群組與拓撲視圖。
  - name: 自動化
    description: 自動化腳本、觸發器與執行歷史。
  - name: 分析中心
    description: 日誌、追蹤與容量規劃。
  - name: 身份與存取 (IAM)
    description: 人員、團隊、角色與審計日誌。
  - name: 通知
    description: 通知策略、管道與歷史。
  - name: 平台
    description: 標籤、版面與系統級配置。
  - name: 全局功能
    description: 全局搜尋與系統健康檢查。
paths:
  # ===========================================================================
  # AUTH & PROFILE
  # ===========================================================================
  /me:
    get:
      tags:
        - 認證與個人設定
      summary: 取得目前登入者的個人資訊
      operationId: getCurrentUser
      responses:
        "200":
          description: 回傳使用者基本資料與角色。
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserProfile"
        "401":
          $ref: "#/components/responses/Unauthorized"
  
  /me/login-history:
    get:
      tags:
        - 認證與個人設定
      summary: 取得登入歷史紀錄
      operationId: getLoginHistory
      parameters:
        - $ref: "#/components/parameters/PageParam"
        - $ref: "#/components/parameters/PageSizeParam"
      responses:
        "200":
          description: 回傳登入歷史分頁列表。
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/PaginatedResponse"
                  - type: object
                    properties:
                      items:
                        type: array
                        items:
                          $ref: "#/components/schemas/LoginHistoryRecord"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /me/preferences:
    get:
      tags:
        - 認證與個人設定
      summary: 取得使用者偏好設定
      operationId: getPreferences
      responses:
        "200":
          description: 回傳偏好設定資料。
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserPreferences"
        "401":
          $ref: "#/components/responses/Unauthorized"
    put:
      tags:
        - 認證與個人設定
      summary: 更新使用者偏好設定
      operationId: updatePreferences
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserPreferences"
      responses:
        "200":
          description: 偏好設定已更新。
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserPreferences"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /me/change-password:
    post:
      tags:
        - 認證與個人設定
      summary: 變更目前登入者的密碼
      operationId: changePassword
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [oldPassword, newPassword]
              properties:
                oldPassword:
                  type: string
                  format: password
                newPassword:
                  type: string
                  format: password
      responses:
        "204":
          description: 密碼已成功更新。
        "400":
          description: "請求無效（例如，舊密碼不正確）。"
        "401":
          $ref: "#/components/responses/Unauthorized"
  
  # ===========================================================================
  # AI COPILOT
  # ===========================================================================
  /ai/briefing:
    get:
      tags: [AI Copilot]
      summary: 取得 SRE 戰情室 AI 每日簡報
      operationId: getAIBriefing
      responses:
        "200":
          description: 回傳最新的 AI 簡報內容。
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BriefingData'
  
  /ai/briefing/generate:
    post:
      tags: [AI Copilot]
      summary: 觸發生成新的 SRE 戰情室 AI 每日簡報
      operationId: generateAIBriefing
      responses:
        "200":
          description: 回傳新生成的 AI 簡報內容。
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BriefingData'
  
  # ... (other endpoints)
  
  # ===========================================================================
  # ALERT RULES
  # ===========================================================================
  /alert-rules/metrics:
    get:
      tags:
        - 告警規則 (Grafana 代理)
      summary: 取得所有可用的指標元數據
      operationId: getAlertRuleMetrics
      responses:
        "200":
          description: 成功回傳指標元數據列表。
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/MetricMetadata'

# ... (other components)

components:
  schemas:
    # ... (other schemas)
    MetricMetadata:
      type: object
      properties:
        id:
          type: string
          description: 指標的唯一識別碼 (e.g., 'cpu_usage_percent')。
        name:
          type: string
          description: 指標的顯示名稱 (e.g., 'CPU Usage')。
        unit:
          type: string
          nullable: true
          description: 指標的單位 (e.g., '%', 'ms', null)。
    # ... (rest of the file)
---
## ... (Rest of the file) ...
      responses:
        "200":
          description: 回傳最新的 AI 簡報內容。
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BriefingData'
  
  /ai/briefing/generate:
    post:
      tags: [AI Copilot]
      summary: 觸發生成新的 SRE 戰情室 AI 每日簡報
      operationId: generateAIBriefing
      responses:
        "200":
          description: 回傳新生成的 AI 簡報內容。
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BriefingData'
  
  # ... (rest of the yaml) ...
  /alert-rules/resource-types:
    get:
      tags:
        - 告警規則 (Grafana 代理)
      summary: 取得所有可用於告警的資源類型
      operationId: getAlertRuleResourceTypes
      responses:
        "200":
          description: 成功回傳資源類型列表。
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ResourceType'
  /alert-rules/metrics:
    get:
      tags:
        - 告警規則 (Grafana 代理)
      summary: 取得所有可用的指標元數據
      operationId: getAlertRuleMetrics
      responses:
        "200":
          description: 成功回傳指標元數據列表。
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/MetricMetadata'
  /alert-rules/{rule_id}/test:
    post:
      tags: [告警規則 (Grafana 代理)]
      summary: 測試一條告警規則
      operationId: testAlertRule
  # ... (rest of the yaml) ...
  /automation/triggers:
    get:
      tags: [自動化]
      summary: 取得觸發器分頁列表
      operationId: getTriggers
      parameters:
        - $ref: "#/components/parameters/PageParam"
        - $ref: "#/components/parameters/PageSizeParam"
        - $ref: "#/components/parameters/KeywordParam"
      responses:
        "200":
          description: 成功回傳觸發器分頁列表。
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/PaginatedResponse"
                  - type: object
                    properties:
                      items:
                        type: array
                        items:
                          $ref: "#/components/schemas/AutomationTrigger"
    post:
      tags: [自動化]
      summary: 建立新的觸發器
      operationId: createTrigger
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AutomationTrigger'
      responses:
        "201":
          description: 成功建立觸發器。
  /automation/triggers/{trigger_id}:
    patch:
      tags: [自動化]
      summary: 更新觸發器
      operationId: updateTrigger
      parameters:
        - name: trigger_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AutomationTrigger'
      responses:
        "200":
          description: 成功回傳更新後的觸發器。
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AutomationTrigger'
    delete:
      tags: [自動化]
      summary: 刪除觸發器
      operationId: deleteTrigger
      parameters:
        - name: trigger_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "204":
          description: 觸發器已成功刪除。
  /automation/triggers/batch-actions:
    post:
      tags: [自動化]
      summary: 批次操作觸發器
      operationId: batchUpdateTriggers
      requestBody:
        $ref: "#/components/requestBodies/BatchAction"
      responses:
        "200":
          $ref: "#/components/responses/Success"
components:
  schemas:
    # ... (other schemas) ...
    AlertRule:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        # ... (other properties) ...
    MetricMetadata:
      type: object
      properties:
        id:
          type: string
          description: 指標的唯一識別碼 (e.g., 'cpu_usage_percent')。
        name:
          type: string
          description: 指標的顯示名稱 (e.g., 'CPU Usage')。
        unit:
          type: string
          nullable: true
          description: 指標的單位 (e.g., '%', 'ms', null)。
    ResourceType:
      type: object
      properties:
        id:
          type: string
          description: The unique identifier for the resource type (e.g., 'host').
        name:
          type: string
          description: The display name for the resource type (e.g., '主機 (Host/VM)').
        icon:
          type: string
          description: The Lucide icon name for the resource type (e.g., 'server').

    # ... (rest of the file) ...
  
  # ... (rest of the file) ...
  /ai/briefing/generate:
    post:
      tags: [AI Copilot]
      summary: 觸發生成新的 SRE 戰情室 AI 每日簡報
      operationId: generateAIBriefing
      responses:
        "200":
          description: 回傳新生成的 AI 簡報內容。
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BriefingData'
  
  # ... (rest of the yaml) ...
  /alert-rules/resource-types:
    get:
      tags:
        - 告警規則 (Grafana 代理)
      summary: 取得所有可用於告警的資源類型
      operationId: getAlertRuleResourceTypes
      responses:
        "200":
          description: 成功回傳資源類型列表。
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ResourceType'
  /alert-rules/metrics:
    get:
      tags:
        - 告警規則 (Grafana 代理)
      summary: 取得所有可用的指標元數據
      operationId: getAlertRuleMetrics
      responses:
        "200":
          description: 成功回傳指標元數據列表。
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/MetricMetadata'
  /alert-rules/{rule_id}/test:
    post:
      tags: [告警規則 (Grafana 代理)]
      summary: 測試一條告警規則
      operationId: testAlertRule
  # ... (rest of the yaml) ...
components:
  schemas:
    # ... (other schemas) ...
    AlertRule:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        # ... (other properties) ...
    MetricMetadata:
      type: object
      properties:
        id:
          type: string
          description: 指標的唯一識別碼 (e.g., 'cpu_usage_percent')。
        name:
          type: string
          description: 指標的顯示名稱 (e.g., 'CPU Usage')。
        unit:
          type: string
          nullable: true
          description: 指標的單位 (e.g., '%', 'ms', null)。
    ResourceType:
      type: object
      properties:
        id:
          type: string
          description: The unique identifier for the resource type (e.g., 'host').
        name:
          type: string
          description: The display name for the resource type (e.g., '主機 (Host/VM)').
        icon:
          type: string
          description: The Lucide icon name for the resource type (e.g., 'server').

    # ... (rest of the file) ...
  
  # ... (rest of the file) ...
  /ai/briefing/generate:
    post:
      tags: [AI Copilot]
      summary: 觸發生成新的 SRE 戰情室 AI 每日簡報
      operationId: generateAIBriefing
      responses:
        "200":
          description: 回傳新生成的 AI 簡報內容。
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BriefingData'
  
  # ... (rest of the yaml) ...
  /alert-rules/resource-types:
    get:
      tags:
        - 告警規則 (Grafana 代理)
      summary: 取得所有可用於告警的資源類型
      operationId: getAlertRuleResourceTypes
      responses:
        "200":
          description: 成功回傳資源類型列表。
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ResourceType'
  /alert-rules/metrics:
    get:
      tags:
        - 告警規則 (Grafana 代理)
      summary: 取得所有可用的指標元數據
      operationId: getAlertRuleMetrics
      responses:
        "200":
          description: 成功回傳指標元數據列表。
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/MetricMetadata'
  /alert-rules/{rule_id}/test:
    post:
      tags: [告警規則 (Grafana 代理)]
      summary: 測試一條告警規則
      operationId: testAlertRule
  # ... (rest of the yaml) ...
components:
  schemas:
    # ... (other schemas) ...
    AlertRule:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        # ... (other properties) ...
    MetricMetadata:
      type: object
      properties:
        id:
          type: string
          description: 指標的唯一識別碼 (e.g., 'cpu_usage_percent')。
        name:
          type: string
          description: 指標的顯示名稱 (e.g., 'CPU Usage')。
        unit:
          type: string
          nullable: true
          description: 指標的單位 (e.g., '%', 'ms', null)。
    ResourceType:
      type: object
      properties:
        id:
          type: string
          description: The unique identifier for the resource type (e.g., 'host').
        name:
          type: string
          description: The display name for the resource type (e.g., '主機 (Host/VM)').
        icon:
          type: string
          description: The Lucide icon name for the resource type (e.g., 'server').

    # ... (rest of the file) ...
  
  # ... (rest of the file) ...
  /ai/briefing/generate:
    post:
      tags: [AI Copilot]
      summary: 觸發生成新的 SRE 戰情室 AI 每日簡報
      operationId: generateAIBriefing
      responses:
        "200":
          description: 回傳新生成的 AI 簡報內容。
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BriefingData'
  
  # ... (rest of the yaml) ...
  /alert-rules/resource-types:
    get:
      tags:
        - 告警規則 (Grafana 代理)
      summary: 取得所有可用於告警的資源類型
      operationId: getAlertRuleResourceTypes
      responses:
        "200":
          description: 成功回傳資源類型列表。
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ResourceType'
  /alert-rules/metrics:
    get:
      tags:
        - 告警規則 (Grafana 代理)
      summary: 取得所有可用的指標元數據
      operationId: getAlertRuleMetrics
      responses:
        "200":
          description: 成功回傳指標元數據列表。
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/MetricMetadata'
  /alert-rules/{rule_id}/test:
    post:
      tags: [告警規則 (Grafana 代理)]
      summary: 測試一條告警規則
      operationId: testAlertRule
  # ... (rest of the yaml) ...
components:
  schemas:
    # ... (other schemas) ...
    AlertRule:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        # ... (other properties) ...
    MetricMetadata:
      type: object
      properties:
        id:
          type: string
          description: 指標的唯一識別碼 (e.g., 'cpu_usage_percent')。
        name:
          type: string
          description: 指標的顯示名稱 (e.g., 'CPU Usage')。
        unit:
          type: string
          nullable: true
          description: 指標的單位 (e.g., '%', 'ms', null)。
    ResourceType:
      type: object
      properties:
        id:
          type: string
          description: The unique identifier for the resource type (e.g., 'host').
        name:
          type: string
          description: The display name for the resource type (e.g., '主機 (Host/VM)').
        icon:
          type: string
          description: The Lucide icon name for the resource type (e.g., 'server').

    # ... (rest of the file) ...
  
  # ... (rest of the file) ...
  /iam/teams:
    get:
      tags: [身份與存取 (IAM)]
      summary: 取得團隊的分頁列表
      operationId: getTeams
      parameters:
        - $ref: "#/components/parameters/PageParam"
        - $ref: "#/components/parameters/PageSizeParam"
        - $ref: "#/components/parameters/KeywordParam"
      responses:
        "200":
          description: 成功回傳團隊分頁列表。
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/PaginatedResponse"
                  - type: object
                    properties:
                      items:
                        type: array
                        items:
                          $ref: "#/components/schemas/Team"
  /iam/teams/batch-actions:
    post:
      tags: [身份與存取 (IAM)]
      summary: 批次操作團隊
      operationId: batchUpdateTeams
      requestBody:
        $ref: "#/components/requestBodies/BatchAction"
      responses:
        "200":
          $ref: "#/components/responses/Success"
  /iam/roles:
    get:
      tags: [身份與存取 (IAM)]
      summary: 取得角色的分頁列表
      operationId: getRoles
      parameters:
        - $ref: "#/components/parameters/PageParam"
        - $ref: "#/components/parameters/PageSizeParam"
        - $ref: "#/components/parameters/KeywordParam"
      responses:
        "200":
          description: 成功回傳角色分頁列表。
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/PaginatedResponse"
                  - type: object
                    properties:
                      items:
                        type: array
                        items:
                          $ref: "#/components/schemas/Role"
  /iam/roles/batch-actions:
    post:
      tags: [身份與存取 (IAM)]
      summary: 批次操作角色
      operationId: batchUpdateRoles
      requestBody:
        $ref: "#/components/requestBodies/BatchAction"
      responses:
        "200":
          $ref: "#/components/responses/Success"
  # ... (rest of file)
components:
  # ... (rest of file)
  parameters:
    KeywordParam:
      name: keyword
      in: query
      description: 用於模糊搜尋的關鍵字。
      schema:
        type: string
  requestBodies:
    BatchAction:
      content:
        application/json:
          schema:
            type: object
            properties:
              action:
                type: string
                enum: [delete, enable, disable]
              ids:
                type: array
                items:
                  type: string
  responses:
    Success:
      description: 操作成功。
      content:
        application/json:
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: true
  # ... (rest of file)
