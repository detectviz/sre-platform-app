# 功能規格書（Feature Specification）: Identity Access Management

**建立日期**: 2025-10-10
**狀態**: Draft
**輸入**: 使用者描述: "提供一個集中化的身分與存取管理 (IAM) 介面，用於管理使用者生命週期、團隊組織、角色定義與權限分配"

## 使用者情境與測試 *(mandatory)*

### 使用者故事 1 - 作為系統管理員，集中管理使用者、團隊與角色 (優先級: P1)

作為系統管理員，我需要一個統一的介面來管理使用者生命週期、建立階層化的團隊組織，以及定義和分配角色。目前，使用者、團隊、角色分散管理，導致操作效率低下，且容易因遺漏步驟而產生權限配置錯誤。

**為什麼此優先級**: 這是 IAM 模組的核心功能，解決了管理分散、效率低下的核心痛點，是實現清晰、安全權限治理的基礎。

**獨立測試**: 可以通過成功建立一個新使用者，將其指派給一個新建立的團隊，並授予一個新建立的角色來獨立測試。

**驗收情境**:

1. **Given** 我在「使用者管理」頁面, **When** 我點擊「新增使用者」，輸入必填資料並指派團隊與角色, **Then** 系統必須建立使用者帳號，狀態為「Pending」，並發送邀請郵件。
2. **Given** 我在「團隊管理」頁面, **When** 我在某個部門下點擊「新增子團隊」並輸入名稱, **Then** 系統必須在組織樹狀圖中建立該團隊節點。
3. **Given** 我在「角色管理」頁面, **When** 我點擊「新增角色」，輸入名稱並選擇權限, **Then** 系統必須建立該角色並顯示於角色列表中。
4. **Given** 我需要調整組織結構, **When** 我在樹狀圖中拖曳「前端團隊」至「工程團隊」下方, **Then** 系統必須更新團隊階層關係，並重新計算成員的權限繼承鏈。

---

### 使用者故事 2 - 作為系統管理員，檢視有效權限並確保治理合規 (優先級: P2)

為了進行權限診斷與合規審查，我需要能夠清晰地檢視任何使用者的有效權限（包括所有繼承來源），並確保所有權限變更都被記錄。目前，權限繼承邏輯不透明，且缺乏稽核日誌，導致問題追蹤和合規審查極為困難。

**為什麼此優先級**: 提供權限透明度和稽核能力，是安全治理和問題診斷的關鍵，也是滿足合規性要求的必要條件。

**獨立測試**: 可以通過檢視某個使用者的權限，確認其包含了直接授予和團隊繼承的權限，並在稽核日誌中找到一筆對應的權限變更記錄來獨立測試。

**驗收情境**:

1. **Given** 我需要診斷某使用者的權限問題, **When** 我進入該使用者的詳情頁，點擊「有效權限」, **Then** 系統必須展開所有權限來源，包括直接授予、團隊繼承和角色繼承。
2. **Given** 我需要稽核權限變更, **When** 我進入「稽核日誌」，篩選類別「identity」, **Then** 系統必須顯示所有相關操作記錄，如建立使用者、指派角色等。
3. **Given** 我嘗試將一個已包含在使用者現有角色中的權限再次授予他, **When** 我確認操作, **Then** 系統應該彈出警告，提示權限重疊。

---

### 使用者故事 3 - 作為人事或管理員，高效處理員工入職、重組與離職 (優先級: P3)

為了應對大量人員變動，我需要能夠批次處理使用者帳號，例如批次匯入新員工、停用離職員工帳號。目前缺乏批次操作功能，處理大量人員變動時效率極低，且容易出錯。

**為什麼此優先級**: 提升大規模使用者管理的效率，降低手動操作的錯誤率，特別是在組織快速擴張或重組時。

**獨立測試**: 可以通過上傳一個包含新員工資料的 CSV 檔案，並驗證系統是否成功為他們建立帳號並發送邀請來獨立測試。

**驗收情境**:

1. **Given** 我有一個包含 50 位新員工資料的 CSV 檔案, **When** 我使用「批次匯入」功能上傳該檔案, **Then** 系統必須驗證檔案並批次建立 50 個使用者帳號，並發送邀請郵件。
2. **Given** 某員工已離職, **When** 我在其帳號上點擊「停用」，並輸入理由, **Then** 系統必須將其狀態變更為「Disabled」，立即撤銷其所有有效 Session，並記錄稽核日誌。
3. **Given** 我計劃進行團隊重組, **When** 我模擬拖曳團隊的操作, **Then** 系統應該顯示權限影響預覽，包括受影響的使用者數量和權限變更摘要。

---

### 邊界案例

- **團隊階層深度超過限制**: 當管理員嘗試建立超過 5 層的團隊時，系統應發出警告但允許操作。
- **使用者邀請連結過期**: 當使用者點擊過期的邀請連結時，系統必須提示錯誤並引導其聯繫管理員重新發送。
- **刪除仍有成員的團隊**: 當管理員嘗試刪除仍有成員或子團隊的團隊時，系統必須拒絕操作並給予明確提示。
- **權限繼承鏈循環**: 當管理員設定角色繼承時，系統必須檢測並阻止循環依賴（如 A→B→C→A）。
- **批次匯入資料錯誤**: 當上傳的 CSV 檔案包含格式錯誤或無效資料時，系統必須拒絕匯入並提供詳細的錯誤報告。
- **無效配置參數**: 當管理員嘗試設定超出合理範圍的配置值時，系統必須拒絕並顯示有效的參數範圍。
- **配置衝突**: 當新配置與現有設定衝突時，系統必須提示潛在影響並要求確認。
- **配置載入失敗**: 當配置服務不可用時，系統必須使用最後已知的有效配置繼續運作並記錄錯誤。

## 功能需求 *(mandatory)*

### 功能需求

- **FR-001**: 系統必須（MUST）支援使用者 CRUD、邀請註冊及狀態管理（Pending、Active、Disabled）。
- **FR-002**: 系統必須（MUST）支援批次匯入與匯出使用者（CSV/JSON 格式）。
- **FR-003**: 停用使用者時，系統必須（MUST）立即撤銷其所有有效 Session。
- **FR-004**: 系統必須（MUST）提供使用者有效權限檢視功能，清晰展示所有權限來源。
- **FR-005**: 系統必須（MUST）支援階層化的團隊結構，並支援透過拖曳進行重組。
- **FR-006**: 團隊調整時，系統應該（SHOULD）提供權限影響預覽。
- **FR-007**: 刪除團隊前，系統必須（MUST）檢查其是否為空（無成員、無子團隊）。
- **FR-008**: 系統必須（MUST）支援角色 CRUD、權限綁定及角色繼承。
- **FR-009**: 系統應該（SHOULD）在授予角色時檢測潛在的權限衝突。

### 外部整合需求

- **FR-INT-001**: 系統必須（MUST）支援 SMTP 郵件服務整合，用於使用者邀請和通知。
- **FR-INT-002**: 系統必須（MUST）支援 LDAP 和 SAML 外部身份提供商整合。
- **FR-INT-003**: 郵件服務失敗時，系統必須（MUST）將郵件排入重試佇列並記錄失敗原因。
- **FR-INT-004**: 外部身份服務不可用時，系統必須（MUST）降級到本地認證模式。
- **FR-INT-005**: 系統應該（SHOULD）提供外部服務健康檢查和狀態監控功能。

### 安全性與合規需求

- **FR-SEC-001**: 系統必須（MUST）使用 HTTPS 加密所有網路通訊。
- **FR-SEC-002**: 系統必須（MUST）實作密碼政策（最小長度、複雜度要求、定期更換）。
- **FR-SEC-003**: 系統必須（MUST）記錄所有身份和權限操作至基本稽核日誌。
- **FR-SEC-004**: 系統必須（MUST）支援多重要素認證（MFA）作為選項。
- **FR-010**: 所有身份與權限相關的變更必須（MUST）被記錄到稽核日誌中。

### 資料管理與保留需求

- **FR-DATA-001**: 使用者帳號資料必須（MUST）無限期保留，除非使用者主動要求刪除。
- **FR-DATA-002**: 稽核日誌必須（MUST）支援可配置的保留期限，預設至少 1 年。
- **FR-DATA-003**: 系統必須（MUST）支援資料匯出功能，允許使用者下載其個人資料。
- **FR-DATA-004**: 停用使用者時，系統必須（MUST）保留其歷史資料但標記為非活躍狀態。

### 參數化配置需求

- **FR-CONFIG-001**: 系統必須（MUST）提供管理介面讓管理員配置業務邏輯參數。
- **FR-CONFIG-002**: 系統必須（MUST）支援動態重新載入非敏感配置參數。
- **FR-CONFIG-003**: 系統必須（MUST）記錄所有配置變更至稽核日誌。
- **FR-CONFIG-004**: 系統必須（MUST）驗證配置參數的合理性範圍。
- **FR-CONFIG-005**: 關鍵安全參數必須（MUST）保持固定，不可通過管理介面修改。

#### 可參數化的業務設定

- **資料保留**: 稽核日誌保留期限、批次操作大小限制
- **效能限制**: API 速率限制、並發連線數、工作階段逾時
- **安全政策**: 密碼複雜度要求（長度、特殊字元）、登入失敗鎖定次數
- **外部整合**: SMTP 伺服器設定、LDAP/SAML 配置、重試策略
- **通知設定**: 郵件範本、通知頻率、提醒閾值

#### 固定不變的安全基準

- **HTTPS 強制**: 所有網路通訊必須使用加密
- **基本稽核**: 敏感操作必須記錄，不可停用
- **身份驗證**: MFA 支援必須啟用（可選用但不能停用功能）

### 關鍵資料實體 *(如果功能涉及資料則包含)*

- **User**: 代表使用者帳號。主要屬性: id, username, email, display_name, status, team_id, created_at, last_login。
- **Team**: 代表團隊或組織單位。主要屬性: id, name, description, parent_id, created_at。
- **Role**: 代表一組權限的集合。主要屬性: id, name, description。
- **Permission**: 代表一個具體的操作權限。主要屬性: id, action (e.g., `identity:user:read`)。
- **Configuration**: 代表系統參數化設定。主要屬性: id, category, key, value, data_type, is_sensitive, updated_by, updated_at。
- **AuditLog**: 代表一筆稽核日誌。主要屬性: id, action, user_id, target_type, target_id, timestamp, details。

## 權限控制 *(RBAC)*

### 權限模型設計

本模組遵循 Grafana 的 RBAC 模型，採用「角色 (Role) → 權限 (Permissions) → 操作 (Actions)」的層級設計。權限可被指派給角色，角色再被授予使用者或團隊。使用者的最終權限是其個人角色、團隊角色及所有繼承角色的權限聯集。

#### 所需權限定義

- **`identity:user:create`**: 允許建立使用者。
- **`identity:user:read`**: 允許讀取使用者資訊。
- **`identity:user:update`**: 允許更新使用者資訊。
- **`identity:user:delete`**: 允許停用/刪除使用者。
- **`identity:team:create`**: 允許建立團隊。
- **`identity:team:read`**: 允許讀取團隊結構與資訊。
- **`identity:team:update`**: 允許修改團隊結構。
- **`identity:team:delete`**: 允許刪除團隊。
- **`identity:role:create`**: 允許建立角色。
- **`identity:role:update`**: 允許修改角色及其權限。
- **`identity:role:delete`**: 允許刪除角色。
- **`identity:role:assign`**: 允許將角色指派給使用者或團隊。
- **`identity:audit:read`**: 允許檢視稽核日誌。
- **`identity:config:read`**: 允許檢視系統配置設定。
- **`identity:config:update`**: 允許修改業務邏輯配置參數（不含安全關鍵參數）。

#### 角色指派建議

- **Admin 角色**: 需要所有 `identity:*` 權限。
- **Editor 角色** (例如部門主管): 需要 `identity:user:*` (對其部門成員), `identity:team:*` (對其部門), `identity:role:assign` (指派部門內角色)。
- **Viewer 角色**: `identity:user:read`, `identity:team:read`。

#### 權限檢查點

- **存取各管理頁面**: 檢查對應資源的 `read` 權限。
- **執行建立/更新/刪除操作**: 檢查對應資源的 `create`/`update`/`delete` 權限。
- **指派角色給使用者/團隊**: 檢查 `identity:role:assign` 權限。

---

## 觀測性與治理檢查（Observability & Governance Checklist）

> 本模組遵循平台憲法中定義之全域治理與觀測性原則。  
> 詳細規範請參閱：
> - [.specify/memory/constitution.md](../../.specify/memory/constitution.md)
> - 章節：[觀測性與治理檢查](../../.specify/memory/constitution.md#ai-生成與規格合規)

> 本模組需確保：
> - 所有操作皆可追蹤並具備審計記錄。  
> - 關鍵事件具備可觀測性指標（logs、metrics、alerts）。  
> - 錯誤回報須符合統一錯誤模型並附 trace_id。  
> - Mock API 與實際行為需與 `/specs` 定義保持一致。

---

## 成功標準 *(mandatory)*

### 可衡量成果

- **SC-001**: 管理員可以在 2 分鐘內完成一個新員工的完整入職流程（建立帳號、指派團隊、授予角色）。
- **SC-002**: 批次匯入 100 位使用者的操作應在 1 分鐘內完成。
- **SC-003**: 權限變更（如調整團隊結構）後的生效時間應小於 3 秒。
- **SC-004**: 系統能支援至少 1000 個使用者和 10 個團隊結構而不影響效能。
- **SC-005**: 稽核日誌查詢應在 2 秒內返回結果。
- **SC-PERF-001**: 所有 IAM API 呼叫的平均回應時間應小於 2 秒（P95 < 5 秒）。
- **SC-SCALE-001**: 系統設計支援最大 **[參數化]** 活躍使用者上限（500個, 1000個, 2000個）活躍使用者並發操作。
- **SC-CONFIG-001**: 配置變更應在 10 秒內生效並應用到所有服務實例。
- **SC-CONFIG-002**: 無效的配置參數應在設定時立即被拒絕並顯示明確的錯誤訊息。

---

## 模糊與待確認事項（Clarifications）

### Session 2025-10-10

- **Q**: 系統需要支援的具體效能目標和規模限制是什麼？ → **A**: 小型部署：1,000 使用者，10 個團隊，API 回應 < 2秒
- **Q**: 系統需要符合哪些具體的安全標準和合規要求？ → **A**: 基本安全：HTTPS 加密、密碼政策、基本稽核日誌
- **Q**: 系統需要與哪些外部服務整合，以及如何處理它們的失敗情況？ → **A**: 郵件服務 + 外部身份：SMTP + LDAP/SAML，用於企業單一登入
- **Q**: 系統需要支援的資料規模和保留政策是什麼？ → **A**: 小型規模：使用者資料無限保留，稽核日誌保留 1 年（可參數化調整）