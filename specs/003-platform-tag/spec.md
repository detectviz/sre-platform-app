# 功能規格書（Feature Specification）: Platform Tag

**建立日期**: 2025-10-08
**狀態**: Draft
**輸入**: 使用者描述: "提供一個集中化的標籤治理介面，用於定義統一的標籤體系、管理標籤值並實施權限控制"

## 使用者情境與測試 *(mandatory)*

### 使用者故事 1 - 作為平台治理負責人，定義與管理全平台統一的標籤體系 (優先級: P1)

作為平台架構師，我需要一個集中化的介面來建立、修改和刪除全平台統一的標籤定義。目前，由於缺乏統一規範，各模組各自為政，導致標籤拼寫不一（如 `env` vs `environment`）、標籤值混亂（如 `prod` vs `production`），使得基於標籤的資源篩選、成本追蹤和自動化操作難以實現。

**為什麼此優先級**: 這是標籤治理的核心，解決了標籤不一致和管理效率低下的根本痛點，是實現數據驅動治理的基礎。

**獨立測試**: 可以通過成功建立一個新的 `enum` 型別標籤，為其新增允許值，並在資源管理頁面看到該標籤及其可選值來獨立測試。

**驗收情境**:

1.  **Given** 我在標籤管理頁面, **When** 我點擊「新增標籤」並輸入標籤鍵 `app`、類型 `text`, **Then** 新標籤應成功建立並出現在列表中。
2.  **Given** 一個現有的 `status` 標籤, **When** 我編輯它，將其從「選填」改為「必填」, **Then** 系統應提示影響範圍並在確認後更新。
3.  **Given** 一個類型為 `enum` 的 `region` 標籤, **When** 我進入其「管理標籤值」頁面並新增一個值 `us-west-2`, **Then** 該值應出現在允許值列表中。
4.  **Given** 我需要批次建立多個標籤值, **When** 我上傳 CSV 檔案, **Then** 系統應驗證並批次新增。
5.  **Given** 我嘗試刪除一個正在被資源使用的 `owner` 標籤, **When** 我點擊「刪除」, **Then** 系統應警告影響並要求二次確認。

---

### 使用者故事 2 - 作為財務或安全管理員，對關鍵標籤實施權限控制 (優先級: P2)

為了確保成本分攤的準確性和安全策略的嚴格執行，我需要能夠限制關鍵標籤（如 `cost_center` 或 `compliance`）的修改權限，僅允許特定角色（如 `Finance` 或 `Security`) 進行修改。目前，任何人都可以修改關鍵標籤，存在巨大的治理風險。

**為什麼此優先級**: 防止關鍵治理標籤被誤改或濫用，是確保成本準確性和安全合規性的必要措施。

**獨立測試**: 可以通過將一個標籤的寫入權限設定為僅限 `Finance` 角色，然後用一個非 `Finance` 角色的帳號嘗試修改該標籤，並驗證操作被拒絕來獨立測試。

**驗收情境**:

1.  **Given** 我編輯 `cost_center` 標籤, **When** 我將其「寫入權限」設定為僅限 `Finance` 角色, **Then** 其他角色將無法修改此標籤的值。
2.  **Given** 一個普通使用者嘗試修改受限的 `cost_center` 標籤, **When** 他點擊儲存, **Then** 系統應顯示權限不足的錯誤。
3.  **Given** 我查看一個系統內建的唯讀標籤（如 `creation_date`）, **When** 我嘗試編輯或刪除它, **Then** 對應的操作按鈕應被禁用或操作被拒絕。

---

### 使用者故事 3 - 作為開發者或SRE，在日常工作中使用標籤進行資源管理 (優先級: P3)

作為平台的使用者，我需要在各種操作中（如資源管理、儀表板過濾、自動化腳本）方便地使用已定義的標籤來篩選和識別資源，以提升工作效率。

**為什麼此優先級**: 體現標籤系統的最終價值，將治理成果應用於日常操作，提升整個平台的可用性和自動化水平。

**獨立測試**: 可以通過在資源管理頁面，使用標籤下拉選單成功地為一個資源附加一個 `enum` 標籤及其預設值來獨立測試。

**驗收情境**:

1.  **Given** 我在資源管理頁面為資源新增標籤, **When** 我點擊標籤鍵的下拉選單, **Then** 系統應顯示所有已定義的標籤鍵供我選擇。
2.  **Given** 我選擇了一個 `enum` 類型的 `environment` 標籤, **When** 我點擊標籤值的輸入框, **Then** 系統應顯示一個包含 `dev`, `staging`, `production` 的下拉選單。
3.  **Given** 我在儀表板中建立一個圖表, **When** 我選擇按 `business_unit` 標籤分組, **Then** 圖表應按業務單位顯示數據。

---

### 邊界案例

- **刪除正在使用的標籤定義**: 系統應警告並要求二次確認。
- **刪除正在使用的標籤值**: 系統應警告並建議將現有資源遷移到新值。
- **權限衝突**: 當使用者屬於多個角色，對同一標籤有不同權限時，應採用最寬鬆的權限。

## 功能需求 *(mandatory)*

### 功能需求

- **FR-001**: 系統必須（MUST）提供標籤定義的 CRUD 功能，包含標籤鍵、類型（enum/text）、是否必填、寫入權限等屬性。
- **FR-002**: 對於 `enum` 型別的標籤，系統必須（MUST）提供其允許值的 CRUD 功能。
- **FR-003**: 系統必須（MUST）支援為每個標籤定義設定「寫入權限」，並在使用者修改標籤時強制執行權限檢查。
- **FR-004**: 系統應該（SHOULD）支援批次匯入/匯出標籤定義和允許值。
- **FR-005**: 所有使用標籤的模組必須（MUST）通過統一的標籤 API 從本模組讀取標籤定義，並在 UI 上提供智能提示和輸入驗證。
- **FR-006**: 刪除正在被使用的標籤定義或允許值時，系統應該（SHOULD）提供警告和遷移選項。
- **FR-007**: 當標籤被設為「必填」時，系統必須（MUST）立即要求所有現有未標記資源補全該標籤。
- **FR-008**: 系統必須（MUST）確保標籤一致性，防止重複或衝突的標籤定義。
- **FR-009**: 系統必須（MUST）記錄所有標籤定義和權限變更至稽核日誌。

### 關鍵資料實體 *(如果功能涉及資料則包含)*

- **TagDefinition**: 代表一個標籤的定義。主要屬性: key, type (`enum`|`text`), required (`boolean`), permissions (`role_id[]`)
- **TagValue**: 代表 `enum` 型別標籤的一個允許值。主要屬性: definition_id, value

## 權限控制 *(RBAC)*

### 權限模型設計

標籤治理的權限控制分為兩個層級：對標籤定義本身的管理權限，以及對具體資源標籤值的寫入權限。後者由標籤定義中的「寫入權限」屬性決定。

#### 所需權限定義

- **`tag-governance:definition:create`**: 允許建立新的標籤定義。
- **`tag-governance:definition:read`**: 允許讀取所有標籤定義。
- **`tag-governance:definition:update`**: 允許修改標籤定義（不包括權限設定）。
- **`tag-governance:definition:delete`**: 允許刪除標籤定義。
- **`tag-governance:permission:update`**: 允許修改標籤定義的「寫入權限」屬性。
- **`tag-governance:value:manage`**: 允許管理 `enum` 型別標籤的允許值。

#### 角色指派建議

- **Admin 角色**: 需要所有 `tag-governance:*` 權限。
- **Editor 角色** (例如平台架構師): `tag-governance:definition:*` (除 `permission:update` 外), `tag-governance:value:manage`。
- **Viewer 角色**: `tag-governance:definition:read`。
- **特定業務角色 (如 Finance)**: 不直接授予 `tag-governance` 權限，而是在具體標籤（如 `cost_center`）的定義中被指定為可寫入者。

#### 權限檢查點

- **存取標籤管理頁面**: 檢查 `tag-governance:definition:read`。
- **執行標籤定義的 CRUD**: 檢查對應的 `create/update/delete` 權限。
- **修改標籤的寫入權限設定**: 檢查 `tag-governance:permission:update`。
- **在資源上附加/修改標籤**: 檢查使用者角色是否符合該標籤定義中指定的「寫入權限」，採用角色優先級策略（Admin > Editor > Viewer）。

---

## 觀測性與治理檢查（Observability & Governance Checklist）

{{specs/common.md}}

---

## 成功標準 *(mandatory)*

### 可衡量成果

- **SC-001**: 管理員可以在 1 分鐘內完成一個新標籤的定義及其允許值的設定。
- **SC-002**: 系統應支援至少 **[參數化]** 標籤定義上限（50個, 100個, 200個）標籤定義，每個最多 **[參數化]** 標籤值上限（25個, 50個, 100個）值，且在資源關聯頁面的查詢效能不應受影響（< 200ms）。
- **SC-003**: 透過實施標籤治理，平台範圍內不一致的標籤（如 `env` vs `environment`）數量減少 90%。
- **SC-004**: 關鍵標籤（如 `cost_center`）的非授權修改嘗試被 100% 阻止。

---

## 模糊與待確認事項（Clarifications）

### Session 2025-10-10

- **Q**: 當使用者屬於多個角色，對同一標籤有不同權限時，應採用何種解決策略？ → **A**: 角色優先級：依角色層級決定（Admin > Editor > Viewer）
- **Q**: 當一個標籤被設為「必填」後，對現有未標記的資源應如何處理？ → **A**: 強制補全：立即要求所有現有資源補全該標籤
- **Q**: 系統需要支援的標籤治理規模限制是什麼？ → **A**: 小型規模：100 個標籤定義，每個最多 50 個值
- **Q**: 標籤治理系統如何與其他模組整合？ → **A**: 集中式 API：所有模組通過統一的標籤 API 獲取定義
- **Q**: 標籤治理需要符合哪些具體的合規和治理標準？ → **A**: 基本治理：標籤一致性、權限控制、稽核記錄