# 功能規格書（Feature Specification）: Insight Log

**建立日期**: 2025-10-06
**狀態**: Draft
**輸入**: 使用者描述: "提供一個強大的日誌探索與分析工具，支援統一日誌搜尋、即時追蹤和 AI 輔助分析"

## 使用者情境與測試 *(mandatory)*

### 使用者故事 1 - 作為 SRE，快速搜尋與過濾海量日誌以定位問題 (優先級: P1)

作為一名 SRE，在排查生產問題時，我需要一個統一的搜尋介面，能根據關鍵字、時間範圍、服務名稱和日誌級別等多個維度，快速從海量日誌中篩選出相關資訊。目前的痛點是資訊過載且搜尋效率低下，難以快速定位關鍵日誌。

**為什麼此優先級**: 這是日誌分析工具最核心的功能，直接關係到故障排查的效率和平均解決時間（MTTR）。

**獨立測試**: 可以通過設定篩選條件「服務名稱=checkout」和「日誌級別=ERROR」，並選擇「過去15分鐘」的時間範圍，然後驗證返回的日誌列表是否同時滿足所有條件來獨立測試。

**驗收情境**:

1. **Given** 我正在排查訂單失敗問題, **When** 我在搜尋框中輸入訂單 ID 並選擇「過去 1 小時」, **Then** 頁面應僅顯示包含該訂單 ID 的日誌，且頂部的直方圖應同步更新。
2. **Given** 我需要根據多個條件篩選, **When** 我設定「服務名稱=checkout」且「日誌級別=ERROR」, **Then** 系統應回傳同時符合所有條件的日誌結果。
3. **Given** 我需要查看特定時間段的日誌, **When** 我在時間選擇器中自訂時間範圍, **Then** 系統應載入該時間範圍內的所有日誌，若數量過多應提示縮小範圍。
4. **Given** 我需要查看單筆日誌的完整內容, **When** 我點擊展開某條日誌, **Then** 系統應顯示該日誌的完整 JSON 內容，並支援折疊/展開。

---

### 使用者故事 2 - 作為開發人員，在發佈期間即時追蹤日誌輸出 (優先級: P2)

作為一名開發人員，在進行新版本發佈時，我需要能夠開啟「即時日誌」模式，持續觀察最新產生的日誌，以即時監控新版本的運行狀態和潛在問題。

**為什麼此優先級**: 提供即時的反饋迴路，讓開發和維運人員能夠在變更發生時立即觀察其影響，是現代 CI/CD 和 DevOps 實踐中的關鍵一環。

**獨立測試**: 可以通過開啟「即時日誌」開關，然後在被監控的服務中觸發一個操作，並在日誌頁面上看到對應的新日誌在 5 秒內自動顯示出來，來獨立測試。

**驗收情境**:

1. **Given** 我正在監控新功能上線, **When** 我開啟「即時日誌」開關, **Then** 頁面應每 5 秒自動載入新日誌，並顯示即時模式指示器。
2. **Given** 即時日誌模式已開啟, **When** 我變更篩選條件, **Then** 後續載入的新日誌應自動套用新條件。
3. **Given** 即時日誌模式已開啟但 API 請求失敗, **When** 系統嘗試載入新日誌時遇到網路錯誤, **Then** 系統應在背景靜默重試，若連續失敗 3 次則顯示錯誤並暫停。

---

### 使用者故事 3 - 作為 SRE，利用 AI 輔助分析與分散式追蹤加速問題定位 (優先級: P2)

面對成千上萬條相似的錯誤日誌，或是在微服務架構中追蹤一個跨越多個服務的請求時，人工分析變得極為困難。我需要 AI 功能來自動總結日誌模式，並能一鍵查詢與某個 `trace_id` 相關的所有日誌，以還原完整的請求鏈。

**為什麼此優先級**: 解決了在複雜和大規模系統中，人工難以識別根本原因和追蹤問題的痛點，能指數級提升疑難雜症的排查效率。

**獨立測試**: 可以通過篩選出一批錯誤日誌，點擊「AI 總結」並獲得一個包含錯誤模式分析的彈窗來獨立測試。或者，點擊某條日誌中的 `trace_id`，系統能跳轉並顯示所有相關日誌。

**驗收情境**:

1. **Given** 我面對大量錯誤日誌, **When** 我點擊「AI 總結」按鈕, **Then** 系統應在模態框中顯示分析結果，包含錯誤模式與建議排查方向。
2. **Given** 我在日誌詳情中看到 `trace_id` 欄位, **When** 我點擊追蹤鏈接, **Then** 系統應展示與該 `trace_id` 關聯的所有日誌，按時間順序排列。
3. **Given** 我需要匯出日誌以供離線分析, **When** 我點擊「匯出報表」按鈕, **Then** 系統應下載一個包含當前檢視日誌的 CSV 檔案。
4. **Given** 我想分享我的查詢結果, **When** 我複製當前的 URL 並發送給同事, **Then** 同事打開 URL 後應看到與我完全相同的查詢條件和結果。

---

### 邊界案例

- **查詢結果過多**: 當查詢時間範圍過大導致日誌數量超過單次查詢上限時，系統應自動分頁顯示前 1000 條結果，並在頁面底部顯示「載入更多結果」按鈕和總結果數量提示。
- **AI 分析服務忙碌**: 當 AI 總結功能因後端模型忙碌而回應緩慢時，系統應立即顯示基本統計資訊，並在背景處理 AI 分析，完成後通過系統通知推送結果。
- **即時日誌效能過載**: 當即時日誌的串流速度遠超前端渲染能力時，系統應將日誌暫存到前端緩衝區，每秒批量更新 UI，避免過度渲染並維持系統流暢性。
- **無效配置參數**: 當使用者輸入無效的配置參數（如負數保留時間）時，系統應拒絕儲存並顯示具體的驗證錯誤訊息。
- **配置同步延遲**: 當多個節點需要同步配置變更時，系統應確保所有節點在 60 秒內完成同步，以維持一致的日誌處理行為。
- **節流與快取**:
  - 當短時間內收到相同查詢請求，系統應優先返回快取結果，減少重複查詢。
  - 當查詢頻率超過角色限制，系統應暫停新請求並提示用戶稍後再試。
  - 當快取過期後重新查詢時，應記錄查詢耗時與結果命中狀態以供觀測。
- **查詢監控資料異常**: 若查詢監控資料寫入失敗，系統應重試一次，失敗後僅記錄警告日誌。
- **快取一致性**: 當查詢快取因節流同步導致快取異常時，應自動清除過期項並重新建立索引。

## 功能需求 *(mandatory)*

### 功能需求

- **FR-001**: 系統必須（MUST）提供一個包含自由文本搜尋框、結構化篩選器（如服務、級別）和時間範圍選擇器的搜尋介面。
- **FR-002**: 系統必須（MUST）提供一個時間序列直方圖，視覺化展示查詢結果在時間上的分佈。
- **FR-003**: 系統必須（MUST）提供「即時日誌」模式，能以不高於 5 秒的延遲持續載入最新日誌。
- **FR-004**: 系統必須（MUST）提供「AI 總結」功能，結合通用大語言模型和專用規則引擎對日誌進行模式分析和摘要。
- **FR-005**: 系統必須（MUST）支援基於 `trace_id` 的分散式追蹤鏈查詢。
- **FR-006**: 系統必須（MUST）支援將查詢結果匯出為 CSV 檔案。
- **FR-007**: 系統必須（MUST）將查詢條件編碼到 URL 中，以支援分享。
- **FR-008**: 使用者必須（MUST）能夠查看單條日誌的完整原始格式（如 JSON）。
- **FR-009**: 系統必須（MUST）實作分級日誌保留策略，ERROR/WARN 日誌保留 **[參數化]** 錯誤日誌保留天數（30天, 90天, 180天），INFO 日誌保留 **[參數化]** 資訊日誌保留天數（3天, 7天, 14天）。
- **FR-010**: 系統必須（MUST）支援參數化配置日誌分析行為，包括保留時間、查詢上限、AI 分析超時、即時更新頻率和效能參數。
- **FR-021**: 系統必須（MUST）實作智慧節流（Smart Throttling），以減少重複查詢造成的負載，並根據使用者角色動態調整查詢速率。
- **FR-022**: 系統必須（MUST）提供查詢快取機制，將重複查詢結果快取於記憶體（TTL 可配置，預設 30 秒）。
- **FR-023**: 系統應該（SHOULD）支援多層速率限制策略（全域層級、角色層級、使用者層級）。
- **FR-024**: 當使用者超出查詢速率限制時，系統應顯示提示「查詢頻率過高，請稍後重試」而非拒絕服務。
- **FR-025**：系統應支援查詢節流事件的觀測指標輸出，包括查詢速率、延遲分佈、拒絕率、快取命中率等，用於平台層監控與報表生成。

### 關鍵資料實體 *(如果功能涉及資料則包含)*

- **LogEntry**: 代表一條日誌記錄。主要屬性: timestamp, level, service_name, message, trace_id, span_id, and other structured fields.
- **LogConfiguration**: 代表日誌分析系統的參數化配置。主要屬性: retention_days_error, retention_days_warn, retention_days_info, query_limit, ai_timeout_seconds, realtime_frequency_seconds, buffer_size。
- **InsightQueryMetric**: 代表一次查詢的監控資料。主要屬性：query_id, user_id, role, start_time, duration_ms, cache_hit, throttle_triggered, status。

## 權限控制 *(RBAC)*

### 權限模型設計

日誌洞察的權限主要圍繞不同服務或環境的日誌讀取權限進行。

#### 所需權限定義

- **`insight:log:read`**: 允許讀取所有日誌的基本權限。
- **`insight:log:query`**: 允許執行日誌查詢操作。
- **`insight:log:export`**: 允許將日誌查詢結果匯出。
- **`insight:log:ai:analyze`**: 允許使用 AI 總結功能。
- **`insight:log:config:read`**: 允許檢視日誌分析系統的配置參數。
- **`insight:log:config:update`**: 允許修改日誌分析系統的配置參數。
- **`insight:log:read:<service_name>`**: [FUTURE] 細粒度權限，僅允許讀取特定服務的日誌。

#### 角色指派建議

- **Admin 角色**: 需要所有 `insight:log:*` 權限。
- **Editor 角色** (SRE/Developer): 需要 `insight:log:read`, `insight:log:query`, `insight:log:export`, `insight:log:ai:analyze`, `insight:log:config:read`。
- **Viewer 角色**: `insight:log:read`, `insight:log:query`。

#### 權限檢查點

- **進入日誌探索頁面**: 檢查 `insight:log:read` 權限。
- **執行搜尋**: 檢查 `insight:log:query` 權限。後端應根據使用者的細粒度權限（如果存在）過濾日誌來源。
- **點擊「匯出」按鈕**: 檢查 `insight:log:export` 權限。
- **點擊「AI 總結」按鈕**: 檢查 `insight:log:ai:analyze` 權限。
- **進入「設定」頁面**: 檢查 `insight:log:config:read` 權限。
- **修改配置參數**: 檢查 `insight:log:config:update` 權限。

---

## 觀測性與治理檢查（Observability & Governance Checklist）

> 本模組遵循平台憲法中定義之全域治理與觀測性原則。  
> 詳細規範請參閱：
> - [.specify/memory/constitution.md](../../.specify/memory/constitution.md)
> - 章節：[觀測性與治理檢查](../../.specify/memory/constitution.md#ai-生成與規格合規)

> 本模組需確保：
> - 所有操作皆可追蹤並具備審計記錄。  
> - 關鍵事件具備可觀測性指標（logs、metrics、alerts）。  
> - 錯誤回報須符合統一錯誤模型並附 trace_id。  
> - Mock API 與實際行為需與 `/specs` 定義保持一致。

---

## 成功標準 *(mandatory)*

### 可衡量成果

- **SC-001**: 對於過去一小時的日誌，95% 的查詢應在 2 秒內返回結果。
- **SC-002**: 即時日誌的端到端延遲（從日誌產生到在 UI 上顯示）應小於 5 秒。
- **SC-003**: 引入 AI 總結功能後，對於複雜問題的平均解決時間（MTTR）縮短 30%。
- **SC-004**: 系統能支援每秒 **[參數化]** 日誌寫入速率（5000條, 10000條, 20000條），而不影響查詢效能。
- **SC-005**: 配置參數修改後，系統應在 **[參數化]** 配置生效時間（10秒, 30秒, 60秒）內生效並應用到新的日誌處理流程。
- **SC-014**: 在高負載下（每秒 500 查詢）平均延遲維持小於 2 秒。
- **SC-015**: 查詢快取命中率應達 70% 以上。
- **SC-016**：節流與查詢觀測資料應完整寫入監控系統，遺失率 ≤ 0.1%。
- **SC-017**：觀測指標更新延遲 ≤ 10 秒。

---

## 模糊與待確認事項（Clarifications）

### Session 2025-10-10

- **Q**: AI 總結功能的底層模型是什麼？是通用大語言模型還是針對日誌場景微調過後的模型？ → **A**: 混合模式：結合通用 LLM 和專用規則引擎進行分析
- **Q**: 日誌的保留策略是什麼？不同級別（INFO, WARN, ERROR）的日誌保留時間是否不同？ → **A**: 分級保留：ERROR/ WARN 保留較長時間（90 天），INFO 保留較短時間（7 天）
- **Q**: 當查詢時間範圍過大，導致日誌數量超過系統單次查詢上限時，系統應如何提示？ → **A**: 自動分頁：將結果分頁顯示，提示用戶可載入更多結果
- **Q**: 當 AI 總結功能因後端模型忙碌而回應緩慢時，前端應如何處理？ → **A**: 非同步處理：立即返回基本統計，AI 分析結果後續推送通知
- **Q**: 當即時日誌的串流速度遠超前端渲染能力時，系統應採取何種策略（如抽樣、緩衝）？ → **A**: 緩衝佇列：將日誌暫存到前端緩衝區，每秒批量更新 UI，避免過度渲染
- **Q**: Insight Log 是否需要參數化設定？ → **A**: 是，全部參數化：保留時間、查詢上限、AI 分析超時、即時更新頻率和效能參數均支援配置