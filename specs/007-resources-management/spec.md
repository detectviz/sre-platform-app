# 功能規格書（Feature Specification）: Resources Management

**建立日期**: 2025-10-08
**狀態**: Draft
**輸入**: 使用者描述: "提供一個完整的資源管理平台，支援多雲環境下的資源自動探索、統一納管、拓撲可視化及健康狀態監控"

## 使用者情境與測試 *(mandatory)*

### 使用者故事 1 - 作為平台管理員，自動探索並納管多雲環境中的資源 (優先級: P1)

作為平台管理員，我需要能夠自動掃描我們的多雲環境（AWS、GCP 等），以發現新建立的資源。我希望能查看新發現資源的清單，並決定是將它們納管進平台，還是忽略它們。我也希望能設定排程任務，讓這個探索過程自動定期執行。

**為什麼此優先級**: 這是資源管理的入口點。自動化探索能力解決了手動追蹤和註冊新資源的延遲和遺漏問題，是實現全面、即時資產可視性的基礎。

**獨立測試**: 可以通過手動觸發一次對指定雲端帳號的探索任務，並在任務完成後，在「待審核」清單中看到新發現的虛擬機資源來獨立測試。

**驗收情境**:

1. **Given** 我在「資源探索」頁面, **When** 我手動觸發一次探索任務, **Then** 系統應執行掃描，並在完成後更新「新發現資源」清單。
2. **Given** 探索任務完成後, **When** 我查看「待審核」清單中的一個新資源, **Then** 我可以點擊「納管」將其加入到統一管理的資源清單中，或點擊「忽略」。
3. **Given** 我需要定期同步資源, **When** 我在設定中啟用「自動排程探索」並設定為每日執行, **Then** 系統應按排程自動執行任務，並將新資源加入待審核清單。
4. **Given** 我需要追蹤探索歷史, **When** 我查看「發現任務」記錄, **Then** 系統應顯示每次任務的執行時間、發現數量和狀態。

---

### 使用者故事 2 - 作為 SRE，在統一的介面中檢視、分組和管理所有資源 (優先級: P2)

作為一名 SRE，我需要一個統一的資源清單來查看所有已納管的資源，無論它們來自哪個雲端。我希望能使用標籤和狀態來篩選資源，對資源進行分組（如按環境或業務線），並能快速查看任何資源的詳細監控指標和健康狀態。

**為什麼此優先級**: 提供一個單一的真實來源 (Single Source of Truth)，解決了在多個雲端控制台之間切換的低效率問題，極大地方便了日常監控、管理和故障排除。

**獨立測試**: 可以通過在資源清單中，使用標籤 `environment=production` 進行篩選，並成功找到所有生產環境的資源來獨立測試。

**驗收情境**:

1. **Given** 我在「資源清單」頁面, **When** 頁面載入, **Then** 系統應顯示所有已納管資源的清單，包含其健康狀態、標籤和所屬群組。
2. **Given** 我需要尋找特定的資源, **When** 我使用標籤 `app=nginx` 和狀態 `warning` 進行篩選, **Then** 清單應立即過濾出符合條件的資源。
3. **Given** 我需要整理資源, **When** 我建立一個名為「Production-DB」的新群組，並將幾個資料庫資源拖曳進去, **Then** 這些資源的所屬群組應被更新。
4. **Given** 我需要快速了解資源狀況, **When** 我點擊清單中的某個資源, **Then** 系統應在詳情面板中顯示其關鍵屬性、監控指標圖表和最近的告警。

---

### 使用者故事 3 - 作為架構師，透過總覽和拓撲圖掌握資源全域分佈與依賴關係 (優先級: P2)

作為一名平台架構師，我需要一個高維度的視圖來理解整個平台的資源狀況。我希望能透過總覽儀表板快速掌握資源的總體數量、健康比例和類型分佈，並透過拓撲圖來視覺化地分析資源之間的依賴關係。

**為什麼此優先級**: 提供宏觀視角，幫助架構師和管理者進行容量規劃、成本分析和架構優化，同時在出現問題時能快速定位影響範圍。

**獨立測試**: 可以通過切換到「拓撲」視圖，看到代表不同資源的節點，並且節點之間有表示依賴關係的連線來獨立測試。

**驗收情境**:

1. **Given** 我想快速了解資源概況, **When** 我切換到「總覽」頁籤, **Then** 系統應顯示 KPI 卡片（總資源數、健康率）、資源類型分佈餅圖等。
2. **Given** 我想分析資源依賴, **When** 我切換到「拓撲」視圖, **Then** 我應看到一個可互動的圖，節點顏色代表其健康狀態。
3. **Given** 我在拓撲圖中發現一個「警告」狀態的節點, **When** 我點擊該節點, **Then** 系統應高亮其關聯節點，並在側邊面板顯示其詳細資訊和告警。

---

### 使用者故事 4 - 作為平台管理員，設定與管理外部監控資料源 (優先級: P3)

為了獲取資源的健康狀態和監控指標，我需要能夠將平台與外部的監控資料源（如 Prometheus、VictoriaMetrics）進行連接。我希望能新增、編輯和測試這些資料源的連線。

**為什麼此優先級**: 這是讓資源管理平台能夠獲取監控數據、計算健康狀態的前提。沒有資料源，資源清單和拓撲圖將缺乏動態的狀態資訊。

**獨立測試**: 可以通過在「資料源設定」頁面新增一個 Prometheus 連線，點擊「測試連線」並看到「成功」的提示來獨立測試。

**驗收情境**:

1. **Given** 我需要連接一個新的監控系統, **When** 我在「資料源設定」頁面點擊「新增」，並填寫 Prometheus 的 URL, **Then** 我可以點擊「測試連線」來驗證設定。
2. **Given** 測試連線成功, **When** 我儲存該資料源, **Then** 它應出現在資料源清單中，狀態為「啟用中」。
3. **Given** 我需要將此資料源應用於特定資源, **When** 我編輯資源時，在資料源欄位選擇這個新的 Prometheus, **Then** 該資源的監控指標應開始從此資料源獲取。

---

### 邊界案例

- **探索任務失敗**: 當探索任務因 API 憑證過期而失敗時，系統應記錄錯誤、發送通知，並在 UI 上顯示明確的失敗原因。
- **刪除正在使用的資料源**: 當嘗試刪除一個仍被資源關聯的資料源時，系統應拒絕操作並提示使用者先解除關聯。
- **拓撲圖效能**: 當資源節點過多（>100）時，拓撲圖應預設聚合低重要性的節點，或提供篩選器來簡化視圖。
- **重複資源**: 當探索任務發現一個已存在的資源時，系統應提示使用者選擇「更新資訊」或「忽略」。

## 功能需求 *(mandatory)*

### 功能需求

- **FR-001**: 系統必須（MUST）提供自動資源探索功能，支援多雲環境，並允許手動或按排程觸發。
- **FR-002**: 探索到的新資源必須（MUST）進入「待審核」清單，供使用者執行「納管」或「忽略」操作。
- **FR-003**: 系統必須（MUST）提供統一的資源清單，支援基於標籤、狀態、群組的多維度篩選和搜尋。
- **FR-004**: 系統必須（MUST）允許使用者建立資源群組，並透過拖曳方式管理資源的歸屬。
- **FR-005**: 點擊任一資源必須（MUST）能查看其詳細屬性、即時監控指標和健康狀態。
- **FR-006**: 系統必須（MUST）提供一個高維度的「總覽」儀表板，展示資源的宏觀統計數據。
- **FR-007**: 系統必須（MUST）提供一個視覺化的「拓撲」視圖，展示資源及其依賴關係，節點顏色需反映健康狀態。
- **FR-008**: 系統必須（MUST）支援設定外部監控資料源（如 Prometheus），並提供連線測試功能。
- **FR-009**: 系統必須（MUST）建立統一的認證實體，支援多種雲供應商的認證類型（IAM Role, Service Account, API Key），並提供統一的驗證流程。
- **FR-010**: 系統必須（MUST）允許使用者定義拓撲關係來源規則，支援雲廠商 API 和監控指標等多種推斷方法。
- **FR-011**: 系統必須（MUST）允許使用者完全自定義健康狀態計算邏輯，包含任意監控指標、計算公式和權重。
- **FR-012**: 系統必須（MUST）使用企業級加密服務（如 HashiCorp Vault）來管理雲端認證金鑰等敏感資料，並實施細粒度存取控制。
- **FR-013**: 所有改變狀態的操作（納管、刪除、分組、設定變更）必須（MUST）寫入稽核日誌。
- **FR-014**: 系統必須（MUST）根據使用者權限過濾可見和可操作的資源。

### 關鍵資料實體 *(如果功能涉及資料則包含)*

- **Resource**: 代表一個被管理的實體（如伺服器、資料庫）。主要屬性: id, name, type, status, tags, group_id, datasource_ids。
- **ResourceGroup**: 代表一組資源的邏輯集合。主要屬性: id, name, description。
- **Datasource**: 代表一個外部監控資料源。主要屬性: id, name, type, url, credentials。
- **CloudCredential**: 代表統一的雲供應商認證實體。主要屬性: id, name, provider, credential_type, credential_data。
- **HealthRule**: 代表健康狀態計算規則。主要屬性: id, name, resource_type, metrics, formula, thresholds, weights。
- **DiscoveryTask**: 代表一次資源探索任務。主要屬性: id, status, start_time, end_time, discovered_count。

## 權限控制 *(RBAC)*

### 權限模型設計

資源管理的權限圍繞資源、群組、資料源和探索任務的讀取與操作進行設計。

#### 所需權限定義

- **`resources:read`**: 允許檢視資源清單、群組、總覽和拓撲。
- **`resources:update`**: 允許編輯資源資訊、標籤和分組。
- **`resources:delete`**: 允許刪除已納管的資源。
- **`resources:datasource:manage`**: 允許新增、編輯、刪除和測試資料源。
- **`resources:credentials:manage`**: 允許新增、編輯和刪除雲端認證，但無法查看敏感金鑰內容。
- **`resources:credentials:read`**: 允許檢視認證設定，但無法查看敏感金鑰內容。
- **`resources:discovery:read`**: 允許檢視資源探索的結果和歷史任務。
- **`resources:discovery:execute`**: 允許手動觸發新的探索任務和納管資源。

#### 角色指派建議

- **Admin 角色**: 需要所有 `resources:*` 權限。
- **Editor 角色** (SRE): `resources:read`, `resources:update`, `resources:delete`, `resources:credentials:read`, `resources:discovery:execute`。
- **Viewer 角色**: `resources:read`。
- **Credential Manager 角色**: `resources:credentials:manage`, `resources:credentials:read`。

#### 權限檢查點

- **頁面/頁籤存取**: 存取「資源管理」下的各個頁籤（清單、總覽、拓撲、探索、資料源、認證）需要對應的 `read` 權限。
- **操作按鈕**:
  - 「編輯/刪除資源」按鈕需要 `resources:update`/`delete` 權限。
  - 「新增/編輯群組」按鈕需要 `resources:update` 權限。
  - 「新增/編輯資料源」按鈕需要 `resources:datasource:manage` 權限。
  - 「新增/編輯認證」按鈕需要 `resources:credentials:manage` 權限。
  - 「觸發探索/納管資源」按鈕需要 `resources:discovery:execute` 權限。

---

## 觀測性與治理檢查（Observability & Governance Checklist）

> 本模組遵循平台憲法中定義之全域治理與觀測性原則。  
> 詳細規範請參閱：
> - [.specify/memory/constitution.md](../../.specify/memory/constitution.md)
> - 章節：[觀測性與治理檢查](../../.specify/memory/constitution.md#ai-生成與規格合規)

> 本模組需確保：
> - 所有操作皆可追蹤並具備審計記錄。  
> - 關鍵事件具備可觀測性指標（logs、metrics、alerts）。  
> - 錯誤回報須符合統一錯誤模型並附 trace_id。  
> - Mock API 與實際行為需與 `/specs` 定義保持一致。

---

## 成功標準 *(mandatory)*

### 可衡量成果

- **SC-001**: 一個新建立的雲端資源，從被自動探索發現到成功納管並出現在拓撲圖中，整個過程應在 **[參數化]** 納管超時（5分鐘, 10分鐘, 15分鐘）內完成。
- **SC-002**: 對於 **[參數化]** 資源規模上限（5000個, 10000個, 20000個）已納管資源，資源清單頁面的篩選和搜尋回應時間應小於 2 秒。
- **SC-003**: 拓撲圖在有 **[參數化]** 圖形節點上限（200個, 500個, 1000個）節點時，初始載入時間應小於 5 秒。
- **SC-004**: 資源健康狀態的更新頻率應為每 **[參數化]** 健康檢查間隔（1分鐘, 2分鐘, 5分鐘），支援 **[參數化]** 並發用戶上限（25個, 50個, 100個）同時操作。

---

## 模糊與待確認事項（Clarifications）

### Session 2025-10-10

- **Q**: 不同雲供應商的 API 認證機制（如 IAM Role, Service Account, API Key）應如何統一管理？ → **A**: 統一認證：建立抽象認證實體，支援多種認證類型，統一驗證流程
- **Q**: 資源間的依賴關係是來自雲廠商的 API，還是需要基於監控指標（如流量）進行推斷？ → **A**: 可配置策略：允許使用者定義關係來源規則，支援多種推斷方法
- **Q**: 「健康狀態」的計算邏輯是什麼？是基於一組預設的監控指標閾值，還是可由使用者自定義？ → **A**: 完全自定義：使用者可定義任意監控指標、計算公式和權重
- **Q**: 資源管理系統應支援的最大規模是什麼？包括資源數量、並發用戶、監控指標更新頻率等。 → **A**: 中規模：10000 個資源，50 個並發用戶，每 2 分鐘更新指標
- **Q**: 資源管理系統中如何處理雲端認證金鑰等敏感資料？是否需要特殊的加密和存取控制？ → **A**: 企業級加密：使用外部金鑰管理服務（如 HashiCorp Vault），細粒度存取控制