# 功能規格書（Feature Specification）: Automation Management

**建立日期**: 2025-10-08
**狀態**: Draft
**輸入**: 使用者描述: "提供一個統一的自動化管理平台，用於建立自動化腳本、設定觸發條件，並追蹤所有執行歷史"

## 使用者情境與測試 *(mandatory)*

### 使用者故事 1 - 作為 SRE，建立與維護可重複使用的自動化腳本 (Playbooks) (優先級: P1)

作為一名 SRE，我需要一個地方來集中建立和維護可重複使用的自動化腳本（Playbooks），例如「重啟服務」、「清理日誌檔案」等。我希望能定義腳本的參數，並能在需要時手動執行它們，以處理臨時的維運任務。

**為什麼此優先級**: Playbook 是自動化的核心原子能力。建立一個可複用的腳本庫是實現後續所有自動化觸發和執行的基礎。

**獨立測試**: 可以通過建立一個新的、帶有參數的 Shell 腳本，儲存後，在列表上手動執行它並傳入參數，最後在執行歷史中看到一筆成功的執行記錄來獨立測試。

**驗收情境**:

1. **Given** 我需要建立一個用於清理磁碟空間的新腳本, **When** 我在「腳本」頁籤點擊「新增腳本」，輸入名稱、描述和腳本內容, **Then** 新的腳本應被成功儲存。
2. **Given** 一台伺服器的磁碟空間告急, **When** 我在腳本列表上點擊「執行腳本」，並在彈窗中填寫必要的參數, **Then** 腳本應被執行，並在執行歷史中產生一筆新紀錄。
3. **Given** 我想一次刪除多個過時的腳本, **When** 我在表格中勾選多個腳本並點擊批次「刪除」按鈕, **Then** 所有被選中的腳本都應被刪除。

---

### 使用者故事 2 - 作為平台管理員，設定觸發器以自動執行腳本 (優先級: P1)

作為平台管理員，我需要能夠設定觸發器（Triggers），將事件（如告警）或排程（如每天凌晨）與我建立的自動化腳本連結起來，以實現真正的自動化，減少手動干預。

**為什麼此優先級**: 觸發器是連接「事件」和「動作」的橋樑，是從手動執行腳本邁向全自動化運維的關鍵一步。

**獨立測試**: 可以通過建立一個排程觸發器，設定為每分鐘執行一次，並綁定一個簡單的腳本。然後在幾分鐘後，去執行歷史頁面查看，應能看到多筆由該觸發器自動觸發的執行記錄。

**驗收情境**:

1. **Given** 我想設定一個每日報告的自動化任務, **When** 我在「觸發器」頁籤點擊「新增觸發器」，設定觸發類型為「排程」，輸入 CRON 表達式，並綁定報告腳本, **Then** 新的觸發器應被建立並啟用。
2. **Given** 我希望在某個告警觸發時自動重啟服務, **When** 我建立觸發器時選擇觸發類型為「事件」，設定告警條件，並綁定「重啟服務」腳本, **Then** 當該告警發生時，對應腳本應被自動執行。
3. **Given** 我需要進行系統維護, **When** 我在觸發器列表中批次停用多個觸發器, **Then** 所有選中的觸發器狀態應變為「停用」，且不再執行。

---

### 使用者故事 3 - 作為維運人員，追蹤與稽核所有自動化任務的執行歷史 (優先級: P2)

作為維運人員，我需要能夠追蹤和稽核所有自動化任務的執行歷史，無論是手動觸發還是自動觸發。我必須能看到每次執行的結果（成功/失敗）、詳細的日誌，並在失敗時能夠方便地重試。

**為什麼此優先級**: 提供了自動化系統的可追溯性和可審計性，這對於故障排查、效能分析和滿足合規性要求至關重要。

**獨立測試**: 可以通過手動執行一個會失敗的腳本，然後在「執行歷史」頁面找到這筆失敗的記錄，點擊查看其錯誤日誌，最後點擊「重試」並成功執行來獨立測試。

**驗收情境**:

1. **Given** 我想了解某次執行失敗的原因, **When** 我在「執行歷史」頁面點擊該筆失敗紀錄, **Then** 系統應在詳情面板中顯示結構化的錯誤日誌和執行步驟。
2. **Given** 一筆任務因暫時性錯誤而執行失敗, **When** 我在該紀錄旁點擊「重試」按鈕, **Then** 系統應重新執行該任務，並新增一筆狀態為「執行中」的紀錄。
3. **Given** 我需要分析最近的執行情況, **When** 我使用快速篩選器選擇「失敗」狀態和「過去24小時」, **Then** 列表應立即更新，只顯示符合條件的執行紀錄。
4. **Given** 我需要匯出執行紀錄, **When** 我點擊「匯出」按鈕, **Then** 系統應下載一份包含當前列表內容的 CSV 檔案。

---

### 邊界案例

- **參數未提供**: 當嘗試執行一個需要參數但未提供的腳本時，系統應阻止執行並給出明確提示。
- **觸發器綁定失效**: 當一個觸發器所綁定的腳本被刪除時，該觸發器應自動被禁用，並在 UI 上標示為無效。
- **執行中任務**: 正在執行中的任務不應允許「重試」操作。
- **資源配額超限**: 當腳本執行超出資源配額（如 CPU、記憶體）時，系統應強制終止執行並記錄資源違規。
- **容器啟動失敗**: 當容器無法正常啟動時（如映像損壞），系統應立即停止執行並記錄具體錯誤。
- **網路存取限制**: 腳本只能進行基本網路存取，當嘗試存取未授權網路資源時應被阻止並記錄安全事件。
- **腳本語言不支援**: 當上傳不支援的腳本語言時，系統應拒絕儲存並提示支援的語言類型。
- **事件條件無效**: 當事件觸發器的條件設定不完整或邏輯錯誤時，系統應阻止儲存並提示具體問題。
- **事件來源不可用**: 當觸發器依賴的事件來源暫時不可用時，系統應記錄警告但不影響其他觸發器的正常運作。
- **事件風暴防護**: 當短時間內收到大量相似事件時，系統應實施防護機制，防止觸發器過度執行。
- **參數 Schema 無效**: 當腳本的 JSON Schema 定義有語法錯誤或不支援的結構時，系統應阻止儲存並提示具體問題。
- **參數值驗證失敗**: 當使用者輸入的參數值不符合 Schema 定義的驗證規則時，系統應阻止執行並顯示具體的驗證錯誤訊息。
- **Schema 版本不相容**: 當腳本參數 Schema 更新導致現有儲存的參數值無效時，系統應提供遷移指引或阻止執行。
- **並發限制超限**: 當同時執行任務超過 50 個時，系統應將新任務加入佇列並在資源釋放後自動執行。
- **腳本庫容量超限**: 當腳本庫數量接近 500 個上限時，系統應發出容量警告並建議清理過時腳本。
- **每日執行配額超限**: 當單日執行次數接近 10000 次時，系統應實施速率限制並記錄效能指標。
- **狀態轉換異常**: 當任務狀態無法從當前狀態轉換到目標狀態時（如從成功轉為執行中），系統應阻止無效操作並記錄異常。
- **超時任務清理**: 當任務執行超時後，系統應自動終止容器、記錄超時狀態，並釋放相關資源。
- **歷史記錄清理失敗**: 當自動清理過期記錄失敗時，系統應發出告警並提供手動清理選項。
- **無效配置參數**: 當使用者輸入無效的配置參數（如負數超時時間）時，系統應拒絕儲存並顯示具體的驗證錯誤訊息。
- **配置同步延遲**: 當多個節點需要同步配置變更時，系統應確保所有節點在 60 秒內完成同步，以維持一致的自動化行為。
- **配置參數衝突**: 當新配置與現有腳本或觸發器發生衝突時，系統應提供遷移指引或阻止配置生效。

## 功能需求 *(mandatory)*

### 功能需求

- **FR-001**: 系統必須（MUST）提供對自動化腳本（Playbooks）的完整 CRUD 管理，並允許手動執行。
- **FR-002**: 系統必須（MUST）提供對觸發器（Triggers）的完整 CRUD 管理，並支援「排程」和「事件」兩種觸發類型。
- **FR-003**: 系統必須（MUST）允許使用者在建立觸發器時，從現有的腳本庫中選擇一個進行綁定。
- **FR-011**: 事件觸發器必須（MUST）支援平台內建事件來源，包括告警事件、服務狀態變更和資源使用率超標。
- **FR-012**: 系統必須（MUST）提供直觀的事件條件產生器，讓使用者輕鬆設定觸發規則。
- **FR-013**: 系統必須（MUST）支援基於 JSON Schema 的動態參數定義，允許自訂參數類型和驗證規則。
- **FR-014**: 參數輸入表單必須（MUST）根據 JSON Schema 動態產生對應的 UI 控制項和驗證邏輯。
- **FR-015**: 系統必須（MUST）支援中型部署規模：至少 500 個腳本庫、50 個並發執行和每日 10000 次任務處理。
- **FR-016**: 系統必須（MUST）支援完整的腳本執行生命週期管理，包含排程/執行中/成功/失敗/取消/超時六種狀態。
- **FR-017**: 系統必須（MUST）自動清理過期的執行歷史記錄，並提供可配置的保留期限設定。
  - **[參數化]** 歷史記錄保留期限（7天, 30天, 90天, 180天, 365天）
  - **[參數化]** 清理排程頻率（每日, 每週, 每月）
- **FR-018**: 系統必須（MUST）支援參數化配置規模限制和效能調優選項。
  - **[參數化]** 最大並發執行數量（10, 25, 50, 100）
  - **[參數化]** 腳本庫容量上限（100, 250, 500, 1000）
  - **[參數化]** 每日執行配額（1000, 5000, 10000, 20000）
- **FR-019**: 系統必須（MUST）支援參數化配置事件處理和觸發器行為。
  - **[參數化]** 事件排隊大小（100, 500, 1000, 2000）
  - **[參數化]** 事件風暴防護閾值（10/分鐘, 50/分鐘, 100/分鐘）
  - **[參數化]** 觸發器啟用延遲（0秒, 5秒, 15秒, 30秒）
- **FR-004**: 系統必須（MUST）在可分頁、可排序的表格中展示所有自動化任務的執行歷史。
- **FR-005**: 執行歷史必須（MUST）記錄觸發來源（手動/觸發器）、執行者、狀態、開始時間和執行時長。
- **FR-006**: 使用者必須（MUST）能夠查看任何一次執行的詳細日誌和輸出。
- **FR-007**: 系統必須（MUST）為執行失敗的任務提供「重試」功能。
- **FR-008**: 所有 CUD 和執行操作都必須（MUST）有權限控制和審計日誌。
- **FR-009**: 系統必須（MUST）支援 Shell、Python 和 Go 腳本的容器化安全執行，包含資源配額控制和基本網路存取。
  - **[參數化]** 腳本執行超時設定（30秒, 60秒, 120秒, 300秒）
  - **[參數化]** 資源配額限制（CPU: 0.5核, 1核, 2核；記憶體: 128MB, 256MB, 512MB, 1GB）
  - **[參數化]** 網路存取等級（無網路, 基本網路, 完整網路）
  - **[參數化]** 最大重試次數（0次, 1次, 3次, 5次）
- **FR-010**: 腳本執行必須（MUST）在隔離的容器環境中進行，防止系統級別的安全風險和資源濫用。

### 關鍵資料實體 *(如果功能涉及資料則包含)*

- **Playbook**: 代表一個自動化腳本。主要屬性: id, name, description, script_content, script_language (`SHELL`|`PYTHON`|`GO`), parameter_schema (JSON Schema 定義參數結構和驗證規則), resource_limits。
- **Trigger**: 代表一個觸發器。主要屬性: id, name, type (`SCHEDULE`|`EVENT`), trigger_config (對於 SCHEDULE: cron_expression；對於 EVENT: event_type (`ALERT`|`SERVICE_STATUS`|`RESOURCE_USAGE`), conditions), playbook_id, enabled。
- **ExecutionHistory**: 代表一次腳本執行記錄。主要屬性: id, playbook_id, trigger_id, status (`SCHEDULED`|`RUNNING`|`SUCCESS`|`FAILED`|`CANCELLED`|`TIMEOUT`), start_time, end_time, logs, triggered_by, container_id, resource_usage, cleanup_scheduled_at。
- **ExecutionEnvironment**: 代表腳本執行的容器化環境配置。主要屬性: id, language, base_image, resource_quotas, network_access, security_policies。
- **AutomationConfiguration**: 代表自動化系統的參數化配置。主要屬性: execution_timeout_seconds, resource_quotas_cpu, resource_quotas_memory, network_access_level, max_retry_attempts, history_retention_days, cleanup_frequency, max_concurrent_executions, playbook_capacity_limit, daily_execution_quota, event_queue_size, storm_protection_threshold, trigger_activation_delay。

## 權限控制 *(RBAC)*

### 權限模型設計

權限圍繞腳本、觸發器和執行歷史的讀取與修改進行設計。

#### 所需權限定義

- **`automation:playbooks:read`**: 允許查看腳本。
- **`automation:playbooks:update`**: 允許修改腳本（建立、編輯）。
- **`automation:playbooks:delete`**: 允許刪除腳本。
- **`automation:playbooks:execute`**: 允許手動執行腳本。
- **`automation:triggers:read`**: 允許查看觸發器。
- **`automation:triggers:update`**: 允許修改觸發器（建立、編輯、啟用/停用）。
- **`automation:triggers:delete`**: 允許刪除觸發器。
- **`automation:history:read`**: 允許查看執行歷史和日誌。
- **`automation:history:retry`**: 允許重試失敗的任務。
- **`automation:config:read`**: 允許檢視自動化系統的配置參數。
- **`automation:config:update`**: 允許修改自動化系統的配置參數。

#### 角色指派建議

- **Admin 角色**: 需要所有 `automation:*` 權限。
- **Editor 角色** (SRE): `automation:playbooks:*`, `automation:triggers:*`, `automation:history:*`, `automation:config:read`。
- **Viewer 角色**: `automation:playbooks:read`, `automation:triggers:read`, `automation:history:read`。

#### 權限檢查點

- **頁籤存取**: 存取各頁籤（腳本、觸發器、歷史、設定）需要對應的 `read` 權限。
- **操作按鈕**: 所有按鈕（新增、編輯、刪除、執行、重試等）都需綁定其對應的權限。
- **設定頁面**: 進入「設定」頁面檢查 `automation:config:read` 權限，修改配置檢查 `automation:config:update` 權限。

---

## 觀測性與治理檢查（Observability & Governance Checklist）

{{specs/common.md}}

---

## 成功標準 *(mandatory)*

### 可衡量成果

- **SC-001**: 使用者可以在 5 分鐘內建立一個新的自動化腳本並設定好其觸發器。
- **SC-002**: 自動化任務的平均執行延遲（從觸發到開始執行）應小於 10 秒。
- **SC-003**: 引入自動化後，團隊的重複性手動操作（如重啟服務）減少 80%。
- **SC-004**: 系統應能支援同時執行至少 50 個自動化任務。
- **SC-009**: 系統應能管理至少 500 個腳本庫，並支援每日處理 10000 次自動化任務執行。
- **SC-005**: 腳本執行必須在容器中完成隔離，確保零安全漏洞洩漏到宿主系統。
- **SC-006**: 資源配額控制應將任何單一腳本的資源使用限制在總系統資源的 10% 以內。
- **SC-007**: 事件觸發器應在事件發生後 3 秒內啟動對應的自動化腳本。
- **SC-008**: 參數輸入表單應根據 JSON Schema 準確產生對應的 UI 控制項，驗證錯誤應在 1 秒內提供回饋。
- **SC-010**: 系統應在任務狀態變更後 2 秒內更新所有相關 UI 組件和通知。
- **SC-011**: 過期執行記錄應在保留期限後 24 小時內自動清理，清理成功率應達到 99.9%。
- **SC-012**: 配置參數修改後，系統應在 30 秒內生效並應用到新的自動化任務處理流程。

---

## 模糊與待確認事項（Clarifications）

### Session 2025-10-10

- **Q**: 腳本執行環境應支援哪些類型的自動化腳本，以及對安全性和資源使用的基本約束是什麼？ → **A**: 多語言支援：Shell/Python/Go，容器化隔離，資源配額控制，基本網路存取
- **Q**: 事件觸發器的條件產生器需要支援哪些事件來源和屬性？ → **A**: 平台內建事件：支援告警事件、服務狀態變更、資源使用率超標
- **Q**: 腳本參數除了字串外，是否需要支援其他類型（如布林、下拉選擇）？ → **A**: 動態類型：支援 JSON Schema 定義的自訂參數類型和驗證規則
- **Q**: 考慮到 SRE 平台的實際使用情境，自動化系統的規模和效能應設定在什麼水準？ → **A**: 中型部署：支援 50 個並發腳本，500 個腳本庫，單日 10000 次執行
- **Q**: 腳本的生命週期和狀態管理應如何設計，以確保可靠的執行追蹤和資源清理？ → **A**: 完整生命週期：包含排程/執行中/成功/失敗/取消/超時狀態，保留歷史記錄並自動清理過期資源
- **執行中任務取消**: [FUTURE] 未來是否需要支援取消正在執行中的任務？