# 功能規格書（Feature Specification）: Automation Management

**建立日期**: 2025-10-08
**狀態**: Draft
**輸入**: 使用者描述: "提供一個統一的自動化管理平台，用於建立自動化腳本、設定觸發條件，並追蹤所有執行歷史"

## 使用者情境與測試 *(mandatory)*

### 使用者故事 1 - 作為 SRE，建立與維護可重複使用的自動化腳本 (Playbooks) (優先級: P1)

作為一名 SRE，我需要一個地方來集中建立和維護可重複使用的自動化腳本（Playbooks），例如「重啟服務」、「清理日誌檔案」等。我希望能定義腳本的參數，並能在需要時手動執行它們，以處理臨時的維運任務。

**為什麼此優先級**: Playbook 是自動化的核心原子能力。建立一個可複用的腳本庫是實現後續所有自動化觸發和執行的基礎。

**獨立測試**: 可以通過建立一個新的、帶有參數的 Shell 腳本，儲存後，在列表上手動執行它並傳入參數，最後在執行歷史中看到一筆成功的執行記錄來獨立測試。

**驗收情境**:

1. **Given** 我需要建立一個用於清理磁碟空間的新腳本, **When** 我在「腳本」頁籤點擊「新增腳本」，輸入名稱、描述和腳本內容, **Then** 新的腳本應被成功儲存。
2. **Given** 一台伺服器的磁碟空間告急, **When** 我在腳本列表上點擊「執行腳本」，並在彈窗中填寫必要的參數, **Then** 腳本應被執行，並在執行歷史中產生一筆新紀錄。
3. **Given** 我想一次刪除多個過時的腳本, **When** 我在表格中勾選多個腳本並點擊批次「刪除」按鈕, **Then** 所有被選中的腳本都應被刪除。

---

### 使用者故事 2 - 作為平台管理員，設定觸發器以自動執行腳本 (優先級: P1)

作為平台管理員，我需要能夠設定觸發器（Triggers），將事件（如告警）或排程（如每天凌晨）與我建立的自動化腳本連結起來，以實現真正的自動化，減少手動干預。

**為什麼此優先級**: 觸發器是連接「事件」和「動作」的橋樑，是從手動執行腳本邁向全自動化運維的關鍵一步。

**獨立測試**: 可以通過建立一個排程觸發器，設定為每分鐘執行一次，並綁定一個簡單的腳本。然後在幾分鐘後，去執行歷史頁面查看，應能看到多筆由該觸發器自動觸發的執行記錄。

**驗收情境**:

1. **Given** 我想設定一個每日報告的自動化任務, **When** 我在「觸發器」頁籤點擊「新增觸發器」，設定觸發類型為「排程」，輸入 CRON 表達式，並綁定報告腳本, **Then** 新的觸發器應被建立並啟用。
2. **Given** 我希望在某個告警觸發時自動重啟服務, **When** 我建立觸發器時選擇觸發類型為「事件」，設定告警條件，並綁定「重啟服務」腳本, **Then** 當該告警發生時，對應腳本應被自動執行。
3. **Given** 我需要進行系統維護, **When** 我在觸發器列表中批次停用多個觸發器, **Then** 所有選中的觸發器狀態應變為「停用」，且不再執行。

---

### 使用者故事 3 - 作為維運人員，追蹤與稽核所有自動化任務的執行歷史 (優先級: P2)

作為維運人員，我需要能夠追蹤和稽核所有自動化任務的執行歷史，無論是手動觸發還是自動觸發。我必須能看到每次執行的結果（成功/失敗）、詳細的日誌，並在失敗時能夠方便地重試。

**為什麼此優先級**: 提供了自動化系統的可追溯性和可審計性，這對於故障排查、效能分析和滿足合規性要求至關重要。

**獨立測試**: 可以通過手動執行一個會失敗的腳本，然後在「執行歷史」頁面找到這筆失敗的記錄，點擊查看其錯誤日誌，最後點擊「重試」並成功執行來獨立測試。

**驗收情境**:

1. **Given** 我想了解某次執行失敗的原因, **When** 我在「執行歷史」頁面點擊該筆失敗紀錄, **Then** 系統應在詳情面板中顯示結構化的錯誤日誌和執行步驟。
2. **Given** 一筆任務因暫時性錯誤而執行失敗, **When** 我在該紀錄旁點擊「重試」按鈕, **Then** 系統應重新執行該任務，並新增一筆狀態為「執行中」的紀錄。
3. **Given** 我需要分析最近的執行情況, **When** 我使用快速篩選器選擇「失敗」狀態和「過去24小時」, **Then** 列表應立即更新，只顯示符合條件的執行紀錄。
4. **Given** 我需要匯出執行紀錄, **When** 我點擊「匯出」按鈕, **Then** 系統應下載一份包含當前列表內容的 CSV 檔案。

---

### 邊界案例

- **參數未提供**: 當嘗試執行一個需要參數但未提供的腳本時，系統應阻止執行並給出明確提示。
- **觸發器綁定失效**: 當一個觸發器所綁定的腳本被刪除時，該觸發器應自動被禁用，並在 UI 上標示為無效。
- **執行中任務**: 正在執行中的任務不應允許「重試」操作。

## 功能需求 *(mandatory)*

### 功能需求

- **FR-001**: 系統必須（MUST）提供對自動化腳本（Playbooks）的完整 CRUD 管理，並允許手動執行。
- **FR-002**: 系統必須（MUST）提供對觸發器（Triggers）的完整 CRUD 管理，並支援「排程」和「事件」兩種觸發類型。
- **FR-003**: 系統必須（MUST）允許使用者在建立觸發器時，從現有的腳本庫中選擇一個進行綁定。
- **FR-004**: 系統必須（MUST）在可分頁、可排序的表格中展示所有自動化任務的執行歷史。
- **FR-005**: 執行歷史必須（MUST）記錄觸發來源（手動/觸發器）、執行者、狀態、開始時間和執行時長。
- **FR-006**: 使用者必須（MUST）能夠查看任何一次執行的詳細日誌和輸出。
- **FR-007**: 系統必須（MUST）為執行失敗的任務提供「重試」功能。
- **FR-008**: 所有 CUD 和執行操作都必須（MUST）有權限控制和審計日誌。

### 關鍵資料實體 *(如果功能涉及資料則包含)*

- **Playbook**: 代表一個自動化腳本。主要屬性: id, name, description, script_content, parameter_definitions。
- **Trigger**: 代表一個觸發器。主要屬性: id, name, type (`SCHEDULE`|`EVENT`), trigger_config, playbook_id, enabled。
- **ExecutionHistory**: 代表一次腳本執行記錄。主要屬性: id, playbook_id, trigger_id, status, start_time, end_time, logs, triggered_by。

## 權限控制 *(RBAC)*

### 權限模型設計

權限圍繞腳本、觸發器和執行歷史的讀取與修改進行設計。

#### 所需權限定義

- **`automation:playbooks:read`**: 允許查看腳本。
- **`automation:playbooks:update`**: 允許修改腳本（建立、編輯）。
- **`automation:playbooks:delete`**: 允許刪除腳本。
- **`automation:playbooks:execute`**: 允許手動執行腳本。
- **`automation:triggers:read`**: 允許查看觸發器。
- **`automation:triggers:update`**: 允許修改觸發器（建立、編輯、啟用/停用）。
- **`automation:triggers:delete`**: 允許刪除觸發器。
- **`automation:history:read`**: 允許查看執行歷史和日誌。
- **`automation:history:retry`**: 允許重試失敗的任務。

#### 角色指派建議

- **Admin 角色**: 需要所有 `automation:*` 權限。
- **Editor 角色** (SRE): `automation:playbooks:*`, `automation:triggers:*`, `automation:history:*`。
- **Viewer 角色**: `automation:playbooks:read`, `automation:triggers:read`, `automation:history:read`。

#### 權限檢查點

- **頁籤存取**: 存取各頁籤（腳本、觸發器、歷史）需要對應的 `read` 權限。
- **操作按鈕**: 所有按鈕（新增、編輯、刪除、執行、重試等）都需綁定其對應的權限。

---

## 觀測性與治理檢查（Observability & Governance Checklist）

{{specs/common.md}}

---

## 成功標準 *(mandatory)*

### 可衡量成果

- **SC-001**: 使用者可以在 5 分鐘內建立一個新的自動化腳本並設定好其觸發器。
- **SC-002**: 自動化任務的平均執行延遲（從觸發到開始執行）應小於 10 秒。
- **SC-003**: 引入自動化後，團隊的重複性手動操作（如重啟服務）減少 80%。
- **SC-004**: 系統應能支援同時執行至少 50 個自動化任務。

---

## 模糊與待確認事項（Clarifications）

- **腳本參數類型**: [NEEDS CLARIFICATION: 腳本參數除了字串外，是否需要支援其他類型（如布林、下拉選擇）？]
- **執行中任務取消**: [FUTURE] 未來是否需要支援取消正在執行中的任務？
- **事件觸發器條件**: [NEEDS CLARIFICATION: 事件觸發器的條件產生器需要支援哪些事件來源和屬性？]