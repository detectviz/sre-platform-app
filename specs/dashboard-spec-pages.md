# 儀表板 (Dashboards) 功能規格

本文檔旨在根據使用者介面 (UI) 截圖，逆向工程並定義儀表板模組的功能規格。文件中包含對每個頁面的現況描述、互動流程、API 資料流分析，並最終整理成使用者需求與功能規格。

所有內容均以繁體中文撰寫，並遵循產品需求文件 (PRD) 的結構，聚焦於 WHAT (功能) 與 WHY (目的)，而非 HOW (技術實現)。

---

### `dashboards-list.png`

**現況描述**
- **頁面標題**：頁面主標題為「儀表板」，副標題為「統一的系統監控與業務洞察儀表板入口」。
- **關鍵指標 (KPI)**：頁面頂部有三個關鍵指標卡片，分別顯示「儀表板總數」、「自訂儀表板」和「Grafana 儀表板」的數量。
- **功能分頁**：包含「儀表板列表」和「範本市集」兩個分頁，當前停留在列表頁。
- **操作列**：
    - 提供「搜尋儀表板...」的輸入框。
    - 包含「匯入」、「匯出」、「欄位設定」和「+ 新增儀表板」四個操作按鈕。
- **儀表板表格**：
    - 表格欄位包含：複選框、儀表板名稱（含描述）、類型、分類、擁有者、最後更新時間和操作。
    - 「類型」欄位以標籤形式展示，如「內建」、「Grafana」。
    - 「操作」欄位提供三個圖示按鈕：收藏（星號）、編輯（筆）、刪除（垃圾桶）。
- **分頁控制**：表格下方提供分頁功能，包含項目總數、頁碼導航和每頁顯示數量的選項。

**互動流程**
- **搜尋**：使用者在搜尋框輸入關鍵字，系統會即時或在使用者按下 Enter 後，向後端發送請求以篩選列表。
- **新增儀表板**：點擊「+ 新增儀表板」按鈕，系統應導航至儀表板模板選擇頁面或開啟建立儀表板的對話框。
- **編輯儀表板**：點擊任一儀表板對應的「編輯」圖示，系統應導航至該儀表板的編輯器頁面。
- **刪除儀表板**：點擊「刪除」圖示，系統應彈出確認對話框，防止誤刪。使用者確認後，從列表中移除該儀表板。
- **批次刪除**：使用者可以透過勾選表格最左側的複選框來選取多個儀表板，此時應出現批次操作按鈕（如「批次刪除」），允許使用者一次刪除所有選中的項目。
- **排序**：使用者可以點擊表格標頭（如「最後更新」）對列表進行升序或降序排序。
- **收藏**：點擊「收藏」圖示可以將儀表板標記為常用，或取消標記。該狀態應被持久化保存。
- **分頁**：使用者可以點擊頁碼或調整每頁顯示的項目數量，來瀏覽完整的儀表板列表。

**API 與資料流**
- **獲取儀表板列表**：
    - **API**: `GET /api/v1/dashboards`
    - **用途**: 載入儀表板列表。
    - **傳入參數**:
        - `page` (可選): 頁碼。
        - `page_size` (可選): 每頁項目數。
        - `keyword` (可選): 搜尋關鍵字。
        - `sort_by` (可選): 排序欄位。
        - `sort_order` (可選): 排序順序 (`asc` 或 `desc`)。
    - **傳出資料**: 回傳一個包含 `items` 陣列的分頁物件，每個 item 為一個 `Dashboard` 物件。
- **刪除儀表板**：
    - **API**: `DELETE /api/v1/dashboards/:id`
    - **用途**: 刪除單個儀表板。
    - **傳入參數**: 儀表板的 `id`。
    - **傳出資料**: 成功時回傳 204 No Content。
- **批次刪除儀表板**：
    - **API**: `POST /api/v1/dashboards/batch-actions`
    - **用途**: 批次刪除多個儀表板。
    - **傳入參數 (Body)**: `{ "action": "delete", "ids": ["db-id-1", "db-id-2"] }`
    - **傳出資料**: 回傳操作成功的訊息。
- **更新儀表板 (收藏)**：
    - **API**: `PATCH /api/v1/dashboards/:id`
    - **用途**: 更新儀表板的屬性，例如收藏狀態。
    - **傳入參數 (Body)**: 可能為 `{ "is_favorite": true/false }`。
    - **傳出資料**: 回傳更新後的 `Dashboard` 物件。

**需求與規格定義**
- **使用者需求**:
    - 作為使用者，我希望能看到一個包含所有儀表板的集中列表，以便於管理和查找。
    - 作為使用者，我希望能透過搜尋功能，快速找到我需要的儀表板。
    - 作為使用者，我希望能建立、編輯和刪除儀表板，以滿足我自訂監控畫面的需求。
    - 作為使用者，我希望能批次刪除不再需要的儀表板，以提高管理效率。
    - 作為使用者，我希望能將重要的儀表板加入收藏，方便快速存取。
- **功能規格**:
    - **SR-DASH-LIST-001**: 系統必須以表格形式顯示所有非軟刪除狀態的儀表板。
    - **SR-DASH-LIST-002**: 表格必須至少包含儀表板名稱、類型、分類、擁有者和最後更新時間欄位。
    - **SR-DASH-LIST-003**: 系統必須提供一個文字輸入框，用於根據儀表板名稱進行關鍵字搜尋。
    - **SR-DASH-LIST-004**: 系統必須提供一個「+ 新增儀表板」按鈕，點擊後啟動儀表板建立流程。
    - **SR-DASH-LIST-005**: 每一列儀表板都必須提供「編輯」和「刪除」操作。
    - **SR-DASH-LIST-006**: 刪除操作前，系統必須彈出確認對話框。
    - **SR-DASH-LIST-007**: 系統必須支援透過複選框進行多選，並提供批次刪除功能。
    - **SR-DASH-LIST-008**: 使用者應能點擊表格標頭對列表進行排序。
    - **SR-DASH-LIST-009**: 頁面頂部必須顯示儀表板總數的統計數據。

---

### `dashboards-template-gallery.png`

**現況描述**
- **頁面佈局**: 此頁面為「儀表板」功能的「範本市集」分頁。
- **模板展示**: 模板以卡片形式並排展示。
- **模板卡片內容**: 每張卡片包含：
    - 一個代表性的圖示 (Icon)。
    - 模板標題 (例如：「微服務健康度」、「業務 KPI 總覽」)。
    - 模板分類標籤 (例如：「應用程式」、「業務」)。
    - 模板的詳細描述。
    - 一個「使用此範本」按鈕。

**互動流程**
- **選擇模板**: 使用者瀏覽範本市集，找到符合需求的儀表板模板。
- **建立儀表板**:
    - 使用者點擊卡片上的「使用此範本」按鈕。
    - 系統應開啟一個對話框或導向新頁面，讓使用者為新的儀表板命名，並可能選擇擁有者（團隊或個人）。
    - 確認後，系統會基於所選模板的結構與預設配置，建立一個新的儀表板。
    - 建立成功後，應導向新建立的儀表板檢視頁面或編輯器頁面。

**API 與資料流**
- **獲取模板列表**:
    - **API**: `GET /api/v1/dashboards/templates`
    - **用途**: 載入所有可用的儀表板模板。
    - **傳出資料**: 回傳一個 `DashboardTemplate` 物件的陣列。每個物件包含 `id`, `name`, `description`, `icon`, `category`。
- **從模板建立儀表板**:
    - **API**: `POST /api/v1/dashboards`
    - **用途**: 使用者選擇模板後，建立一個新的儀表板實例。
    - **傳入參數 (Body)**:
        - `name`: 使用者輸入的新儀表板名稱。
        - `description` (可選): 使用者輸入的描述。
        - `type`: 'custom'。
        - `category`: 來自所選模板的 `category`。
        - `owner_id` / `team_id` (可選): 使用者指定的擁有者。
        - `template_id` (推測): 所選模板的 `id`，用於後端複製結構。
    - **傳出資料**: 回傳新建立的 `Dashboard` 物件。後端會根據模板的 `category` 自動關聯預設的 `resource_ids`。

**需求與規格定義**
- **使用者需求**:
    - 作為使用者，我希望能從一個預設的模板庫中選擇儀表板，以快速開始監控，而無需從零開始配置。
    - 作為使用者，我希望能預覽每個模板的用途和內容，以便做出正確的選擇。
- **功能規格**:
    - **SR-DASH-TPL-001**: 系統必須提供一個「範本市集」頁面，以卡片形式展示所有可用的儀表板模板。
    - **SR-DASH-TPL-002**: 每個模板卡片必須清晰地展示其名稱、描述、分類和一個代表性圖示。
    - **SR-DASH-TPL-003**: 每個模板卡片必須提供一個「使用此範本」的按鈕。
    - **SR-DASH-TPL-004**: 點擊「使用此範本」後，系統必須引導使用者完成儀表板的建立流程，至少需要使用者提供新儀表板的名稱。
    - **SR-DASH-TPL-005**: 系統必須能根據所選的模板，自動建立一個新的、可供編輯的儀表板副本。

---

### `dashboards-add-widget-modal.png`

**現況描述**
- **觸發方式**: 此彈窗應在儀表板編輯器頁面中，透過點擊「+ 新增小工具」按鈕觸發。
- **彈窗標題**: 標題為「新增小工具至儀表板」。
- **佈局**:
    - 彈窗內以列表或網格形式展示所有可用的小工具。
    - [NEEDS CLARIFICATION: 截圖中未顯示，但通常應包含搜尋框以快速查找小工具]。
- **小工具項目**: 每個項目包含：
    - 小工具的名稱 (例如：「待處理事件」、「總資源數」)。
    - 小工具的功能描述。
    - 一個「+」按鈕，用於將該小工具新增至儀表板。

**互動流程**
- **開啟彈窗**: 在儀表板編輯頁面，使用者點擊「新增小工具」按鈕，系統彈出此視窗。
- **選擇小工具**: 使用者在列表中找到想要新增的小工具。
- **新增小工具**:
    - 使用者點擊小工具項目右側的「+」按鈕。
    - 系統應立即將對應的小工具新增到儀表板的畫布上，通常會出現在一個預設的位置或第一個可用的空格中。
    - 新增後，彈窗可以保持開啟狀態，允許使用者繼續新增其他小工具，或者自動關閉。
- **關閉彈窗**: 使用者可以點擊彈窗右上角的「x」按鈕或按下 `Esc` 鍵來關閉此視窗。

**API 與資料流**
- **獲取可用小工具列表**:
    - **API**: `GET /api/v1/settings/widgets` (推測)
    - **用途**: 載入所有可在儀表板中使用的小工具定義。
    - **傳出資料**: 回傳一個 `LayoutWidget` 物件的陣列。每個物件包含 `id`, `name`, `description` 等資訊。
- **新增小工具到儀表板**:
    - **API**: 此操作通常在前端完成，不直接呼叫 API。使用者在畫布上完成佈局調整後，點擊「儲存」按鈕時，才會將包含新小工具的完整佈局資訊透過 `PATCH /api/v1/dashboards/:id` 一併儲存。
    - **前端資料流**:
        - 點擊「+」按鈕後，前端狀態管理系統 (例如 Redux, Zustand) 會在儀表板的 `layout` 狀態陣列中新增一個 `DashboardLayoutItem` 物件。
        - 該物件包含新小工具的 `i` (ID), 以及預設的 `x`, `y`, `w`, `h` (位置與大小) 屬性。
        - React 偵測到狀態變更，重新渲染儀表板畫布，顯示出新的小工具。

**需求與規格定義**
- **使用者需求**:
    - 作為使用者，我希望能有一個小工具市集，讓我瀏覽並選擇想新增到儀表板的監控項目。
    - 作為使用者，我希望能輕鬆地將所選的小工具添加到我的儀表板畫布上。
- **功能規格**:
    - **SR-DASH-WIDGET-001**: 系統必須提供一個「新增小工具」的彈窗介面。
    - **SR-DASH-WIDGET-002**: 彈窗內必須以列表形式展示所有可用的小工具。
    - **SR-DASH-WIDGET-003**: 每個小工具選項必須顯示其名稱、描述和一個新增按鈕。
    - **SR-DASH-WIDGET-004**: 點擊新增按鈕後，對應的小工具必須立即出現在儀表板的編輯畫布上。
    - **SR-DASH-WIDGET-005**: [建議] 彈窗應提供搜尋功能，方便使用者在大量小工具中快速查找。

---

### `dashboards-builder-empty.png` 與 `dashboards-builder-with-widgets.png`

**現況描述**
- **頁面標題**: 頁面顯示「建立儀表板：[儀表板名稱]」，例如「建立儀表板：微服務健康度」。
- **操作按鈕**:
    - **主要操作**: 「+ 新增小工具」。
    - **頁面級操作**: 「取消」和「儲存儀表板」。
- **畫布區域**:
    - **空狀態 (`dashboards-builder-empty.png`)**: 當畫布上沒有任何小工具時，中央會顯示一個圖示和提示文字「空儀表板」，並引導使用者「點擊『新增小工具』開始建立您的儀表板」。
    - **有小工具狀態 (`dashboards-builder-with-widgets.png`)**: 當畫布上有小工具時，它們會被放置在一個不可見的網格系統上。每個小工具都是一個獨立的卡片，顯示其對應的數據。

**互動流程**
- **新增小工具**:
    - 使用者點擊「+ 新增小工具」按鈕，觸發「新增小工具至儀表板」彈窗（如前一節所述）。
    - 從彈窗中選擇並新增小工具後，小工具會出現在畫布上。
- **佈局管理**:
    - **移動**: 使用者可以透過滑鼠拖放 (Drag and Drop) 的方式，在畫布上自由移動小工具的位置。
    - **縮放**: 使用者可以拖動小工具的右下角邊框，來調整其寬度和高度。
    - **刪除**: [NEEDS CLARIFICATION: 截圖中未顯示] 每個小工具卡片上應有一個「x」或垃圾桶圖示，允許使用者將其從畫布上移除。
- **儲存與取消**:
    - **儲存**: 使用者完成佈局調整後，點擊「儲存儀表板」按鈕。系統會將當前的佈局資訊傳送至後端進行保存。
    - **取消**: 使用者點擊「取消」按鈕，系統應放棄所有未儲存的變更，並返回儀表板列表頁。

**API 與資料流**
- **儲存儀表板佈局**:
    - **API**: `PATCH /api/v1/dashboards/:id`
    - **用途**: 當使用者點擊「儲存儀表板」時，用來持久化儀表板的佈局變更。
    - **傳入參數 (Body)**:
        - `layout`: 一個 `DashboardLayoutItem` 物件的陣列。每個物件代表一個小工具的佈局資訊。
        - 格式: `[{ "i": "widget-id-1", "x": 0, "y": 0, "w": 4, "h": 2 }, ...]`
            - `i`: 小工具的唯一識別碼。
            - `x`, `y`: 小工具在網格佈局中的起始座標。
            - `w`, `h`: 小工具佔用的網格寬度和高度。
    - **前端資料流**:
        - 使用者在畫布上拖放或縮放小工具時，前端的網格佈局元件（例如 `react-grid-layout`）會即時更新其在記憶體中的 `layout` 狀態。
        - 當使用者點擊儲存時，這個 `layout` 狀態陣列會被序列化並作為請求主體，發送到後端 API。

**需求與規格定義**
- **使用者需求**:
    - 作為使用者，我希望能自由地安排儀表板上小工具的位置和大小，以建立符合我監控習慣的版面。
    - 作為使用者，我希望能隨時新增或移除儀表板上的小工具。
    - 作為使用者，我希望能儲存我的自訂佈局，以便下次檢視時保持一樣的版面。
- **功能規格**:
    - **SR-DASH-BUILDER-001**: 系統必須提供一個基於網格的畫布，作為儀表板編輯器。
    - **SR-DASH-BUILDER-002**: 在編輯模式下，使用者必須能夠透過拖放操作來移動小工具。
    - **SR-DASH-BUILDER-003**: 在編輯模式下，使用者必須能夠透過拖動邊框來調整小工具的大小。
    - **SR-DASH-BUILDER-004**: 系統必須提供一個「儲存儀表板」按鈕，點擊後會透過 API 持久化當前的 `layout` 資訊。
    - **SR-DASH-BUILDER-005**: 系統必須提供一個「取消」按鈕，點擊後會放棄所有未儲存的變更。
    - **SR-DASH-BUILDER-006**: 當儀表板為空時，必須顯示清晰的空狀態提示，引導使用者新增小工具。
    - **SR-DASH-BUILDER-007**: [建議] 每個小工具卡片應提供一個移除按鈕，允許使用者將其從畫布中刪除。

---

### `dashboard-overview-ai-summary.png`

**現況描述**
- **頁面用途**: 此頁面是一個 AI 驅動的分析總覽儀表板，旨在提供系統健康狀況的高層次快照。
- **頂部 KPI**: 顯示四個關鍵指標：「待處理事件」、「處理中」、「今日已解決」和「自動化率」。
- **AI 每日簡報**:
    - **穩定性摘要**: 提供一段由 AI 生成的關於系統整體穩定性的文字摘要。
    - **關鍵異常**: 標示出 AI 偵測到的最重要異常事件，並提供連結（例如：`on 支付 API`）。
    - **建議操作**: 基於偵測到的異常，提供具體、可執行的建議，並包含一個「查看日誌」的按鈕。
- **服務健康度總覽**:
    - 一個熱力圖 (Heatmap)，顯示不同服務在不同維度（例如 `us-east-1`, `eu-central-1`）上的健康分數。
    - 顏色代表健康狀態（例如：綠色為健康，紅色為異常）。
- **資源群組狀態**:
    - 一個堆疊長條圖 (Stacked Bar Chart)，顯示不同資源群組（例如 `API Services`, `Logging Stack`）的狀態分佈。
    - 長條圖以不同顏色區分狀態，如「健康」、「警告」、「嚴重」。

**互動流程**
- **刷新簡報**: 使用者可以點擊「AI 每日簡報」區塊右上角的刷新按鈕，以獲取最新的分析結果。
    - **實現細節**: 點擊重新整理按鈕觸發 `POST /ai/briefing/generate` 以重新產生摘要；期間按鈕進入 loading 狀態避免重複送出 【F:pages/SREWarRoomPage.tsx†L82-L93】【F:pages/SREWarRoomPage.tsx†L183-L187】
- **查看異常詳情**: 點擊「關鍵異常」中提到的實體連結（如 `支付 API`），應導向該實體的詳細監控頁面。
- **執行建議操作**: 點擊「建議操作」中的「查看日誌」按鈕，應導向相關的日誌查詢頁面，並可能預先填入篩選條件。
- **圖表互動**:
    - 使用者將滑鼠懸停在熱力圖或長條圖的某個區塊上時，應顯示一個工具提示 (Tooltip)，提供該區塊的詳細數據（例如：服務名稱、具體健康分數、資源群組的各狀態數量）。
    - **實現細節**: 服務健康度與資源群組圖表點擊資料列時，分別導向資源清單與資源群組頁面，延續使用者調查流程 【F:pages/SREWarRoomPage.tsx†L95-L109】
    - [NEEDS CLARIFICATION: 截圖中未顯示] 點擊圖表中的某個元素（如一個長條或熱力圖方格）可能會觸發下鑽 (Drill-down) 功能，顯示更詳細的數據或導向相關資源列表。

**API 與資料流**
- **獲取總覽數據**:
    - **API**: `GET /api/v1/analysis/overview`
    - **用途**: 一次性獲取頁面上大部分 AI 分析相關的數據。
    - **傳出資料**: 回傳一個 `AnalysisOverviewData` 物件，其中包含：
        - `health_score`: 對應「穩定性摘要」。
        - `anomalies`: 對應「關鍵異常」。
        - `suggestions`: 對應「建議操作」。
- **獲取服務健康度**:
    - **API**: `GET /api/v1/dashboards/sre-war-room/service-health`
    - **用途**: 獲取熱力圖所需的數據。
    - **傳出資料**: 回傳一個 `ServiceHealthData` 物件，包含 `heatmap_data`, `x_axis_labels`, `y_axis_labels`。
    - **實現細節**: 失敗時顯示錯誤並允許重試 【F:pages/SREWarRoomPage.tsx†L56-L74】【F:mock-server/handlers.ts†L534-L538】
- **獲取資源群組狀態**:
    - **API**: `GET /api/v1/dashboards/sre-war-room/resource-group-status`
    - **用途**: 獲取堆疊長條圖所需的數據。
    - **傳出資料**: 回傳一個 `ResourceGroupStatusData` 物件，包含 `group_names` 和 `series` 陣列。
    - **實現細節**: 失敗時顯示錯誤並允許重試 【F:pages/SREWarRoomPage.tsx†L56-L74】【F:mock-server/handlers.ts†L534-L538】
- **獲取頂部 KPI**:
    - **API**: 可能是透過 `GET /api/v1/incidents/count` 搭配不同的 `matchers` 參數來分別獲取各狀態的事件數量，或是由一個專門的 KPI API 提供。
- **AI 簡報資料**:
    - **API**: `GET /ai/briefing`、`POST /ai/briefing/generate`
    - **實現細節**: 回傳摘要、異常與建議文字；資料來源為 mock DB 的 `ai_briefing` 【F:mock-server/handlers.ts†L462-L470】【F:mock-server/db.ts†L3122-L3134】
- **KPI 區塊資料**:
    - **實現細節**: `PageKPIs` 會呼叫 `GET /kpi-data`、`GET /settings/widgets` 與 `GET /settings/layouts`，並緩存於元件狀態；缺資料時改顯示缺少設定的提示卡 【F:components/PageKPIs.tsx†L29-L59】【F:mock-server/handlers.ts†L3200-L3244】【F:mock-server/handlers.ts†L3880-L3902】

**需求與規格定義**
- **使用者需求**:
    - 作為 SRE 或運維人員，我希望能有一個高層次的總覽頁面，快速了解當前系統的整體健康狀況和最重要的風險。
    - 作為使用者，我希望能獲得由 AI 提供的摘要和建議，幫助我快速定位問題並採取行動。
    - 作為使用者，我希望能透過視覺化的圖表（熱力圖、長條圖）直觀地比較不同服務和資源群組的狀態。
- **功能規格**:
    - **SR-AI-OV-001**: 系統必須提供一個「AI 每日簡報」區塊，顯示由後端 AI 服務生成的穩定性摘要、關鍵異常和建議操作。
    - **SR-AI-OV-002**: 系統必須提供一個「服務健康度總覽」熱力圖，視覺化展示各服務的健康分數。
    - **SR-AI-OV-003**: 系統必須提供一個「資源群組狀態」堆疊長條圖，展示各資源群組的狀態組成。
    - **SR-AI-OV-004**: 「AI 每日簡報」區塊必須提供手動刷新功能。
    - **SR-AI-OV-005**: 簡報中的「關鍵異常」和「建議操作」必須提供可點擊的連結或按鈕，以導向相關的詳細頁面或執行操作。
    - **SR-AI-OV-006**: 所有圖表在滑鼠懸停時必須顯示包含詳細數據的工具提示。