# 功能規格書（Feature Specification）: Dashboards Management

**建立日期**: 2025-10-10
**狀態**: Draft
**輸入**: 使用者描述: "提供一個統一的儀表板管理介面，用於快速切換、管理和擴充平台內建及外部連結的 Grafana 儀表板"

## 使用者情境與測試 *(mandatory)*

### 使用者故事 1 - 作為 SRE，在統一介面中查看與切換多種類型的儀表板 (優先級: P1)

作為一名 SRE，在日常監控和問題排查時，我需要在一個統一的介面中快速查看和切換多個儀表板，無論它們是平台內建的還是從外部 Grafana 連結的。目前的痛點是在多個系統和 URL 之間頻繁跳轉，操作複雜且效率低下。

**為什麼此優先級**: 解決了監控視圖分散的核心痛點，為使用者提供了單一入口，是提升日常維運效率的基礎。

**獨立測試**: 可以通過在儀表板清單中成功看到一個「內建」儀表板和一個「外部」儀表板，並能點擊它們順利載入對應的儀表板內容來獨立測試。

**驗收情境**:

1.  **Given** 我在儀表板管理頁面中, **When** 我查看儀表板清單, **Then** 系統應顯示所有「內建」與「外部」儀表板，並以標籤清晰區分來源。
2.  **Given** 我想了解儀表板的元數據, **When** 我打開儀表板資訊側欄, **Then** 系統應顯示其版本、來源、上次同步時間等資訊。
3.  **Given** 我需要依不同場景切換儀表板呈現方式, **When** 我切換「顯示模式」為「標準」或「全螢幕」, **Then** 系統應即時重新渲染視圖。

---

### 使用者故事 2 - 作為平台管理員，連結外部 Grafana 儀表板以擴充監控能力 (優先級: P2)

作為平台管理員，當平台內建的儀表板無法滿足特定業務需求時，我需要能夠將團隊在自己 Grafana 中建立的儀表板連結到平台中，方便整個團隊存取。目前的痛點是，如果無法連結，自訂儀表板就成了資訊孤島。

**為什麼此優先級**: 提供了平台的擴充性，允許團隊利用現有的 Grafana 資源，滿足客製化的監控需求。

**獨立測試**: 可以通過在管理頁面輸入一個有效的 Grafana 儀表板 URL，成功建立連結後，在儀表板清單中看到這個新的「外部」儀表板來獨立測試。

**驗收情境**:

1.  **Given** 我需要新增外部 Grafana 儀表板, **When** 我輸入 Grafana UID 或完整 URL 並確認, **Then** 系統應驗證儀表板是否存在並成功建立連結。
2.  **Given** 我新增了一個外部儀表板連結, **When** 我在儀表板清單中點擊它, **Then** 系統應能在 iframe 或新頁面中正確載入該儀表板。

---

### 使用者故事 3 - 作為平台使用者，個人化儀表板偏好以提升效率 (優先級: P3)

作為平台使用者，我希望能將最常用的儀表板設定為我的預設首頁，並能將一些儀表板加入書籤以便快速尋找。目前的痛點是每次登入或重新整理後都需要手動尋找常用儀表板，浪費時間。

**為什麼此優先級**: 提升使用者體驗，減少重複的導航操作，讓使用者可以更快地進入工作狀態。

**驗收情境**:

1.  **Given** 我想在首頁自動顯示常用儀表板, **When** 我在設定中將某個儀表板設為「預設儀表板」並儲存, **Then** 下次登入後首頁應自動導向該儀表板。
2.  **Given** 我瀏覽儀表板清單, **When** 我點擊一個儀表板旁的書籤圖示, **Then** 該儀表板應被標記為我的個人書籤，並可以透過篩選快速找到。
3.  **Given** 我在桌面版設定了書籤, **When** 我在手機版登入同一帳號, **Then** 書籤狀態應保持同步。
4.  **Given** 我切換排序為「最近使用」, **When** 我重新開啟儀表板管理頁, **Then** 系統應自動保留我的排序偏好設定。

---

### 邊界案例

- **內建儀表板**: 內建儀表板應為唯讀，不允許使用者編輯或刪除其連結。
- **自訂元件載入失敗**: 當內建儀表板的 React 元件載入失敗時，系統應顯示友好的錯誤訊息並提供重新載入選項。
- **整合 Grafana 連線失敗**: 當平台管理的 Grafana 實例無法連線時，系統應顯示錯誤訊息並提供重新載入選項。
- **外部儀表板失效**: 當一個外部連結的 Grafana 儀表板在源頭被刪除時，平台中的連結點擊後應顯示「儀表板不存在或無權限存取」的錯誤頁面。
- **權限問題**: 當使用者沒有權限查看某個外部儀表板時，點擊連結後應顯示 Grafana 的權限錯誤頁面。
- **代理伺服器故障**: 當代理伺服器無法連線時，系統應顯示適當的錯誤訊息並提供重新連線選項。
- **代理快取失效**: 當代理伺服器的快取資料過期或損壞時，應自動重新從源頭獲取最新資料。
- **代理安全性檢查**: 代理伺服器必須驗證所有轉發請求的安全性，阻止潛在的惡意請求。
- **API 資料載入失敗**: 當內建儀表板的資料 API 請求失敗時，系統應顯示快取資料或適當的載入狀態。
- **並發使用者上限**: 當同時在線使用者超過 50 個時，系統應實施適當的資源調配或排隊機制。
- **儀表板數量上限**: 當儀表板總數接近 200 個時，系統應發出容量警告並建議整理過時儀表板。
- **每日查看配額超限**: 當每日查看次數接近 5000 次時，系統應實施速率限制並記錄使用量指標。
- **無效配置參數**: 當使用者輸入無效的配置參數（如負數超時時間）時，系統應拒絕儲存並顯示具體的驗證錯誤訊息。
- **配置同步延遲**: 當多個節點需要同步配置變更時，系統應確保所有節點在 60 秒內完成同步，以維持一致的儀表板行為。
- **配置參數衝突**: 當新配置與現有儀表板設定發生衝突時，系統應提供遷移指引或阻止配置生效。
- **書籤同步衝突**：當同一使用者在多裝置同時修改書籤時，系統應保留最新修改並記錄衝突事件。
- **無效書籤清理**：定期檢查失效或已刪除儀表板的書籤，並自動清除。
- **跨角色可見性**：團隊共享書籤僅對具相同團隊角色的使用者可見。

## 功能需求 *(mandatory)*

### 功能需求

- **FR-001**: 系統必須（MUST）支援「內建」和「外部」兩種類型的儀表板，並在清單中清晰標示。
- **FR-002**: 內建儀表板必須（MUST）是唯讀的。
- **FR-009**: 內建儀表板採用混合模式：核心儀表板使用自訂 React 元件實現，複雜儀表板整合平台管理的 Grafana 實例。
- **FR-010**: 系統必須（MUST）支援內建儀表板的動態資料載入，通過平台 API 獲取即時監控資料。
- **FR-003**: 系統必須（MUST）允許使用者透過 Grafana 的 UID 或 URL 來新增外部儀表板的連結。
- **FR-011**: 外部儀表板必須（MUST）通過平台的安全代理伺服器載入，避免 CORS 問題並增強安全性。
- **FR-012**: 代理伺服器必須（MUST）支援請求轉發、回應快取和錯誤處理功能。
  - **[參數化]** 代理快取大小（100MB, 500MB, 1GB, 2GB）
  - **[參數化]** 快取過期時間（5分鐘, 15分鐘, 30分鐘, 1小時）
  - **[參數化]** 請求超時設定（10秒, 30秒, 60秒, 120秒）
- **FR-013**: 系統必須（MUST）支援中型部署規模：至少 200 個儀表板、50 個並發使用者和每日 5000 次查看。
- **FR-014**: 系統必須（MUST）提供基本的錯誤處理機制：顯示清晰的錯誤訊息，提供重新載入選項，並記錄所有錯誤到日誌。
- **FR-015**: 系統必須（MUST）支援參數化配置儀表板載入和顯示行為。
  - **[參數化]** 儀表板載入超時（5秒, 10秒, 15秒, 30秒）
  - **[參數化]** 自動重新整理間隔（關閉, 1分鐘, 5分鐘, 15分鐘）
  - **[參數化]** 預設顯示模式（標準, 全螢幕）
- **FR-016**: 系統必須（MUST）支援參數化配置規模限制和資源管理。
  - **[參數化]** 最大儀表板數量（100, 200, 500, 1000）
  - **[參數化]** 最大並發使用者數（25, 50, 100, 200）
  - **[參數化]** 每日查看配額（1000, 5000, 10000, 20000）
- **FR-004**: 儀表板清單必須（MUST）支援搜尋、排序和分頁功能。
- **FR-005**: 系統必須（MUST）提供多種顯示模式，如標準、全螢幕。
- **FR-006**: 使用者必須（MUST）能夠設定個人的預設儀表板。
- **FR-007**: 使用者必須（MUST）能夠將儀表板加入書籤，且偏好設定（書籤、排序）需要跨裝置同步。
- **FR-008**: 所有新增、刪除儀表板連結的操作必須（MUST）記錄到審計日誌。
- **FR-017**：系統必須（MUST）支援儀表板書籤的跨模組同步，當使用者在任何模組新增或移除書籤時，導覽系統與偏好設定應自動更新。
- **FR-018**：儀表板書籤需區分三種類型：個人書籤、團隊共享書籤與系統預設書籤；顯示時應有明確標籤。
- **FR-019**：系統應支援書籤排序方式，包括「最近使用」、「自訂排序」與「權限優先」。
- **FR-020**：不同 subtype (`CUSTOM_COMPONENT`, `INTEGRATED_GRAFANA`, `LINKED_GRAFANA`) 的書籤需具備容錯邏輯：當來源載入失敗時，顯示替代狀態（如「已失效」或「待更新」）。

### 關鍵資料實體 *(如果功能涉及資料則包含)*

- **Dashboard**: 代表一個儀表板。主要屬性: id, name, type (`BUILT_IN`|`EXTERNAL`), subtype (對於 BUILT_IN: `CUSTOM_COMPONENT`|`INTEGRATED_GRAFANA`; 對於 EXTERNAL: `LINKED_GRAFANA`), source_id (Grafana UID 或元件 ID), url, component_config (自訂元件的配置), proxy_config (代理伺服器設定)。
- **UserDashboardPreference**: 儲存使用者的儀表板偏好。主要屬性: user_id, default_dashboard_id, bookmarked_dashboard_ids (`id[]`)。
- **DashboardSystemConfiguration**: 代表儀表板系統的參數化配置。主要屬性: proxy_cache_size, cache_expiration_minutes, request_timeout_seconds, dashboard_load_timeout, auto_refresh_interval, default_display_mode, max_dashboards, max_concurrent_users, daily_view_quota。

## 權限控制 *(RBAC)*

### 權限模型設計

權限圍繞儀表板的查看和管理（主要是外部連結的管理）進行設計。

#### 所需權限定義

- **`dashboards:read`**: 允許檢視儀表板清單與內容。
- **`dashboards:link:create`**: 允許新增外部 Grafana 儀表板連結。
- **`dashboards:link:delete`**: 允許刪除外部儀表板連結。
- **`dashboards:preferences:update`**: 允許使用者設定自己的偏好（如預設儀表板、書籤）。
- **`dashboards:config:read`**: 允許檢視儀表板系統的配置參數。
- **`dashboards:config:update`**: 允許修改儀表板系統的配置參數。

#### 角色指派建議

- **Admin 角色**: `dashboards:read`, `dashboards:link:create`, `dashboards:link:delete`, `dashboards:preferences:update`, `dashboards:config:*`。
- **Editor 角色**: `dashboards:read`, `dashboards:link:create`, `dashboards:link:delete`, `dashboards:preferences:update`, `dashboards:config:read`。
- **Viewer 角色**: `dashboards:read`, `dashboards:preferences:update`。

#### 權限檢查點

- **進入儀表板頁面**: 檢查 `dashboards:read` 權限。
- **顯示「新增連結」按鈕**: 檢查 `dashboards:link:create` 權限。
- **顯示「刪除連結」按鈕**: 檢查 `dashboards:link:delete` 權限。
- **儲存個人偏好**: 檢查 `dashboards:preferences:update` 權限。
- **進入設定頁面**: 檢查 `dashboards:config:read` 權限。
- **修改系統配置**: 檢查 `dashboards:config:update` 權限。

---

## 觀測性與治理檢查（Observability & Governance Checklist）

> 本模組遵循平台憲法中定義之全域治理與觀測性原則。  
> 詳細規範請參閱：
> - [.specify/memory/constitution.md](../../.specify/memory/constitution.md)
> - 章節：[觀測性與治理檢查](../../.specify/memory/constitution.md#ai-生成與規格合規)

> 本模組需確保：
> - 所有操作皆可追蹤並具備審計記錄。  
> - 關鍵事件具備可觀測性指標（logs、metrics、alerts）。  
> - 錯誤回報須符合統一錯誤模型並附 trace_id。  
> - Mock API 與實際行為需與 `/specs` 定義保持一致。

---

## 成功標準 *(mandatory)*

### 可衡量成果

- **SC-001**: 使用者可以在 30 秒內成功新增一個外部儀表板連結。
- **SC-002**: 儀表板（內嵌框架）的平均載入時間應低於 3 秒。
- **SC-003**: 95% 的使用者能在首次使用時成功找到並設定自己的預設儀表板。
- **SC-004**: 自訂元件儀表板的初始渲染時間應低於 2 秒，資料更新延遲應低於 1 秒。
- **SC-005**: 整合 Grafana 儀表板的載入時間應低於 5 秒，包含驗證和 iframe 初始化。
- **SC-006**: 代理伺服器轉發請求的平均延遲應低於 500 毫秒，快取命中率應達到 80% 以上。
- **SC-007**: 系統應能管理至少 200 個儀表板，並支援 50 個並發使用者同時查看。
- **SC-008**: 系統應能處理每日至少 5000 次儀表板查看請求，平均回應時間低於 2 秒。
- **SC-009**: 當發生錯誤時，系統應在 3 秒內顯示清晰的錯誤訊息，並提供重新載入選項。
- **SC-010**: 配置參數修改後，系統應在 30 秒內生效並應用到新的儀表板載入流程。
- **SC-011**：書籤狀態變更應於 1 秒內同步至導覽系統與個人偏好設定。
- **SC-012**：不同 subtype 儀表板書籤的錯誤容忍率應達 100%（即任何載入錯誤皆能安全回退）。
- **SC-013**：書籤同步機制在多裝置間一致性維持率應達 99.9%。

---

## 模糊與待確認事項（Clarifications）

### Session 2025-10-10

- **Q**: 內建儀表板的來源和技術實現應採用什麼方式？ → **A**: 混合模式：核心儀表板使用自訂元件，複雜儀表板整合外部 Grafana
- **Q**: 外部 Grafana 儀表板的整合應採用什麼模式？ → **A**: 安全代理：通過平台代理伺服器轉發請求，避免 CORS 和安全問題
- **Q**: 儀表板系統的規模和效能應設定在什麼水準？ → **A**: 中型部署：支援 200 個儀表板，50 個並發使用者，單日 5000 次查看
- **Q**: 儀表板系統的錯誤處理和恢復機制應如何設計？ → **A**: 基本處理：顯示錯誤訊息，提供重新載入選項，記錄錯誤但不自動恢復
- **儀表板同步**: [FUTURE] 未來是否需要支援將外部儀表板的 JSON 內容同步到平台內，以實現版本控制和更深入的整合？
- **儀表板匯入/匯出**: [FUTURE] 是否需要支援匯出/匯入儀表板的連結設定，以方便在不同環境間遷移？
- **Grafana Scenes**: [FUTURE] 未來是否考慮整合 Grafana Scenes 作為內建儀表板的底層技術？