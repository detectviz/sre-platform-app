# 功能規格書（Feature Specification）: Identity Audit

**建立日期**: 2025-10-08
**狀態**: Draft
**輸入**: 使用者描述: "提供一個不可變的審計日誌系統，用於追蹤所有關鍵操作、快速查詢與篩選，並產出合規報表"

## 使用者情境與測試 *(mandatory)*

### 使用者故事 1 - 作為安全管理員，調查安全事件與追蹤系統變更 (優先級: P1)

作為一名安全管理員，當需要調查安全事件（如異常權限變更）或追蹤系統變更時，我需要能夠快速地查詢和篩選審計日誌。我必須能查看操作的完整上下文，包括操作者、時間、IP位址，以及最重要的——變更前後的資料快照。目前的痛點是日誌分散且細節不足，導致調查效率低下。

**為什麼此優先級**: 這是審計日誌最核心的價值所在，直接關係到安全事件的響應速度和問題定位的準確性。

**獨立測試**: 可以通過在系統中執行一次角色變更操作，然後在審計日誌中篩選出該操作，並驗證其詳情面板中是否清晰地展示了變更前和變更後的角色資訊來獨立測試。

**驗收情境**:

1.  **Given** 我需要調查使用者 `john@example.com` 的所有活動, **When** 我在篩選器中設定「操作者 = john@example.com」和適當的時間範圍, **Then** 列表應僅顯示該使用者的操作記錄。
2.  **Given** 我需要調查一次失敗的部署操作, **When** 我設定篩選條件「動作類型 = Deploy」和「結果 = Failed」, **Then** 系統必須顯示所有符合條件的失敗部署日誌。
3.  **Given** 我在日誌列表中點擊一筆「角色更新」記錄, **When** 詳情面板打開, **Then** 我必須能看到變更前的角色與變更後的角色（Before/After 快照）。
4.  **Given** 我需要追蹤一個特定的請求, **When** 我在搜尋框中輸入請求 ID, **Then** 系統必須顯示與該請求 ID 關聯的所有操作記錄。

---

### 使用者故事 2 - 作為合規稽核人員，產出與匯出審計報告 (優先級: P2)

作為一名合規稽核人員，為了滿足季度或年度的安全審查（如 SOC 2），我需要能夠方便地篩選出特定時間範圍內的所有特權操作記錄，並將其匯出為標準格式（如 CSV、JSON）的報告。目前的痛點是需要人工整理報表，耗時且容易出錯。

**為什麼此優先級**: 滿足外部合規性要求是企業的硬性需求。提供一鍵匯出功能可以極大簡化合規工作流程。

**獨立測試**: 可以通過篩選出過去 30 天內所有「權限變更」相關的日誌，點擊「匯出為 CSV」，並驗證下載的檔案中是否包含了所有篩選出的記錄且格式正確來獨立測試。

**驗收情境**:

1.  **Given** 我需要為稽核準備一份報告, **When** 我篩選出所有「權限變更」相關日誌並點擊「匯出為 CSV」, **Then** 系統應下載一個包含所有篩選結果的 CSV 檔案。
2.  **Given** 我需要將日誌導入到外部 SIEM 系統, **When** 我點擊「匯出為 JSON」, **Then** 系統應下載一個包含完整日誌詳細資訊的 JSON 檔案。
3.  **Given** 我需要匯出大量日誌（超過 10,000 筆）, **When** 我啟動匯出任務, **Then** 系統應以後台任務處理，並在完成後通知我下載。

---

### 使用者故事 3 - 作為系統管理員，確保日誌的完整性與查詢效能 (優先級: P3)

作為系統管理員，我需要確保審計日誌是不可篡改的，以保證其作為證據的有效性。同時，即使日誌量達到百萬甚至千萬級別，查詢介面也必須保持高效能，在幾秒內響應。

**為什麼此優先級**: 保障了審計日誌的基礎——可信度和可用性。如果日誌可以被篡改或無法被及時查詢，其價值將大打折扣。

**獨立測試**: 可以通過查詢一個包含百萬筆日誌的時間範圍，驗證頁面是否在 5 秒內響應並採用分頁載入。同時，在日誌詳情中應能看到用於完整性校驗的欄位（如數位簽章）。

**驗收情境**:

1.  **Given** 系統配置了「日誌不可篡改」儲存策略, **When** 我查看日誌詳情, **Then** 我應該能看到該日誌的數位簽章或完整性校驗和。
2.  **Given** 我查詢一個包含 100 萬筆日誌的時間範圍, **When** 系統載入頁面, **Then** 頁面必須在 5 秒內響應，並採用分頁載入顯示結果。

---

### 邊界案例

- **大量匯出**: 大量日誌的匯出應採用後台異步任務處理，並在完成後提供下載連結，避免長時間佔用前端。
- **查詢超時**: 對於極其複雜的查詢，如果後端處理超時，前端應顯示清晰的超時提示，並建議使用者縮小查詢範圍。
- **歸檔日誌**: 查詢已歸檔的日誌時，系統應提示可能會有較長的延遲。

## 功能需求 *(mandatory)*

### 功能需求

- **FR-001**: 系統必須（MUST）記錄所有關鍵操作的審計日誌，核心欄位包括：操作者、時間、動作、目標、結果、IP 位址、請求 ID。
- **FR-002**: 對於所有變更型操作，系統必須（MUST）記錄操作前和操作後的資料快照（Before/After Snapshot）。
- **FR-003**: 系統必須（MUST）提供多維度複合篩選功能，至少支援按時間範圍、操作者、動作類型和結果狀態進行篩選。
- **FR-004**: 系統必須（MUST）支援將查詢結果匯出為 CSV 和 JSON 格式。
- **FR-005**: 系統應該（SHOULD）採用防篡改機制（如數位簽章或 WORM 儲存）來保證日誌的完整性。
- **FR-006**: 日誌查詢響應時間在百萬級日誌量下必須（MUST）在 5 秒內完成。
- **FR-007**: 系統必須（MUST）支援日誌保留策略，例如線上保留 90 天，之後自動歸檔。

### 關鍵資料實體 *(如果功能涉及資料則包含)*

- **AuditLog**: 代表一條審計日誌記錄。主要屬性: id, timestamp, actor_id, action_type, target_id, result_status, ip_address, request_id, before_snapshot, after_snapshot, signature。

## 權限控制 *(RBAC)*

### 權限模型設計

審計日誌的權限控制相對簡單，主要圍繞讀取和匯出進行。

#### 所需權限定義

- **`audit-logs:read`**: 允許檢視審計日誌列表與詳細資訊。
- **`audit-logs:export`**: 允許匯出審計日誌（CSV、JSON）。
- **`audit-logs:verify`**: 允許查看日誌完整性驗證報告。

#### 角色指派建議

- **Admin 角色**: `audit-logs:read`, `audit-logs:export`, `audit-logs:verify`。
- **Editor 角色**: `audit-logs:read`。
- **Viewer 角色**: `audit-logs:read`。
- **Auditor 角色** (特定合規角色): `audit-logs:read`, `audit-logs:export`, `audit-logs:verify`。

#### 權限檢查點

- **進入審計日誌頁面**: 檢查 `audit-logs:read` 權限。
- **顯示「匯出」按鈕**: 檢查 `audit-logs:export` 權限。
- **查看完整性報告**: 檢查 `audit-logs:verify` 權限。

---

## 觀測性與治理檢查（Observability & Governance Checklist）

{{specs/common.md}}

---

## 成功標準 *(mandatory)*

### 可衡量成果

- **SC-001**: 對於千萬級別的日誌總量，95% 的標準查詢（按時間、使用者篩選）應在 2 秒內返回結果。
- **SC-002**: 匯出 10 萬筆日誌記錄的任務應在 5 分鐘內完成。
- **SC-003**: 審計日誌的寫入操作對核心業務流程的效能影響應小於 1%。

---

## 模糊與待確認事項（Clarifications）

- **歸檔日誌查詢**: [NEEDS CLARIFICATION: 已歸檔的日誌如何查詢？是提供一個獨立的介面還是與線上查詢整合，但標明延遲？]
- **防篡改技術選型**: [NEEDS CLARIFICATION: 防篡改機制的具體技術實現是什麼？是基於區塊鏈、特定資料庫功能還是其他方式？]
- **異常行為告警**: [FUTURE] 是否需要基於審計日誌建立一個異常行為檢測和告警的子模組？