# 功能規格書（Feature Specification）: Platform Mail

**建立日期**: 2025-10-06
**狀態**: Draft
**輸入**: 使用者描述: "為平台提供全局 SMTP 郵件伺服器設定，以可靠地發送所有系統通知"

## 使用者情境與測試 *(mandatory)*

### 使用者故事 1 - 作為平台管理員，設定並儲存 SMTP 伺服器資訊 (優先級: P1)

作為平台管理員，我需要設定一個全局的 SMTP 郵件伺服器，以便平台能夠可靠地發送所有系統通知，如告警、使用者邀請和報告。我需要一個清晰的表單來配置伺服器位址、埠號、加密方式和認證資訊。目前，若無此功能，平台將無法發送任何郵件。

**為什麼此優先級**: 這是平台通知功能的基礎，若無法設定，告警、邀請等核心功能將完全失效。

**獨立測試**: 可以通過填寫完整的 SMTP 設定，點擊儲存，然後重新載入頁面，驗證所有資訊（除密碼外）都已正確保存來獨立測試。

**驗收情境**:

1.  **Given** 我首次設定平台的郵件功能, **When** 我進入「SMTP 郵件伺服器」設定頁面, **Then** 系統應顯示一個包含所有必要欄位的表單。
2.  **Given** 我已填寫完整的 SMTP 設定資訊, **When** 我點擊「儲存變更」按鈕, **Then** 系統應成功保存設定並顯示成功訊息。
3.  **Given** 我需要修改現有的 SMTP 設定, **When** 我重新進入設定頁面並變更伺服器位址, **Then** 密碼欄位應顯示佔位符 `••••••••••`。
4.  **Given** 我已修改設定但尚未儲存, **When** 我點擊「還原為已儲存設定」按鈕, **Then** 系統應撤銷所有未儲存的變更。

---

### 使用者故事 2 - 作為平台管理員，在儲存前測試 SMTP 連線以確保設定正確 (優先級: P2)

在儲存 SMTP 設定前，我需要能夠發送一封測試郵件，以驗證伺服器位址、埠號、加密方式和認證憑證是否全部正確。目前的痛點是，如果沒有測試功能，設定錯誤只能在實際發送通知時才被發現，可能導致關鍵告警漏發，且問題排查效率低下。

**為什麼此優先級**: 顯著降低設定錯誤的風險，避免關鍵通知遺漏，提升問題排查效率。

**獨立測試**: 可以通過填寫 SMTP 設定，點擊「發送測試郵件」，並在指定信箱中成功收到測試郵件來獨立測試。

**驗收情境**:

1.  **Given** 我已填寫 SMTP 設定但尚未儲存, **When** 我點擊「發送測試郵件」按鈕, **Then** 系統應使用當前表單中的設定值發送測試郵件，並顯示成功發送的訊息。
2.  **Given** 我輸入了錯誤的 SMTP 憑證, **When** 我點擊「發送測試郵件」按鈕, **Then** 系統應返回「認證失敗」的錯誤訊息。
3.  **Given** 我輸入了無法連線的 SMTP 伺服器位址, **When** 我點擊「發送測試郵件」按鈕, **Then** 系統應在超時後返回「無法連線」的錯誤訊息。
4.  **Given** 我測試連線成功後, **When** 我查看「連線健康狀態」指示器, **Then** 系統應顯示綠色的「連線正常」標籤與最後測試時間。

---

### 使用者故事 3 - 作為平台管理員，安全地管理敏感憑證並獲得清晰的輸入指引 (優先級: P3)

在設定 SMTP 時，我需要確保密碼等敏感資訊受到保護，同時在輸入錯誤時能獲得明確的提示。目前的痛點是，密碼若以明文顯示會有安全風險，而模糊的錯誤提示會降低配置效率。

**為什麼此優先級**: 保障系統安全，同時提升使用者體驗和配置效率。

**獨立測試**: 可以通過驗證密碼欄位預設為遮蔽狀態，且提供顯示/隱藏切換功能來獨立測試。同時，可以通過輸入無效的 Email 格式並驗證系統是否給出正確的錯誤提示來測試。

**驗收情境**:

1.  **Given** 我正在查看已儲存的 SMTP 設定, **When** 頁面載入, **Then** 密碼欄位應預設以遮蔽形式顯示，並提供「顯示/隱藏」切換按鈕。
2.  **Given** 我需要更新 SMTP 密碼, **When** 我在密碼欄位輸入新密碼並儲存, **Then** 系統應僅在使用者輸入新值時才在 API 請求中傳遞密碼欄位。
3.  **Given** 我輸入了一個無效的寄件人 Email 地址, **When** 我嘗試儲存, **Then** 系統應顯示「請輸入有效的 Email 格式」的錯誤訊息並阻止操作。
4.  **Given** 我選擇了需要認證的 SMTP 伺服器但未填寫密碼, **When** 我嘗試儲存, **Then** 系統應顯示「使用者名稱與密碼為必填欄位」的錯誤。

---

### 邊界案例

- 當 SMTP 伺服器回應緩慢時，測試功能應如何處理超時？
- 當儲存的設定因伺服器端變更而失效時，系統應如何提示？

## 功能需求 *(mandatory)*

### 功能需求

- **FR-001**: 系統必須（MUST）提供一個表單介面，允許管理員設定和編輯全局 SMTP 參數（伺服器、埠號、加密方式、認證資訊等）。
- **FR-002**: 系統必須（MUST）提供「發送測試郵件」功能，以驗證當前表單中的設定是否正確。
- **FR-003**: 系統必須（MUST）在 UI 上清晰地展示連線測試的結果（如成功、認證失敗、無法連線）。
- **FR-004**: 密碼欄位必須（MUST）預設以遮蔽形式顯示，並提供「顯示/隱藏」的切換功能。
- **FR-005**: 當載入已儲存的設定時，密碼欄位必須（MUST）顯示為佔位符，而非明文。
- **FR-006**: 系統必須（MUST）對 Email、埠號等欄位進行前端和後端的格式驗證。
- **FR-007**: 所有設定變更與測試操作必須（MUST）記錄至審計日誌 [FUTURE]。

### 關鍵資料實體 *(如果功能涉及資料則包含)*

- **SmtpConfiguration**: 代表全局 SMTP 設定的單一實體。主要屬性: host, port, encryption (`tls`|`starttls`|`none`), username, password_secret, from_address。

## 權限控制 *(RBAC)*

### 權限模型設計

此功能的存取控制相對簡單，主要限制只有具備平台管理權限的角色才能進行設定。

#### 所需權限定義

- **`platform:mail:read`**: 允許查看 SMTP 設定（通常與 update 權限合併）。
- **`platform:mail:update`**: 允許修改並儲存 SMTP 設定。
- **`platform:mail:test`**: 允許執行「發送測試郵件」操作。

#### 角色指派建議

- **Admin 角色**: 需要 `platform:mail:update` 和 `platform:mail:test` 權限。
- **Editor 角色**: 無權限。
- **Viewer 角色**: 無權限。

#### 權限檢查點

- **進入設定頁面**: 檢查使用者是否擁有 `platform:mail:update` 權限。
- **點擊「儲存」按鈕**: 檢查 `platform:mail:update` 權限。
- **點擊「發送測試郵件」按鈕**: 檢查 `platform:mail:test` 權限。

---

## 觀測性與治理檢查（Observability & Governance Checklist）

{{specs/common.md}}

---

## 成功標準 *(mandatory)*

### 可衡量成果

- **SC-001**: 管理員可以在 3 分鐘內完成從填寫表單到成功收到測試郵件的完整流程。
- **SC-002**: 透過平台的郵件發送成功率應達到 99.9% 以上。
- **SC-003**: 至少 95% 的常見設定錯誤（如密碼錯誤、埠號不對）能在儲存前的測試階段被識別和攔截。

---

## 模糊與待確認事項（Clarifications）

- [NEEDS CLARIFICATION: 「發送測試郵件」功能應發送給哪個信箱？是固定的管理員信箱，還是可以在測試時臨時輸入？]