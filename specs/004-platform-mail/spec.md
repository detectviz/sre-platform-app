# 功能規格書（Feature Specification）: Platform Mail

**建立日期**: 2025-10-06
**狀態**: Draft
**輸入**: 使用者描述: "為平台提供全局 SMTP 郵件伺服器設定，以可靠地發送所有系統通知"

## 使用者情境與測試 *(mandatory)*

### 使用者故事 1 - 作為平台管理員，設定並儲存 SMTP 伺服器資訊 (優先級: P1)

作為平台管理員，我需要設定一個全局的 SMTP 郵件伺服器，以便平台能夠可靠地發送所有系統通知，如告警、使用者邀請和報告。我需要一個清晰的表單來配置伺服器位址、埠號、加密方式和認證資訊。目前，若無此功能，平台將無法發送任何郵件。

**為什麼此優先級**: 這是平台通知功能的基礎，若無法設定，告警、邀請等核心功能將完全失效。

**獨立測試**: 可以通過填寫完整的 SMTP 設定，點擊儲存，然後重新載入頁面，驗證所有資訊（除密碼外）都已正確保存來獨立測試。

**驗收情境**:

1.  **Given** 我首次設定平台的郵件功能, **When** 我進入「SMTP 郵件伺服器」設定頁面, **Then** 系統應顯示一個包含所有必要欄位的表單。
2.  **Given** 我已填寫完整的 SMTP 設定資訊, **When** 我點擊「儲存變更」按鈕, **Then** 系統應成功保存設定並顯示成功訊息。
3.  **Given** 我需要修改現有的 SMTP 設定, **When** 我重新進入設定頁面並變更伺服器位址, **Then** 密碼欄位應顯示佔位符 `••••••••••`。
4.  **Given** 我已修改設定但尚未儲存, **When** 我點擊「還原為已儲存設定」按鈕, **Then** 系統應撤銷所有未儲存的變更。

---

### 使用者故事 2 - 作為平台管理員，在儲存前測試 SMTP 連線以確保設定正確 (優先級: P2)

在儲存 SMTP 設定前，我需要能夠發送一封測試郵件，以驗證伺服器位址、埠號、加密方式和認證憑證是否全部正確。目前的痛點是，如果沒有測試功能，設定錯誤只能在實際發送通知時才被發現，可能導致關鍵告警漏發，且問題排查效率低下。

**為什麼此優先級**: 顯著降低設定錯誤的風險，避免關鍵通知遺漏，提升問題排查效率。

**獨立測試**: 可以通過填寫 SMTP 設定，點擊「發送測試郵件」，並在指定信箱中成功收到測試郵件來獨立測試。

**驗收情境**:

1.  **Given** 我已填寫 SMTP 設定但尚未儲存, **When** 我點擊「發送測試郵件」按鈕, **Then** 系統應使用當前表單中的設定值發送測試郵件，並顯示成功發送的訊息。
2.  **Given** 我輸入了錯誤的 SMTP 憑證, **When** 我點擊「發送測試郵件」按鈕, **Then** 系統應返回「認證失敗」的錯誤訊息。
3.  **Given** 我輸入了無法連線的 SMTP 伺服器位址, **When** 我點擊「發送測試郵件」按鈕, **Then** 系統應在超時後返回「無法連線」的錯誤訊息。
4.  **Given** 我測試連線成功後, **When** 我查看「連線健康狀態」指示器, **Then** 系統應顯示綠色的「連線正常」標籤與最後測試時間。

---

### 使用者故事 3 - 作為平台管理員，安全地管理敏感憑證並獲得清晰的輸入指引 (優先級: P3)

在設定 SMTP 時，我需要確保密碼等敏感資訊受到保護，同時在輸入錯誤時能獲得明確的提示。目前的痛點是，密碼若以明文顯示會有安全風險，而模糊的錯誤提示會降低配置效率。

**為什麼此優先級**: 保障系統安全，同時提升使用者體驗和配置效率。

**獨立測試**: 可以通過驗證密碼欄位預設為遮蔽狀態，且提供顯示/隱藏切換功能來獨立測試。同時，可以通過輸入無效的 Email 格式並驗證系統是否給出正確的錯誤提示來測試。

**驗收情境**:

1.  **Given** 我正在查看已儲存的 SMTP 設定, **When** 頁面載入, **Then** 密碼欄位應預設以遮蔽形式顯示，並提供「顯示/隱藏」切換按鈕。
2.  **Given** 我需要更新 SMTP 密碼, **When** 我在密碼欄位輸入新密碼並儲存, **Then** 系統應僅在使用者輸入新值時才在 API 請求中傳遞密碼欄位。
3.  **Given** 我輸入了一個無效的寄件人 Email 地址, **When** 我嘗試儲存, **Then** 系統應顯示「請輸入有效的 Email 格式」的錯誤訊息並阻止操作。
4.  **Given** 我選擇了需要認證的 SMTP 伺服器但未填寫密碼, **When** 我嘗試儲存, **Then** 系統應顯示「使用者名稱與密碼為必填欄位」的錯誤。

---

### 邊界案例

- **SMTP 連線超時**: 當 SMTP 伺服器回應緩慢時，測試功能應在 30 秒後超時並顯示明確的錯誤訊息。
- **SMTP 服務降級**: 當 SMTP 服務部分降級時，系統應自動切換到備用 SMTP 配置並記錄切換事件。
- **郵件發送失敗**: 郵件發送失敗時，系統應將郵件排入重試佇列，最多重試 3 次並實作指數退避策略。
- **分散式故障恢復**: 當某個郵件發送節點故障時，其他節點應自動接管工作負載並重新分配佇列中的郵件。
- **監控告警**: 當郵件發送成功率低於 95% 或佇列積壓超過閾值時，系統應觸發告警通知管理員。
- **速率限制處理**: SMTP 服務器實施速率限制時，系統應實作適應性延遲和分散式發送調度。
- **垃圾郵件防護**: 郵件被識別為垃圾郵件時，系統應記錄詳細日誌並通知寄件者模組進行後續處理。

## 功能需求 *(mandatory)*

### 功能需求

- **FR-001**: 系統必須（MUST）提供一個表單介面，允許管理員設定和編輯全局 SMTP 參數（伺服器、埠號、加密方式、認證資訊等）。
- **FR-002**: 系統必須（MUST）提供「發送測試郵件」功能，以驗證當前表單中的設定是否正確。預設發送給當前登入的管理員信箱，但允許臨時指定其他測試收件人信箱。
- **FR-003**: 系統必須（MUST）在 UI 上清晰地展示連線測試的結果（如成功、認證失敗、無法連線）。
- **FR-004**: 密碼欄位必須（MUST）預設以遮蔽形式顯示，並提供「顯示/隱藏」的切換功能。
- **FR-005**: 當載入已儲存的設定時，密碼欄位必須（MUST）顯示為佔位符，而非明文。
- **FR-006**: 系統必須（MUST）對 Email、埠號等欄位進行前端和後端的格式驗證。
- **FR-007**: 所有設定變更與測試操作必須（MUST）記錄至審計日誌 [FUTURE]。
- **FR-008**: 系統必須（MUST）支援每日 1000000+ 封郵件的發送量，平均發送時間小於 2 秒。
- **FR-009**: 系統必須（MUST）支援分散式郵件發送架構，包含多個 SMTP 實例和負載平衡。
- **FR-SEC-001**: SMTP 密碼和認證資訊必須（MUST）在儲存和傳輸過程中進行加密。
- **FR-SEC-002**: 所有郵件設定變更必須（MUST）記錄詳細的稽核日誌，包含操作者、時間和變更內容。
- **FR-SEC-003**: 系統必須（MUST）實作角色-based 存取控制，限制 SMTP 設定的檢視和修改權限。

### 整合與外部依賴需求

- **FR-INT-001**: 系統必須（MUST）提供統一的郵件發送 REST API，其他模組通過 HTTP 呼叫使用郵件功能。
- **FR-INT-002**: SMTP 服務不可用時，系統必須（MUST）將郵件排入重試佇列，支援指數退避重試策略。
- **FR-INT-003**: 系統必須（MUST）提供郵件發送狀態查詢 API，允許發送者追蹤郵件投遞狀態。
- **FR-INT-004**: 外部 SMTP 服務持續故障時，系統必須（MUST）支援備用 SMTP 配置的自動切換。

### 關鍵資料實體 *(如果功能涉及資料則包含)*

- **SmtpConfiguration**: 代表全局 SMTP 設定的單一實體。主要屬性: host, port, encryption (`tls`|`starttls`|`none`), username, password_secret, from_address。

## 權限控制 *(RBAC)*

### 權限模型設計

此功能的存取控制相對簡單，主要限制只有具備平台管理權限的角色才能進行設定。

#### 所需權限定義

- **`platform:mail:read`**: 允許查看 SMTP 設定（通常與 update 權限合併）。
- **`platform:mail:update`**: 允許修改並儲存 SMTP 設定。
- **`platform:mail:test`**: 允許執行「發送測試郵件」操作。

#### 角色指派建議

- **Admin 角色**: 需要 `platform:mail:update` 和 `platform:mail:test` 權限。
- **Editor 角色**: 無權限。
- **Viewer 角色**: 無權限。

#### 權限檢查點

- **進入設定頁面**: 檢查使用者是否擁有 `platform:mail:update` 權限。
- **點擊「儲存」按鈕**: 檢查 `platform:mail:update` 權限。
- **點擊「發送測試郵件」按鈕**: 檢查 `platform:mail:test` 權限。

---

## 觀測性與治理檢查（Observability & Governance Checklist）

{{specs/common.md}}

---

## 成功標準 *(mandatory)*

### 可衡量成果

- **SC-001**: 管理員可以在 3 分鐘內完成從填寫表單到成功收到測試郵件的完整流程。
- **SC-002**: 透過平台的郵件發送成功率應達到 99.9% 以上，支援每日 **[參數化]** 郵件發送配額（500000封, 1000000封, 2000000封）的發送量。
- **SC-003**: 至少 95% 的常見設定錯誤（如密碼錯誤、埠號不對）能在儲存前的測試階段被識別和攔截。
- **SC-PERF-001**: 平均郵件發送時間應小於 2 秒，P95 延遲小於 10 秒。

---

## 模糊與待確認事項（Clarifications）

### Session 2025-10-10

- **Q**: 「發送測試郵件」功能應發送給哪個信箱？ → **A**: 雙重選擇：預設發送給管理員，但允許臨時指定其他信箱
- **Q**: 郵件服務需要支援的效能目標和規模限制是什麼？ → **A**: 超大規模：每日 1000000+ 封郵件，支援分散式發送
- **Q**: 郵件服務需要符合哪些安全標準和資料保護要求？ → **A**: 企業級安全：加上敏感資料加密、稽核追蹤、存取控制
- **Q**: 郵件服務如何與其他平台模組整合，以及如何處理外部 SMTP 服務的故障？ → **A**: 集中式 API：提供統一的郵件發送 API，其他模組通過 HTTP 呼叫
- **Q**: 郵件服務需要處理哪些關鍵的邊界案例和錯誤情況？ → **A**: 完整容錯：所有上述項目加上分散式故障恢復和監控告警