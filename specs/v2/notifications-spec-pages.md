# 通知功能規格

本文檔旨在根據現有系統的 UI 截圖，逆向分析並定義通知中心 (Notifications) 的功能規格。其內容包含對每個頁面的現況描述、使用者互動流程、API 資料流分析，以及明確的使用者需求與功能規格。

所有內容均遵循產品需求文件 (PRD) 的標準，聚焦於 **WHAT** 與 **WHY**，並確保每個需求都是可驗證的。

---

### `notifications-channels-list.png`

**現況描述**
- 此頁面為「通知管道」的管理中心，以表格形式展示所有已設定的通知管道。
- 頁面頂部有一個工具列，包含左側的「搜尋與篩選」按鈕，以及右側的「欄位設定」和「新增管道」按鈕。
- 表格支援多選功能，選取項目後，工具列會顯示批次操作按鈕，包括「啟用」、「停用」和「刪除」。
- 表格主要欄位包括：啟用狀態 (開關)、管道名稱、類型、上次測試結果、上次測試時間。
- 每一列末端都有「編輯」和「刪除」的獨立操作按鈕。
- 「類型」欄位會根據管道類型 (Email, Slack 等) 顯示對應的圖示和名稱。
- 「上次測試結果」欄位會以不同顏色的藥丸 (Pill) 樣式顯示 `success`、`failed` 或 `not_tested` 狀態。

**互動流程**
- **新增管道**：使用者點擊「新增管道」按鈕，會開啟一個模態視窗 (Modal) 讓使用者設定新的通知管道。
- **編輯管道**：使用者點擊任一管道旁的「編輯」圖示，會開啟同一個模態視窗，並載入該管道的現有設定以供修改。
- **刪除管道**：使用者點擊「刪除」圖示，會跳出一個確認對話框，提醒操作無法復原。確認後，該管道將被刪除。
- **啟用/停用**：使用者可以直接點擊「啟用」欄位下的開關 (Toggle)，即時切換該管道的啟用狀態。
- **批次操作**：
    1. 使用者透過勾選表格每一列的核取方塊 (Checkbox) 來選取多個管道。
    2. 選取後，工具列會顯示已選取的項目數量及批次操作按鈕。
    3. 使用者可點擊「啟用」、「停用」或「刪除」按鈕，對所有選取的管道執行相應操作。
- **搜尋與篩選**：使用者點擊「搜尋與篩選」按鈕，會開啟一個搜尋模態視窗，可根據關鍵字、類型等條件篩選管道列表。
- **欄位設定**：使用者點擊「欄位設定」，可以自訂表格中要顯示或隱藏的欄位。

**API 與資料流**
- **載入頁面**：
    - `GET /settings/notification-channels`：向後端請求通知管道列表。可傳入篩選參數 (如 `filters`)。
    - **回傳**：後端回傳一個包含 `items` (管道陣列) 和 `total` (總數) 的物件。每個管道物件的結構遵循 `NotificationChannel` 型別。
    - `GET /ui/icons-config`：獲取管道類型的圖示設定。
    - `GET /settings/column-config/:pageKey`：獲取使用者自訂的表格欄位顯示設定。
- **切換啟用狀態**：
    - `PATCH /settings/notification-channels/:id`：傳送一個僅包含 `enabled` 欄位的物件來更新該管道的狀態。
- **儲存 (新增/編輯)**：
    - **新增**：`POST /settings/notification-channels`，Body 中包含完整的 `NotificationChannel` 物件。
    - **編輯**：`PATCH /settings/notification-channels/:id`，Body 中包含被修改的 `NotificationChannel` 物件欄位。
- **刪除**：
    - `DELETE /settings/notification-channels/:id`：刪除指定 ID 的管道。
- **批次操作**：
    - `POST /settings/notification-channels/batch-actions`：
    - **傳入**：`{ action: 'enable' | 'disable' | 'delete', ids: string[] }`。
    - **流程**：前端收集所有選取管道的 ID，連同指定的操作名稱一次性傳送給後端。

**需求與規格定義**
- **使用者需求**
    - 作為系統管理員，我需要一個集中的地方來查看、管理我所有的通知發送管道。
    - 我希望能快速新增不同類型的通知管道 (例如 Email、Slack)。
    - 我希望能方便地啟用或停用特定管道，而不需要刪除它。
    - 我希望能對不再使用的管道進行刪除。
    - 當管道數量多時，我需要能夠搜尋和篩選，以快速找到目標。
    - 我希望能一次對多個管道進行相同的操作 (如全部啟用或刪除)。
- **功能規格**
    - **[R-NC-01]** 系統必須提供一個頁面，以表格形式展示所有已設定的通知管道。
    - **[R-NC-02]** 表格必須顯示以下預設欄位：啟用狀態、管道名稱、類型、上次測試結果、上次測試時間。
    - **[R-NC-03]** 系統必須提供「新增管道」功能，點擊後應彈出設定視窗。
    - **[R-NC-04]** 每一筆管道記錄都必須提供「編輯」和「刪除」操作。
        - **[R-NC-04-01]** 刪除操作前，必須有再次確認的提示。
    - **[R-NC-05]** 系統必須支援對單一管道的「啟用/停用」操作，且操作應即時生效。
    - **[R-NC-06]** 系統必須支援批次選取功能。
        - **[R-NC-06-01]** 使用者選取後，必須能對選取的管道執行批次「啟用」、「停用」及「刪除」操作。
    - **[R-NC-07]** 系統必須提供搜尋與篩選功能。
    - **[R-NC-08]** 系統必須允許使用者自訂表格顯示的欄位，並保存其設定。

---

### `notifications-add-channel-email.png`

**現況描述**
- 此為新增/編輯「Email」類型通知管道的表單。
- 包含通用欄位：「名稱」和「管道類型」(已選定為 Email)。
- 專屬欄位包括：「收件人 (To)」、「副本 (CC)」、「密件副本 (BCC)」。
- 這些收件人欄位都支援多個電子郵件地址輸入，輸入後會以標籤 (Tag) 形式呈現。

**互動流程**
- **輸入**：使用者在「名稱」欄位輸入管道的自訂名稱。
- **新增收件人**：
    1. 在 To/CC/BCC 輸入框中輸入一個完整的電子郵件地址。
    2. 按下 `Enter`, `Space` 或 `,` 鍵，或在輸入框失焦 (onBlur) 時，系統會驗證郵件格式。
    3. 若格式有效，該郵件地址會變成一個標籤，並清空輸入框以便繼續輸入。
    4. 若格式無效，系統會提示錯誤。
    5. 使用者可直接貼上一串以逗號或分號分隔的郵件地址，系統會自動將其轉換為多個標籤。
- **移除收件人**：點擊郵件地址標籤旁邊的 `x` 圖示即可移除。
- **儲存**：點擊「儲存」按鈕，會將表單資料送出。
- **測試**：
    1. 管道必須先儲存 (獲得 `id`) 才能進行測試。
    2. 點擊「發送測試」按鈕，系統會向後端發起測試請求。
    3. 前端應顯示測試中的狀態，並在收到結果後以提示訊息 (Toast) 顯示成功或失敗。

**API 與資料流**
- **儲存**：
    - `POST` 或 `PATCH /settings/notification-channels`
    - **傳入**：Body 中包含 `NotificationChannel` 物件，其 `type` 為 `email`，`config` 物件包含 `to`, `cc`, `bcc` 欄位，值為逗號分隔的郵件地址字串。
- **測試**：
    - `POST /settings/notification-channels/:id/test`
    - **回傳**：`NotificationChannelTestResponse` 物件，包含成功/失敗狀態與訊息。

**需求與規格定義**
- **使用者需求**
    - 我希望能設定透過 Email 發送通知，並能指定多個主要收件人、副本和密件副本收件人。
- **功能規格**
    - **[R-NC-09]** 系統必須提供 Email 類型的通知管道設定。
    - **[R-NC-10]** Email 管道設定必須包含「名稱」、「收件人 (To)」、「副本 (CC)」、「密件副本 (BCC)」欄位。
    - **[R-NC-11]** 「名稱」與「收件人 (To)」為必填欄位。
    - **[R-NC-12]** 收件人、副本、密件副本欄位必須支援輸入多個有效的電子郵件地址。
    - **[R-NC-13]** 系統必須在使用者新增郵件地址時驗證其格式。
    - **[R-NC-14]** 系統必須提供「發送測試」功能，以驗證 Email 管道設定是否正確。
        - **[R-NC-14-01]** 只有已儲存的管道才能進行測試。

---

### `notifications-add-channel-webhook.png`

**現況描述**
- 此為新增/編輯「Webhook (通用)」類型通知管道的表單。
- 包含通用欄位：「名稱」和「管道類型」。
- 專屬欄位包括：「Webhook URL」和「HTTP 方法 (Method)」。

**互動流程**
- **輸入**：使用者在「名稱」和「Webhook URL」欄位輸入對應資訊。
- **選擇方法**：使用者可從下拉選單中選擇 HTTP 方法 (如 POST, GET, PUT)。預設為 POST。
- **儲存與測試**：流程同 Email 管道。

**API 與資料流**
- **儲存**：
    - `POST` 或 `PATCH /settings/notification-channels`
    - **傳入**：`config` 物件包含 `webhook_url` 和 `http_method`。
- **測試**：`POST /settings/notification-channels/:id/test`

**需求與規格定義**
- **使用者需求**
    - 我希望能設定一個通用的 Webhook，將通知發送到任何支援 Webhook 的第三方服務。
- **功能規格**
    - **[R-NC-15]** 系統必須提供 Webhook (通用) 類型的通知管道設定。
    - **[R-NC-16]** Webhook 管道設定必須包含「名稱」、「Webhook URL」、「HTTP 方法」欄位。
    - **[R-NC-17]** 「名稱」與「Webhook URL」為必填欄位。
    - **[R-NC-18]** 「HTTP 方法」應為下拉選單，預設值為 `POST`。
    - **[R-NC-19]** 系統必須提供「發送測試」功能。

---

### `notifications-add-channel-slack.png`

**現況描述**
- 此為新增/編輯「Slack」類型通知管道的表單。
- 專屬欄位包括：「Incoming Webhook URL」和「提及對象 (Mention)」。

**互動流程**
- **輸入**：使用者填寫 Slack 提供的 Webhook URL，並可選擇性地填寫要提及的對象 (如 `@channel`)。
- **儲存與測試**：流程同 Email 管道。

**API 與資料流**
- **儲存**：
    - `POST` 或 `PATCH /settings/notification-channels`
    - **傳入**：`config` 物件包含 `webhook_url` 和 `mention`。
- **測試**：`POST /settings/notification-channels/:id/test`

**需求與規格定義**
- **使用者需求**
    - 我希望能將通知直接發送到指定的 Slack 頻道，並能 at 特定的人或群組。
- **功能規格**
    - **[R-NC-20]** 系統必須提供 Slack 類型的通知管道設定。
    - **[R-NC-21]** Slack 管道設定必須包含「Incoming Webhook URL」欄位，此為必填。
    - **[R-NC-22]** Slack 管道設定可選填「提及對象」欄位。
    - **[R-NC-23]** 系統必須提供「發送測試」功能。

---

### `notifications-add-channel-line.png`

**現況描述**
- 此為新增/編輯「LINE Notify」類型通知管道的表單。
- 專屬欄位為「存取權杖 (Access Token)」。
- 該欄位為密碼輸入框，右側有可切換顯示/隱藏內容的眼睛圖示。

**互動流程**
- **輸入**：使用者將從 LINE Notify 取得的權杖貼入輸入框。
- **切換可見度**：點擊眼睛圖示，可以在明文和密文之間切換，方便使用者確認輸入是否正確。
- **儲存與測試**：流程同 Email 管道。

**API 與資料流**
- **儲存**：
    - `POST` 或 `PATCH /settings/notification-channels`
    - **傳入**：`config` 物件包含 `access_token`。
- **測試**：`POST /settings/notification-channels/:id/test`

**需求與規格定義**
- **使用者需求**
    - 我希望能透過 LINE Notify 服務接收通知。
- **功能規格**
    - **[R-NC-24]** 系統必須提供 LINE Notify 類型的通知管道設定。
    - **[R-NC-25]** LINE Notify 管道設定必須包含「存取權杖」欄位，此為必填。
    - **[R-NC-26]** 「存取權杖」輸入框必須預設為密文顯示，並提供可切換為明文的選項。
    - **[R-NC-27]** 系統必須提供「發送測試」功能。

---

### `notifications-add-channel-sms.png`

**現況描述**
- 此為新增/編輯「SMS」類型通知管道的表單。
- 專屬欄位為「收件人手機號碼」。

**互動流程**
- **輸入**：使用者輸入目標手機號碼。輸入框中有提示文字 `例如: +886912345678`，引導使用者輸入包含國碼的完整號碼。
- **儲存與測試**：流程同 Email 管道。

**API 與資料流**
- **儲存**：
    - `POST` 或 `PATCH /settings/notification-channels`
    - **傳入**：`config` 物件包含 `phone_number`。
- **測試**：`POST /settings/notification-channels/:id/test`

**需求與規格定義**
- **使用者需求**
    - 我希望能透過手機簡訊 (SMS) 接收重要通知。
- **功能規格**
    - **[R-NC-28]** 系統必須提供 SMS 類型的通知管道設定。
    - **[R-NC-29]** SMS 管道設定必須包含「收件人手機號碼」欄位，此為必填。
    - **[R-NC-30]** 系統應提示使用者輸入包含國碼的正確手機號碼格式。
    - **[R-NC-31]** 系統必須提供「發送測試」功能。
        - [NEEDS CLARIFICATION: SMS 測試是否會產生實際費用？若會，應在 UI 上有明確提示。]

---

### `notifications-strategies-list.png`

**現況描述**
- 此頁面為「通知策略」的管理中心，以表格形式展示所有已建立的通知策略。
- 頁面頂部有一個工具列，包含「搜尋與篩選」、「欄位設定」和「新增策略」按鈕。
- 表格支援多選功能，選取項目後，工具列會顯示批次操作按鈕，包括「啟用」、「停用」和「刪除」。
- 表格主要欄位包括：啟用狀態、策略名稱、觸發條件、管道數量、嚴重性等級、影響等級、建立者、更新時間。
- 「觸發條件」、「嚴重性等級」、「影響等級」等欄位會以標籤 (Tag) 或藥丸 (Pill) 的形式呈現，方便閱讀。
- 每一列末端都有「編輯」、「複製」和「刪除」的獨立操作按鈕。

**互動流程**
- **新增策略**：使用者點擊「新增策略」按鈕，會開啟一個多步驟的模態視窗 (Wizard) 來建立新策略。
- **編輯策略**：使用者點擊「編輯」圖示，會開啟同一個模態視窗，並載入該策略的現有設定以供修改。
- **複製策略**：使用者點擊「複製」圖示，會開啟新增策略的模態視窗，並自動填入被複製策略的資訊，策略名稱預設為 `Copy of [原名稱]`。
- **刪除策略**：使用者點擊「刪除」圖示，會跳出一個確認對話框。確認後，該策略將被刪除。
- **啟用/停用**：使用者可以直接點擊「啟用」欄位下的開關 (Toggle)，即時切換該策略的啟用狀態。
- **批次操作**：使用者可透過勾選核取方塊來選取多個策略，並執行批次的「啟用」、「停用」或「刪除」操作。
- **搜尋與篩選**：使用者點擊「搜尋與篩選」按鈕，可根據關鍵字等條件篩選策略列表。
- **欄位設定**：使用者點擊「欄位設定」，可以自訂表格中要顯示或隱藏的欄位。

**API 與資料流**
- **載入頁面**：
    - `GET /settings/notification-strategies`：向後端請求策略列表。可傳入篩選參數。
    - **回傳**：回傳一個包含 `items` (策略陣列) 和 `total` (總數) 的物件。每個策略物件的結構遵循 `NotificationStrategy` 型別。
- **切換啟用狀態**：
    - `PATCH /settings/notification-strategies/:id`：傳送一個僅包含 `enabled` 欄位的物件來更新狀態。
- **儲存 (新增/編輯/複製)**：
    - **新增/複製**：`POST /settings/notification-strategies`，Body 中包含完整的 `NotificationStrategy` 物件。
    - **編輯**：`PATCH /settings/notification-strategies/:id`，Body 中包含被修改的 `NotificationStrategy` 物件欄位。
- **刪除**：
    - `DELETE /settings/notification-strategies/:id`：刪除指定 ID 的策略。
- **批次操作**：
    - `POST /settings/notification-strategies/batch-actions`：
    - **傳入**：`{ action: 'enable' | 'disable' | 'delete', ids: string[] }`。

**需求與規格定義**
- **使用者需求**
    - 作為系統管理員，我需要能夠定義一組規則 (策略)，來決定「在什麼情況下」要「透過哪些管道」發送通知。
    - 我希望能方便地管理這些策略，包括建立、修改、複製和刪除。
    - 我希望能快速啟用或停用某個策略，以應對臨時情況。
    - 當策略很多時，我需要搜尋功能來快速定位。
- **功能規格**
    - **[R-NS-01]** 系統必須提供一個頁面，以表格形式展示所有已設定的通知策略。
    - **[R-NS-02]** 表格必須能清晰地展示策略的關鍵資訊，包括：啟用狀態、名稱、觸發條件、關聯的管道數等。
    - **[R-NS-03]** 系統必須提供「新增策略」功能。
    - **[R-NS-04]** 每一筆策略記錄都必須提供「編輯」、「複製」和「刪除」操作。
        - **[R-NS-04-01]** 刪除操作前，必須有再次確認的提示。
        - **[R-NS-04-02]** 複製操作應預填所有資訊，並提示使用者修改名稱。
    - **[R-NS-05]** 系統必須支援對單一策略的「啟用/停用」操作。
    - **[R-NS-06]** 系統必須支援對策略的批次「啟用」、「停用」及「刪除」操作。
    - **[R-NS-07]** 系統必須提供搜尋與篩選功能。
    - **[R-NS-08]** 系統必須允許使用者自訂表格顯示的欄位。

---

### `notifications-strategy-step1.png`, `notifications-strategy-step2.png`, `notifications-strategy-step3.png`

**現況描述**
- 此為一個三步驟的精靈 (Wizard) 介面，用於新增或編輯通知策略。
- 介面頂部有步驟指示器，顯示目前所在的步驟：「基本資訊與範圍」、「通知管道」、「附加條件」。
- 介面底部有導覽按鈕：「上一步」、「下一步」和「完成」。

- **步驟 1: 基本資訊與範圍**
    - 欄位包含：策略名稱、涵蓋嚴重度、涵蓋影響範圍、資源群組。
    - 「涵蓋嚴重度」、「涵蓋影響範圍」、「資源群組」皆為多選下拉式選單。

- **步驟 2: 通知管道**
    - 欄位包含：接收團隊 (下拉選單)、通知管道 (可複選的列表)。
    - 系統會根據步驟 1 選擇的資源群組，自動建議一個「接收團隊」。

- **步驟 3: 附加條件**
    - 允許使用者定義更精細的觸發條件。
    - 使用者可以新增多個「標籤鍵 - 運算子 - 標籤值」的組合。
    - 所有附加條件之間以 `AND` 邏輯結合。

**互動流程**
- **導覽**：使用者點擊「下一步」和「上一步」按鈕在三個步驟之間切換。使用者也可以直接點擊頂部的步驟指示器來跳轉。
- **步驟 1**：
    1. 使用者輸入策略名稱。
    2. 使用者從下拉選單中勾選一或多個「嚴重度」、「影響範圍」和「資源群組」。
- **步驟 2**：
    1. 使用者從下拉選單選擇一個「接收團隊」。
    2. 使用者勾選一或多個要使用的「通知管道」。
- **步驟 3**：
    1. 使用者點擊「新增 AND 條件」來增加一列條件設定。
    2. 在每一列中，使用者從下拉選單選擇「標籤鍵」和「運算子 (`=`, `!=`, `~=`)」，並輸入或選擇「標籤值」。
    3. 使用者可以隨時移除任一條件列。
- **完成**：在最後一步，使用者點擊「完成」按鈕，系統會將所有步驟收集到的資訊組合起來，並儲存此策略。

**API 與資料流**
- **載入精靈**：
    - `GET /resource-groups`：在步驟 1 載入資源群組選項。
    - `GET /iam/teams`：在步驟 2 載入接收團隊選項。
    - `GET /settings/notification-channels`：在步驟 2 載入通知管道列表。
    - `GET /ui/options` (透過 `useOptions` context)：獲取步驟 1 的嚴重性/影響等級選項，以及步驟 3 的標籤鍵/值選項。
- **儲存**：
    - `POST` (新增) 或 `PATCH` (編輯) `/settings/notification-strategies`
    - **組合 `trigger_condition`**：前端會將步驟 1 選擇的「資源群組」和步驟 3 設定的「附加條件」組合成一個字串，用 `AND` 連接。例如：`resource.group IN ("Group A", "Group B") AND tag.service = "core-api"`。
    - **傳入**：Body 中包含 `NotificationStrategy` 物件，其中 `trigger_condition` 為上述組合的字串，並包含 `name`, `severity_levels`, `impact_levels`, `channel_ids` 等欄位。

**需求與規格定義**
- **使用者需求**
    - 我希望能有一個引導式的流程來幫助我設定複雜的通知策略，避免遺漏重要設定。
    - 我希望能根據事件的嚴重性、影響範圍和發生的資源群組來觸發通知。
    - 我希望能進一步根據標籤 (Tag) 來過濾事件，讓觸發條件更精準。
    - 我希望能將通知發送給特定的團隊和指定的管道。
- **功能規格**
    - **[R-NS-09]** 系統必須提供一個多步驟的精靈介面來引導使用者建立/編輯通知策略。
    - **[R-NS-10]** **步驟 1 (基本資訊與範圍)** 必須包含以下設定：
        - **[R-NS-10-01]** 策略名稱 (必填)。
        - **[R-NS-10-02]** 涵蓋嚴重度 (多選，必填)。
        - **[R-NS-10-03]** 涵蓋影響範圍 (多選，必填)。
        - **[R-NS-10-04]** 資源群組 (多選，必填)。
    - **[R-NS-11]** **步驟 2 (通知管道)** 必須包含以下設定：
        - **[R-NS-11-01]** 接收團隊 (單選)。
        - **[R-NS-11-02]** 通知管道 (多選，必填)。
        - **[R-NS-11-03]** 系統應根據所選資源群組的負責團隊，提供智慧推薦。
    - **[R-NS-12]** **步驟 3 (附加條件)** 必須允許使用者新增一或多個以 `AND` 邏輯組合的標籤條件。
        - **[R-NS-12-01]** 每個條件由「標籤鍵」、「運算子」和「標籤值」組成。
    - **[R-NS-13]** 系統必須在使用者完成精靈後，將所有輸入轉換為一個 `NotificationStrategy` 物件發送至後端。

---

### `notifications-send-history.png`

**現況描述**
- 此頁面為「發送歷史」，以表格形式展示所有已發送或嘗試發送的通知記錄。
- 頁面頂部有一個工具列，包含「搜尋與篩選」、「欄位設定」和「匯出」按鈕。
- 表格主要欄位包括：時間戳、策略、管道、收件人、狀態、內容。
- 「管道」欄位會根據管道類型 (Email, Slack 等) 顯示對應的圖示和名稱。
- 「狀態」欄位會以不同顏色 (成功為綠色，失敗為紅色) 標示 `SENT` 或 `FAILED`。
- 頁面底部有分頁控制器，用於瀏覽大量歷史記錄。

**互動流程**
- **查看詳情**：使用者點擊任一筆歷史記錄，會從右側滑出一個抽屜 (Drawer) 面板，顯示該筆記錄的完整 JSON 格式內容。
- **搜尋與篩選**：使用者點擊「搜尋與篩選」按鈕，會開啟一個模態視窗，可根據關鍵字、狀態、管道類型、日期範圍等條件篩選歷史記錄。
- **匯出**：使用者點擊「匯出」按鈕，會將目前篩選結果下的所有歷史記錄匯出為 CSV 檔案。
- **欄位設定**：使用者點擊「欄位設定」，可以自訂表格中要顯示或隱藏的欄位。
- **分頁**：使用者可以透過底部的分頁元件切換頁面或更改每頁顯示的項目數量。

**API 與資料流**
- **載入頁面**：
    - `GET /settings/notification-history`：向後端請求歷史記錄列表。
    - **傳入**：可傳入分頁參數 (`page`, `page_size`) 和篩選參數 (`filters`)。
    - **回傳**：回傳一個包含 `items` (歷史記錄陣列) 和 `total` (總數) 的物件。每個記錄物件的結構遵循 `NotificationHistoryRecord` 型別。
- **匯出**：
    - 此為前端功能，`exportToCsv` 服務會將當前載入的 `history` 陣列資料轉換為 CSV 格式並觸發下載。
    - [NEEDS CLARIFICATION: 目前的實作是僅匯出當前頁面，還是會匯出所有符合篩選條件的資料？規格上應定義清楚。]

**需求與規格定義**
- **使用者需求**
    - 作為系統管理員，我需要能夠查看所有通知的發送歷史，以便追蹤與稽核。
    - 我希望能快速篩選出特定時間範圍內、特定狀態 (如失敗) 或特定管道的通知。
    - 我希望能查看每一筆通知的詳細內容。
    - 我希望能將查詢結果匯出存檔。
- **功能規格**
    - **[R-NH-01]** 系統必須提供一個頁面，以表格形式展示所有通知的發送歷史。
    - **[R-NH-02]** 表格必須顯示關鍵資訊，包括：發送時間、關聯的策略、使用的管道、收件人、發送狀態及內容摘要。
    - **[R-NH-03]** 系統必須支援分頁瀏覽歷史記錄。
    - **[R-NH-04]** 使用者點擊任一筆記錄，系統必須以抽屜 (Drawer) 或其他形式展示該記錄的完整詳情。
    - **[R-NH-05]** 系統必須提供篩選功能，至少應支援：
        - **[R-NH-05-01]** 依狀態 (成功/失敗) 篩選。
        - **[R-NH-05-02]** 依管道類型篩選。
        - **[R-NH-05-03]** 依日期範圍篩選。
        - **[R-NH-05-04]** 依關鍵字篩選。
    - **[R-NH-06]** 系統必須提供將當前檢視的歷史記錄列表匯出為 CSV 檔案的功能。
    - **[R-NH-07]** 系統必須允許使用者自訂表格顯示的欄位。

---

### `notifications-history-detail.png`

**現況描述**
- 此畫面為一個從右側滑出的抽屜 (Drawer) 面板，用於顯示單筆通知發送歷史的完整詳情。
- 抽屜標題會顯示該筆記錄的 ID。
- 抽屜的主要內容區域以 `JSON` 格式完整呈現 `NotificationHistoryRecord` 物件的所有欄位與值。
- 如果該筆記錄的發送狀態為 `failed`，抽屜的標題列右側會出現一個「重新發送」按鈕。

**互動流程**
- **開啟**：在發送歷史列表頁點擊任一筆記錄即可開啟此抽屜。
- **關閉**：點擊抽屜右上角的關閉圖示，或點擊抽屜外的遮罩區域，即可關閉。
- **重新發送**：
    1. 當一筆失敗 (`failed`) 的記錄被點開時，「重新發送」按鈕會呈現可點擊狀態。
    2. 使用者點擊此按鈕，系統會向後端發起一個重新發送的請求。
    3. 按鈕會顯示為「重送中...」的載入狀態。
    4. 請求完成後，系統會顯示成功或失敗的提示訊息，並自動關閉抽屜、刷新背景的歷史記錄列表以顯示最新狀態。

**API 與資料流**
- **顯示資料**：
    - 資料來源於歷史列表頁已載入的 `NotificationHistoryRecord` 物件，無需額外的 API 請求。
- **重新發送**：
    - `POST /settings/notification-history/:id/resend`：向後端請求重新發送指定 ID 的通知。
    - **回傳**：成功或失敗的狀態。前端收到成功回應後會刷新列表。

**需求與規格定義**
- **使用者需求**
    - 我希望能看到每一筆通知發送的完整原始資料，以便於排查問題。
    - 當一個通知發送失敗時，我希望能有一個簡單的方式手動觸發重送。
- **功能規格**
    - **[R-NH-08]** 系統必須在使用者點擊歷史記錄時，以抽屜 (Drawer) 形式顯示該記錄的完整詳情。
    - **[R-NH-09]** 詳情內容必須以易於閱讀的 JSON 格式呈現。
    - **[R-NH-10]** 對於發送失敗 (`failed`) 的記錄，系統必須在詳情畫面中提供「重新發送」功能。
    - **[R-NH-11]** 「重新發送」功能僅對失敗的記錄可見且可用。
    - **[R-NH-12]** 執行重新發送時，UI 必須有明確的載入中狀態提示。
    - **[R-NH-13]** 重新發送成功後，系統應自動刷新歷史記錄列表。