# 功能規格書（Feature Specification）: Notification Management

**建立日期**: 2025-10-08
**狀態**: Draft
**輸入**: 使用者描述: "提供一個完整的通知管理系統，用於設定通知管道、定義分派策略，並追蹤所有通知的發送歷史"

## 使用者情境與測試 *(mandatory)*

### 使用者故事 1 - 作為平台管理員，設定與管理多種通知管道 (優先級: P1)

作為平台管理員，我需要能夠設定和管理多種通知管道，例如 Slack Webhook、PagerDuty 和電子郵件伺服器。我必須能在儲存設定後對其進行測試，以確保平台能夠透過這些管道成功發送訊息。

**為什麼此優先級**: 這是整個通知系統的基礎。如果管道無法正確設定和驗證，後續所有的通知策略都將無法生效。

**獨立測試**: 可以通過新增一個 Slack 通知管道，填寫其 Webhook URL，然後點擊「測試管道」並在對應的 Slack 頻道中收到測試訊息來獨立測試。

**驗收情境**:

1. **Given** 我需要新增一個 Slack 通知管道, **When** 我在「管道」頁籤點擊「新增管道」，選擇類型為 "Slack"，並填寫名稱和 Webhook URL, **Then** 新的 Slack 管道應出現在列表中。
2. **Given** 我不確定一個新設定的 PagerDuty 管道是否配置正確, **When** 我點擊該管道的「測試管道」按鈕, **Then** 系統應發送一條測試通知，並在短時間後顯示最終測試結果（成功/失敗）。
3. **Given** 我需要更新一個 SMTP 管道的設定, **When** 我點擊該管道的「編輯」按鈕，修改設定並儲存, **Then** 系統應更新管道設定。
4. **Given** 我嘗試刪除一個正被策略使用的管道, **When** 我點擊刪除, **Then** 系統應提示「此管道正被 N 個策略使用，無法刪除」並阻止操作。

---

### 使用者故事 2 - 作為 SRE，定義精細的通知策略以路由告警 (優先級: P1)

作為一名 SRE，我需要能夠定義通知策略，指定當發生特定條件（如嚴重性、標籤）的事件時，應透過哪些管道發送通知。我希望能啟用/停用策略，並能快速複製現有策略以進行微調。

**為什麼此優先級**: 這是通知系統的核心邏輯，確保了正確的告警能夠在正確的時間，透過正確的管道，發送給正確的人。

**獨立測試**: 可以通過建立一個策略（條件：嚴重度=Critical，管道：PagerDuty），然後手動觸發一個 Critical 級別的告警，並驗證 PagerDuty 收到了通知來獨立測試。

**驗收情境**:

1. **Given** 我想為所有「嚴重」等級的資料庫相關告警設定緊急通知, **When** 我在「策略」頁籤點擊「新增策略」，設定觸發條件並選擇 PagerDuty 管道, **Then** 新的策略應被建立並啟用。
2. **Given** 我發現一個現有的通知策略過於嘈雜, **When** 我在策略列表中點擊其「啟用」開關, **Then** 該策略的狀態應變為「停用」，且不再觸發通知。
3. **Given** 我需要建立一個類似的策略但發送到不同管道, **When** 我點擊一個現有策略的「複製」按鈕, **Then** 系統應打開一個預填好資訊的編輯表單供我修改。

---

### 使用者故事 3 - 作為值班工程師，追蹤通知歷史並在失敗時重試 (優先級: P2)

作為值班工程師，我需要能夠查看所有已發送通知的歷史記錄，以確認關鍵告警是否已成功送達。當發現有通知發送失敗時，我需要能查看失敗原因，並在問題修復後手動重新發送該通知。

**為什麼此優先級**: 提供了通知系統的可靠性和可追溯性保障。能夠確認送達狀態和手動重試是確保關鍵資訊不丟失的重要兜底機制。

**獨立測試**: 可以通過觸發一個使用無效配置管道的策略，然後在「歷史」頁籤中找到一條狀態為「失敗」的記錄，點擊後查看錯誤詳情，並在修正管道後成功「重新發送」來獨立測試。

**驗收情境**:

1. **Given** 我想確認昨晚的嚴重告警是否已成功發送, **When** 我在「歷史」頁籤篩選管道類型為 "PagerDuty" 和時間為「昨天」, **Then** 我應該能看到對應的通知紀錄，其狀態顯示為「已送達」。
2. **Given** 我發現一條發送到 Slack 的通知狀態為「失敗」, **When** 我點擊該筆紀錄, **Then** 系統應在詳情面板中顯示結構化的錯誤訊息。
3. **Given** 我已修復導致通知失敗的管道設定, **When** 我在該筆失敗紀錄旁點擊「重新發送」按鈕, **Then** 系統應嘗試重新發送該通知，並在成功後更新其狀態為「已送達」。
4. **Given** 我需要匯出通知記錄, **When** 我設定好篩選條件後點擊「匯出」, **Then** 系統應下載一份包含當前列表內容的 CSV 檔案。

---

### 邊界案例

- **動態表單**: 新增/編輯管道的表單應根據後端提供的 JSON Schema 動態產生，以支援未來新增的管道類型。
- **自動刷新**: 管道和歷史頁面應定期自動刷新（例如每 30-60 秒），以獲取最新狀態。
- **空狀態**: 當任何頁籤（管道、策略、歷史）沒有數據時，應顯示清晰的空狀態提示和操作引導。

## 功能需求 *(mandatory)*

### 功能需求

- **FR-001**: 系統必須（MUST）提供對通知管道（Channels）的完整 CRUD 管理，並為每個管道提供「測試」功能。
- **FR-002**: 系統必須（MUST）提供對通知策略（Strategies）的完整 CRUD 管理，並支援啟用/停用和複製操作。
- **FR-003**: 策略必須（MUST）允許使用者基於事件的屬性（如嚴重性、標籤）來定義觸發條件，並關聯一個或多個通知管道。
- **FR-004**: 系統必須（MUST）在可分頁、可排序的表格中展示所有通知的發送歷史，記錄包括時間戳、目標管道、狀態（成功/失敗）和內容摘要。
- **FR-005**: 系統必須（MUST）為發送失敗的通知提供查看失敗原因和手動「重新發送」的功能。
- **FR-006**: 系統必須（MUST）在刪除一個正在被策略使用的管道時，發出警告並阻止刪除。
- **FR-007**: 系統必須（MUST）支援將歷史記錄匯出為 CSV 檔案。
- **FR-008**: 所有 CUD 操作、測試和重發操作都必須（MUST）有權限控制和審計日誌。

### 關鍵資料實體 *(如果功能涉及資料則包含)*

- **NotificationChannel**: 代表一個通知管道。主要屬性: id, name, type (`Slack`|`Email`|`PagerDuty`), config_data, enabled。
- **NotificationStrategy**: 代表一條通知路由策略。主要屬性: id, name, trigger_conditions, channel_ids, enabled。
- **NotificationHistory**: 代表一條已發送的通知記錄。主要屬性: id, strategy_id, channel_id, timestamp, status, error_message。

## 權限控制 *(RBAC)*

### 權限模型設計

權限圍繞管道、策略和歷史記錄的讀取與修改進行設計。

#### 所需權限定義

- **`notification:channels:read`**: 允許查看通知管道。
- **`notification:channels:update`**: 允許修改通知管道（建立、編輯、測試）。
- **`notification:channels:delete`**: 允許刪除通知管道。
- **`notification:strategies:read`**: 允許查看通知策略。
- **`notification:strategies:update`**: 允許修改通知策略（建立、編輯、啟用/停用）。
- **`notification:strategies:delete`**: 允許刪除通知策略。
- **`notification:history:read`**: 允許查看通知歷史。
- **`notification:history:resend`**: 允許重新發送失敗的通知。

#### 角色指派建議

- **Admin 角色**: 需要所有 `notification:*` 權限。
- **Editor 角色** (SRE): `notification:channels:read/update`, `notification:strategies:read/update/delete`, `notification:history:read/resend`。
- **Viewer 角色**: `notification:channels:read`, `notification:strategies:read`, `notification:history:read`。

#### 權限檢查點

- **頁籤存取**: 存取各頁籤（管道、策略、歷史）需要對應的 `read` 權限。
- **操作按鈕**: 所有按鈕（新增、編輯、刪除、測試、重發等）都需綁定其對應的權限。

---

## 觀測性與治理檢查（Observability & Governance Checklist）

{{specs/common.md}}

---

## 成功標準 *(mandatory)*

### 可衡量成果

- **SC-001**: 管理員可以在 3 分鐘內完成一個新通知管道的設定並成功收到測試訊息。
- **SC-002**: 從事件觸發到透過管道發出通知，端到端的平均延遲應低於 5 秒。
- **SC-003**: 系統的通知發送成功率應達到 99.9%。
- **SC-004**: 系統應能支援管理至少 1000 個通知策略，並每日處理 10 萬次以上的通知。

---

## 模糊與待確認事項（Clarifications）

- **結構化條件產生器**: [FUTURE] 編輯策略時應提供一個結構化的條件產生器，以取代目前的純字串輸入，提升易用性。
- **自動重試機制**: [NEEDS CLARIFICATION: 除了手動重試，系統是否應支援對失敗通知的自動重試機制？重試策略是什麼？]
- **管道類型擴展**: [FUTURE] 未來計劃支援哪些新的管道類型（如 Microsoft Teams, SMS）？動態表單的 Schema 是否能良好支持？