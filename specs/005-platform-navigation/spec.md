# 功能規格書（Feature Specification）: Platform Navigation

**建立日期**: 2025-10-08
**狀態**: Draft
**輸入**: 使用者描述: "提供一個統一且智能的平台導覽系統，支援權限過濾、個人化偏好及集中化管理"

## 使用者情境與測試 *(mandatory)*

### 使用者故事 1 - 作為平台管理員，集中管理與即時同步導覽結構 (優先級: P1)

作為平台管理員，我需要一個視覺化的編輯器來集中管理全域導覽樹，包括新增/移除群組和項目、調整順序、綁定權限。變更儲存後，必須能即時同步給所有線上使用者，確保導覽的一致性。

**為什麼此優先級**: 這是導覽系統的治理核心，解決了以往需要修改程式碼才能調整導覽的痛點，極大提升了平台的靈活性和管理效率。

**獨立測試**: 可以通過在管理介面新增一個導覽群組，儲存後，在另一個瀏覽器的普通使用者帳號下立即看到該新群組的出現來獨立測試。

**驗收情境**:

1. **Given** 我是管理員, **When** 我新增一個名為「Governance」的導覽群組, **Then** 該群組必須在編輯器中即時顯示。
2. **Given** 導覽樹中有多個群組, **When** 我拖曳調整群組順序並儲存, **Then** 所有使用者的導覽列必須在 500ms 內同步新順序。
3. **Given** 我選擇一個導覽項, **When** 我點擊「移除」並確認, **Then** 系統必須軟刪除該項目並從所有使用者導覽列移除。
4. **Given** 我有一個導覽結構 JSON 檔案, **When** 我上傳並匯入, **Then** 系統必須驗證結構並批次建立所有群組與項目。

---

### 使用者故事 2 - 作為平台使用者，獲得基於權限過濾的個人化導覽體驗 (優先級: P2)

作為一名平台使用者，我希望導覽列只顯示我被授權存取的功能，避免無關選項的干擾。同時，我希望能將常用功能加入我的最愛，並摺疊不常用的群組，且這些偏好設定能在我的不同裝置間同步。

**為什麼此優先級**: 提升使用者體驗，降低使用者尋找功能的認知負擔，使導覽更具個人化和效率。

**獨立測試**: 可以用一個僅有 `dashboards:read` 權限的帳號登入，驗證其導覽列只顯示儀表板相關項目。然後將某個儀表板加入常用，登出後用手機登入，驗證常用設定依然存在。

**驗收情境**:

1. **Given** 我的角色僅具備 `dashboards:read` 權限, **When** 我登入平台, **Then** 導覽列必須僅顯示我有權限的項目。
2. **Given** 我目前無法看到「Automation」導覽項, **When** 管理員授予我 `automation:*` 權限, **Then** 導覽列必須在 2 秒內同步更新，顯示「Automation」項目。
3. **Given** 我經常使用「Log Exploration」, **When** 我點擊「⭐ 加入常用」, **Then** 該項目必須出現在「常用功能」群組頂部。
4. **Given** 我不常使用「Platform Settings」群組, **When** 我摺疊該群組, **Then** 下次登入時它必須保持摺疊狀態，並在跨裝置同步。
5. **Given** 我想恢復預設設定, **When** 我點擊「重設導覽偏好」, **Then** 導覽列必須回到預設展開狀態。

---

### 使用者故事 3 - 作為稽核人員，追蹤所有導覽結構的變更歷史 (優先級: P3)

作為安全稽核人員，我需要能夠追蹤所有對導覽結構的修改歷史，包括誰、在何時、做了什麼變更。在發生誤操作時，應能根據稽核日誌中的資訊進行回滾。

**為什麼此優先級**: 滿足合規性和治理要求，確保導覽系統的變更可追溯、可審計、可恢復。

**獨立測試**: 可以由管理員刪除一個導覽群組，然後稽核人員在稽核日誌中篩選 `category: navigation`，應能找到該筆刪除記錄，並檢視其變更前後的狀態。

**驗收情境**:

1. **Given** 我是稽核人員, **When** 我篩選 `category: navigation` 的稽核日誌, **Then** 我必須能看到所有導覽變更操作的完整記錄。
2. **Given** 管理員誤刪除一個群組, **When** 我在稽核日誌中找到該操作並點擊「回滾」, **Then** 系統必須還原該群組與其所有子項目。
3. **Given** 某導覽項的權限從 `viewer` 修改為 `admin`, **When** 我檢視稽核日誌, **Then** 我必須能看到 `before_state` 與 `after_state` 的權限差異。

---

### 邊界案例

- **模組註冊**: 當新模組透過 API 註冊導覽項時，系統應如何處理？當模組下線時，如何自動移除？
- **效能**: 當平台有大量導覽項目（如 150+）和大量同時在線使用者（如 200+）時，同步和渲染效能如何保證？
- **網路延遲**: 當即時同步的 WebSocket/SSE 連線中斷時，前端應如何處理重連和資料一致性？

## 功能需求 *(mandatory)*

### 功能需求

- **FR-001**: 系統必須（MUST）提供一個視覺化管理介面，讓管理員能以拖曳方式管理導覽樹（群組和項目）的結構和順序。
- **FR-002**: 每個導覽項目必須（MUST）可以綁定一個或多個權限字串，用於後續的權限過濾。
- **FR-003**: 系統必須（MUST）根據使用者當前的有效權限，動態計算並僅顯示其可見的導覽項目。
- **FR-004**: 使用者必須（MUST）能夠將任何可見的導覽項目標記為「常用」，並能摺疊/展開導覽群組。
- **FR-005**: 使用者的個人化偏好（常用項、摺疊狀態）必須（MUST）儲存於後端，並在使用者跨裝置登入時保持同步。
- **FR-006**: 任何對導覽結構的修改（新增、刪除、排序、權限變更）必須（MUST）能即時（<500ms）推送給所有在線使用者。
- **FR-007**: 所有導覽項目的標籤必須（MUST）使用 i18n Key 以支援多語系。
- **FR-008**: 所有對導覽結構的修改必須（MUST）產生詳細的稽核日誌，記錄操作人、時間、變更前後的狀態。
- **FR-009**: 系統應該（SHOULD）支援從稽核日誌中一鍵回滾某次導覽變更。
- **FR-010**: 導覽層級必須（MUST）限制在最多 3 層（群組 -> 項目 -> 子項目）。

### 關鍵資料實體 *(如果功能涉及資料則包含)*

- **NavigationNode**: 代表導覽樹中的一個節點（可以是群組或項目）。主要屬性: id, parent_id, node_type, i18n_key, icon, route_path, required_permissions, order。
- **UserNavigationPreference**: 儲存使用者的個人化導覽設定。主要屬性: user_id, favorite_nodes (`id[]`), collapsed_groups (`id[]`)。

## 權限控制 *(RBAC)*

### 權限模型設計

導覽系統的權限分為兩部分：1. 管理導覽結構本身的權限。 2. 決定導覽項是否對使用者可見的業務權限。

#### 所需權限定義

- **`platform:navigation:read`**: 允許讀取導覽結構（所有使用者預設擁有）。
- **`platform:navigation:update`**: 允許修改導覽結構（新增、刪除、排序、綁定權限）。
- **`platform:navigation:audit:read`**: 允許讀取導覽變更的稽核日誌。
- **`platform:navigation:audit:rollback`**: 允許從稽核日誌回滾變更。

#### 角色指派建議

- **Admin 角色**: 需要 `platform:navigation:update`, `platform:navigation:audit:read`, `platform:navigation:audit:rollback`。
- **Editor 角色**: 無導覽管理權限。
- **Viewer 角色**: 無導覽管理權限。
- **Auditor 角色**: `platform:navigation:audit:read`。

#### 權限檢查點

- **進入導覽管理頁面**: 檢查 `platform:navigation:update` 權限。
- **請求導覽樹 API**: 後端根據請求者的業務權限（如 `dashboards:read`, `automation:*` 等）過濾節點後返回。
- **進入稽核日誌頁面**: 檢查 `platform:navigation:audit:read` 權限。
- **執行回滾操作**: 檢查 `platform:navigation:audit:rollback` 權限。

---

## 觀測性與治理檢查（Observability & Governance Checklist）

{{specs/common.md}}

---

## 成功標準 *(mandatory)*

### 可衡量成果

- **SC-001**: 管理員調整導覽結構的變更，能在 500 毫秒內同步到 99% 的在線使用者。
- **SC-002**: 對於擁有 100+ 個導覽項目的複雜權限使用者，導覽樹在客戶端的渲染時間應小於 200 毫秒。
- **SC-003**: 實施個人化導覽後，使用者找到目標功能的平均點擊次數減少 30%。
- **SC-004**: 95% 的使用者能在首次使用中成功找到並使用「加入常用」功能。

---

## 模糊與待確認事項（Clarifications）

- **WebSocket 技術選型**: 建議使用 Server-Sent Events (SSE)，因其單向通信模型更適合此場景，客戶端實作更簡單。
- **快取策略**: 使用者的權限檢查結果應在後端快取（建議 TTL 5 分鐘），但當使用者權限變更時，必須主動清除相關快取。
- **外部連結**: 支援導覽項目指向外部連結，但需在後端設定白名單，以防止開放重定向（Open Redirect）漏洞。