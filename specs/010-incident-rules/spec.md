# 功能規格書（Feature Specification）: Incident Rules

**建立日期**: 2025-10-08
**狀態**: Draft
**輸入**: 使用者描述: "提供一個統一的事件規則管理平台，用於定義告警規則和靜音規則，以實現有效的系統監控與告警降噪"

## 使用者情境與測試 *(mandatory)*

### 使用者故事 1 - 作為 SRE，定義與管理告警規則以監控系統 (優先級: P1)

作為一名 SRE，我需要一個介面來建立、編輯、啟用/停用和複製告警規則，以設定系統監控的觸發條件、嚴重性和通知方式。我還希望能對規則進行 AI 分析，以評估其潛在影響並獲得優化建議。

**為什麼此優先級**: 這是事件監控的基礎，讓 SRE 能夠將業務和系統需求轉化為具體的、可自動執行的監控策略。

**獨立測試**: 可以通過建立一條新的告警規則（例如：當 CPU 使用率超過 80% 持續 5 分鐘時觸發），儲存並啟用它，然後驗證其狀態是否變為「啟用中」來獨立測試。

**驗收情境**:

1. **Given** 我需要為新服務建立監控, **When** 我點擊「新增告警規則」，填寫觸發條件、嚴重性和通知設定, **Then** 新規則應被成功建立並出現在列表中。
2. **Given** 一條現有規則過於頻繁地觸發誤報, **When** 我編輯該規則，調整其觸發閾值, **Then** 該規則應被更新並立即生效。
3. **Given** 我需要暫時停用一組季節性告警, **When** 我勾選這些規則並點擊「停用」, **Then** 所有選中規則的狀態都應變為「停用」。
4. **Given** 我想建立一條類似的規則, **When** 我點擊某條規則旁的「複製」按鈕, **Then** 系統應打開一個預填好資訊的編輯表單，規則名稱加上 "Copy of" 前綴。
5. **Given** 我想評估某條規則的效能, **When** 我選擇該規則並點擊「AI 分析」, **Then** 系統應在彈窗中展示歷史觸發頻率、預估誤報率和調整建議。

---

### 使用者故事 2 - 作為平台管理員，建立靜音規則以在維護期間抑制告警 (優先級: P1)

作為平台管理員，在進行計劃性維護（如資料庫升級）或處理已知問題時，我需要能夠建立靜音規則，以暫時抑制相關的告警，避免告警風暴，減少對團隊的干擾。

**為什麼此優先級**: 解決告警疲勞問題，確保團隊的警覺性集中在未知和真正的問題上，是維持高效維運的關鍵。

**獨立測試**: 可以通過建立一條匹配特定服務的靜音規則，設定其生效時間為接下來1小時。然後觸發一個符合條件的告警，驗證該告警是否被成功靜音（未發出通知）。

**驗收情境**:

1. **Given** 我即將進行資料庫升級, **When** 我建立一條匹配資料庫資源的靜音規則，並設定生效時間為接下來 2 小時, **Then** 新規則應被儲存，狀態為「啟用中」。
2. **Given** 一個臨時靜音規則即將到期但問題尚未解決, **When** 我點擊「延長」並選擇 +1 小時, **Then** 該規則的結束時間應被更新。
3. **Given** 我需要為每週的例行備份設定靜音, **When** 我建立靜音規則時選擇「週期性」並設定 CRON 表達式, **Then** 系統應儲存該規則，並按排程自動生效與失效。
4. **Given** 我需要清理過期的靜音規則, **When** 我篩選出「已過期」的規則並批次刪除, **Then** 所有選中的規則都應被移除。

---

### 使用者故事 3 - 作為 SRE，預覽和審查規則之間的相互影響 (優先級: P2)

在管理大量規則時，我需要能夠理解它們之間的關係。例如，在建立靜音規則時，我希望能預覽它將會匹配到哪些告警規則。反之，在查看告警規則時，我也想知道它當前是否被任何靜音規則所抑制。

**為什麼此優先級**: 提升規則管理的透明度和可預測性，避免因錯誤的匹配條件導致靜音了非預期的告警，或未能靜音預期的告警。

**獨立測試**: 可以通過在靜音規則的編輯表單中輸入匹配條件，點擊「預覽匹配」，系統能彈出一個列表顯示預計會被靜音的告警規則來獨立測試。

**驗收情境**:

1. **Given** 我正在建立一條靜音規則, **When** 我輸入匹配條件並點擊「預覽匹配」, **Then** 系統應即時顯示符合條件的告警規則清單。
2. **Given** 我正在查看一條告警規則的詳情, **When** 該規則正在被一條有效的靜音規則所抑制, **Then** 詳情面板中應顯示「關聯靜音規則」列表，並列出該靜音規則的資訊。

---

### 邊界案例

- **延長週期性靜音**: 當使用者嘗試「延長」一個週期性的靜音規則時，系統應允許臨時延長本次執行的結束時間，但不改變原 CRON 排程，並在 UI 中清楚標示此次延長為臨時性質。
- **無效的 CRON 表達式**: 當使用者在建立週期性靜音時輸入了無效的 CRON 表達式，系統應在輸入過程中即時檢查並顯示紅色錯誤提示，同時提供格式說明和修正建議。
- **刪除規則**: 當使用者嘗試刪除任何規則時，系統必須彈出二次確認對話框，除了顯示規則基本資訊，還需展示該規則的歷史影響統計（如觸發次數、靜音告警數量），以幫助使用者評估刪除後的影響。

## 功能需求 *(mandatory)*

### 功能需求

- **FR-001**: 系統必須（MUST）提供對告警規則和靜音規則的完整 CRUD（建立、讀取、更新、刪除）管理介面。
- **FR-002**: 系統必須（MUST）在可分頁、可排序的表格中分別展示告警規則和靜音規則。
- **FR-003**: 系統必須（MUST）支援對告警規則的啟用/停用和複製操作。
- **FR-004**: 系統必須（MUST）支援對單次生效的靜音規則進行時間延長。
- **FR-005**: 系統必須（MUST）支援基於 CRON 表達式的週期性靜音規則。
- **FR-006**: 系統應該（SHOULD）提供 AI 分析功能，結合統計指標和機器學習演算法，以評估和優化告警規則。
- **FR-007**: 系統必須（MUST）提供預覽功能，讓使用者在建立靜音規則時能看到其將匹配的告警規則。
- **FR-008**: 告警規則的詳情必須（MUST）能展示正在對其生效的靜音規則列表。
- **FR-009**: 靜音規則必須（MUST）支援混合匹配邏輯，結合精確匹配和通配符進行標籤匹配。
- **FR-010**: 所有改變狀態的操作必須（MUST）有權限控制和審計日誌。

### 關鍵資料實體 *(如果功能涉及資料則包含)*

- **AlertRule**: 代表一條告警規則。主要屬性: id, name, enabled, severity, conditions, notification_config。
- **SilenceRule**: 代表一條靜音規則。主要屬性: id, name, enabled, matchers, schedule_type (`once`|`recurring`), start_time, end_time, cron_expression, status (`active`|`expired`|`pending`)。

## 權限控制 *(RBAC)*

### 權限模型設計

權限圍繞告警規則和靜音規則的讀取與修改進行分離設計。

#### 所需權限定義

- **`incident-rules:alert:read`**: 允許檢視告警規則。
- **`incident-rules:alert:update`**: 允許修改告警規則（建立、編輯、啟用/停用、複製）。
- **`incident-rules:alert:delete`**: 允許刪除告警規則。
- **`incident-rules:alert:analyze`**: 允許對告警規則使用 AI 分析功能。
- **`incident-rules:silence:read`**: 允許檢視靜音規則。
- **`incident-rules:silence:update`**: 允許修改靜音規則（建立、編輯、延長）。
- **`incident-rules:silence:delete`**: 允許刪除靜音規則。

#### 角色指派建議

- **Admin 角色**: 需要所有 `incident-rules:*` 權限。
- **Editor 角色** (SRE): `incident-rules:alert:read/update/delete/analyze`, `incident-rules:silence:read/update/delete`。
- **Viewer 角色**: `incident-rules:alert:read`, `incident-rules:silence:read`。

#### 權限檢查點

- **頁籤存取**: 存取「告警規則」頁籤需 `incident-rules:alert:read`，存取「靜音規則」頁籤需 `incident-rules:silence:read`。
- **操作按鈕**: 所有按鈕（新增、編輯、刪除、複製、延長、AI分析等）都需綁定其對應的權限。

---

## 觀測性與治理檢查（Observability & Governance Checklist）

{{specs/common.md}}

---

## 成功標準 *(mandatory)*

### 可衡量成果

- **SC-001**: 使用者可以在 2 分鐘內建立一條新的告警規則並使其生效。
- **SC-002**: 規則引擎處理事件的平均延遲應低於 100 毫秒。
- **SC-003**: 引入靜音規則後，計劃性維護期間的告警噪音減少 99%。
- **SC-004**: AI 分析能在 **[參數化]** AI 分析超時（15秒, 30秒, 60秒）內為一條複雜規則提供優化建議。

---

## 模糊與待確認事項（Clarifications）

### Session 2025-10-10

- **Q**: AI 分析的具體指標（如歷史觸發頻率、誤報率）及其背後的演算法是什麼？ → **A**: 混合分析：結合統計指標和機器學習，提供全面的規則效能分析
- **Q**: 靜音規則與告警規則標籤的匹配邏輯是精確匹配、正則匹配還是其他？ → **A**: 混合匹配：結合精確匹配和通配符，支援簡單的萬用字元
- **Q**: 當使用者嘗試「延長」一個週期性的靜音規則時，系統應如何處理？ → **A**: 臨時覆蓋：允許臨時延長本次執行的結束時間，但不改變原排程
- **Q**: 當使用者在建立週期性靜音時輸入了無效的 CRON 表達式，系統應如何處理？ → **A**: 即時驗證：在輸入過程中即時檢查並顯示紅色錯誤提示
- **Q**: 當使用者嘗試刪除任何規則時，系統應如何設計二次確認對話框？ → **A**: 影響評估：除了規則資訊，還顯示此規則的歷史影響統計（如靜音了多少告警）
- **規則版本控制**: [FUTURE] 是否需要支援規則的版本歷史追蹤與一鍵回滾功能？