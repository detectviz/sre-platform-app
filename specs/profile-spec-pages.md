# 個人檔案功能規格

本文檔旨在根據現有 UI 截圖和程式碼，逆向工程出個人檔案 (Profile) 相關頁面的功能規格。其中包含對使用者介面、互動流程、API 資料流的分析，並依此定義出明確的使用者需求與功能規格。

---

### `profile-personal-info.png`

**現況描述**
- 此頁面為「個人資訊」分頁，以唯讀形式展示當前登入使用者的基本資料。
- 顯示的欄位包含：名稱、電子郵件、角色、團隊、狀態。
- 頁面底部提供一個外部連結，引導使用者至身分驗證提供商（IdP）的管理介面（例如 Keycloak）進行更深入的管理。
- 頁面頂部有三個資訊卡，顯示「最近 7 日登入次數」、「上次密碼變更」和「MFA 狀態」，但這些資訊似乎來自父組件或佈局，而非此頁面本身邏輯。

**互動流程**
- **資料載入**：
  - 進入頁面時，系統會自動發出請求以獲取使用者資訊和驗證設定。
  - 載入期間應顯示一個載入中指示器。
  - 若資料獲取失敗，應顯示錯誤訊息。
- **查看資訊**：
  - 使用者只能查看頁面上顯示的所有個人資料，無法進行編輯。
- **外部管理**：
  - 使用者可以點擊「在 Keycloak 中管理」連結。
  - 點擊後，系統會在新的瀏覽器分頁中開啟 `idp_admin_url` 對應的網址。

**API 與資料流**
1.  **獲取使用者資訊**
    - **API**: `GET /api/v1/me`
    - **傳出參數**: 無
    - **傳入資料 (Response)**:
      ```json
      {
        "id": "string",
        "name": "string",
        "email": "string",
        "role": "UserRole", // 'admin' | 'sre' | 'developer' | 'viewer'
        "team": "string",
        "status": "UserStatus" // 'active' | 'invited' | 'inactive'
      }
      ```
    - **資料流**: 前端發送請求，後端回傳當前登入使用者的 `User` 物件，並將其顯示在對應的欄位中。

2.  **獲取驗證設定**
    - **API**: `GET /api/v1/settings/auth`
    - **傳出參數**: 無
    - **傳入資料 (Response)**:
      ```json
      {
        "provider": "string", // 'keycloak' | 'auth0' etc.
        "idp_admin_url": "string" // e.g., "https://idp.example.com/admin/realm/users"
      }
      ```
    - **資料流**: 前端發送請求，後端回傳 IdP 的設定。如果 `idp_admin_url` 存在，則顯示前往該 URL 的連結。

**需求與規格定義**
- **使用者需求**
  - **UR-01**: 作為一名使用者，我希望能查看我的基本個人資料，以確認我的帳號資訊是否正確。
  - **UR-02**: 作為一名使用者，如果我的帳號是透過外部系統（如 Keycloak）管理的，我希望能有一個快速連結前往該系統來管理我的帳號。
- **功能規格**
  - **FS-01**: 系統必須在「個人資訊」頁面載入時，自動從 `GET /api/v1/me` 獲取並顯示使用者的「名稱」、「電子郵件」、「角色」、「團隊」和「狀態」。
  - **FS-02**: 頁面上顯示的所有個人資料欄位均為唯讀，使用者不可直接在此頁面修改。
  - **FS-03**: 系統必須在頁面載入時，從 `GET /api/v1/settings/auth` 獲取驗證設定。
  - **FS-04**: 若 `GET /api/v1/settings/auth` 回傳的資料中包含 `idp_admin_url`，系統必須顯示一個連結，其文字為「在 [provider] 中管理」（例如「在 Keycloak 中管理」）。
  - **FS-05**: 點擊該外部管理連結後，必須在新分頁中開啟 `idp_admin_url`。
  - **FS-06**: 若任一 API 請求失敗，系統必須顯示一個清晰的錯誤訊息，例如「無法獲取個人資訊或驗證設定」。

---

### `profile-preferences.png`

**現況描述**
- 此頁面為「偏好設定」分頁，允許使用者自訂其介面偏好。
- 可設定的選項包含：介面主題、預設首頁、語言、時區。
- 每個選項都是一個下拉選單。
- 頁面底部提供三個操作按鈕：「重置為預設」、「儲存設定」和「匯出偏好設定」。

**互動流程**
- **資料載入**：
  - 進入頁面時，系統會並行發出三個請求：獲取使用者當前的偏好設定、獲取所有下拉選單的可用選項、獲取儀表板列表。
  - 載入期間應顯示載入指示器。
  - 若資料獲取失敗，應顯示錯誤訊息。
- **修改設定**：
  - 使用者可以從每個下拉選單中選擇不同的值。
  - 選擇後，前端狀態會更新，但不會立即儲存。
- **儲存設定**：
  - 使用者點擊「儲存設定」按鈕。
  - 系統會發出 `PUT` 請求，將當前的設定狀態傳送到後端。
  - 成功後，應顯示成功提示（Toast），例如「偏好設定已成功儲存」。
  - 失敗後，應顯示錯誤提示，例如「無法儲存偏好設定」。
- **重置設定**：
  - 使用者點擊「重置為預設」按鈕。
  - 前端會將所有設定選項恢復為從 `GET /settings/preferences/options` 獲取的預設值。
  - 應顯示成功提示，例如「偏好設定已重置為預設值」。
- **匯出設定**：
  - 使用者點擊「匯出偏好設定」按鈕。
  - 系統會發出 `POST` 請求來啟動匯出程序。
  - 成功後，應顯示成功提示，並自動觸發下載 `download_url` 對應的檔案。
  - 匯出過程中，按鈕應處於禁用狀態並顯示載入指示器。

**API 與資料流**
1.  **獲取偏好設定**
    - **API**: `GET /api/v1/me/preferences`
    - **傳入資料 (Response)**: `UserPreferences` 物件。
      ```json
      {
        "theme": "dark",
        "language": "zh-TW",
        "timezone": "Asia/Taipei",
        "default_page": "dashboard-sre-war-room"
      }
      ```
    - **資料流**: 用於填充表單的初始值。

2.  **獲取設定選項**
    - **API**: `GET /api/v1/settings/preferences/options`
    - **傳入資料 (Response)**: `PreferenceOptions` 物件。
      ```json
      {
        "defaults": { "...UserPreferences" },
        "timezones": ["Asia/Taipei", "UTC"],
        "languages": [{ "value": "en", "label": "English" }],
        "themes": [{ "value": "dark", "label": "深色" }]
      }
      ```
    - **資料流**: 用於填充各個下拉選單的選項，以及「重置為預設」時的資料來源。

3.  **獲取儀表板列表**
    - **API**: `GET /api/v1/dashboards`
    - **傳入資料 (Response)**: `{ "items": [Dashboard] }`
    - **資料流**: 用於填充「預設首頁」的下拉選單。

4.  **儲存偏好設定**
    - **API**: `PUT /api/v1/me/preferences`
    - **傳出資料 (Request Body)**: `UserPreferences` 物件。
    - **資料流**: 將使用者修改後的設定傳送至後端儲存。

5.  **匯出偏好設定**
    - **API**: `POST /api/v1/me/preferences/export`
    - **傳出資料 (Request Body)**: `{ "format": "json" }`
    - **傳入資料 (Response)**:
      ```json
      {
        "download_url": "string",
        "expires_at": "string"
      }
      ```
    - **資料流**: 後端處理匯出並回傳檔案下載連結，前端觸發下載。

**需求與規格定義**
- **使用者需求**
  - **UR-03**: 作為一名使用者，我希望能更改介面主題（如深色/淺色），以符合我的視覺偏好。
  - **UR-04**: 作為一名使用者，我希望能設定我的預設登入首頁，以便快速進入我最關心的儀表板。
  - **UR-05**: 作為一名使用者，我希望能切換介面語言和時區。
  - **UR-06**: 作為一名使用者，我希望能將所有偏好設定還原為系統預設值。
  - **UR-07**: 作為一名使用者，我希望能將我的偏好設定匯出成一個檔案，以便備份或遷移。
- **功能規格**
  - **FS-07**: 系統必須提供「介面主題」、「預設首頁」、「語言」和「時區」的下拉選單供使用者修改。
  - **FS-08**: 選單選項必須分別由 `GET /settings/preferences/options` 和 `GET /dashboards` API 動態載入。
  - **FS-09**: 點擊「儲存設定」後，系統必須透過 `PUT /api/v1/me/preferences` 提交所有變更。
  - **FS-10**: 點擊「重置為預設」後，系統必須將所有表單欄位恢復到 `PreferenceOptions.defaults` 中定義的值。
  - **FS-11**: 點擊「匯出偏好設定」後，系統必須透過 `POST /api/v1/me/preferences/export` 請求一個下載連結，並自動開始下載。
  - **FS-12**: 所有 API 操作（儲存、重置、匯出）後，都必須提供成功或失敗的視覺回饋（Toast）。

---

### `profile-security-settings.png`

**現況描述**
- 此頁面為「安全設定」分頁，提供兩項核心安全功能。
- **變更密碼**：一個表單，包含「舊密碼」、「新密碼」和「確認新密碼」三個輸入欄位，以及一個「更新密碼」按鈕。
- **最近登入活動**：一個表格，以分頁形式顯示使用者的登入歷史，欄位包含「時間」、「IP 位址」、「裝置」和「狀態」。

**互動流程**
- **變更密碼**：
  - 使用者在表單中輸入密碼。
  - 點擊「更新密碼」按鈕時，前端會進行驗證：
    - 所有欄位均不可為空。
    - 「新密碼」和「確認新密碼」必須一致。
    - 「新密碼」長度必須符合系統要求（例如，至少 6 個字元）。
  - 驗證通過後，系統會發出 `POST` 請求。
  - 請求期間，「更新密碼」按鈕應處於禁用狀態並顯示載入中動畫。
  - 成功後，應清空所有輸入欄位，並顯示成功提示，例如「密碼已成功更新」。
  - 失敗後（例如，舊密碼錯誤），應顯示從後端回傳的錯誤訊息。
- **查看登入歷史**：
  - 進入頁面時，系統會自動獲取第一頁的登入歷史。
  - 載入期間，表格應顯示載入中狀態。
  - 若獲取失敗，應顯示錯誤訊息及重試按鈕。
  - 使用者可以透過底部的分頁控制項來切換頁碼或調整每頁顯示的項目數量。

**API 與資料流**
1.  **變更密碼**
    - **API**: `POST /api/v1/me/change-password`
    - **傳出資料 (Request Body)**:
      ```json
      {
        "old_password": "string",
        "new_password": "string"
      }
      ```
    - **資料流**: 前端將使用者輸入的密碼傳送至後端進行驗證與更新。後端回傳成功或失敗狀態。

2.  **獲取登入歷史**
    - **API**: `GET /api/v1/me/login-history`
    - **傳出參數**: `page`, `page_size`
    - **傳入資料 (Response)**:
      ```json
      {
        "items": [
          {
            "id": "string",
            "timestamp": "string",
            "ip": "string",
            "device": "string",
            "status": "LoginStatus" // 'success' | 'failed'
          }
        ],
        "total": "number"
      }
      ```
    - **資料流**: 前端根據分頁狀態請求特定範圍的登入紀錄，後端回傳對應的資料列表及總數。

**需求與規格定義**
- **使用者需求**
  - **UR-08**: 作為一名使用者，我希望能變更我的登入密碼，以增強帳號安全性。
  - **UR-09**: 作為一名使用者，我希望能查看我最近的登入活動，以監控是否有未經授權的存取。
- **功能規格**
  - **FS-13**: 系統必須提供一個表單讓使用者可以輸入舊密碼、新密碼和確認新密碼。
  - **FS-14**: 在提交密碼變更請求前，系統必須在前端驗證：a) 所有欄位都已填寫；b) 新密碼與確認密碼相符；c) 新密碼滿足最小長度要求。
  - **FS-15**: 驗證通過後，系統必須透過 `POST /api/v1/me/change-password` 提交更新。
  - **FS-16**: 系統必須透過 `GET /api/v1/me/login-history` 獲取登入歷史，並以分頁表格的形式顯示。
  - **FS-17**: 登入歷史表格必須包含「時間」、「IP 位址」、「裝置」和「狀態」欄位。
  - **FS-18**: 登入狀態為 "success" 的紀錄應以綠色文字顯示，"failed" 則以紅色文字顯示，以提高可讀性。
  - **FS-19**: 系統必須提供分頁功能，允許使用者瀏覽所有登入歷史紀錄。
  - **FS-20**: 所有 API 操作後，都必須提供清晰的成功或失敗視覺回饋（Toast）。