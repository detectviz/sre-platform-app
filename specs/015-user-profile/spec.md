# 功能規格書（Feature Specification）: User Profile

**建立日期**: 2025-10-08
**狀態**: Draft
**輸入**: 使用者描述: "提供一個統一的個人設定中心，用於查看個人資訊、客製化平台偏好及管理帳號安全"

## 使用者情境與測試 *(mandatory)*

### 使用者故事 1 - 作為平台使用者，查看我的個人資訊與帳號狀態 (優先級: P1)

作為一名平台使用者，我需要能快速查看我的個人資訊，包括我的帳號狀態、所屬的角色和團隊，以及我的帳號是否由外部身份系統（如公司 SSO）管理。這對於我確認權限、了解帳號歸屬至關重要。

**為什麼此優先級**: 這是使用者自我服務的基礎，提供了必要的透明度，讓使用者能自行確認帳號狀態與權限歸屬。

**獨立測試**: 可以使用一個由外部 IdP 管理的帳號登入，導航到個人資訊頁面，並驗證頁面是否正確顯示了該使用者的角色、團隊，以及一條提示其帳號由外部管理的訊息。

**驗收情境**:

1. **Given** 我導航到「個人設定」的「基本資訊」頁籤, **When** 頁面載入完成, **Then** 我應該能看到我的姓名、Email、目前狀態（如「啟用」）、角色和團隊。
2. **Given** 我的帳號是透過外部身份提供商（IdP）管理的, **When** 我查看我的基本資訊頁面, **Then** 頁面上應顯示一條提示訊息，告知我此帳號由外部系統管理，並提供一個連結到該系統。
3. **Given** 我想確認我的帳號建立時間, **When** 我查看基本資訊頁面, **Then** 「建立時間」和「最近登入時間」欄位應顯示易於理解的相對時間和精確的日期時間。

---

### 使用者故事 2 - 作為平台使用者，客製化我的平台使用偏好 (優先級: P2)

為了提升工作效率和舒適度，我需要能夠客製化我的平台偏好，例如根據環境光線調整介面主題（亮色/暗色/自動）、設定我習慣的語言和時區，並將我最常用的儀表板設為預設首頁。

**為什麼此優先級**: 個人化設定能極大提升使用者體驗和日常工作效率，適應不同使用者在不同場景下的需求。

**獨立測試**: 可以通過將介面主題切換為「深色」，並將預設首頁設定為某個特定儀表板，儲存後重新整理頁面，驗證主題已變更且首頁已更新來獨立測試。

**驗收情境**:

1. **Given** 我偏好在夜間工作, **When** 我在「偏好設定」頁籤將「介面主題」更改為「深色」並儲存, **Then** 整個平台的使用者介面應立即切換為深色主題。
2. **Given** 我最常查看的是某個儀表板, **When** 我在「預設首頁」下拉選單中選擇它並儲存, **Then** 下次我登入時，應直接被導向到該儀表板。
3. **Given** 我需要備份我的設定, **When** 我點擊「匯出偏好設定」按鈕, **Then** 系統應下載一份包含我當前所有偏好設定的 JSON 檔案。
4. **Given** 我想從備份檔案恢復設定, **When** 我點擊「匯入偏好設定」按鈕並選擇一個有效的 JSON 檔案, **Then** 系統應驗證檔案格式並成功匯入設定。
5. **Given** 我想恢復初始設定, **When** 我點擊「重置為預設」按鈕, **Then** 頁面上的所有選項應恢復為系統預設值。

---

### 使用者故事 3 - 作為平台使用者，管理我的帳號安全 (優先級: P1)

為了保障帳號安全，我需要能夠定期變更密碼、查看最近的登入歷史以偵測可疑活動，並在懷疑帳號被盜用時能立即撤銷所有其他裝置的登入會話。

**為什麼此優先級**: 這是保障使用者帳號安全的核心功能，賦予使用者自我保護和快速應對安全威脅的能力。

**獨立測試**: 可以通過成功修改一次密碼，然後在新瀏覽器中使用新密碼登入。接著在原瀏覽器中查看登入歷史，應能看到一筆新的成功登入記錄。最後點擊「登出其他裝置」，新瀏覽器中的會話應被強制登出。

**驗收情境**:

1. **Given** 我想變更我的密碼, **When** 我在「安全設定」頁籤輸入正確的舊密碼和符合強度要求的新密碼, **Then** 系統應提示我密碼更新成功。
2. **Given** 我在設定新密碼時, **When** 我輸入密碼, **Then** 系統應提供視覺化的「密碼強度計」即時回饋其強度。
3. **Given** 我懷疑我的帳號在別處被登入, **When** 我點擊「登出其他裝置」按鈕, **Then** 系統應提示操作成功，並使我所有其他裝置上的登入會話立即失效。
4. **Given** 我想檢查最近的登入活動, **When** 我查看「最近登入活動」列表, **Then** 我應該能看到每一次登入的時間、IP 位址、裝置類型和結果（成功/失敗）。

---

### 邊界案例

- **儲存按鈕狀態**: 「儲存設定」按鈕在使用者沒有做出任何修改時應處於禁用狀態。
- **密碼強度**: 如果使用者輸入的新密碼強度不足，提交時應被阻止並提示。
- **IdP 管理的帳號**: 對於由外部 IdP 管理的帳號，「安全設定」中的修改密碼功能應被禁用並顯示提示。
- **IdP 連線失敗**: 當外部 IdP 服務不可用時，系統應允許使用者使用快取的認證資訊登入並顯示服務中斷提示。
- **IdP 設定變更**: 當 IdP 的設定（如憑證過期）發生問題時，系統應記錄詳細錯誤並提供管理員修復指引。
- **協定不相容**: 當 IdP 使用不支援的協定版本時，系統應提供明確的錯誤訊息和升級建議。
- **登入歷史清理**: 當登入記錄達到 100 條上限時，系統應自動刪除最舊的記錄並記錄清理操作。
- **資料清理失敗**: 當自動清理登入歷史失敗時，系統應發出告警但不阻止新登入記錄的建立。
- **偏好設定大小**: 雖然偏好設定無大小限制，但當設定過大時系統應提供最佳化建議。
- **i18n 金鑰遺失**: 當某個 i18n 金鑰不存在時，系統應顯示預設的英文文字並記錄警告，而不是顯示金鑰名稱。
- **語言包載入失敗**: 當語言包檔案無法載入時，系統應降級使用英文作為預設語言，並提供重新載入選項。
- **偏好檔案格式無效**: 當使用者上傳的 JSON 檔案格式無效時，系統應顯示具體的驗證錯誤訊息並阻止匯入。
- **偏好設定衝突**: 當匯入的偏好設定與現有設定發生衝突時，系統應提供合併選項或完全覆蓋的選擇。
- **偏好檔案過大**: 當匯入的 JSON 檔案過大時，系統應限制檔案大小並提供最佳化建議。

## 功能需求 *(mandatory)*

### 功能需求

- **FR-001**: 系統必須（MUST）在一個統一的介面中，以唯讀形式展示使用者的核心資訊（姓名、Email、狀態、角色、團隊）。
- **FR-002**: 若帳號由外部 IdP 管理，系統必須（MUST）顯示提示並提供跳轉連結。
- **FR-011**: 系統必須（MUST）支援所有主流身份協定：SAML 2.0、OAuth 2.0 和 OpenID Connect。
- **FR-012**: 系統必須（MUST）提供自訂整合介面，允許企業級 IdP（如 Azure AD、Okta、Google Workspace）通過標準 API 整合。
- **FR-003**: 系統必須（MUST）允許使用者客製化其偏好設定，至少包括介面主題（亮色/暗色/自動）、語言、時區和預設首頁。
- **FR-004**: 使用者的偏好設定必須（MUST）能夠被儲存、重置為預設，並能匯出為 JSON 檔案。
- **FR-014**: 系統必須（MUST）支援從 JSON 檔案匯入偏好設定，允許使用者從備份檔案恢復其個人化設定。
- **FR-005**: 系統必須（MUST）提供密碼變更功能，並附帶即時的密碼強度驗證。
- **FR-006**: 系統必須（MUST）提供「登出其他裝置」的功能，以立即撤銷所有其他會話。
- **FR-007**: 系統必須（MUST）在一個可分頁的表格中展示使用者最近的登入歷史，包含時間、IP、裝置和結果。
- **FR-008**: 所有修改個人設定的操作必須（MUST）有權限控制和審計日誌。
- **FR-009**: 系統必須（MUST）自動清理超過 **[參數化]** 保留天數（7天, 30天, 90天, 180天）的登入歷史記錄，每個使用者最多保留 **[參數化]** 記錄上限（50條, 100條, 200條）。
- **FR-010**: 使用者的偏好設定資料大小不設限制，但系統應提供儲存使用量提示。
- **FR-013**: 系統必須（MUST）一次性將所有硬編碼中文遷移至 i18n 內容管理系統，確保介面文字的完全本地化支援。

### 關鍵資料實體 *(如果功能涉及資料則包含)*

- **User**: 代表使用者。主要屬性: id, name, email, status, roles, teams, managed_by_idp (支援 SAML/OAuth/OIDC/custom), idp_metadata (IdP 特定資訊如 issuer、client_id 等)。
- **UserPreference**: 代表使用者的個人偏好。主要屬性: user_id, theme, language, timezone, default_homepage。
- **LoginHistory**: 代表一條登入記錄。主要屬性: user_id, timestamp, ip_address, user_agent, status。約束: 每個使用者最多保留 100 條記錄，記錄自動清理超過 30 天的資料。

## 權限控制 *(RBAC)*

### 權限模型設計

此模組的權限控制非常簡單，基本上所有登入使用者都應擁有管理自己個人設定的權限。

#### 所需權限定義

- **`profile:read`**: 允許讀取自己的個人資訊、偏好和安全設定。
- **`profile:update`**: 允許修改自己的偏好設定和安全設定（如改密碼、撤銷會話）。

#### 角色指派建議

- **所有角色 (Admin, Editor, Viewer)**: 都需要 `profile:read` 和 `profile:update` 權限。這通常是平台的基礎權限。

#### 權限檢查點

- **進入個人設定頁面**: 檢查使用者是否已登入。
- **儲存偏好/更新密碼/撤銷會話**: 後端檢查操作者是否是該 profile 的擁有者。

---

## 觀測性與治理檢查（Observability & Governance Checklist）

> 本模組遵循平台憲法中定義之全域治理與觀測性原則。  
> 詳細規範請參閱：
> - [.specify/memory/constitution.md](../../.specify/memory/constitution.md)
> - 章節：[觀測性與治理檢查](../../.specify/memory/constitution.md#ai-生成與規格合規)

> 本模組需確保：
> - 所有操作皆可追蹤並具備審計記錄。  
> - 關鍵事件具備可觀測性指標（logs、metrics、alerts）。  
> - 錯誤回報須符合統一錯誤模型並附 trace_id。  
> - Mock API 與實際行為需與 `/specs` 定義保持一致。

---

## 成功標準 *(mandatory)*

### 可衡量成果

- **SC-001**: 使用者可以在 1 分鐘內完成對其個人偏好（主題、語言、首頁）的修改並儲存。
- **SC-002**: 密碼重設流程（從輸入舊密碼到更新成功）應在 30 秒內完成。
- **SC-003**: 個人設定頁面的載入時間應低於 200 毫秒。
- **SC-004**: 登入歷史清理應在記錄過期後 24 小時內完成，清理成功率應達到 99.9%。
- **SC-005**: IdP 認證應在 2 秒內完成，支援至少 95% 的主流企業級身份提供商。
- **SC-006**: 偏好設定匯入流程應在 10 秒內完成，包含檔案驗證、設定合併和儲存操作。

---

## 模糊與待確認事項（Clarifications）

### Session 2025-10-10

- **Q**: 使用者偏好的資料（登入歷史、偏好設定）應採用什麼規模和保留策略？ → **A**: 小型保留：登入歷史保留 30 天，最多 100 條記錄，偏好設定無大小限制
- **Q**: 外部 IdP 整合應支援哪些身份提供商類型和協定？ → **A**: 廣泛支援：支援所有主流協定（SAML、OAuth、OIDC）以及自訂整合介面
- **Q**: 是否需要支援從 JSON 檔案匯入偏好設定的功能？ → **A**: 是，需要支援從 JSON 檔案匯入偏好設定的功能