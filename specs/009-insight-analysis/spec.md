# 功能規格書（Feature Specification）: Insight Analysis

**建立日期**: 2025-10-08
**狀態**: Draft
**輸入**: 使用者描述: "提供一個集中化的系統分析與預測介面，支援歷史趨勢分析、事件回放、容量預測和效能比較"

## 使用者情境與測試 *(mandatory)*

### 使用者故事 1 - 作為 SRE，回放歷史事件以進行根因分析 (優先級: P1)

作為一名 SRE，在事故發生後，我需要能夠以時間線的方式重現事件發生期間的系統行為，包括關鍵指標的變化、觸發的告警和相關的操作記錄。目前的痛點是事故回放依賴人工記憶和分散的筆記，難以準確重現當時的情境，導致根因分析效率低下。

**為什麼此優先級**: 這是解決事故後分析效率低下問題的核心功能，能顯著縮短問題定位時間，並將事故經驗轉化為可複用的知識資產。

**獨立測試**: 可以通過選擇一個過去的告警事件，系統能自動載入事件前後的指標數據，並在時間軸上播放指標變化動畫來獨立測試。

**驗收情境**:

1. **Given** 我選擇一個歷史 Incident, **When** 我進入「事件回放」頁面, **Then** 系統必須自動載入相關時間區間與資料。
2. **Given** 我在事件回放頁面, **When** 我點擊「播放」, **Then** 系統必須逐步重現資源指標與事件序列的變化。
3. **Given** 我在事件回放頁面, **When** 我點擊「標註」並在時間軸的某個點輸入備註, **Then** 系統必須在時間軸上標註此時間點並顯示我的備註。
4. **Given** 我完成分析, **When** 我儲存此次回放分析並設為「團隊共享」, **Then** 其他團隊成員必須能查看我的分析結果。

---

### 使用者故事 2 - 作為容量規劃工程師，預測未來資源需求以避免瓶頸 (優先級: P2)

作為容量規劃工程師，我需要根據歷史資源使用數據，科學地預測未來1-4週的資源需求，以避免因資源不足導致服務中斷，或因過度擴容造成成本浪費。目前的痛點是容量規劃主要依賴經驗和手動的 Excel 分析，缺乏準確性。

**為什麼此優先級**: 提供數據驅動的決策依據，幫助企業在成本和穩定性之間找到最佳平衡點，是主動式維運的關鍵一環。

**獨立測試**: 可以通過選擇「過去90天」的歷史數據，成功生成一個「未來4週」的 CPU 使用率預測曲線圖，且圖中標示了預測的信心區間（如 P90, P99）來獨立測試。

**驗收情境**:

1. **Given** 我在「容量預測」頁面, **When** 我選擇「過去 90 天」作為歷史基礎並預測「未來 4 週」, **Then** 系統必須產出預測曲線與信心區間。
2. **Given** 系統產出預測結果, **When** 結果顯示「未來 2 週內 CPU 將達 85%」, **Then** 系統必須在圖表和摘要中高亮標示此潛在瓶頸。
3. **Given** 我建立一個容量預測任務, **When** 我設定「每週自動更新」, **Then** 系統必須定期更新預測結果並保留歷史版本以便追蹤。
4. **Given** 我完成預測, **When** 我點擊「匯出報表」, **Then** 系統必須產出包含預測圖表和數據摘要的 PDF 檔案。

---

### 使用者故事 3 - 作為平台分析師，多維度分析和比較系統效能 (優先級: P2)

作為平台分析師，我需要能夠靈活地查詢歷史趨勢，並排比較不同時間段或不同資源組的效能表現，以量化優化效果或發現異常模式。目前的痛點是歷史數據分散在不同系統，難以進行統一的關聯與比較分析。

**為什麼此優先級**: 為效能優化、成本控制和異常偵測提供量化依據，讓決策更科學。

**獨立測試**: 可以通過在「比較模式」下，選擇優化前後的兩個不同時間週，系統能並排顯示兩週的平均 CPU 使用率圖表，並自動計算出差異百分比來獨立測試。

**驗收情境**:

1. **Given** 我在分析頁面, **When** 我選擇時間區間並勾選「CPU、Memory」指標，再篩選「應用=OrderService」, **Then** 圖表必須更新，僅顯示該應用的資源指標趨勢。
2. **Given** 我在「比較模式」頁面, **When** 我選擇兩個不同的時間區間, **Then** 系統必須並排顯示兩時段的指標圖表，並自動計算關鍵指標的差異百分比。
3. **Given** 我在「異常偵測」頁面, **When** 我選擇時間範圍並執行掃描, **Then** 系統必須自動識別出指標異常的時段，並允許我點擊跳轉到對應的事件回放視圖。

---

### 邊界案例

- **數據不足**: 當進行容量預測時，若歷史數據不足（如少於一個完整週期），系統應提示用戶擴大時間範圍或等待更多數據收集，並顯示建議的數據收集時長。
- **模型訓練失敗**: 當容量預測或異常偵測的後端模型訓練失敗時，系統應根據失敗類型顯示具體錯誤訊息（如「數據質量不足」、「計算資源不足」或「演算法收斂失敗」），並提供相應的解決建議。
- **資料延遲**: 當底層監控數據有延遲時，分析結果應結合時間戳標示、顏色編碼和警告訊息顯示數據新鮮度，並提供數據來源狀態儀表板供用戶監控數據健康狀況。
- **無效配置參數**: 當使用者輸入無效的配置參數（如負數超時時間）時，系統應拒絕儲存並顯示具體的驗證錯誤訊息。
- **配置同步延遲**: 當多個節點需要同步配置變更時，系統應確保所有節點在 60 秒內完成同步，以維持一致的分析行為。
- **節流與預取**:
  - 當使用者在短時間內發出相同分析請求，系統應優先回傳快取結果以減少重複計算。
  - 當快取過期時，系統應自動觸發新分析並更新快取，同時記錄分析耗時與命中率。
  - 若預取資料因資源不足而失敗，系統應記錄警告並不影響主要分析流程。

## 功能需求 *(mandatory)*

### 功能需求

- **FR-001**: 系統必須（MUST）支援查詢任意時間區間、任意資源維度（節點、應用等）的歷史指標數據並將其視覺化。
- **FR-002**: 系統必須（MUST）提供事件回放功能，能在時間軸上同步重現指標、告警和操作記錄。
- **FR-003**: 系統必須（MUST）提供基於歷史數據的容量預測功能，結合統計模型和機器學習演算法，能產出帶有信心區間的預測曲線並標示潛在瓶頸。
  - **[參數化]** 預測演算法權重分配（統計:機器學習 = 30:70, 50:50, 70:30）
  - **[參數化]** 預測時間範圍（1-12週）
  - **[參數化]** 信心區間設定（P80, P90, P95, P99）
  - **[參數化]** 自動更新頻率（每日/每週/每月）
- **FR-004**: 系統必須（MUST）支援並排比較不同時間區間或不同資源組的效能指標。
  - **[參數化]** 預設比較時間段（過去7天vs過去30天, 上週vs本週等）
  - **[參數化]** 差異閾值顯示（僅顯示差異 > 5%, > 10%, > 20%）
- **FR-005**: 系統應該（SHOULD）提供自動化異常偵測功能，提供低/中/高三個預設敏感度等級，幫助使用者主動發現歷史數據中的異常模式。
  - **[參數化]** 敏感度等級（低:3-sigma, 中:2-sigma, 高:1.5-sigma）
  - **[參數化]** 掃描時間窗口（1小時, 6小時, 24小時, 7天）
  - **[參數化]** 最小異常持續時間（5分鐘, 15分鐘, 1小時）
- **FR-006**: 所有分析（回放、預測、比較）的結果必須（MUST）可以被儲存、分享和版本化管理。
- **FR-007**: 系統必須（MUST）支援將分析結果匯出為報表（PDF/CSV）。
- **FR-008**: 系統必須（MUST）支援參數化配置分析行為，包括效能參數、顯示設定和處理限制。
  - **[參數化]** 查詢超時設定（30秒, 60秒, 120秒）
  - **[參數化]** 最大同時分析任務數（3, 5, 10）
  - **[參數化]** 數據快取時間（1小時, 6小時, 24小時）
  - **[參數化]** 圖表最大數據點數（1000, 5000, 10000點）
- **FR-021**：系統必須（MUST）支援智慧節流（Smart Throttling），以減少重複分析請求造成的計算負載。
- **FR-022**：系統必須（MUST）針對重複查詢結果提供快取層，快取有效期限（TTL）可配置，預設為 60 秒。
- **FR-023**：系統應該（SHOULD）支援預取機制（Prefetching），根據使用者常見分析模式預先載入必要資料以降低等待時間。
- **FR-024**：當使用者超出分析速率限制時，系統應顯示提示「分析請求頻率過高，請稍後重試」而非拒絕請求。

### 關鍵資料實體 *(如果功能涉及資料則包含)*

- **AnalysisTask**: 代表一次分析任務的設定與結果。主要屬性: id, type (`replay`|`prediction`|`comparison`), parameters, status, result_data。
- **PredictionModel**: 代表一個容量預測模型。主要屬性: id, resource_type, trained_on_data, accuracy_score。
- **AnalysisConfiguration**: 代表分析系統的參數化配置。主要屬性: prediction_weights, forecast_horizon_weeks, confidence_interval, auto_update_frequency, anomaly_sensitivity, scan_window_hours, min_anomaly_duration_minutes, query_timeout_seconds, max_concurrent_tasks, cache_ttl_hours, max_chart_points。

## 權限控制 *(RBAC)*

### 權限模型設計

分析洞察的權限主要圍繞分析任務的讀取和執行權限展開。

#### 所需權限定義

- **`insight:analysis:read`**: 允許讀取和查看已儲存的分析任務結果。
- **`insight:analysis:execute`**: 允許建立並執行新的分析任務（包括歷史分析、事件回放、比較）。
- **`insight:prediction:execute`**: 允許建立並執行容量預測任務。
- **`insight:analysis:export`**: 允許匯出分析報表。
- **`insight:analysis:config:read`**: 允許檢視分析系統的配置參數。
- **`insight:analysis:config:update`**: 允許修改分析系統的配置參數。

#### 角色指派建議

- **Admin 角色**: 需要所有 `insight:analysis:*` 和 `insight:prediction:*` 權限。
- **Editor 角色** (SRE/分析師): `insight:analysis:read`, `insight:analysis:execute`, `insight:prediction:execute`, `insight:analysis:export`, `insight:analysis:config:read`。
- **Viewer 角色**: `insight:analysis:read`。

#### 權限檢查點

- **進入分析頁面**: 檢查 `insight:analysis:read` 權限。
- **執行分析/回放/比較**: 檢查 `insight:analysis:execute` 權限。
- **執行容量預測**: 檢查 `insight:prediction:execute` 權限。
- **點擊「匯出」按鈕**: 檢查 `insight:analysis:export` 權限。
- **查看他人分享的分析**: 檢查 `insight:analysis:read` 權限。
- **進入「設定」頁面**: 檢查 `insight:analysis:config:read` 權限。
- **修改分析配置**: 檢查 `insight:analysis:config:update` 權限。

---

## 觀測性與治理檢查（Observability & Governance Checklist）

> 本模組遵循平台憲法中定義之全域治理與觀測性原則。  
> 詳細規範請參閱：
> - [.specify/memory/constitution.md](../../.specify/memory/constitution.md)
> - 章節：[觀測性與治理檢查](../../.specify/memory/constitution.md#ai-生成與規格合規)

> 本模組需確保：
> - 所有操作皆可追蹤並具備審計記錄。  
> - 關鍵事件具備可觀測性指標（logs、metrics、alerts）。  
> - 錯誤回報須符合統一錯誤模型並附 trace_id。  
> - Mock API 與實際行為需與 `/specs` 定義保持一致。

---

## 成功標準 *(mandatory)*

### 可衡量成果

- **SC-001**: 一次典型的事故回放分析（涉及1小時數據、10個關鍵指標）的準備和載入時間應小於 60 秒。
- **SC-002**: 一次基於過去90天數據的4週容量預測任務，其計算時間應在 5 分鐘內完成。
- **SC-003**: 容量預測的準確率（與實際情況相比）應達到 90% 以上。
- **SC-004**: 引入此模組後，團隊撰寫根因分析（RCA）報告的平均時間縮短 50%。
- **SC-005**: 配置參數修改後，系統應在 30 秒內生效並應用到新的分析任務。
- **SC-006**：智慧節流機制在高併發下（同時 50 任務）維持系統回應時間小於 3 秒。
- **SC-007**：分析快取命中率應達 70% 以上。
- **SC-008**：預取資料命中率應達 60% 以上。

---

## 模糊與待確認事項（Clarifications）

### Session 2025-10-10

- **Q**: 容量預測背後的演算法是什麼？是傳統的時間序列模型（如 ARIMA）還是基於機器學習的模型？ → **A**: 混合方法：結合統計模型和機器學習，根據數據特徵自動選擇
- **Q**: 自動異常偵測的敏感度是否可由使用者調節？ → **A**: 預設等級：提供低/中/高三個預設敏感度等級供選擇
- **Q**: 當進行容量預測時，若歷史數據不足（如少於一個完整週期），系統應如何提示？ → **A**: 建議延長：提示用戶擴大時間範圍或等待更多數據收集
- **Q**: 當容量預測或異常偵測的後端模型訓練失敗時，應如何向使用者顯示錯誤？ → **A**: 分類錯誤：根據失敗類型顯示不同錯誤訊息（如數據問題、資源不足等）
- **Q**: 當底層監控數據有延遲時，分析結果應如何標示其數據的「新鮮度」？ → **A**: 綜合標示：結合時間戳、顏色編碼和警告訊息，並提供數據來源狀態儀表板
- **Q**: Insight Analysis 是否需要參數化設定？ → **A**: 是，全部參數化：容量預測、異常偵測、比較分析和系統效能參數均支援配置

> 本模組已導入「智慧節流與預取分析（Smart Throttling & Prefetching）」機制，以減少分析伺服器負載並提升互動體驗，確保大型分析任務在高併發場景下仍能穩定執行。