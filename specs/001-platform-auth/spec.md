# 功能規格書（Feature Specification）: Platform Auth

**建立日期**: 2025-10-06
**狀態**: Draft
**輸入**: 使用者描述: "為平台提供全面的身份驗證與授權管理功能，支援多個外部身份提供商（IdP）的 OIDC/SSO 連線設定"

## 使用者情境與測試 *(mandatory)*

### 使用者故事 1 - 作為平台管理員，配置與管理多個身份提供商 (IdP) (優先級: P1)

作為一名平台管理員或安全工程師，我需要能夠管理平台與多個外部身份提供商（IdP）的 OIDC/SSO 連線設定，以便支援企業級多租戶場景、提升認證系統的可用性與彈性。這包括配置多個 IdP（如 Keycloak、Auth0）、設定主備援以實現高可用性，以及管理使用者在登入頁面可見的選項。當前的限制是只支援單一 IdP，且缺乏容錯機制，一旦 IdP 故障，整個平台登入功能便會中斷。

**為什麼此優先級**: 此為核心功能，解決了單一 IdP 限制、無容錯機制的關鍵痛點，是支援企業級多租戶和高可用性認證的基礎。

**獨立測試**: 可以通過新增、設定並啟用一個 OIDC IdP，並成功使用該 IdP 登入來獨立測試。

**驗收情境**:

1. **Given** 系統已配置多個 IdP, **When** 我開啟設定頁面, **Then** 系統應以清單形式顯示所有已配置的 IdP。
2. **Given** 我需要新增 IdP, **When** 我點擊「新增 IdP」按鈕, **Then** 系統應顯示 IdP 配置表單。
3. **Given** 我正在配置新的 IdP, **When** 我選擇 IdP 類型, **Then** 系統應根據所選類型動態調整表單欄位。
4. **Given** 我需要設定主要 IdP, **When** 我在 IdP 清單中標記某個 IdP 為「預設」, **Then** 該 IdP 應成為使用者登入時的預設選項。
5. **Given** 系統已配置主備 IdP, **When** 主要 IdP 連線失敗, **Then** 系統應自動嘗試使用備用 IdP 進行認證。
6. **Given** 我需要編輯某個 IdP, **When** 我點擊「編輯」按鈕, **Then** 系統應顯示預填好現有配置的表單。
7. **Given** 我需要停用某個 IdP, **When** 我將其啟用狀態切換為「停用」, **Then** 使用者將無法透過該 IdP 登入。
8. **Given** 我需要測試 IdP 連線, **When** 我點擊「測試連線」按鈕, **Then** 系統應發送測試請求並顯示結果。
9. **Given** 我需要刪除某個 IdP, **When** 我點擊「刪除」按鈕, **Then** 系統應顯示確認對話框並在確認後刪除配置。

---

### 使用者故事 2 - 作為平台管理員，安全地查看與管理 IdP 的敏感憑證 (優先級: P2)

為了安全地進行金鑰輪換或故障排查，管理員需要能夠查看如 Client ID 等資訊，並在受控的情況下顯示或複製 Client Secret。目前的痛點是 Client Secret 若以明文顯示，可能導致外洩風險。

**為什麼此優先級**: 確保敏感憑證（如 Client Secret）的管理既安全又便捷，防止資訊外洩，同時滿足日常維運需求。

**獨立測試**: 可以通過驗證 Client Secret 預設為遮蔽、點擊按鈕可顯示/隱藏、以及複製功能可正常運作來獨立測試。

**驗收情境**:

1. **Given** Client Secret 欄位可見, **When** 我查看 Client Secret 欄位, **Then** Client Secret 應預設以遮蔽形式顯示。
2. **Given** 我需要驗證儲存的 Client Secret, **When** 我點擊「顯示」按鈕, **Then** 被遮蔽的密鑰應切換為明文顯示。
3. **Given** Client Secret 目前以明文顯示, **When** 我再次點擊「隱藏」按鈕, **Then** 密鑰應恢復為遮蔽狀態。
4. **Given** 我需要提供 Client ID, **When** 我點擊「複製」按鈕, **Then** Client ID 字串應被複製到剪貼簿，並顯示成功提示。
5. **Given** 我需要複製 Client Secret, **When** 我點擊「複製」按鈕, **Then** 完整的 Client Secret（明文）應被複製到剪貼簿，並顯示成功提示。
6. **Given** 我在不支援剪貼簿 API 的環境中, **When** 我嘗試點擊「複製」按鈕, **Then** 系統應顯示錯誤提示，建議我手動複製。

---

### 使用者故事 3 - 作為平台管理員，查看 IdP 設定與處理錯誤 (優先級: P3)

為了日常維護和問題診斷，管理員需要清晰地查看所有 IdP 的設定資訊，並在系統發生錯誤（如 API 載入失敗、權限不足）時獲得明確的提示。

**為什麼此優先級**: 提供必要的資訊透明度和錯誤處理機制，是確保系統可維護性的基礎。

**獨立測試**: 可以通過驗證頁面能正確顯示已配置的 IdP 資訊，並在模擬 API 失敗時顯示錯誤訊息來獨立測試。

**驗收情境**:

1. **Given** 我正在「身份驗證設定」頁面, **When** 頁面載入完成, **Then** 所有設定欄位均應以唯讀狀態顯示。
2. **Given** 頁面已成功載入身份驗證設定, **When** 我檢視設定內容, **Then** 系統應清晰顯示身份提供商名稱、Realm、OIDC 啟用狀態。
3. **Given** 某些設定值未被配置, **When** 我查看對應的設定欄位, **Then** 系統應顯示佔位符（如 "—"）。
4. **Given** 後端 API 無法載入身份驗證設定, **When** 頁面嘗試載入資料, **Then** 系統應顯示清晰的錯誤訊息。
5. **Given** 使用者權限不足, **When** 使用者嘗試存取此頁面, **Then** 系統應顯示權限不足的提示訊息。
6. **Given** 我在頁面上停留較長時間, **When** 我嘗試重新載入設定, **Then** 系統應檢測到 Session 過期並提示重新登入。

---

### 邊界案例

- **IdP 數量超出限制**: 當管理員嘗試配置超過支援的最大 IdP 數量時，系統應發出警告但允許操作。
- **連線測試逾時**: 當 IdP 連線測試超過配置的逾時時間時，系統應中斷測試並記錄逾時事件。
- **憑證驗證失敗**: 當 IdP 憑證驗證失敗時，系統應根據配置策略決定是否停用該 IdP 或發出告警。
- **並發認證請求過載**: 當認證請求數量超過配置的並發限制時，系統應排隊處理並記錄效能指標。
- **無效配置參數**: 當管理員嘗試設定超出合理範圍的認證配置值時，系統必須拒絕並顯示有效的參數範圍。
- **配置衝突**: 當新認證配置與現有設定衝突時，系統必須提示潛在影響並要求確認。
- **配置載入失敗**: 當認證配置服務不可用時，系統必須使用最後已知的有效配置繼續運作並記錄錯誤。

## 功能需求 *(mandatory)*

### 功能需求

- **FR-IDP-001**: 系統必須（MUST）支援配置多個身份提供商（IdP）。
- **FR-IDP-002**: 系統必須（MUST）提供 IdP 的 CRUD（建立、讀取、更新、刪除）功能。
- **FR-IDP-003**: 系統必須（MUST）根據所選 IdP 類型動態調整配置表單。
- **FR-IDP-004**: 系統必須（MUST）支援至少 10 個 IdP 配置並同時處理 1000 個認證請求/分鐘。
- **FR-HA-001**: 系統必須（MUST）支援配置備用 IdP，當主要 IdP 不可用時自動切換。
- **FR-HA-002**: 系統必須（MUST）在 IdP 故障轉移時記錄審計日誌。
- **FR-HA-003**: IdP 故障轉移必須（MUST）在 5 秒內完成。
- **FR-HA-004**: 網路逾時情境下，系統必須（MUST）在 30 秒內重試 3 次。
- **FR-HA-005**: IdP 服務錯誤時，系統必須（MUST）降級到快取模式以維持服務可用性。
- **FR-HA-006**: 憑證錯誤時，系統必須（MUST）發出告警並自動停用相關 IdP。
- **FR-TEST-001**: 系統必須（MUST）為每個 IdP 提供「測試連線」功能。
- **FR-TEST-002**: 測試結果必須（MUST）顯示連線狀態、錯誤訊息、版本資訊與回應時間。
- **FR-SEC-001**: Client Secret 必須（MUST）預設以遮蔽形式顯示。
- **FR-SEC-002**: 系統必須（MUST）提供「顯示/隱藏」和「一鍵複製」功能。
- **FR-SEC-003**: Client Secret 必須（MUST）在後端加密儲存。
- **FR-SEC-004**: 系統必須（MUST）支援加密傳輸並符合 GDPR 和 ISO 27001 標準。
- **FR-SEC-005**: 系統必須（MUST）防範零日攻擊和內部威脅，提供完整的審計追蹤。
- **FR-UX-001**: 登入頁面必須（MUST）顯示所有已啟用的 IdP 選項。
- **FR-UX-002**: 系統應該（SHOULD）支援根據使用者屬性自動導向對應的 IdP。
- **FR-AUDIT-001**: 系統必須（MUST）記錄所有 IdP 配置變更與敏感操作至審計日誌。
- **FR-AUDIT-002**: 系統應該（SHOULD）提供 IdP 使用統計儀表板。
- **FR-TENANT-001**: 系統應該（SHOULD）支援租戶級別的 IdP 配置。

### 參數化配置需求

- **FR-CONFIG-001**: 系統必須（MUST）提供管理介面讓管理員配置認證相關參數。
- **FR-CONFIG-002**: 系統必須（MUST）支援動態重新載入非敏感認證配置參數。
- **FR-CONFIG-003**: 系統必須（MUST）記錄所有認證配置變更至稽核日誌。
- **FR-CONFIG-004**: 系統必須（MUST）驗證認證配置參數的安全性和合理性。
- **FR-CONFIG-005**: 關鍵安全參數必須（MUST）保持固定，不可通過管理介面修改。

#### 可參數化的認證設定

- **高可用性**: 故障轉移逾時、重試次數和間隔、快取模式持續時間
- **效能限制**: 最大 IdP 數量、並發認證請求數、連線池大小
- **安全政策**: 工作階段逾時、登入失敗鎖定策略、密碼重置令牌有效期
- **外部整合**: IdP 連線逾時、測試頻率、重試策略、憑證驗證模式
- **稽核設定**: 日誌保留期限、統計報告頻率、告警閾值

#### 固定不變的安全基準

- **加密要求**: 所有通訊必須使用 HTTPS，Client Secret 必須加密儲存
- **基本稽核**: 所有認證操作必須記錄，不可停用
- **身份驗證**: 多重要素認證支援必須啟用（可選用但不能停用功能）
- **GDPR/ISO 27001**: 基本合規要求必須滿足

### 關鍵資料實體 *(如果功能涉及資料則包含)*

- **IdentityProvider**: 代表一個已配置的身份提供商（IdP）的核心實體。主要屬性: id, name, type, is_active, priority_order, created_at, updated_at
- **IdPConfiguration**: 代表 IdP 特定的配置參數。
- **IdPConnectionTest**: 代表 IdP 連線測試結果。
- **IdPFailoverLog**: 代表 IdP 故障轉移記錄。
- **AuthConfiguration**: 代表認證系統的參數化設定。主要屬性: id, category, key, value, data_type, is_sensitive, updated_by, updated_at。
- **IdPAuditLog**: 代表 IdP 審計日誌。

## 技術實現細節 *(如果功能涉及技術棧則包含)*

### 數據存儲策略
- **業務數據**: 使用 PostgreSQL 存儲 IdP 配置和認證日誌
- **快取數據**: 使用 Redis 進行認證會話管理和 Token 快取
- **審計日誌**: 使用 Grafana Loki 記錄身份認證和授權事件

### 外部系統整合
- **Keycloak**: 作為主要身份認證和授權服務
- **OIDC/SAML**: 支援標準協議的身份提供商整合
- **高可用性**: 支援多 IdP 配置和自動故障轉移

### API 端點定義
- **GET /api/v1/auth/providers**: IdP 配置列表
- **POST /api/v1/auth/providers**: 新增 IdP 配置
- **PUT /api/v1/auth/providers/{id}**: 更新 IdP 配置
- **POST /api/v1/auth/providers/{id}/test**: 測試 IdP 連線

## 權限控制 *(RBAC)*

### 權限模型設計

此功能採用基於角色的存取控制（RBAC）模型。操作權限被細分為讀取、建立、更新、刪除、測試及敏感資訊操作等，並指派給預設的管理員角色。

#### 所需權限定義

- **`settings:auth:read`**: 允許查看身份驗證設定。
- **`settings:auth:create`**: 允許新增 IdP 配置。
- **`settings:auth:update`**: 允許編輯 IdP 配置。
- **`settings:auth:delete`**: 允許刪除 IdP 配置。
- **`settings:auth:test`**: 允許執行 IdP 連線測試。
- **`settings:auth:secret:view`**: 允許查看 Client Secret。
- **`settings:auth:secret:copy`**: 允許複製 Client Secret。
- **`settings:auth:config:read`**: 允許檢視認證系統配置設定。
- **`settings:auth:config:update`**: 允許修改認證業務邏輯配置參數（不含安全關鍵參數）。

#### 角色指派建議

- **Admin 角色**: 需要所有 `settings:auth:*` 權限。
- **Editor 角色**: [NEEDS CLARIFICATION: 是否需要 Editor 角色？若需要，應授予哪些權限？]
- **Viewer 角色**: `settings:auth:read`

#### 權限檢查點

- **頁面載入**: 檢查 `settings:auth:read` 權限。
- **執行新增/編輯/刪除/測試操作**: 分別檢查 `create`, `update`, `delete`, `test` 權限。
- **查看/複製 Secret**: 分別檢查 `secret:view` 和 `secret:copy` 權限。

---

## 觀測性與治理檢查（Observability & Governance Checklist）

> 本模組遵循平台憲法中定義之全域治理與觀測性原則。  
> 詳細規範請參閱：
> - [.specify/memory/constitution.md](../../.specify/memory/constitution.md)
> - 章節：[觀測性與治理檢查](../../.specify/memory/constitution.md#ai-生成與規格合規)

> 本模組需確保：
> - 所有操作皆可追蹤並具備審計記錄。  
> - 關鍵事件具備可觀測性指標（logs、metrics、alerts）。  
> - 錯誤回報須符合統一錯誤模型並附 trace_id。  
> - Mock API 與實際行為需與 `/specs` 定義保持一致。

---

## 成功標準 *(mandatory)*

### 可衡量成果

- **SC-001**: 使用者可以在 30 秒內完成 IdP 配置並驗證連線狀態。
- **SC-002**: 當主要 IdP 故障時，系統能在 5 秒內自動切換到備用 IdP並維持服務可用性。
- **SC-003**: 敏感資訊顯示和複製操作的成功率達到 99.9%，並且所有操作都被完整記錄。
- **SC-004**: 95% 的認證操作能在單次嘗試中成功完成，包含正常和容錯情境。
- **SC-005**: 審計系統能夠在 1 秒內查詢並顯示指定時間範圍內的認證活動記錄。
- **SC-CONFIG-001**: 認證配置變更應在 **[參數化]** 配置生效時間（5秒, 10秒, 30秒）內生效並應用到所有服務實例。
- **SC-CONFIG-002**: 無效的認證配置參數應在設定時立即被拒絕並顯示明確的錯誤訊息。

---

## 模糊與待確認事項（Clarifications）

### Session 2025-10-10

- **Q**: 資料實體的具體屬性與關係？ → **A**: 基本屬性：id, name, type, is_active, priority_order, created_at, updated_at
- **Q**: 效能與可擴展性約束？ → **A**: 效能目標：IdP 切換 <5秒，支援 10個 IdP 配置，同時處理 1000個認證請求/分鐘
- **Q**: 安全威脅模型與合規要求？ → **A**: 符合 GDPR 和 ISO 27001，支援加密傳輸，防範進階威脅：零日攻擊、內部威脅。
- **Q**: 使用者角色區分？ → **A**: 二角色：管理員（完整權限）、使用者（登入權限），通過權限控制細粒度管理。
- **Q**: 外部依賴失敗模式？ → **A**: 網路逾時：30秒重試3次；服務錯誤：降級到快取模式；憑證錯誤：發出告警並停用 IdP。