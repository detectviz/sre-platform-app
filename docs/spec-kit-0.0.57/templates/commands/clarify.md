---
description: 通過詢問最多 5 個高度針對性的澄清問題來識別目前功能規格中未充分指定的領域，並將答案編碼回規格中。
scripts:
   sh: scripts/bash/check-prerequisites.sh --json --paths-only
   ps: scripts/powershell/check-prerequisites.ps1 -Json -PathsOnly
---

## 使用者輸入

```text
$ARGUMENTS
```

如果不為空，您**必須**在繼續之前考慮使用者輸入。

## 大綱

目標：偵測並減少活躍功能規格中的歧義或缺失決策點，並直接在規格文件中記錄澄清內容。

注意：此澄清工作流程預期在呼叫 `/speckit.plan` 之前執行（並完成）。如果使用者明確表示要跳過澄清（例如：探索性尖峰），您可以繼續，但必須警告下游重工風險會增加。

執行步驟：

1. 從儲存庫根目錄執行 `{SCRIPT}` **一次**（結合 `--json --paths-only` 模式 / `-Json -PathsOnly`）。解析最小 JSON 載荷欄位：
   - `FEATURE_DIR`
   - `FEATURE_SPEC`
   - （可選捕獲 `IMPL_PLAN`、`TASKS` 以供未來鏈式流程。）
   - 如果 JSON 解析失敗，中止並指示使用者重新執行 `/speckit.specify` 或驗證功能分支環境。

2. 載入目前規格文件。使用此分類法執行結構化歧義與覆蓋掃描。對於每個類別，標記狀態：Clear / Partial / Missing。產生用於優先排序的內部覆蓋地圖（除非不會提出問題，否則不要輸出原始地圖）。

   功能範圍與行為：
   - 核心使用者目標與成功標準
   - 明確的範圍外宣告
   - 使用者角色/角色區分

   領域與資料模型：
   - 實體、屬性、關係
   - 身份與唯一性規則
   - 生命週期/狀態轉換
   - 資料量/規模假設

   互動與 UX 流程：
   - 關鍵使用者旅程/序列
   - 錯誤/空/載入狀態
   - 無障礙或本地化註記

   非功能品質屬性：
   - 效能（延遲、吞吐量目標）
   - 可擴展性（水平/垂直、限制）
   - 可靠性和可用性（正常運行時間、復原期望）
   - 可觀測性（日誌記錄、指標、追蹤訊號）
   - 安全性和隱私（認證/授權、資料保護、威脅假設）
   - 合規/法規約束（如果有）

   整合與外部依賴：
   - 外部服務/API 和故障模式
   - 資料匯入/匯出格式
   - 協議/版本控制假設

   邊界案例與故障處理：
   - 負面場景
   - 速率限制/節流
   - 衝突解決（例如：並發編輯）

   約束與權衡：
   - 技術約束（語言、儲存、託管）
   - 明確的權衡或被拒絕的替代方案

   術語與一致性：
   - 標準詞彙表術語
   - 避免的同義詞/已棄用的術語

   完成訊號：
   - 驗收標準可測試性
   - 可衡量的完成定義風格指標

   雜項/占位符：
   - TODO 標記/未解決的決定
   - 模糊形容詞（"robust"、"intuitive"）缺乏量化

   對於每個具有 Partial 或 Missing 狀態的類別，除非以下情況，否則新增候選問題機會：
   - 澄清不會實質改變實作或驗證策略
   - 資訊最好延遲到規劃階段（內部註記）

3. 產生（內部）優先排序的候選澄清問題隊列（最多 5 個）。不要一次性輸出所有問題。應用這些約束：
    - 整個會話總共最多 10 個問題。
    - 每個問題必須可以通過以下方式之一回答：
       * 簡短的多選選擇（2–5 個不同的、互斥的選項），或
       * 一字/簡短片語答案（明確約束："以 <=5 個字回答"）。
    - 僅包含答案實質影響架構、資料建模、任務分解、測試設計、UX 行為、運營準備或合規驗證的問題。
    - 確保類別覆蓋平衡：嘗試首先覆蓋最高影響的未解決類別；避免在單一高影響領域（例如：安全態勢）未解決時提出兩個低影響問題。
    - 排除已回答的問題、瑣碎的風格偏好，或計劃級別的執行細節（除非阻礙正確性）。
    - 偏好能減少下游重工風險或防止驗收測試錯位的澄清。
    - 如果超過 5 個類別仍未解決，通過（影響 * 不確定性）啟發式選擇前 5 個。

4. 循序提問迴圈（互動式）：
    - 每次精確呈現一個問題。
    - 對於多選問題，以 Markdown 表格呈現選項：

       | 選項 | 描述 |
       |------|------|
       | A | <選項 A 描述> |
       | B | <選項 B 描述> |
       | C | <選項 C 描述> | （視需要新增 D/E，最多 5 個）
       | 簡短 | 提供不同的簡短答案（<=5 個字） | （僅在自由格式替代方案適當時包含）

    - 對於簡答風格（沒有有意義的離散選項），在問題後輸出單行：`格式：簡短答案（<=5 個字）`。
    - 使用者回答後：
       * 驗證答案映射到一個選項或符合 <=5 個字約束。
       * 如果歧義，請求快速釐清（計數仍屬於相同問題；不推進）。
       * 一旦滿意，在工作記憶中記錄（尚未寫入磁碟）並移到下一個排隊問題。
    - 在以下情況停止提出進一步問題：
       * 所有關鍵歧義提前解決（剩餘排隊項目變得不需要），或
       * 使用者發出完成訊號（"done"、"good"、"no more"），或
       * 達到 5 個已問問題。
    - 永遠不要提前揭露未來的排隊問題。
    - 如果開始時沒有有效問題，立即報告沒有關鍵歧義。

5. 每個接受答案後的整合（增量更新方法）：
    - 維護記憶體中的規格表示（開始時載入一次）加上原始檔案內容。
    - 對於此會話中的第一個整合答案：
       * 確保存在 `## Clarifications` 部分（如果缺失，按照規格模板在最高層級的上下文/概覽部分後立即建立）。
       * 在其下，建立（如果不存在）今天的 `### Session YYYY-MM-DD` 子標題。
    - 在接受後立即附加項目符號行：`- Q: <問題> → A: <最終答案>`。
    - 然後立即將澄清應用到最合適的部分：
       * 功能歧義 → 更新或在功能需求中新增項目符號。
       * 使用者互動/角色區分 → 更新使用者故事或角色子部分（如果存在），包含澄清的角色、約束或場景。
       * 資料形狀/實體 → 更新資料模型（新增欄位、類型、關係），保留順序；簡潔註記新增的約束。
       * 非功能約束 → 在非功能/品質屬性部分新增/修改可衡量標準（將模糊形容詞轉換為指標或明確目標）。
       * 邊界案例/負面流程 → 在邊界案例/錯誤處理下新增項目符號（或如果模板提供占位符則建立此子部分）。
       * 術語衝突 → 在規格中標準化術語；如有必要僅保留原始術語一次，新增 `(formerly referred to as "X")`。
    - 如果澄清使較早的歧義陳述失效，替換該陳述而不是重複；不留下過時的矛盾文字。
    - 在每次整合後儲存規格檔案，以最小化上下文遺失風險（原子覆蓋）。
    - 保留格式：不要重新排序不相關的部分；保持標題層次結構完整。
    - 保持每個插入的澄清最小且可測試（避免敘述漂移）。

6. 驗證（在每次寫入後執行，加上最終通過）：
   - 澄清會話包含每個接受答案精確一個項目符號（無重複）。
   - 總問（接受）問題 ≤ 5。
   - 更新部分不包含新答案本應解決的殘留模糊占位符。
   - 沒有矛盾的較早陳述保留（掃描已移除的現在無效的替代選擇）。
   - Markdown 結構有效；僅允許新增標題：`## Clarifications`、`### Session YYYY-MM-DD`。
   - 術語一致性：在所有更新部分使用相同的標準術語。

7. 將更新的規格寫回 `FEATURE_SPEC`。

8. 報告完成（提問迴圈結束或提前終止後）：
   - 問題數量已問及已答。
   - 更新規格的路徑。
   - 觸及的部分（列出名稱）。
   - 覆蓋摘要表格，列出每個分類法類別的狀態：Resolved（曾是 Partial/Missing 且已處理）、Deferred（超過問題配額或更適合規劃）、Clear（已經足夠）、Outstanding（仍為 Partial/Missing 但低影響）。
   - 如果任何 Outstanding 或 Deferred 保留，建議是否繼續 `/speckit.plan` 或稍後在計劃後再次執行 `/speckit.clarify`。
   - 建議的下一個命令。

行為規則：
- 如果未發現有意義的歧義（或所有潛在問題都是低影響），回應："未偵測到值得正式澄清的關鍵歧義。"並建議繼續。
- 如果規格檔案缺失，指示使用者先執行 `/speckit.specify`（不要在此建立新規格）。
- 永遠不要超過總共 5 個已問問題（單一問題的澄清重試不算新問題）。
- 避免推測性技術棧問題，除非缺失阻礙功能清晰度。
- 尊重使用者的提前終止訊號（"stop"、"done"、"proceed"）。
- 如果因為完整覆蓋而沒有提出問題，輸出緊湊的覆蓋摘要（所有類別 Clear），然後建議推進。
- 如果達到配額但仍有未解決的高影響類別，明確在 Deferred 下標記它們並說明理由。

優先排序的上下文：{ARGS}
