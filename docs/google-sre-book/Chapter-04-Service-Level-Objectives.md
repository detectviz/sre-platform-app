# 服務水準目標 (Service Level Objectives)

作者：Chris Jones、John Wilkes 和 Niall Murphy 與 Cody Smith  編輯：Betsy Beyer

如果不了解哪些行為對服務真正重要，以及如何衡量和評估這些行為，就不可能正確地管理服務，更不用說管理好服務了。為此，我們希望為我們的用戶定義並提供給定的服務水平，無論他們使用的是內部 API 還是公開產品。

我們利用直覺、經驗和對用戶需求的理解來定義**服務水準指標 (service level indicators, SLIs)**、**目標 (objectives, SLOs)** 和**協議 (agreements, SLAs)**。這些衡量標準描述了重要指標的基本屬性、我們希望這些指標具有什麼樣的值，以及如果我們無法提供預期服務時我們將如何應對。最終，選擇適當的指標有助於在出現問題時推動正確的行動，並給予 SRE 團隊信心，確信服務是健康的。

本章描述了我們用來解決指標建模、指標選擇和指標分析問題的框架。如果沒有範例，大部分解釋將會非常抽象，因此我們將使用「莎士比亞：一個範例服務」中概述的莎士比亞服務來說明我們的要點。

## 服務水準術語

許多讀者可能熟悉 SLA 的概念，但 SLI 和 SLO 這兩個術語也值得仔細定義，因為在通用術語中，SLA 這個詞被過度使用，並根據上下文具有多種含義。為了清晰起見，我們更喜歡區分這些含義。

## 指標 (Indicators)

**SLI** 是**服務水準指標 (service level indicator)**——對所提供服務水平的某個方面進行的精心定義的量化衡量。

大多數服務都將**請求延遲 (request latency)**——即返回請求回應所需的時間——視為一個關鍵的 SLI。其他常見的 SLI 包括**錯誤率 (error rate)**，通常表示為所有收到請求的一部分，以及**系統吞吐量 (system throughput)**，通常以每秒請求數來衡量。這些測量值通常是匯總的：即，在一個測量窗口內收集原始資料，然後轉化為速率、平均值或百分位數。

理想情況下，SLI 直接衡量感興趣的服務水平，但有時只能使用代理指標，因為期望的衡量可能難以獲得或解釋。例如，客戶端延遲通常是與用戶更相關的指標，但可能只能在伺服器端測量延遲。

對 SRE 而言，另一種重要的 SLI 是**可用性 (availability)**，即可用服務時間的比例。它通常以成功處理的格式正確的請求的比例來定義，有時稱為**產出 (yield)**。（對於資料儲存系統，**持久性 (durability)**——即資料在長時間內被保留的可能性——同樣重要。）雖然 100% 的可用性是不可能的，但接近 100% 的可用性通常很容易實現，業界通常用可用性百分比中的「九」的數量來表示高可用性值。例如，99% 和 99.999% 的可用性可分別稱為「2 個九」和「5 個九」的可用性，而目前公佈的 Google Compute Engine 可用性目標是「三個半九」——99.95% 的可用性。

## 目標 (Objectives)

**SLO** 是**服務水準目標 (service level objective)**：由 SLI 衡量的服務水平的目標值或值範圍。因此，SLO 的一個自然結構是 SLI ≤ 目標，或下限 ≤ SLI ≤ 上限。例如，我們可能會決定我們將「快速」返回莎士比亞搜索結果，採納一個 SLO，即我們的平均搜索請求延遲應小於 100 毫秒。

選擇一個合適的 SLO 是複雜的。首先，您並不總能選擇它的值！對於從外部世界到您服務的傳入 HTTP 請求，每秒查詢次數 (QPS) 指標基本上是由您的用戶的意願決定的，您無法真正為此設定一個 SLO。

另一方面，您可以說您希望每個請求的平均延遲低於 100 毫秒，設定這樣的目標反過來可能會激勵您編寫具有各種低延遲行為的前端，或者購買某些類型的低延遲設備。（100 毫秒顯然是一個任意值，但總的來說，較低的延遲數字是好的。有充分的理由相信快比慢好，而且用戶體驗到的延遲超過某些值實際上會趕走人們——更多細節請參閱「速度很重要 (Speed Matters)」[Bru09]。）

再次強調，這比乍看之下更為微妙，因為這兩個 SLI——QPS 和延遲——可能在幕後相互關聯：較高的 QPS 通常會導致較大的延遲，而且服務在超過某個負載閾值後出現性能懸崖是很常見的。

向用戶選擇並發布 SLO 可以設定對服務將如何表現的期望。這種策略可以減少用戶對服務所有者的無端抱怨，例如，關於服務緩慢的抱怨。如果沒有明確的 SLO，用戶通常會對期望的性能產生自己的信念，這可能與設計和運營服務的人所持有的信念無關。這種動態可能導致對服務的過度依賴，當用戶錯誤地認為服務會比實際更可用時（就像 Chubby 發生的那樣：請參閱「全球 Chubby 計劃性中斷」），以及依賴不足，當潛在用戶認為系統比實際更不穩定和不可靠時。

作者：Marc Alvidrez

Chubby [Bur06] 是 Google 用於鬆散耦合分散式系統的鎖服務。在全球案例中，我們分發 Chubby 實例，使得每個副本都位於不同的地理區域。隨著時間的推移，我們發現全球 Chubby 實例的故障持續引發服務中斷，其中許多對終端用戶是可見的。事實證明，真正的全球 Chubby 中斷非常罕見，以至於服務所有者開始在假設它永遠不會宕機的情況下增加對 Chubby 的依賴。其高可靠性提供了一種虛假的安全感，因為當 Chubby 不可用時，服務無法正常運行，無論這種情況多麼罕見。

這個 Chubby 場景的解決方案很有趣：SRE 確保全球 Chubby 達到但不會顯著超過其服務水準目標。在任何給定的季度，如果沒有真正的故障將可用性降至目標以下，就會通過故意關閉系統來合成一次受控的中斷。通過這種方式，我們能夠在不合理的依賴被添加到 Chubby 後不久就將其清除。這樣做迫使服務所有者遲早要面對分散式系統的現實。

## 協議 (Agreements)

最後，**SLA** 是**服務水準協議 (service level agreements)**：與您的用戶簽訂的明確或隱含的合約，其中包括滿足（或未滿足）其中包含的 SLO 的後果。當後果是金錢上的——回扣或罰款——時，最容易識別，但它們也可以採取其他形式。區分 SLO 和 SLA 的一個簡單方法是問「如果 SLO 未被滿足會發生什麼？」：如果沒有明確的後果，那麼您幾乎肯定是在看一個 SLO。16

SRE 通常不參與制定 SLA，因為 SLA 與業務和產品決策密切相關。然而，SRE 確實參與幫助避免觸發未滿足 SLO 的後果。他們還可以幫助定義 SLI：協議中顯然需要一種客觀的方式來衡量 SLO，否則會產生分歧。

Google 搜尋是一個沒有對公眾提供 SLA 的重要服務的例子：我們希望每個人都能盡可能流暢高效地使用搜尋，但我們沒有與全世界簽訂合約。即便如此，如果搜尋不可用，仍然會產生後果——不可用會導致我們的聲譽受損，以及廣告收入下降。許多其他 Google 服务，例如 Google for Work，確實與其用戶簽訂了明確的 SLA。無論特定服務是否有 SLA，定義 SLI 和 SLO 並使用它們來管理服務都是有價值的。

理論就到此為止——現在來談談實踐。

# 實踐中的指標

鑑於我們已經說明了為什麼選擇適當的指標來衡量您的服務很重要，您如何著手確定哪些指標對您的服務或系統有意義？

## 您和您的用戶關心什麼？

您不應該將監控系統中可以跟踪的每個指標都用作 SLI；了解您的用戶希望從系統中得到什麼，將有助於明智地選擇幾個指標。選擇過多的指標會使得難以對真正重要的指標給予適當的關注，而選擇過少的指標可能會讓您系統的重要行為未被檢視。我們通常發現，少數幾個有代表性的指標足以評估和推斷系統的健康狀況。

就其相關的 SLI 而言，服務往往可分為幾個大類：

- **面向用戶的服務型系統**，例如莎士比亞搜索前端，通常關心**可用性 (availability)**、**延遲 (latency)** 和**吞吐量 (throughput)**。換句話說：我們能回應請求嗎？回應需要多長時間？可以處理多少個請求？
- **儲存系統**通常強調**延遲 (latency)**、**可用性 (availability)** 和**持久性 (durability)**。換句話說：讀取或寫入資料需要多長時間？我們能按需存取資料嗎？當我們需要時，資料還在嗎？有關這些問題的擴展討論，請參閱「資料完整性：所讀即所寫」。
- **大數據系統**，例如資料處理管線，往往關心**吞吐量 (throughput)** 和**端到端延遲 (end-to-end latency)**。換句話說：正在處理多少資料？資料從擷取到完成需要多長時間？（一些管線也可能對單個處理階段的延遲有目標。）
- **所有系統**都應關心**正確性 (correctness)**：是否返回了正確的答案，檢索了正確的資料，進行了正確的分析？即使正確性通常是系統中資料的屬性，而不是基礎設施本身的屬性，因此通常不是 SRE 的責任，但將其作為系統健康狀況的指標來跟踪仍然很重要。

## 收集指標

許多指標指標最自然地是在伺服器端收集的，使用像 Borgmon（請參閱「來自時間序列資料的實用警報」）或 Prometheus 這樣的監控系統，或者通過定期的日誌分析——例如，HTTP 500 回應佔所有請求的比例。然而，有些系統應該配備**客戶端 (client)** 收集，因為不衡量客戶端的行為可能會錯過一系列影響用戶但不會影響伺服器端指標的問題。例如，專注於莎士比亞搜索後端的響應延遲可能會錯過由於頁面 JavaScript 問題導致的用戶延遲不佳：在這種情況下，衡量頁面在瀏覽器中變得可用所需的時間是更好地代表用戶實際體驗的代理指標。

## 匯總

為了簡單和可用性，我們經常匯總原始測量值。這需要小心進行。

有些指標看似簡單，比如每秒服務的請求數，但即使是這個看似簡單的測量也隱含地在測量窗口內匯總了資料。這個測量是每秒獲取一次，還是在一分鐘內平均請求數？後者可能會隱藏在僅持續幾秒鐘的突發流量中更高的瞬時請求率。考慮一個在偶數秒服務 200 個請求/秒，在其他秒服務 0 個請求/秒的系統。它的平均負載與一個持續服務 100 個請求/秒的系統相同，但其瞬時負載是平均負載的兩倍。同樣，平均請求延遲可能看起來很有吸引力，但它掩蓋了一個重要的細節：絕大多數請求可能很快，但很長的請求尾巴可能要慢得多，慢得多。

將大多數指標視為分佈而不是平均值會更好。例如，對於一個延遲 SLI，一些請求會被快速服務，而另一些則不可避免地需要更長的時間——有時要長得多。一個簡單的平均值可能會掩蓋這些尾部延遲，以及它們的變化。圖 4-1 提供了一個例子：儘管一個典型的請求在約 50 毫秒內被服務，但 5% 的請求要慢 20 倍！僅基於平均延遲的監控和警報在一天中不會顯示出行為的任何變化，而實際上尾部延遲（最上面的線）存在顯著的變化。

使用百分位數作為指標可以讓您考慮分佈的形狀及其不同的屬性：一個高階百分位數，例如第 99 或 99.9 個百分位數，向您展示了一個合理的「最壞情況」值，而使用第 50 個百分位數（也稱為中位數）則強調了典型情況。響應時間的方差越大，典型用戶體驗受長尾行為的影響就越大，這種效應在高負載下因排隊效應而加劇。用戶研究表明，人們通常更喜歡一個稍慢的系統，而不是一個響應時間方差很大的系統，所以一些 SRE 團隊只關注高百分位數值，理由是如果第 99.9 個百分位數的行為是好的，那麼典型體驗肯定也會是好的。

我們通常更喜歡使用百分位數而不是一組值的平均值（算術平均值）。這樣做可以考慮到資料點的長尾，這些資料點通常具有與平均值顯著不同（且更有趣）的特徵。由於計算系統的人為性質，資料點通常是偏斜的——例如，沒有請求可以在小於 0 毫秒的時間內得到響應，而 1000 毫秒的超時意味著不可能有大於超時值的成功響應。因此，我們不能假設平均值和中位數是相同甚至接近的！

我們盡量不假設我們的資料是常態分佈的，除非我們先進行驗證，以防一些標準的直覺和近似值不成立。例如，如果分佈不如預期，一個在看到異常值時採取行動的程序（例如，重新啟動請求延遲高的伺服器）可能會過於頻繁或不夠頻繁地這樣做。

## 標準化指標

我們建議您為 SLI 標準化通用定義，這樣您就不必每次都從第一性原理來推理它們。任何符合標準定義模板的特性都可以從單個 SLI 的規範中省略，例如：

- **匯總間隔**：「在 1 分鐘內平均」
- **匯總區域**：「叢集中的所有任務」
- **測量頻率**：「每 10 秒」
- **包含哪些請求**：「來自黑盒監控工作的 HTTP GET」
- **資料獲取方式**：「通過我們的監控，在伺服器端測量」
- **資料存取延遲**：「到最後一個位元組的時間」

為了節省精力，為每個通用指標建立一組可重用的 SLI 範本；這也讓每個人更容易理解特定 SLI 的含義。

# 實踐中的目標

從思考（或找出！）您的用戶關心什麼開始，而不是您能測量什麼。通常，您的用戶關心的東西很難或不可能測量，所以您最終會以某種方式近似用戶的需求。然而，如果您只是從容易測量的東西開始，您最終會得到較不有用的 SLO。因此，我們有時發現，從期望的目標反向推導到具體的指標，比選擇指標然後想出目標效果更好。

## 定義目標

為了最大程度的清晰，SLO 應指明它們是如何被測量的，以及它們有效的條件。例如，我們可以這樣說（第二行與第一行相同，但依賴於上一節的 SLI 預設值以消除冗餘）：

- 99%（在 1 分鐘內平均）的 Get RPC 呼叫將在小於 100 毫秒內完成（在所有後端伺服器上測量）。
- 99% 的 Get RPC 呼叫將在小於 100 毫秒內完成。

如果性能曲線的形狀很重要，那麼您可以指定多個 SLO 目標：

- 90% 的 Get RPC 呼叫將在小於 1 毫秒內完成。
- 99% 的 Get RPC 呼叫將在小於 10 毫秒內完成。
- 99.9% 的 Get RPC 呼叫將在小於 100 毫秒內完成。

如果您有異質工作負載的用戶，例如關心吞吐量的批次處理管線和關心延遲的互動式客戶端，那麼為每類工作負載定義單獨的目標可能是合適的：

- 95% 的吞吐量客戶端的 Set RPC 呼叫將在 < 1 秒內完成。
- 99% 的延遲客戶端的 Set RPC 呼叫（負載 < 1 kB）將在 < 10 毫秒內完成。

堅持 SLO 將 100% 的時間被滿足既不切實際也不可取：這樣做會降低創新和部署的速度，需要昂貴、過於保守的解決方案，或兩者兼而有之。相反，最好是允許一個**錯誤預算 (error budget)**——一個可以錯過 SLO 的比率——並每天或每週跟踪它。高層管理人員可能也需要每月或每季度的評估。（錯誤預算只是滿足其他 SLO 的一個 SLO！）

SLO 違規率可以與錯誤預算進行比較（請參閱「錯誤預算的動機」），其差距可用作決定何時推出新版本的過程的輸入。

## 選擇目標

選擇目標 (SLO) 並非純粹的技術活動，因為它涉及產品和業務的影響，這些影響應反映在所選擇的 SLI 和 SLO（以及可能的 SLA）中。同樣，可能需要在人員配置、上市時間、硬體可用性和資金等約束條件下，權衡某些產品屬性與其他屬性。雖然 SRE 應該參與這場對話，並就不同選項的風險和可行性提供建議，但我們已經學到了一些教訓，可以幫助使這場討論更富有成效：

SLO 可以而且應該是 SRE 和產品開發人員優先安排工作的主要驅動力，因為它們反映了用戶關心的東西。一個好的 SLO 對開發團隊來說是一個有幫助的、合法的強制功能。但一個考慮不周的 SLO 可能會導致工作浪費，如果團隊為了達到一個過於激進的 SLO 而付出巨大努力，或者如果 SLO 太寬鬆，則會導致產品糟糕。SLO 是一個巨大的槓桿：請明智地使用它們。

## 控制措施

SLI 和 SLO 是用於管理系統的控制迴路中的關鍵元素：

1.  **監控和測量**系統的 SLI。
2.  將 SLI 與 SLO **比較**，並決定是否需要採取行動。
3.  如果需要採取行動，**找出**需要做什麼才能達到目標。
4.  **採取**該行動。

例如，如果第 2 步顯示請求延遲正在增加，並且除非採取措施，否則將在幾小時內錯過 SLO，第 3 步可能包括測試伺服器 CPU 受限的假設，並決定增加更多伺服器以分散負載。如果沒有 SLO，您就不知道是否（或何時）需要採取行動。

## SLO 設定期望

發布 SLO 可以設定對系統行為的期望。用戶（和潛在用戶）通常想知道他們可以從服務中期待什麼，以便了解它是否適合他們的用例。例如，一個想建立照片分享網站的團隊可能會想避免使用一個承諾非常強的持久性和低成本以換取稍低可用性的服務，儘管同樣的服務可能非常適合檔案記錄管理系統。

為了為您的用戶設定現實的期望，您可以考慮使用以下一種或兩種策略：

了解一個系統滿足其期望的程度有助於決定是否投資於使系統更快、更可用、更有彈性。或者，如果服務運行良好，也許員工的時間應該花在其他優先事項上，例如償還技術債務、增加新功能或推出其他產品。

# 實踐中的協議

制定 SLA 需要業務和法律團隊為違規選擇適當的後果和懲罰。SRE 的角色是幫助他們了解滿足 SLA 中包含的 SLO 的可能性和難度。許多關於 SLO 制定的建議也適用於 SLA。在向用戶宣傳時保持保守是明智的，因為受眾越廣，就越難更改或刪除那些被證明是不明智或難以實施的 SLA。

16 大多數人說「SLA」時，他們真正的意思是 SLO。一個線索：如果有人談論「SLA 違規」，他們幾乎總是在談論一個錯過的 SLO。真正的 SLA 違規可能會引發因違約而提起的訴訟。

17 如果您在關於 SLO 的對話中永遠無法獲勝，那麼為該產品設立 SRE 團隊可能就不值得了。

18 故障注入 [Ben12] 的目的不同，但也可以幫助設定期望。