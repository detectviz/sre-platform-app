## 前言

作者：Benjamin Treynor Sloss 6  編輯：Betsy Beyer

希望不是一種策略。

傳統 SRE 諺語

眾所周知，系統不會自行運轉。那麼，一個系統——尤其是一個大規模運行的複雜計算系統——應該如何運轉呢？

# 服務管理的系統管理員 (Sysadmin) 方法

過去，公司通常聘請系統管理員來運行複雜的計算系統。

這種系統管理員 (sysadmin) 的方法，是將現有的軟體組件組合起來，並將它們部署在一起以提供服務。系統管理員的任務是運行服務，並在事件和更新發生時做出回應。隨著系統複雜性和流量的增長，事件和更新也相應增加，系統管理員團隊也隨之擴大以應對額外的工作。由於系統管理員的角色所需的技能與產品開發人員的技能截然不同，開發人員和系統管理員被分成了不同的團隊：「開發 (development)」和「運營 (operations)」或「ops」。

系統管理員的服務管理模式有幾個優點。對於決定如何運行和配置服務人力的公司來說，這種方法相對容易實施：作為一個熟悉的行業範例，有許多例子可供學習和模仿。相關的人才庫已經廣泛存在。現有的各種工具、軟體組件（無論是現成的還是其他的）和整合公司都可以幫助運行這些組合系統，因此新手系統管理員團隊不必從頭開始重新設計系統。

系統管理員方法以及隨之而來的開發/運營分離有許多缺點和陷阱。這些大致可分為兩類：直接成本和間接成本。

直接成本既不隱晦也不模糊。當一個服務的團隊依賴手動干預來進行變更管理和事件處理時，隨著服務和/或流量的增長，運行該服務的成本會變得非常昂貴，因為團隊的規模必須與系統產生的負載成比例擴大。

開發/運營分離的間接成本可能很隱晦，但通常對組織來說比直接成本更昂貴。這些成本源於兩個團隊在背景、技能和激勵機制上都截然不同。他們使用不同的詞彙來描述情況；他們對風險和技術解決方案的可能性有不同的假設；他們對產品穩定性的目標水平有不同的假設。團隊之間的分歧很容易不僅僅是激勵機制上的，還會擴展到溝通、目標，並最終影響到信任和尊重。這種結果是一種病態。

因此，傳統的運營團隊和他們的產品開發同事經常發生衝突，最明顯的是在軟體發布到生產環境的速度上。開發團隊的核心目標是推出新功能並看到它們被用戶採用。運營團隊的核心目標是確保在他們負責呼叫器 (pager) 時服務不會中斷。由於大多數服務中斷都是由某種變更引起的——新的配置、新功能的推出或新型的用戶流量——這兩個團隊的目標從根本上是緊張對立的。

兩個團隊都明白，用最直白的語言陳述自己的利益是不可接受的（「我們希望隨時隨地無阻礙地推出任何東西」vs「一旦系統正常工作，我們就不想再對它做任何改變」）。而且由於他們的詞彙和風險假設不同，兩個團隊常常訴諸於一種熟悉的塹壕戰來推進自己的利益。運營團隊試圖通过引入發布和變更的關卡來保護運行中的系統免受變更的風險。例如，發布審查可能包含對過去曾導致服務中斷的每個問題的明確檢查——這可能是一個任意長的列表，並非所有項目都具有同等價值。開發團隊很快就學會了如何應對。他們減少了「發布」，增加了「功能開關」、「增量更新」或「擇優挑選 (cherrypicks)」。他們採取了諸如對產品進行分片 (sharding) 的策略，以便更少的功能需要經過發布審查。

# Google 的服務管理方法：網站可靠性工程 (Site Reliability Engineering)

衝突並非提供軟體服務過程中不可避免的一部分。Google 選擇用一種不同的方法來運行我們的系統：我們的網站可靠性工程 (Site Reliability Engineering) 團隊專注於聘請軟體工程師來運行我們的產品，並創建系統來完成那些原本需要系統管理員（通常是手動）完成的工作。

Google 所定義的網站可靠性工程 (Site Reliability Engineering) 究竟是什麼？我的解釋很簡單：SRE 就是當你讓一位軟體工程師來設計一個運營團隊時所發生的事情。當我 2003 年加入 Google 並被指派管理一個由七名工程師組成的「生產團隊 (Production Team)」時，我之前的人生一直都是軟體工程。所以我按照如果我自己是 SRE 的話，我會希望它如何運作的方式來設計和管理這個團隊。這個團隊後來發展成為 Google 現今的 SRE 團隊，它仍然忠於其作為一個終身軟體工程師所設想的初衷。

Google 服務管理方法的一個主要基石是每個 SRE 團隊的組成。總體而言，SRE 可以分為兩大類。

50-60% 是 Google 軟體工程師，或者更準確地說，是通過 Google 軟體工程師的標準招聘程序招聘的人員。另外 40-50% 的候選人非常接近 Google 軟體工程的資格要求（即所需技能的 85-99%），並且他們還擁有一套對 SRE 有用但在大多數軟體工程師中很罕見的技術技能。到目前為止，UNIX 系統內部原理和網路（第 1 層到第 3 層）的專業知識是我們尋求的兩種最常見的替代技術技能。

所有 SRE 的共同點是，他們都相信並有能力開發軟體系統來解決複雜問題。在 SRE 內部，我們密切關注這兩類工程師的職業發展，迄今為止，我們發現在這兩個軌道上的工程師在表現上沒有實際差異。事實上，SRE 團隊背景的多元化常常能催生出巧妙、高質量的系統，這些系統顯然是多種技能綜合的產物。

我們招聘 SRE 的方法所帶來的結果是，我們最終得到了一個這樣的團隊：(a) 他們會很快對手動執行任務感到厭煩，並且 (b) 他們擁有編寫軟體來取代之前手動工作的必要技能，即使解決方案很複雜。SRE 最終也與開發組織的其他成員擁有共同的學術和知識背景。因此，SRE 基本上是在做歷史上由運營團隊完成的工作，但是使用的是具備軟體專業知識的工程師，並寄望於這些工程師天生就傾向於並且有能力通過軟體設計和實現自動化來取代人力勞動。

從設計上講，SRE 團隊專注於工程是至關重要的。沒有持續的工程投入，運營負擔會增加，團隊將需要更多的人手才能跟上工作量的步伐。最終，一個傳統的以運營為中心的團隊會隨著服務規模的擴大而線性擴展：如果服務所支持的產品成功，運營負載將隨著流量的增長而增長。這意味著需要僱用更多的人來一遍又一遍地做同樣的任務。

為了避免這種命運，負責管理服務的團隊需要編寫程式碼，否則就會被淹沒。因此，Google 為所有 SRE 的「運營」工作設定了 50% 的上限——包括工單、值班、手動任務等。這個上限確保了 SRE 團隊在他們的時間表中有足夠的時間來使服務穩定和可操作。這個上限是一個上限；隨著時間的推移，如果任其發展，SRE 團隊最終應該只有很少的運營負載，幾乎完全從事開發任務，因為服務基本上可以自行運行和修復：我們想要的是**自動 (automatic)** 的系統，而不僅僅是**自動化 (automated)** 的系統。在實踐中，規模和新功能讓 SRE 們時刻保持警惕。

Google 的經驗法則是，SRE 團隊必須將其剩餘的 50% 時間用於實際的開發工作。那麼我們如何執行這個門檻呢？首先，我們必須衡量 SRE 的時間是如何花費的。有了這個衡量標準，我們就能確保那些持續花費不到 50% 時間在開發工作上的團隊改變他們的做法。這通常意味著將部分運營負擔轉移回開發團隊，或者在不為團隊分配額外運營責任的情況下增加團隊人員。有意識地維持運營和開發工作之間的平衡，使我們能夠確保 SRE 有足夠的精力從事創造性的、自主的工程工作，同時仍然保留從運行服務的運營方面獲得的智慧。

我們發現，Google SRE 運行大規模系統的方法有許多優點。因為 SRE 在追求讓 Google 系統自行運轉的過程中直接修改程式碼，SRE 團隊的特點是快速創新和對變革的高度接受。這樣的團隊相對便宜——用一個以運營為導向的團隊來支持同樣的服務將需要多得多的人員。相反，運行、維護和改進一個系統所需的 SRE 數量與系統規模的增長呈次線性關係。最後，SRE 不僅規避了開發/運營分離的功能失調，這種結構還改善了我們的產品開發團隊：產品開發和 SRE 團隊之間的輕鬆調動可以交叉培訓整個團隊，並提高那些原本可能難以學習如何構建百萬核心分散式系統的開發人員的技能。

儘管有這些淨收益，SRE 模型也有其自身的一系列獨特挑戰。Google 持續面臨的一個挑戰是招聘 SRE：SRE 不僅與產品開發的招聘渠道競爭相同的候選人，而且我們在程式碼撰寫和系統工程技能方面都設定了很高的招聘標準，這意味著我們的招聘人才庫必然很小。由於我們的學科相對較新且獨特，業界關於如何建立和管理 SRE 團隊的資訊不多（儘管希望這本書能朝著這個方向邁出一大步！）。一旦 SRE 團隊就位，他們在服務管理方面可能採取的非傳統方法需要強有力的管理層支持。例如，一旦錯誤預算 (error budget) 耗盡，就決定在本季度剩餘時間內停止發布，這樣的決定可能不會被產品開發團隊所接受，除非得到他們管理層的強制要求。

# DevOps 還是 SRE？

「DevOps」一詞於 2008 年末在業界出現，在撰寫本文時（2016 年初）仍處於不斷變化的狀態。其核心原則——IT 職能參與系統設計和開發的每個階段、高度依賴自動化而非人力、將工程實踐和工具應用於運營任務——與 SRE 的許多原則和實踐是一致的。人們可以將 DevOps 視為將幾個核心 SRE 原則推廣到更廣泛的組織、管理結構和人員。同樣地，人們也可以將 SRE 視為 DevOps 的一個特定實現，並帶有一些獨特的擴展。

# SRE 的信條

雖然不同 SRE 團隊的工作流程、優先級和日常運營的細微之處各不相同，但所有團隊都對其支持的服務承擔著一系列基本責任，並遵守相同的核心信條。總體而言，一個 SRE 團隊負責其服務的可用性、延遲、性能、效率、變更管理、監控、緊急應變和容量規劃。我們已經制定了 SRE 團隊如何與其環境互動的參與規則和原則——不僅僅是生產環境，還包括產品開發團隊、測試團隊、用戶等等。這些規則和工作實踐幫助我們將重點放在工程工作上，而不是運營工作上。

以下部分將討論 Google SRE 的每個核心信條。

## 確保對工程的持久專注

如前所述，Google 將 SRE 的運營工作上限定為其時間的 50%。他們剩餘的時間應該用在專案工作上，發揮他們的程式碼撰寫技能。在實踐中，這是通過監控 SRE 正在做的運營工作的數量，並將超額的運營工作重定向到產品開發團隊來實現的：將錯誤和工單重新分配給開發經理，將開發人員[重新]整合到值班呼叫器輪換中，等等。當運營負載降至 50% 或更低時，重定向就會結束。這也提供了一個有效的反饋機制，引導開發人員構建不需要手動干預的系統。當整個組織——SRE 和開發團隊都一樣——都理解為什麼存在安全閥機制，並支持因為產品不會產生足夠的運營負載而不需要它，從而沒有溢出事件的目標時，這種方法效果很好。

當他們專注於運營工作時，SRE 平均每個 8-12 小時的值班班次最多應收到兩個事件。這個目標數量讓值班工程師有足夠的時間準確快速地處理事件，清理並恢復正常服務，然後進行事後檢討 (postmortem)。如果每個值班班次經常發生兩個以上的事件，問題就無法得到徹底調查，工程師也會不堪重負，無法從這些事件中學習。呼叫器疲勞 (pager fatigue) 的情況也不會隨著規模的擴大而改善。相反，如果值班 SRE 持續每個班次收到的事件少於一個，讓他們待命就是浪費時間。

所有重大事件都應撰寫事後檢討，無論是否觸發了呼叫器；未觸發呼叫器的事後檢討更有價值，因為它們可能指向明顯的監控漏洞。這項調查應詳細確定事件的經過，找出事件的所有根本原因，並分配行動來糾正問題或改進下次處理問題的方式。Google 奉行**無指責的事後檢討文化 (blame-free postmortem culture)**，目標是暴露故障並應用工程來修復這些故障，而不是迴避或最小化它們。

## 在不違反服務 SLO 的前提下追求最快的變更速度

產品開發和 SRE 團隊可以通過消除各自目標中的結構性衝突來建立富有成效的工作關係。結構性衝突存在於創新速度和產品穩定性之間，如前所述，這種衝突通常是間接表現出來的。在 SRE 中，我們將這種衝突擺到檯面上，然後通過引入**錯誤預算 (error budget)** 來解決它。

錯誤預算源於這樣一種觀察：對於幾乎所有事情來說，100% 都是錯誤的可靠性目標（心律調節器和防鎖死煞車是顯著的例外）。一般來說，對於任何軟體服務或系統，100% 都不是正確的可靠性目標，因為沒有用戶能分辨出一個系統是 100% 可用還是 99.999% 可用。在用戶和服務之間還有許多其他系統（他們的筆記型電腦、家裡的 WiFi、他們的 ISP、電網……），這些系統的總體可用性遠低於 99.999%。因此，99.999% 和 100% 之間的邊際差異在其他不可用性的噪音中消失了，用戶無法從為增加最後 0.001% 的可用性而付出的巨大努力中獲得任何好處。

如果 100% 是系統錯誤的可靠性目標，那麼，什麼才是系統正確的可靠性目標呢？這其實根本不是一個技術問題——這是一個產品問題，應該考慮以下因素：

- 考慮到用戶使用產品的方式，什麼樣的可用性水平會讓他們滿意？
- 對產品可用性不滿意的用戶有哪些替代選擇？
- 在不同的可用性水平下，用戶對產品的使用情況會發生什麼變化？

業務或產品部門必須確定系統的可用性目標。一旦確定了該目標，錯誤預算就是 1 減去可用性目標。一個 99.99% 可用的服務有 0.01% 的不可用時間。這允許的 0.01% 的不可用時間就是服務的**錯誤預算 (error budget)**。只要我們不超支，我們可以把這個預算花在任何我們想花的地方。

那麼我們想如何使用錯誤預算呢？開發團隊希望推出新功能並吸引新用戶。理想情況下，我們會將所有的錯誤預算都用於承擔發布時的風險，以便更快地推出。這個基本前提描述了整個錯誤預算模型。一旦 SRE 的活動在這個框架下被概念化，通過諸如分階段推出和 1% 實驗等策略來釋放錯誤預算，就可以優化以實現更快的發布。

使用錯誤預算解決了開發和 SRE 之間激勵機制的結構性衝突。SRE 的目標不再是「零中斷」；相反，SRE 和產品開發人員的目標是花費錯誤預算以獲得最大的功能發布速度。這個改變帶來了天壤之別。中斷不再是一件「壞」事——它是創新過程中預期的一部分，也是開發和 SRE 團隊共同管理而非恐懼的事件。

## 監控

監控是服務所有者跟踪系統健康狀況和可用性的主要手段之一。因此，監控策略應經過深思熟慮。一個典型且常見的監控方法是觀察某個特定值或條件，然後在該值被超出或該條件發生時觸發電子郵件警報。然而，這種類型的電子郵件警報並不是一個有效的解決方案：一個需要人類閱讀電子郵件並決定是否需要採取某種行動的系統，從根本上就是有缺陷的。監控絕不應要求人類來解釋警報域的任何部分。相反，應該由軟體來進行解釋，只有在需要人類採取行動時才通知他們。

有三種有效的監控輸出：

## 緊急應變

可靠性是平均無故障時間 (MTTF) 和平均修復時間 (MTTR) 的函數 [Sch15]。在評估緊急應變有效性方面，最相關的指標是應變團隊能夠多快地將系統恢復到健康狀態——也就是 MTTR。

人會增加延遲。即使某個系統實際故障更多，一個能夠避免需要人為干預的緊急情況的系統，其可用性也會高於需要手動干預的系統。當需要人為干預時，我們發現，事先在「劇本 (playbook)」中思考並記錄下最佳實踐，與「隨機應變」的策略相比，MTTR 大約能提高 3 倍。英雄般的萬事通值班工程師確實能解決問題，但配備了劇本且訓練有素的值班工程師效果要好得多。雖然沒有任何劇本，無論多麼全面，可以替代能夠隨機應變的聰明工程師，但在應對高風險或時間緊迫的呼叫時，清晰透徹的故障排除步驟和提示非常有價值。因此，Google SRE 依靠值班劇本，以及諸如「厄運之輪 (Wheel of Misfortune)」7 等演習，來讓工程師為應對值班事件做好準備。

## 變更管理

SRE 發現，大約 70% 的服務中斷是由於對線上系統的變更引起的。該領域的最佳實踐是使用自動化來完成以下工作：

- 實施漸進式部署
- 快速準確地檢測問題
- 在出現問題時安全地回滾變更

這三項實踐有效地將暴露於不良變更的用戶和操作的總數降至最低。通過將人從流程中移除，這些實踐避免了疲勞、熟悉/輕視以及對高度重複性任務注意力不集中的常見問題。結果是，發布速度和安全性都得到了提高。

## 需求預測和容量規劃

需求預測和容量規劃可以被視為確保有足夠的容量和冗餘，以滿足預期的未來需求並達到所需的可用性。這些概念本身並沒有什麼特別之處，只是令人驚訝的是，許多服務和團隊沒有採取必要的步驟來確保在需要時及時部署所需的容量。容量規劃應同時考慮有機增長（源於客戶對產品的自然採用和使用）和無機增長（源於功能發布、行銷活動或其他業務驅動的變更等事件）。

在容量規劃中有幾個步驟是強制性的：

- 一個準確的有機需求預測，其時間範圍應超過獲取容量所需的前置時間
- 將無機需求來源準確地納入需求預測
- 定期對系統進行負載測試，以將原始容量（伺服器、磁盤等）與服務容量關聯起來

由於容量對可用性至關重要，因此 SRE 團隊自然必須負責容量規劃，這也意味著他們也必須負責資源配置。

## 資源配置 (Provisioning)

資源配置結合了變更管理和容量規劃。根據我們的經驗，資源配置必須迅速且僅在必要時進行，因為容量是昂貴的。這項工作也必須正確完成，否則容量在需要時無法正常工作。增加新容量通常涉及啟動一個新的實例或地點，對現有系統進行重大修改（配置文件、負載均衡器、網路），並驗證新容量的性能和結果是否正確。因此，這是一項比負載轉移風險更高的操作，後者通常每小時進行多次，必須以相應的額外謹慎對待。

## 效率和性能

只要服務關心成本，有效利用資源就很重要。由於 SRE 最終控制著資源配置，因此它也必須參與任何關於利用率的工作，因為利用率是給定服務如何工作以及如何配置的函數。因此，密切關注服務的資源配置策略，進而關注其利用率，可以對服務的總成本產生非常非常大的影響。

資源使用是需求（負載）、容量和軟體效率的函數。SRE 預測需求、配置容量，並可以修改軟體。這三個因素是服務效率的很大一部分（儘管不是全部）。

隨著負載的增加，軟體系統會變慢。服務變慢相當於容量損失。在某個點上，一個變慢的系統會停止服務，這對應於無限的緩慢。SRE 進行資源配置是為了在特定的響應速度下達到容量目標，因此對服務的性能非常感興趣。SRE 和產品開發人員將（也應該）監控和修改服務以提高其性能，從而增加容量並提高效率。8

# 結束的開始

網站可靠性工程 (Site Reliability Engineering) 代表了與現有行業管理大型複雜服務的最佳實踐的重大突破。最初的動機是出於熟悉——「作為一名軟體工程師，這就是我希望如何投入時間來完成一系列重複性任務的方式」——現在它已經變得更多：一套原則、一套實踐、一套激勵機制，以及在更廣泛的軟體工程學科中的一個奮鬥領域。本書的其餘部分將詳細探討 SRE 的方式。

6 Google 工程副總裁，Google SRE 創始人

7 請參閱「災難角色扮演 (Disaster Role Playing)」。

8 關於這種協作在實踐中如何運作的進一步討論，請參閱「溝通：生產會議 (Communications: Production Meetings)」。