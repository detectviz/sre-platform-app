# 追蹤服務中斷

作者：Gabe Krabbe 編輯：Lisa Carey

只有當您從一個已知的基線開始，並能夠追蹤進度時，才有可能隨著時間的推移提高可靠性。「Outalator」，我們的中斷追蹤器，是我們用來做到這一點的工具之一。Outalator 是一個被動接收我們監控系統發送的所有警報的系統，並允許我們對這些資料進行註釋、分組和分析。

系統地從過去的問題中學習，對於有效的服務管理至關重要。事後檢討（請參閱「事後檢討文化：從失敗中學習」）為個別中斷提供了詳細資訊，但它們只是答案的一部分。它們只針對影響重大的事件撰寫，因此那些個別影響小但頻繁且廣泛的問題不在其範圍內。同樣地，事後檢討傾向於為改善單一服務或一組服務提供有用的見解，但可能會錯失在個別案例中影響較小，或成本效益比較差，但卻具有巨大橫向影響的機會。84

我們也可以從諸如「這個團隊每個值班班次會收到多少警報？」、「上個季度可操作/不可操作警報的比例是多少？」或甚至只是「這個團隊管理的服務中，哪個製造了最多的瑣務？」等問題中獲得有用的資訊。

## Escalator

在 Google，所有 SRE 的警報通知都共享一個中央複製系統，該系統跟踪是否有人確認收到通知。如果在配置的時間間隔後沒有收到確認，系統會將其升級到下一個配置的目的地——例如，從主要值班人員到次要值班人員。這個名為「The Escalator」的系統，最初被設計成一個基本上透明的工具，它接收發送到值班別名的電子郵件副本。這個功能讓 Escalator 能夠輕鬆地與現有的工作流程整合，而無需用戶行為（或當時的監控系統行為）有任何改變。

# Outalator

繼 Escalator 的例子之後，我們在現有基礎設施上增加了有用的功能，我們創建了一個不僅處理單個升級通知，而且處理下一層抽象的系統：**中斷 (outages)**。

Outalator 讓用戶可以一次性查看多個佇列的時間交錯的通知列表，而不需要用戶手動在佇列之間切換。圖 16-1 顯示了多個佇列在 Outalator 的佇列視圖中的樣子。這個功能很方便，因為通常一個 SRE 團隊是具有不同次要升級目標（通常是開發團隊）的服務的主要聯繫點。

Outalator 儲存原始通知的副本，並允許對事件進行註釋。為方便起見，它還會靜默地接收並保存任何電子郵件回覆的副本。因為有些後續回覆不如其他的有幫助（例如，一個僅僅為了將更多收件人添加到抄送列表而發送的「全部回覆」），註釋可以被標記為「重要」。如果一個註釋很重要，訊息的其他部分會在介面中被折疊起來以減少混亂。總的來說，這在引用一個事件時，比一個可能支離破碎的電子郵件線程提供了更多的上下文。

多個升級通知（「警報」）可以在 Outalator 中被組合成一個單一的實體（「事件」）。這些通知可能與同一個單一事件相關，也可能是其他不相關且無趣的可審計事件，例如特權資料庫存取，或者是虛假的監控故障。這種分組功能，如圖 16-2 所示，可以整理概覽顯示，並允許對「每天的事件數」與「每天的警報數」進行單獨分析。

許多組織使用像 Slack、Hipchat 或甚至 IRC 這樣的訊息系統進行內部溝通和/或更新狀態儀表板。這些系統是與像 Outalator 這樣的系統進行掛鉤的好地方。

## 匯總

單一事件可能，而且通常會，觸發多個警報。例如，網路故障會導致所有人的後端服務超時和無法連線，因此所有受影響的團隊都會收到他們自己的警報，包括後端服務的所有者；與此同時，網路運營中心的警報器也會響個不停。然而，即使是影響單一服務的較小問題，也可能因為診斷出多個錯誤條件而觸發多個警報。雖然嘗試最小化由單一事件觸發的警報數量是值得的，但在誤報和漏報之間的權衡計算中，觸發多個警報是不可避免的。

將多個警報組合成一個單一事件的能力，對於處理這種重複至關重要。發送一封電子郵件說「這和那件事是同一件事；它們是同一事件的症狀」對於給定的警報是有效的：它可以防止重複的除錯或恐慌。但是為每個警報都發送一封電子郵件，並不是在一個團隊內部，更不用說在團隊之間或更長的時間段內處理重複警報的實用或可擴展的解決方案。

## 標籤

當然，並非每個警報事件都是一個事件。也會出現誤報警報，以及測試事件或來自人類的錯誤目標電子郵件。Outalator 本身並不區分這些事件，但它允許通用的**標籤 (tagging)** 在任何層級上為通知添加元資料。標籤大多是自由形式的單個「單詞」。然而，冒號被解釋為語義分隔符，這巧妙地促進了分層命名空間的使用，並允許一些自動處理。這種命名空間由建議的標籤前綴支持，主要是「cause」和「action」，但列表是特定於團隊的，並根據歷史使用情況生成。例如，「cause:network」對於某些團隊來說可能足夠了，而另一個團隊可能會選擇更具體的標籤，例如「cause:network:switch」與「cause:network:cable」。一些團隊可能經常使用「customer:132456」風格的標籤，因此「customer」會被建議給那些團隊，但不會建議給其他團隊。

標籤可以被解析並轉換成一個方便的連結（「bug:76543」連結到錯誤跟踪系統）。其他標籤只是一個單詞（「bogus」被廣泛用於誤報）。當然，有些標籤是拼寫錯誤（「cause:netwrok」），有些標籤不是特別有幫助（「problem-went-away」），但避免一個預定的列表，並允許團隊找到他們自己的偏好和標準，將會產生一個更有用的工具和更好的資料。總的來說，標籤已經成為一個非常強大的工具，讓團隊能夠獲取並提供一個關於給定服務痛點的概覽，即使沒有太多，甚至沒有任何正式的分析。儘管標籤看起來微不足道，但它可能是 Outalator 最有用的獨特功能之一。

## 分析

當然，SRE 所做的不僅僅是應對事件。歷史資料在應對事件時很有用——「我們上次是怎麼做的？」這個問題總是一個很好的起點。但歷史資訊在涉及系統性、週期性或其他更廣泛的可能存在的問題時，則更有用。啟用此類分析是中斷追蹤工具最重要的功能之一。

分析的底層包括計數和用於報告的基本匯總統計。細節取決于團隊，但包括諸如每週/每月/每季度的事件數和每個事件的警報數等資訊。下一層更重要，也更容易提供：在團隊/服務之間以及隨時間進行比較，以識別初步的模式和趨勢。這一層讓團隊能夠確定給定的警報負載相對於他們自己的記錄和其他服務的記錄是否「正常」。「這周已經是第三次了」可能是好事也可能是壞事，但知道「它」以前是每天發生五次還是一個月發生五次，可以幫助解釋。

資料分析的下一步是發現更廣泛的問題，這些問題不僅僅是原始計數，還需要一些語義分析。例如，識別導致大多數事件的基礎設施組件，並因此識別提高該組件穩定性或性能的潛在好處，85 假設有一種直接的方法可以在事件記錄旁邊提供這些資訊。舉個簡單的例子：不同的團隊有特定於服務的警報條件，例如「資料過期」或「高延遲」。這兩種情況都可能是由網路擁塞導致的資料庫複製延遲引起的，需要干預。或者，它們可能在名義上的服務水準目標之內，但未能滿足用戶更高的期望。跨多個團隊檢查這些資訊，可以讓我們識別系統性問題並選擇正確的解決方案，特別是如果解決方案可能是引入更多的人為故障以阻止過度表現。

### 報告與溝通

對於第一線的 SRE 來說，更直接的用途是能夠選擇零個或多個「outalations」，並將其主題、標籤和「重要」註釋包含在一封電子郵件中，發送給下一位值班工程師（以及任意的抄送列表），以便在班次之間傳遞最近的狀態。對於生產服務的定期審查（大多數團隊每週進行一次），Outalator 還支援一種「報告模式」，在該模式中，重要的註釋會在主列表旁邊內聯展開，以便快速概覽重點問題。

## 意外的好處

能夠識別出一個警報，或一連串的警報，與另一個給定的中斷同時發生，有明顯的好處：它提高了診斷的速度，並通過承認確實存在一個事件來減輕其他團隊的負擔。還有一些額外的不明顯的好處。以 Bigtable 為例，如果一個服務因為一個明顯的 Bigtable 事件而中斷，但你可以看到 Bigtable SRE 團隊沒有收到警報，那麼手動向該團隊發出警報可能是一個好主意。改善跨團隊的可見性能夠並且確實在事件解決，或至少在事件緩解方面產生重大影響。

全公司的一些團隊甚至設立了虛擬的升級配置：沒有人會收到發送到那裡的通知，但通知會出現在 Outalator 中，並且可以被標記、註釋和審查。這種「記錄系統」的一個用途是記錄和審計特權或角色帳戶的使用（儘管必須指出，這個功能是基本的，用於技術審計，而非法律審計）。另一個用途是記錄並自動註釋可能不是冪等的定期作業的運行——例如，從版本控制到資料庫系統的模式更改的自動應用。

84 例如，對 Bigtable 進行某項特定變更可能需要大量的工程努力，而該變更對於一次中斷僅有微小的緩解效果。然而，如果同樣的緩解措施能夠適用於許多事件，那麼工程努力就非常值得了。

85 一方面，「導致最多事件」是減少觸發警報數量和改善整體系統的一個很好的起點。另一方面，這個指標可能僅僅是過度敏感的監控或一小部分客戶端系統行為不當或其本身超出協定的服務水平的產物。再者，僅僅事件的數量並不能說明修復的難度或影響的嚴重性。