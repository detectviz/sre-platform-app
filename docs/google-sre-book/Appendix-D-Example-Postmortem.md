# 附錄 D - 事後檢討範例

## 莎士比亞十四行詩++ 事後檢討 (事件 #465)

**日期**：2015-10-21
**作者**：jennifer, martym, agoogler
**狀態**：已完成，行動項目進行中

**摘要**：由於一首新發現的十四行詩引起了對莎士比亞的高度興趣，莎士比亞搜尋服務中斷了 66 分鐘。

**影響**：估計損失 12.1 億次查詢，無營收影響。

**根本原因**：由於極高的負載和當搜尋詞彙未在莎士比亞語料庫中時導致的資源洩漏相結合，引發了級聯故障。新發現的十四行詩使用了一個從未在莎士比亞作品中出現過的詞，而這個詞恰好是使用者搜尋的詞彙。在正常情況下，由於資源洩漏導致的任務失敗率低到不會被注意到。

**觸發點**：潛在的錯誤被流量的突然增加所觸發。

**解決方案**：將流量導向犧牲叢集，並增加 10 倍容量以緩解級聯故障。部署了更新的索引，解決了與潛在錯誤的交互作用。在公眾對新十四行詩的興趣激增過去之前，維持額外容量。已識別資源洩漏並部署了修復。

**偵測**：Borgmon 偵測到大量的 HTTP 500 錯誤並呼叫了 on-call 人員。

**行動項目**：

| 類型 | 描述 | 負責人 | 錯誤單號 | 狀態 |
|---|---|---|---|---|
| 緩解 | 更新劇本，加入應對級聯故障的說明 | jennifer | n/a | DONE |
| 預防 | 使用通量電容器以平衡叢集間的負載 | martym | Bug 5554823 | TODO |
| 流程 | 在下次 DiRT 期間安排級聯故障測試 | docbrown | n/a | TODO |
| 預防 | 研究持續運行索引 MR/融合的可行性 | jennifer | Bug 5554824 | TODO |
| 預防 | 修補搜尋排序子系統中的檔案描述符洩漏 | agoogler | Bug 5554825 | DONE |
| 預防 | 為莎士比亞搜尋增加減載功能 | agoogler | Bug 5554826 | TODO |
| 預防 | 建立迴歸測試以確保伺服器對死亡查詢能做出理性回應 | clarac | Bug 5554827 | TODO |
| 預防 | 將更新的搜尋排序子系統部署到生產環境 | jennifer | n/a | DONE |
| 其他 | 由於錯誤預算耗盡，凍結生產環境至 2015-11-20，或因怪誕、難以置信、離奇和前所未有的情況尋求例外 | docbrown | n/a | TODO |

## 學到的教訓

**做得好的地方**
*   監控系統迅速就大量的 HTTP 500 錯誤（達到約 100%）向我們發出警報。
*   迅速將更新後的莎士比亞語料庫分發到所有叢集。

**出錯的地方**
*   我們對於應對級聯故障已經疏於練習。
*   由於流量異常激增，且基本上所有請求都導致失敗，我們超出了可用性錯誤預算（好幾個數量級）。

**幸運之處**
*   莎士比亞愛好者的郵件列表中有一份新十四行詩的副本。
*   伺服器日誌中的堆疊追蹤指向檔案描述符耗盡是崩潰的原因。
*   透過推送包含熱門搜尋詞的新索引，解決了「死亡查詢」問題。

## 時間軸

2015-10-21 (所有時間均為 UTC)
*   **14:51** 新聞報導在一輛 Delorean 的手套箱中發現了一首新的莎士比亞十四行詩。
*   **14:53** 在 /r/shakespeare 的一則貼文指向莎士比亞搜尋引擎作為尋找新十四行詩的地方後，搜尋流量增加了 88 倍（但我們當時還沒有這首詩）。
*   **14:54** **服務中斷開始** - 搜尋後端在負載下開始崩潰。
*   **14:55** docbrown 收到呼叫器風暴，所有叢集出現大量 Http500 錯誤。
*   **14:57** 所有對莎士比亞搜尋的流量都失敗：參見 https://monitor
*   **14:58** docbrown 開始調查，發現後端崩潰率非常高。
*   **15:01** **事件開始** - docbrown 因級聯故障宣布事件 #465 開始，在 #shakespeare 上進行協調，並任命 jennifer 為事件指揮官。
*   **15:02** 有人碰巧向 shakespeare-discuss@ 發送了一封關於十四行詩發現的電子郵件，這封郵件恰好在 martym 的收件箱頂部。
*   **15:03** jennifer 通知 shakespeare-incidents@ 列表該事件。
*   **15:04** martym 找到了新十四行詩的文本，並查找語料庫更新的文件。
*   **15:06** docbrown 發現所有叢集中所有任務的崩潰症狀都相同，根據應用程式日誌調查原因。
*   **15:07** martym 找到文件，開始準備語料庫更新。
*   **15:10** martym 將十四行詩加入莎士比亞的已知作品中，開始索引作業。
*   **15:12** docbrown 聯繫 clarac 和 agoogler（來自莎士比亞開發團隊）協助檢查程式碼以尋找可能的原因。
*   **15:18** clarac 在日誌中找到指向檔案描述符耗盡的確鑿證據，並根據程式碼確認如果搜尋不在語料庫中的詞彙，確實存在洩漏。
*   **15:20** martym 的索引 MapReduce 作業完成。
*   **15:21** jennifer 和 docbrown 決定增加足夠的實例數量，以降低實例上的負載，使它們能夠在死亡和重啟前完成可觀的工作。
*   **15:23** docbrown 將所有流量負載平衡到 USA-2 叢集，允許在其他叢集中增加實例數量而伺服器不會立即失敗。
*   **15:25** martym 開始將新索引複製到所有叢集。
*   **15:28** docbrown 開始將實例數量增加 2 倍。
*   **15:32** jennifer 更改負載平衡，以增加到非犧牲叢集的流量。
*   **15:33** 非犧牲叢集中的任務開始失敗，症狀與之前相同。
*   **15:34** 發現在白板上計算實例數量增加時出現了數量級的錯誤。
*   **15:36** jennifer 恢復負載平衡，重新犧牲 USA-2 叢集，為全球額外增加 5 倍實例（總計為初始容量的 10 倍）做準備。
*   **15:36** **服務中斷緩解** - 更新的索引已複製到所有叢集。
*   **15:39** docbrown 開始第二波實例數量增加，達到初始容量的 10 倍。
*   **15:41** jennifer 恢復所有叢集的負載平衡，處理 1% 的流量。
*   **15:43** 非犧牲叢集的 HTTP 500 錯誤率恢復正常水準，任務失敗偶爾發生在低水準。
*   **15:45** jennifer 將 10% 的流量平衡到非犧牲叢集。
*   **15:47** 非犧牲叢集的 HTTP 500 錯誤率保持在 SLO 範圍內，未觀察到任務失敗。
*   **15:50** 30% 的流量平衡到非犧牲叢集。
*   **15:55** 50% 的流量平衡到非犧牲叢集。
*   **16:00** **服務中斷結束** - 所有流量在所有叢集中平衡。
*   **16:30** **事件結束** - 達到 30 分鐘名義效能的退出標準。

## 支援資訊：
*   監控儀表板，https://monitor/shakespeare?end_time=20151021T160000&duration=7200

---
**註腳**

163. **影響**是指對使用者、營收等的效應。
164. **根本原因**是解釋此事件發生的情況。使用像「五個為什麼」[Ohn88] 這樣的技術來理解促成因素通常很有幫助。
165. **行動項目**：「膝跳反射式」的行動項目通常會變得過於極端或實施成本過高，可能需要判斷力在更大的背景下重新界定它們的範圍。存在過度優化特定問題的風險，例如在單元測試等可靠機制可以在開發過程中更早地發現問題時，卻增加了特定的監控/警報。
166. **幸運之處**：這個部分實際上是用於「險些失手」的情況，例如，「山羊傳送器儘管缺乏認證，但仍可用於緊急傳送其他動物。」
167. **時間軸**：事件的「劇本」；使用事件管理文件中的事件時間軸來開始填寫事後檢討的時間軸，然後補充其他相關條目。
168. **支援資訊**：有用的資訊、連結、日誌、螢幕截圖、圖表、IRC 日誌、IM 日誌等。
