# 發布工程 (Release Engineering)

作者：Dinah McNutt 編輯：Betsy Beyer 與 Tim Harvey

發布工程 (Release engineering) 是一個相對較新且快速發展的軟體工程學科，可以簡潔地描述為**建置和交付軟體 (building and delivering software)** [McN14a]。發布工程師對原始碼管理、編譯器、建置配置語言、自動化建置工具、軟體包管理器和安裝程式有著扎實（如果不是專家級）的理解。他們的技能集包括多個領域的深入知識：開發、配置管理、測試整合、系統管理和客戶支援。

運行可靠的服務需要可靠的發布流程。網站可靠性工程師 (SRE) 需要知道他們使用的二進位檔案和配置是以可重現、自動化的方式建置的，這樣發布才是可重複的，而不是「獨一無二的雪花」。對發布流程任何方面的更改都應該是有意的，而不是偶然的。SRE 關心從原始碼到部署的整個過程。

發布工程是 Google 的一個特定工作職能。發布工程師與產品開發中的軟體工程師 (SWE) 和 SRE 合作，定義發布軟體所需的所有步驟——從軟體如何儲存在原始碼儲存庫中，到編譯的建置規則，再到如何進行測試、打包和部署。

## 發布工程師的角色

Google 是一家數據驅動的公司，發布工程也不例外。我們有工具可以報告一系列指標，例如一個程式碼變更部署到生產環境需要多長時間（換句話說，**發布速度 (release velocity)**），以及關於建置設定檔中正在使用哪些功能的統計資料 [Ada15]。這些工具大多是由發布工程師構想和開發的。

發布工程師定義使用我們工具的最佳實踐，以確保專案使用一致且可重複的方法進行發布。我們的最佳實踐涵蓋了發布過程的所有元素。例子包括編譯器標誌、建置識別標籤的格式，以及建置過程中的必要步驟。確保我們的工具預設行為正確且有充分的文件記錄，可以讓團隊輕鬆地專注於功能和用戶，而不是在發布軟體時花時間（糟糕地）重新發明輪子。

Google 有大量的 SRE，他們負責安全地部署產品並保持 Google 服務的正常運行。為了確保我們的發布流程滿足業務需求，發布工程師和 SRE 共同制定策略，用於**金絲雀測試 (canarying)** 變更、在不中斷服務的情況下推出新版本，以及回滾出現問題的功能。

# 理念

發布工程以一種工程和服務理念為指導，該理念通過四個主要原則來表達，詳見以下各節。

## 自助服務模型 (Self-Service Model)

為了大規模工作，團隊必須能夠自給自足。發布工程已經開發出最佳實踐和工具，讓我們的產品開發團隊能夠控制和運行自己的發布流程。儘管我們有成千上萬的工程師和產品，但我們能夠實現高發布速度，因為各個團隊可以決定他們產品新版本的發布頻率和時間。發布流程可以自動化到只需要工程師最少的參與，許多專案都是使用我們的自動化建置系統和部署工具的組合來自動建置和發布的。發布是真正自動的，只有在出現問題時才需要工程師的介入。

## 高速度 (High Velocity)

面向用戶的軟體（例如 Google 搜尋的許多組件）會頻繁地重新建置，因為我們的目標是盡快推出面向客戶的功能。我們已經接受了這樣一種理念：頻繁的發布會導致版本之間的變更更少。這種方法使測試和故障排除更容易。一些團隊每小時進行一次建置，然後從產生的建置池中選擇要實際部署到生產環境的版本。選擇是基於測試結果和給定建置中包含的功能。其他團隊則採用了「綠燈時推送 (Push on Green)」的發布模型，並部署每個通過所有測試的建置 [Kle14]。

## 密封建置 (Hermetic Builds)

建置工具必須讓我們能夠確保一致性和可重複性。如果兩個人試圖在不同的機器上，從原始碼儲存庫的相同修訂號建置相同的產品，我們期望得到相同的結果。36 我們的建置是**密封的 (hermetic)**，這意味著它們對建置機器上安裝的函式庫和其他軟體不敏感。相反，建置依賴於已知版本的建置工具（如編譯器）和依賴項（如函式庫）。建置過程是自包含的，絕不能依賴於建置環境之外的服務。

當我們需要修復正在生產環境中運行的軟體中的錯誤時，重新建置舊版本可能是一個挑戰。我們通過在與原始建置相同的修訂版上重新建置，並包含在該時間點之後提交的特定變更來完成此任務。我們稱這種策略為**擇優挑選 (cherry picking)**。我們的建置工具本身是根據正在建置的專案在原始碼儲存庫中的修訂版進行版本控制的。因此，如果需要進行擇優挑選，上個月建置的專案將不會使用本月的編譯器版本，因為該版本可能包含不相容或不期望的功能。

## 政策和程序的強制執行

多層安全和存取控制決定了誰可以在發布專案時執行特定操作。受限制的操作包括：

- **批准原始碼變更**——此操作通過散佈在整個程式碼庫中的設定檔進行管理
- **指定發布過程中要執行的操作**
- **創建一個新的發布**
- **批准初始整合提案**（這是在原始碼儲存庫中特定修訂號執行建置的請求）和後續的擇優挑選
- **部署一個新的發布**
- **對專案的建置配置進行變更**

幾乎所有對程式碼庫的變更都需要程式碼審查，這是一個整合到我們正常開發人員工作流程中的簡化操作。我們的自動化發布系統會生成一份包含在發布中的所有變更的報告，該報告與其他建置產物一起存檔。通過讓 SRE 了解一個專案的新版本中包含了哪些變更，這份報告可以在發布出現問題時加快故障排除速度。

# 持續建置與部署

Google 開發了一個名為 **Rapid** 的自動化發布系統。Rapid 是一個利用多項 Google 技術提供一個框架，以交付可擴展、密封且可靠的發布的系統。以下各節描述了 Google 的軟體生命週期，以及如何使用 Rapid 和其他相關工具對其進行管理。

## 建置

**Blaze** 37 是 Google 首選的建置工具。它支援從多種語言建置二進位檔案，包括我們的標準語言 C++、Java、Python、Go 和 JavaScript。工程師使用 Blaze 來定義建置目標（例如，建置的輸出，如一個 JAR 檔案），並為每個目標指定依賴項 [Kem11]。在執行建置時，Blaze 會自動建置依賴項目標。

二進位檔案和單元測試的建置目標在 Rapid 的專案設定檔中定義。專案特定的標誌，例如唯一的建置識別碼，由 Rapid 傳遞給 Blaze。所有二進位檔案都支援一個標誌，該標誌顯示建置日期、修訂號和建置識別碼，這使我們能夠輕鬆地將一個二進位檔案與其建置方式的記錄關聯起來。

## 分支

所有程式碼都簽入到原始碼樹的主分支（mainline）。然而，大多數主要專案並不直接從主線發布。相反，我們在一個特定的修訂版上從主線創建一個分支，並且絕不將分支的變更合併回主線。錯誤修復被提交到主線，然後**擇優挑選 (cherry picked)** 到分支中以包含在發布中。這種做法避免了無意中納入自原始建置以來提交到主線的不相關變更。使用這種分支和擇優挑選的方法，我們確切地知道每個發布的內容。

## 測試

一個**持續測試 (continuous test)** 系統在每次提交變更時，都會對主線中的程式碼運行單元測試，讓我們能夠快速檢測到建置和測試失敗。發布工程建議持續建置測試目標與限制專案發布的測試目標相對應。我們還建議在最後一個成功完成所有測試的持續測試建置的修訂號（版本）上創建發布。這些措施降低了後續對主線的變更在發布時執行的建置期間導致失敗的可能性。

在發布過程中，我們使用發布分支重新運行單元測試，並創建一個顯示所有測試都通過的審計追蹤。這一步很重要，因為如果一個發布涉及擇優挑選，發布分支可能包含一個在主線上任何地方都不存在的程式碼版本。我們希望保證測試在實際發布的上下文中通過。

為了補充持續測試系統，我們使用一個獨立的測試環境，該環境在打包的建置產物上運行系統級測試。這些測試可以手動啟動，也可以從 Rapid 啟動。

## 打包

軟體通過 **Midas 套件管理器 (Midas Package Manager, MPM)** [McN14c] 分發到我們的生產機器上。MPM 根據 Blaze 規則組裝軟體包，這些規則列出了要包含的建置產物，以及它們的所有者和權限。軟體包被命名（例如，`search/shakespeare/frontend`），用唯一的雜湊值進行版本控制，並進行簽名以確保真實性。MPM 支援對特定版本的軟體包應用標籤。Rapid 應用一個包含建置 ID 的標籤，這保證了可以使用軟體包的名稱和這個標籤唯一地引用一個軟體包。

標籤可以應用於 MPM 軟體包，以指示軟體包在發布過程中的位置（例如，`dev`、`canary` 或 `production`）。如果您將現有標籤應用於新軟體包，該標籤會自動從舊軟體包移動到新軟體包。例如：如果一個軟體包被標記為 `canary`，隨後安裝該軟體包的 `canary` 版本的人將自動收到帶有 `canary` 標籤的最新版本的軟體包。

## Rapid

圖 8-1 顯示了 Rapid 系統的主要組件。Rapid 是用稱為**藍圖 (blueprints)** 的檔案配置的。藍圖是用一種內部配置語言編寫的，用於定義建置和測試目標、部署規則以及管理資訊（如專案所有者）。基於角色的存取控制列表決定了誰可以在 Rapid 專案上執行特定操作。

每個 Rapid 專案都有**工作流程 (workflows)**，用於定義在發布過程中要執行的操作。工作流程操作可以串行或並行執行，一個工作流程可以啟動其他工作流程。Rapid 將工作請求分派到在我們的生產伺服器上作為 Borg 工作運行的任務。由於 Rapid 使用我們的生產基礎設施，它可以同時處理數千個發布請求。

一個典型的發布過程如下：

- Rapid 使用請求的整合修訂號（通常從我們的持續測試系統自動獲取）來創建一個發布分支。
- Rapid 使用 Blaze 編譯所有二進位檔案並執行單元測試，通常並行執行這兩個步驟。編譯和測試在專門用於這些特定任務的環境中進行，而不是在執行 Rapid 工作流程的 Borg 工作中進行。這種分離使我們能夠輕鬆地並行化工作。
- 然後，建置產物可用於系統測試和金絲雀部署。一個典型的金絲雀部署涉及在系統測試完成後，在我們的生產環境中啟動幾個工作。
- 過程的每一步的結果都會被記錄下來。會創建一份自上次發布以來的所有變更的報告。

Rapid 允許我們管理我們的發布分支和擇優挑選；單個擇優挑選請求可以被批准或拒絕包含在發布中。

## 部署

Rapid 通常直接用於驅動簡單的部署。它根據藍圖檔案中的部署定義和專門的任務執行器，更新 Borg 工作以使用新建置的 MPM 軟體包。

對於更複雜的部署，我們使用 **Sisyphus**，這是由 SRE 開發的一個通用的推出自動化框架。一個**推出 (rollout)** 是一個邏輯工作單元，由一個或多個單獨的任務組成。Sisyphus 提供了一組可以擴展以支援任何部署過程的 Python 類。它有一個儀表板，可以更精細地控制推出的執行方式，並提供一種監控推出進度的方法。

在一個典型的整合中，Rapid 在一個長期運行的 Sisyphus 工作中創建一個推出。Rapid 知道與其創建的 MPM 軟體包相關聯的建置標籤，並且可以在 Sisyphus 中創建推出時指定該建置標籤。Sisyphus 使用建置標籤來指定應該部署哪個版本的 MPM 軟體包。

有了 Sisyphus，推出過程可以根據需要簡單或複雜。例如，它可以立即更新所有相關的工作，也可以在幾個小時內將一個新的二進位檔案陸續推送到各個叢集。

我們的目標是使部署過程適合給定服務的風險狀況。在開發或預生產環境中，我們可能會每小時建置一次，並在所有測試通過時自動推送發布。對於大型面向用戶的服務，我們可能會從一個叢集開始推送，然後指數級擴展，直到所有叢集都更新完畢。對於基礎設施的敏感部分，我們可能會將推出延長幾天，在不同地理區域的實例之間交錯進行。

# 配置管理

配置管理是發布工程師和 SRE 之間特別密切合作的一個領域。儘管配置管理最初可能看起來是一個 deceptively simple 的問題，但配置變更是潛在的不穩定來源。因此，我們發布和管理系統及服務配置的方法隨著時間的推移發生了實質性的演變。今天，我們使用幾種模型來分發設定檔，如下段所述。所有方案都涉及將配置儲存在我們的主要原始碼儲存庫中，並強制執行嚴格的程式碼審查要求。

- **使用主線進行配置**。這是用於在 Borg（以及早於 Borg 的系統）中配置服務的第一種方法。使用這種方案，開發人員和 SRE 在主分支的頭部修改設定檔。變更經過審查後應用於正在運行的系統。結果，二進位發布和配置變更是解耦的。雖然在概念上和程序上都很簡單，但這種技術常常導致簽入版本的設定檔和正在運行的版本的設定檔之間出現偏差，因為必須更新工作才能獲取變更。
- **將設定檔和二進位檔案包含在同一個 MPM 軟體包中**。對於設定檔很少的專案，或者檔案（或檔案子集）隨每個發布週期變更的專案，可以將設定檔與二進位檔案一起包含在 MPM 軟體包中。雖然這種策略通過將二進位檔案和設定檔緊密綁定而限制了靈活性，但它簡化了部署，因為它只需要安裝**一個**軟體包。
- **將設定檔打包到 MPM「配置軟體包」中**。我們可以將密封原則應用於配置管理。二進位配置傾向於與特定版本的二進位檔案緊密綁定，因此我們利用建置和打包系統來快照和發布設定檔及其二進位檔案。與我們對待二進位檔案的方式類似，我們可以使用建置 ID 來在特定時間點重建配置。
    例如，一個實現新功能的變更可以與一個配置該功能的標誌設定一起發布。通過生成兩個 MPM 軟體包，一個用於二進位檔案，一個用於配置，我們保留了獨立更改每個軟體包的能力。也就是說，如果該功能是以 `first_folio` 的標誌設定發布的，但我們意識到它應該是 `bad_quarto`，我們可以將該變更擇優挑選到發布分支上，重新建置配置軟體包，並部署它。這種方法的優點是不需要新的二進位建置。
    我們可以利用 MPM 的標籤功能來指示哪些版本的 MPM 軟體包應該一起安裝。可以將 `much_ado` 的標籤應用於前一段中描述的 MPM 軟體包，這讓我們可以使用這個標籤來獲取兩個軟體包。當建置一個新版本的專案時，`much_ado` 標籤將被應用於新的軟體包。因為這些標籤在 MPM 軟體包的命名空間內是唯一的，所以只會使用帶有該標籤的最新軟體包。
- **從外部儲存讀取設定檔**。一些專案的設定檔需要頻繁或動態地更改（即，在二進位檔案運行時）。這些檔案可以儲存在 Chubby、Bigtable 或我們基於原始碼的檔案系統 [Yor11] 中。

總之，專案所有者會考慮分發和管理設定檔的不同選項，並根據具體情況決定哪種最有效。

# 結論

雖然本章專門討論了 Google 的發布工程方法，以及發布工程師與 SRE 的工作和協作方式，但這些實踐也可以更廣泛地應用。

## 不僅僅適用於 Google 員工

當配備了正確的工具、適當的自動化和明確定義的政策時，開發人員和 SRE 就不必擔心發布軟體。發布可以像按一下按鈕一樣輕鬆。

大多數公司都面臨著同樣的一系列發布工程問題，無論其規模大小或使用的工具如何：您應該如何處理軟體包的版本控制？您應該使用持續建置和部署模型，還是執行定期建置？您應該多久發布一次？您應該使用什麼配置管理政策？哪些發布指標是您感興趣的？

Google 發布工程師出於必要開發了自己的工具，因為開源或供應商提供的工具無法滿足我們所需的規模。客製化工具使我們能夠包含支持（甚至強制執行）發布流程政策的功能。然而，必須首先定義這些政策，才能為我們的工具添加適當的功能，所有公司都應該努力定義他們的發布流程——無論這些流程是否可以自動化和/或強制執行。

## 從一開始就進行發布工程

發布工程常常被視為事後諸葛，隨著平台和服務的規模和複雜性不斷增長，這種思維方式必須改變。

團隊應該在產品開發週期的開始就為發布工程資源做預算。早期建立良好的實踐和流程，比以後改造您的系統要便宜。

開發人員、SRE 和發布工程師之間的合作至關重要。發布工程師需要了解程式碼應該如何建置和部署的意圖。開發人員不應該建置完就把「結果扔過牆」讓發布工程師去處理。

個別專案團隊決定何時讓發布工程參與專案。由於發布工程仍然是一個相對年輕的學科，管理者並不總是在專案的早期階段就為發布工程進行規劃和預算。因此，在考慮如何整合發布工程實踐時，請務必考慮其在您產品或服務整個生命週期中的作用——尤其是在早期階段。

有關發布工程的更多資訊，請參閱以下演講，每個演講都有線上影片：

- *How Embracing Continuous Release Reduced Change Complexity*, USENIX Release Engineering Summit West 2014, [Dic14]
- *Maintaining Consistency in a Massively Parallel Environment*, USENIX Configuration Management Summit 2013, [McN13]
- *The 10 Commandments of Release Engineering*, 2nd International Workshop on Release Engineering 2014, [McN14b]
- *Distributing Software in a Massively Parallel Environment*, LISA 2014, [McN14c]

36 Google 使用一個單一的統一原始碼儲存庫；請參閱 [Pot16]。

37 Blaze 已作為 Bazel 開源。請參閱 Bazel 網站上的「Bazel 常見問題」，https://bazel.build/faq.html。