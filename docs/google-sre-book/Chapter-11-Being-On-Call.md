# 值班 (Being On-Call)

作者：Andrea Spadaccini 56 編輯：Kavita Guliani

值班 (Being on-call) 是許多運營和工程團隊為保持其服務可靠和可用而必須承擔的一項關鍵職責。然而，在值班輪換和職責的組織中存在一些陷阱，如果不及時避免，可能會對服務和團隊造成嚴重後果。本章描述了 Google 網站可靠性工程師 (SRE) 多年來發展起來的值班方法的主要原則，並解釋了這種方法如何隨著時間的推移帶來了可靠的服務和可持續的工作負載。

## 前言

有幾個行業要求員工執行某種形式的值班職責，這需要在工作時間和非工作時間都能接聽電話。在 IT 領域，值班活動歷來由專門的運營 (Ops) 團隊執行，其主要職責是保持其負責的服務的良好健康狀況。

Google 的許多重要服務，例如搜尋、廣告和 Gmail，都有專門的 SRE 團隊負責這些服務的性能和可靠性。因此，SRE 為他們支持的服務值班。SRE 團隊與純粹的運營團隊截然不同，因為他們非常重視使用工程方法來解決問題。這些問題通常屬於運營領域，其規模之大，若無軟體工程解決方案將難以處理。

為了強制執行這種解決問題的方式，Google 將具有系統和軟體工程多元背景的人才招聘到 SRE 團隊。我們將 SRE 花在純粹運營工作上的時間上限定為 50%；SRE 至少 50% 的時間應該分配給工程專案，這些專案除了改善服務外，還能通過自動化進一步擴大團隊的影響力。

# 值班工程師的生活

本節描述了值班工程師的典型活動，並為本章的其餘部分提供了一些背景。

作為生產系統的守護者，值班工程師通過管理影響團隊的中斷以及執行和/或審查生產變更來照管其分配的操作。

值班時，工程師需要在幾分鐘內就能對生產系統執行操作，這取決於團隊和業務系統所有者商定的呼叫回應時間。典型的值是面向用戶的或其他高度時間關鍵的服務為 5 分鐘，而時間敏感性較低的系統為 30 分鐘。公司提供接收呼叫的設備，通常是手機。Google 有靈活的警報傳遞系統，可以通過多種機制（電子郵件、簡訊、機器人電話、應用程式）跨多個設備分派呼叫。

回應時間與期望的服務可用性有關，如下面的簡單例子所示：如果一個面向用戶的系統在一個季度內必須達到 4 個九的可用性 (99.99%)，則允許的季度停機時間約為 13 分鐘（可用性表格）。這個約束意味著值班工程師的反應時間必須在分鐘級別（嚴格來說，是 13 分鐘）。對於 SLO 較寬鬆的系統，反應時間可以在幾十分鐘的級別。

一旦收到並確認呼叫，值班工程師應對問題進行分類並努力解決，可能需要其他團隊成員的參與，並在必要時進行升級。

非呼叫的生產事件，例如較低優先級的警報或軟體發布，也可以在工作時間由值班工程師處理和/或審查。這些活動不如呼叫事件緊急，後者優先於幾乎所有其他任務，包括專案工作。有關中斷和其他導致運營負載的非呼叫事件的更多見解，請參閱「處理中斷」。

許多團隊都有主要和次要的值班輪換。主要和次要職責的分配因團隊而異。一個團隊可能會將次要人員用作主要值班錯過的呼叫的後備。另一個團隊可能會規定主要值班只處理呼叫，而次要人員處理所有其他非緊急的生產活動。

在那些不需要嚴格分配職責的次要輪換的團隊中，兩個相關的團隊互相擔任次要值班，並負責後備處理職責是很常見的。這種設置消除了對專門的次要值班輪換的需求。

組織值班輪換的方式有很多種；有關詳細分析，請參閱 [Lim14] 的「值班」一章。

# 平衡的值班

SRE 團隊對值班班次的數量和品質有特定的限制。值班的**數量**可以通過工程師花在值班職責上的時間百分比來計算。值班的**品質**可以通過值班期間發生的事件數量來計算。

SRE 經理有責任在這兩個軸上保持值班工作負載的平衡和可持續性。

## 數量的平衡

我們堅信，「SRE」中的「E」是我們組織的一個決定性特徵，因此我們努力將至少 50% 的 SRE 時間投入到工程中：在剩餘的時間裡，不超過 25% 的時間可以用於值班，剩下的最多 25% 用於其他類型的運營性、非專案工作。

使用 25% 的值班規則，我們可以推導出維持 24/7 值班輪換所需的最少 SRE 人數。假設總有兩個人在值班（主要和次要，職責不同），一個單點團隊進行值班所需的最少工程師人數是八人：假設是為期一周的班次，每個工程師每個月值班（主要或次要）一周。對於雙點團隊，每個團隊的合理最小規模是六人，這既是為了遵守 25% 的規則，也是為了確保團隊有足夠的工程師來形成關鍵多數。

如果一個服務的工作量足以證明發展一個單點團隊是合理的，我們更傾向於創建一個多點團隊。一個多點團隊有兩個優點：

- 夜班對人們的健康有不利影響 [Dur05]，而一個多點的「跟隨太陽 (follow the sun)」輪換可以讓團隊完全避免夜班。
- 限制值班輪換中的工程師數量可以確保工程師不會與生產系統脫節（請參閱「一個危險的敵人：運營負載不足」）。

然而，多點團隊會產生溝通和協調的開銷。因此，決定採用多點還是單點應該基於每個選項所帶來的權衡、系統的重要性以及每個系統產生的工作負載。

## 品質的平衡

對於每個值班班次，工程師應該有足夠的時間來處理任何事件和後續活動，例如撰寫事後檢討 [Loo10]。讓我們將一個**事件 (incident)** 定義為與同一個根本原因相關的一系列事件和警報，並且會在同一個事後檢討中進行討論。我們發現，平均而言，處理一個值班事件所涉及的任務——根本原因分析、補救和後續活動，如撰寫事後檢討和修復錯誤——需要 6 個小時。因此，每天的最大事件數是每個 12 小時值班班次 2 個。為了保持在這個上限之內，呼叫事件的分佈應該隨著時間的推移非常平坦，中位數可能為 0：如果某個組件或問題每天都導致呼叫（中位數事件/天 > 1），那麼很可能在某個時候會有其他東西出問題，從而導致比應允許的更多的事件。

如果這個限制被暫時超過，例如，在一個季度內，應該採取糾正措施，以確保運營負載恢復到可持續的狀態（請參閱「運營過載」和「嵌入 SRE 以從運營過載中恢復」）。

## 補償

對於非工作時間的支援需要考慮足夠的補償。不同的組織以不同的方式處理值班補償；Google 提供補休或直接的現金補償，上限為總薪資的某個比例。這個補償上限實際上代表了任何個人將承擔的值班工作量的限制。這種補償結構確保了在團隊需要時參與值班職責的激勵，但也促進了平衡的值班工作分配，並限制了過度值班可能帶來的缺點，例如倦怠或專案工作時間不足。

# 感到安全

如前所述，SRE 團隊支持 Google 最關鍵的系統。作為一名 SRE 值班，通常意味著要為面向用戶的、收入關鍵的系統或保持這些系統正常運行的基礎設施承擔責任。SRE 思考和解決問題的方法論對於服務的適當運營至關重要。

現代研究確定了個人在面臨挑戰時可能會有意識或無意識地選擇的兩種不同的思維方式 [Kah11]：

- 直覺的、自動的、快速的行動
- 理性的、專注的、深思熟慮的認知功能

當一個人處理與複雜系統相關的中斷時，後一種選擇更有可能產生更好的結果，並導致精心策劃的事件處理。

為了確保工程師處於適當的心態來利用後一種思維模式，降低與值班相關的壓力非常重要。服務的重要性和影響以及潛在中斷的後果會給值班工程師帶來巨大的壓力，損害團隊成員個人的福祉，並可能促使 SRE 做出可能危及服務可用性的不正確選擇。眾所周知，皮質醇和促腎上腺皮質激素釋放激素 (CRH) 等壓力荷爾蒙會導致包括恐懼在內的行為後果，這些後果會損害認知功能並導致次優的決策 [Chr09]。

在這些壓力荷爾蒙的影響下，更深思熟慮的認知方法通常會被不假思索和未經考慮的（但卻是立即的）行動所取代，從而可能導致對啟發式方法的濫用。在值班時，啟發式方法是非常誘人的行為。例如，當同一個警報在一周內第四次呼叫，而前三次呼叫是由一個外部基礎設施系統引發的時，通過自動將第四次出現的問題與之前的原因聯繫起來，來運用**確認偏誤 (confirmation bias)** 是極具誘惑力的。

雖然直覺和快速反應在事件管理中似乎是可取的特質，但它們也有缺點。直覺可能是錯誤的，而且通常缺乏明顯的資料支持。因此，跟隨直覺可能會讓工程師浪費時間去追尋一個從一開始就錯誤的推理路線。快速反應根植於習慣，而習慣性的反應是未經考慮的，這意味著它們可能是災難性的。事件管理的理想方法論是在有足夠的資料做出合理決策時，以期望的速度採取步驟，同時批判性地審視你的假設，從而達到完美的平衡。

重要的是，值班的 SRE 要明白，他們可以依靠多種資源，使值班的經歷不像看起來那麼令人畏懼。最重要的值班資源是：

- 清晰的升級路徑
- 定義明確的事件管理程序
- 無指責的事後檢討文化 ([Loo10], [All12])

SRE 支持的系統的開發團隊通常會參與 24/7 的值班輪換，並且在必要時總是可以升級到這些合作夥伴團隊。對中斷進行適當的升級，通常是應對具有重大未知因素的嚴重中斷的一種有原則的方式。

當處理事件時，如果問題足夠複雜，涉及多個團隊，或者在經過一些調查後，仍然無法估計事件時間範圍的上限，那麼採用正式的事件管理協定可能會很有用。Google SRE 使用「管理事件」中描述的協定，該協定提供了一套易於遵循且定義明確的步驟，可幫助值班工程師在所有必要的幫助下，理性地追求滿意的事件解決方案。該協定內部由一個基於 Web 的工具支持，該工具可以自動化大多數事件管理操作，例如交接角色以及記錄和傳達狀態更新。該工具使事件管理者能夠專注於處理事件，而不是花時間和認知精力在諸如格式化電子郵件或一次更新多個溝通渠道等單調乏味的行動上。

最後，當事件發生時，評估哪裡出了問題，認識到哪裡做得好，並採取行動防止將來再次發生同樣的錯誤，這一點非常重要。SRE 團隊必須在重大事件後撰寫事後檢討，並詳細說明所發生事件的完整時間線。通過專注於事件而非個人，這些事後檢討提供了巨大的價值。它們不是將責任歸咎於個人，而是從對生產事件的系統性分析中獲取價值。錯誤會發生，軟體應該確保我們盡可能少犯錯誤。認識到自動化的機會是預防人為錯誤的最佳方法之一 [Loo10]。

# 避免不適當的運營負載

如「平衡的值班」中所述，SRE 最多將 50% 的時間用於運營工作。如果運營活動超過這個限制會發生什麼？

## 運營過載

SRE 團隊和領導層有責任在季度工作規劃中包含具體的目標，以確保工作負載恢復到可持續的水平。暫時將一名經驗豐富的 SRE 借調到一個超負荷的團隊，如「嵌入 SRE 以從運營過載中恢復」中所討論的，可以提供足夠的喘息空間，使團隊能夠在解決問題上取得進展。

理想情況下，運營過載的症狀應該是可衡量的，以便可以量化目標（例如，每日工單數 < 5，每個班次的呼叫事件 < 2）。

配置錯誤的監控是運營過載的常見原因。呼叫警報應與威脅服務 SLO 的症狀保持一致。所有呼叫警報也應該是可操作的。每小時（或更頻繁）打擾值班工程師的低優先級警報會擾亂生產力，而此類警報引起的疲勞也可能導致對嚴重警報的關注度低於必要的程度。更多討論請參閱「處理中斷」。

控制值班工程師因單一事件收到的警報數量也很重要。有時一個異常情況會產生多個警報，因此通過確保相關警報被監控或警報系統分組在一起來調節警報的扇出非常重要。如果在事件期間，出於任何原因產生了重複或無資訊的警報，將這些警報靜音可以為值班工程師提供必要的安靜，以專注於事件本身。系統性地為每個事件產生多於一個警報的嘈雜警報應該被調整，以接近 1:1 的警報/事件比率。這樣做可以讓值班工程師專注於事件，而不是分類重複的警報。

有時，導致運營過載的變更並不在 SRE 團隊的控制之下。例如，應用程式開發人員可能會引入導致系統更嘈雜、可靠性更低或兩者兼而有之的變更。在這種情況下，與應用程式開發人員合作設定共同的目標來改善系統是適當的。

在極端情況下，SRE 團隊可以選擇「交還呼叫器」——SRE 可以要求開發團隊專門為該系統值班，直到它達到相關 SRE 團隊的標準。交還呼叫器並不經常發生，因為幾乎總是可以與開發團隊合作，以減少運營負載並使給定的系統更可靠。然而，在某些情況下，可能需要跨越多個季度的複雜或架構性變更，才能使一個系統從運營的角度來看是可持續的。在這種情況下，SRE 團隊不應承受過度的運營負載。相反，與開發團隊重新協商值班職責是適當的，可能會將部分或全部呼叫警報路由給開發人員值班。這樣的解決方案通常是臨時措施，在此期間，SRE 和開發團隊共同努力，使服務恢復到可以再次由 SRE 團隊接管的狀態。

SRE 和產品開發團隊之間重新協商值班職責的可能性，證明了團隊之間的權力平衡。57 這種工作關係也例證了這兩個團隊及其所代表的價值觀——可靠性與功能速度——之間的健康張力通常是如何通過極大地有益於服務，並進而有益於整個公司來解決的。

## 一個危險的敵人：運營負載不足

為一個安靜的系統值班是幸福的，但是如果系統太安靜，或者當 SRE 不夠頻繁地值班時會發生什麼？運營負載不足對於 SRE 團隊來說是不可取的。長時間與生產脫節可能會導致信心問題，無論是過度自信還是信心不足，而知識差距只有在事件發生時才會被發現。

為了應對這種可能性，SRE 團隊的規模應該能夠讓每個工程師每季度至少值班一次或兩次，從而確保每個團隊成員都充分接觸到生產環境。「厄運之輪 (Wheel of Misfortune)」演習（在「加速 SRE 的值班與後續發展」中討論）也是有用的團隊活動，可以幫助磨練和提高故障排除技能和對服務的了解。Google 每年還有一個全公司範圍的災難恢復活動，稱為 DiRT（災難恢復培訓），它結合了理論和實踐演習，對基礎設施系統和單個服務進行為期多天的測試；請參閱 [Kri12]。

# 結論

本章描述的值班方法可作為 Google 所有 SRE 團隊的指導方針，並且是培養可持續和可管理的工作環境的關鍵。Google 的值班方法使我們能夠將工程工作作為擴展生產職責和維持高可靠性和可用性的主要手段，儘管 SRE 負責的系統和服務的複雜性和數量不斷增加。

雖然這種方法可能不直接適用於工程師需要為 IT 服務值班的所有情況，但我們相信它代表了一個堅實的模型，組織可以採用該模型來擴展以應對不斷增長的值班工作量。

56 本章的早期版本曾以文章形式發表在 ;login: (2015 年 10 月，第 40 卷，第 5 期)。

57 有關 SRE 和產品開發團隊之間自然張力的更多討論，請參閱「前言」。