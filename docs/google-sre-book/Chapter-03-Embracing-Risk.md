# 擁抱風險

作者：Marc Alvidrez 編輯：Kavita Guliani

您可能會期望 Google 努力打造 100% 可靠的服務——也就是永不故障的服務。然而，事實證明，超過某個點之後，提高可靠性對服務（及其用戶）來說反而更糟！極高的可靠性是有代價的：最大化穩定性會限制新功能的開發速度和產品交付給用戶的速度，並大幅增加其成本，這反過來又減少了團隊能夠提供的功能數量。此外，用戶通常不會注意到服務高可靠性與極高可靠性之間的差異，因為用戶體驗主要由較不可靠的組件（如行動網路或他們正在使用的設備）所主導。簡單來說，一個使用 99% 可靠智慧型手機的用戶，無法分辨出 99.99% 和 99.999% 的服務可靠性之間的區別！有鑑於此，網站可靠性工程 (Site Reliability Engineering) 不僅僅是最大化正常運行時間，而是尋求在不可用風險與快速創新和高效服務運營的目標之間取得平衡，從而優化用戶在功能、服務和性能方面的整體滿意度。

## 管理風險

不可靠的系統會迅速侵蝕用戶的信心，因此我們希望降低系統故障的機率。然而，經驗表明，在我們建構系統時，成本並非隨著可靠性的增加而線性增長——可靠性的增量改進可能比上一次增量改進的成本高出 100 倍。這種昂貴性有兩個維度：

在 SRE 中，我們主要通過管理風險來管理服務的可靠性。我們將風險概念化為一個連續體。我們同等重視如何將更高的可靠性工程化到 Google 系統中，以及確定我們運行的服務的適當容忍度。這樣做使我們能夠進行成本/效益分析，以確定例如，我們應該將搜尋、廣告、Gmail 或相簿放置在（非線性的）風險連續體上的哪個位置。我們的目標是將給定服務所承擔的風險與業務願意承擔的風險明確地對齊。我們努力使服務足夠可靠，但又不過分可靠。也就是說，當我們設定 99.99% 的可用性目標時，我們希望超過它，但不要超過太多：那樣會浪費為系統添加功能、清理技術債務或降低運營成本的機會。在某種意義上，我們將可用性目標視為一個最小值和最大值。這種框架的關鍵優勢在於它開啟了明確、深思熟慮的風險承擔。

# 衡量服務風險

作為 Google 的標準做法，我們通常最好通過確定一個客觀的指標來代表我們想要優化的系統屬性。通過設定目標，我們可以評估我們目前的性能，並跟踪隨時間的推移而發生的改進或退化。對於服務風險，如何將所有潛在因素簡化為單一指標並不明顯。服務故障可能有多種潛在影響，包括用戶不滿、傷害或失去信任；直接或間接的收入損失；品牌或聲譽影響；以及不良的媒體報導。顯然，其中一些因素很難衡量。為了使這個問題在我們運行的多種類型的系統中變得易於處理和一致，我們專注於**非計劃性停機 (unplanned downtime)**。

對於大多數服務來說，表示風險容忍度最直接的方法是可接受的非計劃性停機水平。非計劃性停機由期望的服務**可用性 (availability)** 水平來體現，通常以我們希望提供的「九」的數量來表示：99.9%、99.99% 或 99.999% 的可用性。每增加一個九，就意味著朝著 100% 可用性提高一個數量級。對於服務型系統，這個指標傳統上是根據系統正常運行時間的比例來計算的（請參閱「基於時間的可用性 (Time-based availability)」）。

使用這個公式，在一年的時間內，我們可以計算出達到給定可用性九位數所需的可接受的停機分鐘數。例如，一個可用性目標為 99.99% 的系統，一年內最多可以停機 52.56 分鐘，並且仍然保持在其可用性目標內；請參閱「可用性表格」以獲取表格。

然而，在 Google，基於時間的可用性指標通常沒有意義，因為我們關注的是全球分散式服務。我們的故障隔離方法使得我們在任何給定時間都很可能在世界某個地方為給定服務提供至少一部分流量（也就是說，我們在任何時候都至少是部分「正常運行」的）。因此，我們不使用圍繞正常運行時間的指標，而是根據**請求成功率 (request success rate)** 來定義可用性。「總體可用性」顯示了這個基於產出的指標是如何在一個滾動窗口內計算的（即，在一天窗口內的成功請求比例）。

例如，一個每天處理 250 萬次請求、每日可用性目標為 99.99% 的系統，最多可以出現 250 次錯誤，並且仍然達到當天的目標。

在典型的應用程式中，並非所有請求都是平等的：失敗一個新用戶註冊請求與失敗一個在背景輪詢新郵件的請求是不同的。然而，在許多情況下，以所有請求的成功率計算的可用性，從終端用戶的角度來看，是「非計劃性停機」的一個合理近似值。

將非計劃性停機量化為請求成功率，也使得這個可用性指標更適合用於那些通常不直接服務於終端用戶的系統。大多數非服務型系統（例如，批次處理、管線、儲存和交易系統）都有明確定義的成功和不成功工作單元概念。事實上，雖然本章討論的系統主要是消費者和基礎設施服務型系統，但許多相同的原則也適用於稍作修改的非服務型系統。

例如，一個批次處理程序，它提取、轉換我們一個客戶資料庫的內容並將其插入資料倉儲以進行進一步分析，可能會被設定為定期運行。使用以成功和不成功處理的記錄來定義的請求成功率，我們可以計算出一個有用的可用性指標，儘管該批次系統並非持續運行。

我們通常為服務設定季度可用性目標，並每週甚至每天跟踪我們對這些目標的表現。這種策略讓我們能夠通過尋找、追踪和修復不可避免出現的重大偏差，來管理服務以達到高層級的可用性目標。更多細節請參閱「服務水準目標 (Service Level Objectives)」。

# 服務的風險容忍度

確定一個服務的風險容忍度意味著什麼？在正式的環境中，或者在安全關鍵型系統的情況下，服務的風險容忍度通常直接內建於基本的產品或服務定義中。在 Google，服務的風險容忍度往往定義得不那麼清晰。

為了確定一個服務的風險容忍度，SRE 必須與產品所有者合作，將一套業務目標轉化為我們可以進行工程設計的明確目標。在這種情況下，我們關心的業務目標對所提供服務的性能和可靠性有直接影響。在實踐中，這種轉化說起來容易做起來難。雖然消費者服務通常有明確的產品所有者，但基礎設施服務（例如，儲存系統或通用的 HTTP 快取層）擁有類似的產品所有權結構卻不尋常。我們將依次討論消費者和基礎設施的情況。

## 確定消費者服務的風險容忍度

我們的消費者服務通常有一個產品團隊，作為應用程式的業務所有者。例如，搜尋、Google 地圖和 Google 文件都有各自的產品經理。這些產品經理負責了解用戶和業務，並為產品在市場上的成功塑造產品。當存在產品團隊時，該團隊通常是討論服務可靠性要求的最佳資源。在沒有專門產品團隊的情況下，建構系統的工程師通常會有意或無意地扮演這個角色。

在評估服務的風險容忍度時，需要考慮許多因素，例如以下幾點：

- 需要什麼樣的可用性水平？
- 不同類型的故障對服務有不同的影響嗎？
- 我們如何利用服務成本來幫助將服務定位在風險連續體上？
- 還有哪些其他服務指標需要考慮？

### 目標可用性水平

給定 Google 服務的目標可用性水平通常取決於其提供的功能以及該服務在市場中的定位。以下列表包括需要考慮的問題：

- 用戶期望的服務水平是什麼？
- 這項服務是否直接關係到收入（無論是我們的收入還是我們客戶的收入）？
- 這是一項付費服務，還是免費服務？
- 如果市場上有競爭對手，這些競爭對手提供什麼樣的服務水平？
- 這項服務是針對消費者還是企業？

考慮一下 Google Apps for Work 的要求。其大部分用戶是企業用戶，有大有小。這些企業依賴 Google Apps for Work 服務（例如，Gmail、日曆、雲端硬碟、文件）來提供工具，使其員工能夠執行日常工作。換句話說，Google Apps for Work 服務的中斷不僅是 Google 的中斷，也是所有嚴重依賴我們的企業的中斷。對於一個典型的 Google Apps for Work 服務，我們可能會設定一個 99.9% 的外部季度可用性目標，並以更強的內部可用性目標和一份規定了如果我們未能達到外部目標的懲罰措施的合約來支持這個目標。

YouTube 提供了一組對比鮮明的考量因素。當 Google 收購 YouTube 時，我們必須為該網站決定適當的可用性目標。2006 年，YouTube 專注於消費者，其業務生命週期階段與當時的 Google 非常不同。雖然 YouTube 已經有了一個很棒的產品，但它仍在快速變化和增長。我們為 YouTube 設定了比我們的企業產品更低的可用性目標，因為相應地，快速的功能開發更為重要。

### 故障類型

給定服務的預期故障形態是另一個重要考量。我們的業務對服務停機的彈性如何？對服務來說，哪種情況更糟：持續的低故障率，還是偶爾的全面網站中斷？兩種故障類型可能導致相同絕對數量的錯誤，但可能對業務產生截然不同的影響。

在提供私人資訊的系統中，自然會出現全面中斷和部分中斷之間差異的說明性例子。考慮一個聯絡人管理應用程式，以及間歇性故障導致個人資料圖片無法呈現，與另一種故障情況導致用戶的私人聯絡人被顯示給另一位用戶之間的差異。第一種情況顯然是用戶體驗不佳，SRE 會努力迅速解決問題。然而，在第二種情況下，暴露私人資料的風險很容易以一種顯著的方式破壞用戶的基本信任。因此，在第二種情況的除錯和潛在清理階段，完全關閉服務是適當的。

在 Google 提供的服務的另一端，有時在維護窗口期間進行定期中斷是可以接受的。幾年前，廣告前端 (Ads Frontend) 就是這樣一種服務。它被廣告商和網站發布者用來設置、配置、運行和監控他們的廣告活動。由於大部分工作都在正常工作時間內進行，我們確定以維護窗口形式的偶爾、定期、計劃性的中斷是可以接受的，我們將這些計劃性中斷計為計劃性停機，而非非計劃性停機。

### 成本

成本通常是決定服務適當可用性目標的關鍵因素。廣告 (Ads) 在進行這種權衡方面處於特別有利的地位，因為請求的成功和失敗可以直接轉化為收入的增加或損失。在確定每個服務的可用性目標時，我們會問這樣的問題：

- 如果我們以再多一個九的可用性來建構和運營這些系統，我們的收入增量會是多少？
- 這個額外的收入是否能抵銷達到該可靠性水平的成本？

為了使這個權衡方程式更具體，請考慮以下一個範例服務的成本/效益，其中每個請求的價值相等：

- 擬議的可用性目標改進：99.9% → 99.99%
- 擬議的可用性增加：0.09%
- 服務收入：100 萬美元
- 提高可用性的價值：100 萬美元 * 0.0009 = 900 美元

在這種情況下，如果將可用性提高一個九的成本低於 900 美元，那麼這項投資就是值得的。如果成本大於 900 美元，成本將超過預期的收入增長。

當我們沒有一個簡單的可靠性與收入之間的轉換函數時，設定這些目標可能會更困難。一個有用的策略可能是考慮網際網路上 ISP 的背景錯誤率。如果從終端用戶的角度來衡量故障，並且有可能將服務的錯誤率降低到背景錯誤率以下，那麼這些錯誤將落在給定用戶網際網路連接的噪音範圍內。雖然 ISP 和協定之間存在顯著差異（例如，TCP 與 UDP，IPv4 與 IPv6），但我們測量到 ISP 的典型背景錯誤率介於 0.01% 和 1% 之間。

### 其他服務指標

除了可用性之外，從其他指標的角度來審視服務的風險容忍度通常也很有成效。了解哪些指標重要，哪些不重要，為我們在嘗試進行深思熟慮的風險承擔時提供了自由度。

我們的廣告系統的服務延遲提供了一個說明性的例子。當 Google 首次推出網頁搜尋時，該服務的關鍵區別特徵之一就是速度。當我們引入 AdWords（在搜尋結果旁邊顯示廣告）時，該系統的一個關鍵要求是廣告不應減慢搜尋體驗。這一要求推動了每一代 AdWords 系統的工程目標，並被視為一個不變量。

AdSense 是 Google 的廣告系統，它響應發布者插入其網站的 JavaScript 程式碼的請求來提供情境廣告，其延遲目標非常不同。AdSense 的延遲目標是避免在插入情境廣告時減慢第三方頁面的呈現速度。因此，具體的延遲目標取決於給定發布者頁面的呈現速度。這意味著 AdSense 廣告的提供速度通常可以比 AdWords 廣告慢數百毫秒。

這種較寬鬆的服務延遲要求使我們能夠在資源配置（即確定我們使用的服務資源的數量和位置）方面做出許多明智的權衡，從而為我們節省了相對於天真配置的大量成本。換句話說，鑑於 AdSense 服務對延遲性能的適度變化相對不敏感，我們能夠將服務整合到更少的地理位置，從而減少我們的運營開銷。

## 確定基礎設施服務的風險容忍度

建構和運行基礎設施組件的要求與消費者產品的要求在許多方面有所不同。一個根本的區別是，根據定義，基礎設施組件有多個客戶端，通常需求各不相同。

### 目標可用性水平

考慮一下 **Bigtable** [Cha06]，一個用於結構化資料的大規模分散式儲存系統。一些消費者服務在用戶請求的路徑中直接從 Bigtable 提供資料。這樣的服務需要低延遲和高可靠性。其他團隊則使用 Bigtable 作為資料儲存庫，定期對其進行離線分析（例如，MapReduce）。這些團隊更關心吞吐量而不是可靠性。這兩種使用案例的風險容忍度截然不同。

滿足這兩種使用案例需求的一種方法是將所有基礎設施服務都設計得極其可靠。鑑於這些基礎設施服務也傾向於聚合大量資源，這種方法在實踐中通常過於昂貴。為了了解不同類型用戶的不同需求，您可以查看每種類型 Bigtable 用戶的請求佇列的期望狀態。

### 故障類型

低延遲用戶希望 Bigtable 的請求佇列（幾乎總是）是空的，以便系統可以在每個未完成的請求到達時立即處理它。（事實上，低效的佇列通常是高尾部延遲的原因。）關心離線分析的用戶更關心系統吞吐量，因此該用戶希望請求佇列永遠不為空。為了優化吞吐量，Bigtable 系統永遠不應在等待下一個請求時空閒。

如您所見，對於這兩組用戶來說，成功和失敗是對立的。低延遲用戶的成功是關心離線分析的用戶的失敗。

### 成本

以符合成本效益的方式滿足這些相互競爭的約束的一種方法是將基礎設施分區，並以多個獨立的服務水平提供。在 Bigtable 的例子中，我們可以建立兩種類型的叢集：低延遲叢集和吞吐量叢集。低延遲叢集旨在由需要低延遲和高可靠性的服務來操作和使用。為了確保短佇列長度並滿足更嚴格的客戶端隔離要求，可以為 Bigtable 系統配置大量的閒置容量，以減少爭用並增加冗餘。另一方面，吞吐量叢集可以被配置為在非常高的負載下運行，冗餘較少，從而優化吞吐量而非延遲。在實踐中，我們能夠以低得多的成本滿足這些較寬鬆的需求，可能只有低延遲叢集成本的 10-50%。鑑於 Bigtable 的巨大規模，這種成本節省很快就會變得非常顯著。

關於基礎設施的關鍵策略是提供具有明確劃分的服務水平的服務，從而使客戶端在建構其系統時能夠做出正確的風險和成本權衡。通過明確劃分的服務水平，基礎設施提供商可以有效地將在給定水平上提供服務的成本差異外部化給客戶端。以這種方式暴露成本，可以激勵客戶端選擇滿足其需求且成本最低的服務水平。例如，Google+ 可以決定將對執行用戶隱私至關重要的資料放在高可用性、全球一致的資料儲存中（例如，像 Spanner [Cor12] 這樣的全球複製的類 SQL 系統），而將可選資料（非關鍵但能增強用戶體驗的資料）放在更便宜、可靠性較低、新鮮度較低且最終一致的資料儲存中（例如，像 Bigtable 這樣具有盡力而為複製的 NoSQL 儲存）。

請注意，我們可以使用相同的硬體和軟體運行多種類別的服務。我們可以通過調整各種服務特性來提供截然不同的服務保證，例如資源數量、冗餘程度、地理配置約束，以及至關重要的**基礎設施軟體配置 (infrastructure software configuration)**。

### 範例：前端基礎設施

為了證明這些風險容忍度評估原則不僅僅適用於儲存基礎設施，讓我們來看看另一大類服務：Google 的前端基礎設施。前端基礎設施由運行在我們網路邊緣附近的反向代理和負載平衡系統組成。這些系統除其他外，是作為來自終端用戶連接的一個端點（例如，終止來自用戶瀏覽器的 TCP）。鑑於其關鍵作用，我們將這些系統設計為提供極高的可靠性水平。雖然消費者服務通常可以限制後端不可靠性的可見性，但這些基礎設施系統就沒那麼幸運了。如果一個請求從未到達應用程式服務的前端伺服器，它就丢失了。

我們已經探討了確定消費者和基礎設施服務風險容忍度的方法。現在，我們將討論如何利用該容忍度水平通過錯誤預算來管理不可靠性。

# 錯誤預算的動機 14

作者：Mark Roth 編輯：Carmela Quinito

本書的其他章節討論了產品開發團隊和 SRE 團隊之間如何產生緊張關係，因為他們通常根據不同的指標進行評估。產品開發的績效主要根據產品速度來評估，這會產生盡快推送新程式碼的激勵。與此同時，SRE 的績效（毫不奇怪）是根據服務的可靠性來評估的，這意味著有抵制高變更率的激勵。兩個團隊之間的資訊不對稱進一步加劇了這種固有的緊張關係。產品開發人員對編寫和發布程式碼所涉及的時間和精力有更多的可見性，而 SRE 對服務的可靠性（以及整個生產環境的狀態）有更多的可見性。

這些緊張關係通常反映在對工程實踐應投入多少精力的不同意見上。以下列表列出了一些典型的緊張關係：

通常，已有的團隊之間已經就風險/努力的界限達成了某種非正式的平衡。不幸的是，人們很少能證明這種平衡是最佳的，而不僅僅是相關工程師談判技巧的函數。這樣的決定也不應由政治、恐懼或希望驅動。（事實上，Google SRE 的非官方座右銘是「希望不是一種策略」。）相反，我們的目標是定義一個雙方都同意的客觀指標，可以用來以可重現的方式指導談判。決策越基於資料，就越好。

## 建立您的錯誤預算

為了將這些決策建立在客觀資料的基礎上，兩個團隊根據服務的**服務水準目標 (service level objective, SLO)**（請參閱「服務水準目標」）共同定義一個季度**錯誤預算 (error budget)**。錯誤預算提供了一個清晰、客觀的指標，確定了服務在單一季度內允許的不可靠程度。這個指標消除了 SRE 和產品開發人員在決定允許多少風險時的政治談判。

我們的實踐如下：

- **產品管理 (Product Management)** 定義一個 SLO，設定服務每季度應有的正常運行時間期望。
- 實際的正常運行時間由一個中立的第三方來衡量：我們的監控系統。
- 這兩個數字之間的差異就是本季度剩餘的「不可靠性」的「預算」。
- 只要測量的正常運行時間高於 SLO——換句話說，只要還有錯誤預算剩餘——就可以推送新的版本。

例如，假設一個服務的 SLO 是每季度成功服務所有查詢的 99.999%。這意味著該服務的錯誤預算是給定季度 0.001% 的失敗率。如果一個問題導致我們失敗了該季度預期查詢的 0.0002%，那麼這個問題就花費了該服務季度錯誤預算的 20%。

## 好處

錯誤預算的主要好處是它提供了一個共同的激勵，使產品開發和 SRE 都能專注於在創新和可靠性之間找到正確的平衡點。

許多產品使用這個控制循環來管理發布速度：只要系統的 SLO 得到滿足，就可以繼續發布。如果 SLO 違規頻繁到耗盡錯誤預算，發布將暫時停止，同時投入額外資源進行系統測試和開發，以使系統更具彈性、提高其性能等等。除了這種簡單的開/關技術外，還有更微妙和有效的方法：15 例如，當 SLO 違規的錯誤預算接近用完時，減慢發布速度或回滾它們。

例如，如果產品開發想在測試上偷工減料或提高推送速度，而 SRE 表示反對，錯誤預算就會指導決策。當預算充足時，產品開發人員可以承擔更多風險。當預算快用完時，產品開發人員自己會推動更多的測試或更慢的推送速度，因為他們不想冒著用完預算而導致發布停滯的風險。實際上，產品開發團隊變得自我監管。他們知道預算，可以管理自己的風險。（當然，這個結果依賴於 SRE 團隊有權在 SLO 被破壞時實際停止發布。）

如果網路中斷或資料中心故障降低了測量的 SLO 會發生什麼？此類事件也會消耗錯誤預算。因此，本季度剩餘時間內的新推送數量可能會減少。整個團隊都支持這種減少，因為每個人都共同承擔正常運行時間的責任。

預算還有助於突顯過高可靠性目標的一些成本，無論是在不靈活性還是創新緩慢方面。如果團隊在推出新功能方面遇到困難，他們可能會選擇放寬 SLO（從而增加錯誤預算）以增加創新。

- 管理服務可靠性在很大程度上是關於管理風險，而管理風險可能是昂貴的。
- 100% 可能永遠不是正確的可靠性目標：不僅不可能實現，而且通常比服務用戶想要或注意到的可靠性更高。將服務的特性與業務願意承擔的風險相匹配。
- 錯誤預算可以協調激勵機制，並強調 SRE 和產品開發之間的共同所有權。錯誤預算使決定發布速度變得更容易，並有效地化解與利益相關者關於中斷的討論，並允許多個團隊在沒有怨恨的情況下就生產風險達成相同的結論。

14 本節的早期版本曾以文章形式發表在 ;login: (2015 年 8 月，第 40 卷，第 4 期)。

15 被稱為「砰砰 (bang/bang)」控制——請參閱 https://en.wikipedia.org/wiki/Bang–bang_control。