# Feature Specification: User Profile

**Created**: 2025-10-08
**Status**: Draft
**Based on**: `.specify/memory/constitution.md` (v1.3.0)

---

## 一、主要使用者情境（User Scenarios & Testing）

### Primary User Story
作為一名平台使用者，我需要一個統一的個人設定中心，讓我能夠：
1. **查看我的個人資訊（Info）**，確認我的帳號狀態、所屬角色和團隊、登入活動記錄，以及了解我的帳號是否由外部身份驗證系統管理

#### 具體情境:
- **資訊確認**: 登入平台後，我需要快速確認自己的帳號狀態是否正常（Active）、所屬角色與團隊是否正確，確保我能存取應有的功能。
- **權限查詢**: 當某項操作被拒絕時，我需要查看自己的角色與團隊歸屬，判斷是否因權限不足，並向管理員申請調整。
- **活動追蹤**: 我需要查看自己最近的登入時間與歷史記錄，確認帳號未被異常存取，提升安全意識。
- **外部 IdP 導引**: 若我的帳號由公司統一身份系統（如 Google Workspace、Azure AD）管理，我需要知道應前往哪裡修改個人資料（如密碼、郵箱），而非在平台端嘗試編輯。
- **帳號建立時間**: 在進行稽核或報表分析時，我需要知道自己的帳號建立時間，作為使用期程的參考。

#### 現有痛點:
- 若個人資料分散在多處，難以快速獲取完整資訊，增加操作複雜度。
- 缺乏外部 IdP 提示時，使用者可能誤以為可在平台端修改資料，導致困惑。
- 若無登入歷史顯示，難以自主進行安全監控，降低帳號安全性。


2. **客製化我的平台偏好（Preferences）**，根據工作習慣調整介面主題（亮色/暗色/自動）、語言、時區，並設定預設首頁

#### 具體情境:
- **介面主題調整**: 在夜間值班時，我需要切換至深色主題保護眼睛；白天則切換回淺色主題，或直接使用自動模式跟隨系統設定。
- **語言偏好**: 作為非中文母語使用者，我需要將平台語言切換為英文，確保介面與文案易於理解。
- **時區設定**: 當我在不同地區工作或與全球團隊協作時，我需要設定正確的時區，確保所有時間戳（如告警、日誌）顯示為我的本地時間，避免混淆。
- **預設首頁**: 我每天最關注系統資源監控儀表板，因此需要將其設為預設首頁，登入後立即顯示，節省導航時間。
- **偏好匯出與備份**: 在更換裝置或重新安裝時，我需要匯出目前的偏好設定（JSON格式），以便快速還原至新環境。
- **恢復預設值**: 當嘗試多種設定後，我需要一鍵恢復為系統預設值，重新開始設定。

#### 現有痛點:
- 若無個人化設定，所有使用者共用相同介面，難以適應不同工作習慣與環境需求。
- 缺乏時區設定時，跨區域協作容易因時間顯示差異產生誤解。
- 若無匯出功能，設定無法備份與遷移，增加重新配置成本。

3. **管理我的帳號安全（Security）**，定期變更密碼、查看登入歷史以偵測可疑活動，並在需要時立即撤銷其他裝置的登入會話

以便我能掌握帳號狀態、提升工作效率，並確保帳號安全性，同時在懷疑帳號被盜用時能快速回應。

#### 具體情境:
- **定期密碼更新**: 依據公司資安政策，我需要每90天更新一次登入密碼，確保帳號安全。
- **密碼強度驗證**: 在設定新密碼時，我需要即時的強度回饋（如「弱」、「中」、「強」），確保符合安全要求（如長度、複雜度）。
- **可疑活動排查**: 當收到異常登入警告時，我需要查看最近的登入歷史（時間、IP、裝置），確認是否有未授權存取。
- **裝置會話管理**: 若懷疑帳號在其他裝置上被盜用，我需要立即登出所有其他裝置的會話，僅保留目前裝置的登入狀態，防止進一步風險。
- **登入失敗分析**: 查看登入歷史中的失敗記錄，判斷是否有暴力破解嘗試或密碼輸入錯誤，必要時聯繫管理員。

#### 現有痛點:
- 若無密碼強度提示，可能設定弱密碼，增加帳號被破解風險。
- 缺乏登入歷史時，難以自主進行安全監控與異常偵測。
- 若無批次登出功能，當帳號疑似外洩時，需逐一處理每個會話，反應速度慢。

### Acceptance Scenarios

#### 場景群組 A：個人資訊查看（Info Viewing）
1. **Given** 我登入平台後，導航到「個人設定」頁面的「基本資訊」頁籤，
   **When** 頁面載入完成，
   **Then** 我應該能看到我的姓名、Email、目前狀態（如「啟用」）、角色和團隊。

2. **Given** 我的帳號是透過外部身份提供商（IdP，如 Google Workspace）進行管理的，
   **When** 我查看我的基本資訊頁面，
   **Then** 頁面上應顯示一條提示訊息，告知我此帳號由外部系統管理，
   **And Then** 提供一個連結讓我能跳轉到該系統的管理介面以修改個人資訊。

3. **Given** 我想確認我的帳號建立時間與最近登入時間，
   **When** 我查看基本資訊頁面，
   **Then** 「建立時間」、「最近更新時間」與「最近登入時間」欄位應顯示易於理解的相對時間（例如「2 年前」）和精確的日期時間。

4. **Given** 我是首次登入的新帳號，
   **When** 我查看基本資訊頁面，
   **Then** 「最近登入」欄位應顯示為「尚未登入」或類似的提示。

#### 場景群組 B：偏好設定管理（Preferences Management）
5. **Given** 我偏好在夜間工作，覺得預設的亮色主題很刺眼，
   **When** 我在「偏好設定」頁籤將「介面主題」更改為「深色」，並點擊「儲存設定」，
   **Then** 整個平台的使用者介面應立即或在下次刷新後切換為深色主題。

6. **Given** 我希望介面主題能依據作業系統設定自動切換，
   **When** 我在「介面主題」選項中選擇「自動（依系統設定）」並儲存偏好，
   **Then** 系統應在我的裝置切換明暗模式時自動套用對應主題，
   **And Then** 若我手動切換為「亮色」或「暗色」，則覆蓋自動偵測行為，直到我再次選擇「自動」為止。

7. **Given** 我最常查看的是「服務 A 健康度」儀表板，
   **When** 我在「預設首頁」的下拉選單中選擇「服務 A 健康度」，並儲存設定，
   **Then** 下次我登入或訪問平台根路徑時，應直接被導向到該儀表板。

8. **Given** 我不小心修改了一些設定，但想恢復到系統的初始狀態，
   **When** 我點擊「重置為預設」按鈕，
   **Then** 頁面上的所有選項應恢復為系統管理員設定的預設值。

9. **Given** 我需要將我的偏好設定備份以便未來恢復，
   **When** 我點擊「匯出偏好設定」按鈕，
   **Then** 系統應下載一份包含我當前所有偏好設定的 JSON 檔案。

#### 場景群組 C：安全管理（Security Management）
10. **Given** 我想變更我的密碼以降低風險，
    **When** 我在「安全設定」頁籤輸入正確的舊密碼，以及一個符合強度要求的新密碼和確認密碼，然後點擊「更新密碼」，
    **Then** 系統應提示我密碼更新成功，
    **And Then** 我可以用新密碼重新登入。

11. **Given** 我在輸入新密碼時，確認密碼與新密碼不符，
    **When** 我將焦點移出確認密碼欄位，
    **Then** 該欄位下方應出現一條錯誤提示，告知「新密碼與確認密碼不符」。

12. **Given** 我在設定新密碼時，
    **When** 我輸入密碼內容，
    **Then** 系統應提供視覺化的「密碼強度計」，根據密碼的複雜度（長度、字元類型組合）即時回饋其強度（弱/中/強）。

13. **Given** 我懷疑我的帳號可能在別處被登入，
    **When** 我點擊「登出其他裝置」按鈕，
    **Then** 系統應提示我操作成功，並使我所有其他裝置上的登入會話立即失效。

14. **Given** 我想檢查最近是否有異常的登入嘗試，
    **When** 我查看「最近登入活動」列表，
    **Then** 我應該能看到每一次登入的時間、IP 位址、裝置類型和登入結果（成功/失敗），
    **And Then** 列表應支援分頁以顯示歷史紀錄。

#### 場景群組 D：整合情境（Integrated Scenarios）
15. **Given** 我修改了多個偏好設定但尚未儲存，
    **When** 我查看頁面狀態，
    **Then** 「儲存設定」按鈕應變為可點擊狀態，
    **And Then** 頁面應顯示提示（如按鈕顏色變化）表明有未儲存的變更。

16. **Given** 我嘗試存取個人設定頁面但後端 API 無法獲取資料，
    **When** 頁面載入失敗，
    **Then** 頁面應顯示一個清晰的錯誤訊息，並提供重試按鈕。

### 邊界案例（Edge Cases）
- 如果使用者沒有任何可用的儀表板（例如新帳號且未被授予任何權限），「預設首頁」的下拉選單應被禁用，並顯示提示訊息。
- 「儲存設定」按鈕在使用者沒有做出任何修改時應處於禁用狀態。
- 更改語言設定後，應提示使用者需要重新整理頁面才能完全套用。
- 如果使用者輸入的舊密碼不正確，後端應返回錯誤，前端需顯示對應的提示。
- 如果使用者輸入的新密碼強度不足，提交時應被阻止。
- 在更新密碼或撤銷會話期間，對應的按鈕應顯示為載入中狀態並被禁用。
- 對於本地使用者（非 IdP 管理），基本資訊頁面應提供連結或指引，將其導向獨立的流程來修改個人資訊（FUTURE）。

---

## 二、功能需求（Functional Requirements）

### 2.1. 個人資訊查看（Info Viewing）
| 編號 | 說明 |
|------|------|
| **FR-I-001** | 頁面必須（MUST）從 `/me` API 端點獲取當前登入使用者的個人資料。 |
| **FR-I-002** | 頁面必須（MUST）以唯讀形式展示使用者的核心資訊，包括：姓名、Email、ID、狀態、角色和團隊。 |
| **FR-I-003** | 頁面必須（MUST）展示關鍵時間戳，包括帳號的建立時間、最近更新時間和最近登入時間，並以使用者友好的相對時間格式呈現（如「2 年前」）。 |
| **FR-I-004** | 如果平台設定了外部身份提供商（IdP），頁面必須（MUST）顯示一條提示訊息，並提供一個指向該 IdP 管理主控台的連結。 |
| **FR-I-005 (AS-IS)** | 基本資訊頁面為唯讀，不提供編輯功能。 |
| **FR-I-006 (AS-IS)** | 頁面中的狀態標籤（如「啟用」）是透過前端的 `statusLabelMap` 進行硬編碼轉換的。 |
| **FR-I-007 (FUTURE)** | 對於本地使用者，應提供一個連結或指引，將其導向獨立的流程來修改個人資訊。 |

### 2.2. 偏好設定管理（Preferences Management）
| 編號 | 說明 |
|------|------|
| **FR-P-001** | 系統必須（MUST）提供一個介面，允許使用者設定其個人化的偏好。 |
| **FR-P-002** | 可設定的偏好必須（MUST）至少包括：介面主題、語言、時區和預設首頁。 |
| **FR-P-003** | 所有可用的選項（如主題列表、語言列表、時區列表、儀表板列表）必須（MUST）由後端 API 動態提供。 |
| **FR-P-004** | 系統必須（MUST）支援三種主題模式：「亮色」、「暗色」、「自動（依系統設定）」，並允許使用者自由切換。 |
| **FR-P-005** | 當主題設定為「自動」時，系統應根據使用者裝置環境自動變更外觀，且變更應於次登入時持續生效。 |
| **FR-P-006** | 系統必須（MUST）提供「儲存變更」的功能，用於將使用者的修改持久化。 |
| **FR-P-007** | 只有在設定被修改後，「儲存變更」按鈕才應變為可點擊狀態。 |
| **FR-P-008** | 系統必須（MUST）提供「重置為預設」的功能，允許使用者一鍵恢復到系統預設的偏好設定。 |
| **FR-P-009** | 系統必須（MUST）提供「匯出偏好設定」的功能，允許使用者將其當前設定下載為一個 JSON 檔案。 |
| **FR-P-010** | 使用者偏好設定必須（MUST）在儲存後立即持久化，並於重新登入時完整還原。若儲存失敗，系統應提示使用者並保留原設定狀態。 |
| **FR-P-011 (FUTURE)** | 系統應支援「匯入偏好設定」功能，允許使用者從 JSON 檔案恢復偏好。 |
| **FR-P-012 (FUTURE)** | 頁面應提供草稿自動儲存功能。 |

### 2.3. 安全管理（Security Management）
| 編號 | 說明 |
|------|------|
| **FR-S-001** | 系統必須（MUST）提供一個表單，允許使用者在提供當前密碼的前提下變更其登入密碼。 |
| **FR-S-002** | 系統必須（MUST）提供一個視覺化的「密碼強度計」，根據新密碼的複雜度（長度、字元類型組合）即時回饋其強度（弱/中/強）。 |
| **FR-S-003** | 系統必須（MUST）在表單驗證層級檢查新密碼與確認密碼是否一致，並即時顯示錯誤提示。 |
| **FR-S-004** | 系統必須（MUST）提供一個「登出其他裝置」的功能，用於立即撤銷使用者所有其他的有效登入會話。 |
| **FR-S-005** | 系統必須（MUST）在一個可分頁的表格中，展示使用者最近的登入歷史紀錄。 |
| **FR-S-006** | 登入歷史紀錄必須（MUST）包含：時間戳、IP 位址、裝置資訊和登入狀態（成功/失敗）。 |
| **FR-S-007 (AS-IS)** | 登入歷史中的「裝置」資訊是前端基於 User-Agent 字串進行簡單解析的結果。 |
| **FR-S-008 (FUTURE)** | 系統必須在後端強制執行密碼強度策略，不得僅依賴前端驗證。 |

### 2.4. 整合與治理需求（Integration & Governance）
| 編號 | 說明 |
|------|------|
| **FR-G-001** | 所有 UI 文字（包括 Toast 通知）必須（MUST）使用 i18n Key 進行渲染。 |
| **FR-G-002** | 所有 UI 元件的顏色必須（MUST）使用語義化的 Theme Token，禁止直接使用 Tailwind 色票或自訂 class。 |
| **FR-G-003** | 所有 state-changing 操作（變更密碼、更新偏好、撤銷會話）成功後，後端必須（MUST）回傳 `auditId`，前端需在提示訊息中顯示此 ID 以利追蹤。 |
| **FR-G-004** | 所有操作（變更密碼、更新偏好、撤銷會話）都必須（MUST）產生包含操作上下文的審計日誌。 |
| **FR-G-005** | 應上報與使用者偏好變更頻率、密碼更新頻率、會話撤銷次數相關的指標至監控系統。 |

---

## 三、關鍵資料實體（Key Entities）

| 實體名稱 | 描述 | 關聯 |
|-----------|------|------|
| **User** | 核心資料實體，代表當前登入的使用者。包含姓名、Email、ID、狀態、角色、團隊、建立時間、最近更新時間、最近登入時間。 | Role, Team, UserPreferences, LoginHistoryRecord |
| **AuthSettings** | 平台的身份驗證設定，用於判斷是否啟用外部 IdP，包含 IdP 類型（Google/Azure AD）、管理主控台 URL。 | - |
| **UserPreferences** | 代表一個使用者的完整偏好設定集合，包含介面主題、語言、時區、預設首頁儀表板 ID。 | User, Dashboard |
| **PreferenceOptions** | 由後端提供的、用於填充各個下拉選單的可用選項列表，包含主題列表、語言列表、時區列表、儀表板列表。 | - |
| **LoginHistoryRecord** | 一筆獨立的登入活動紀錄，包含時間戳、IP 位址、裝置資訊（User-Agent）、登入狀態（成功/失敗）。 | User |

---

## 四、權限控制 (RBAC)

### 4.1. 權限定義 (Permissions)
| 權限字串 | 描述 |
|-----------|------|
| `profile:info:read` | 檢視個人基本資訊。 |
| `profile:preferences:read` | 檢視個人偏好設定。 |
| `profile:preferences:update` | 修改個人偏好設定。 |
| `profile:security:read` | 檢視安全設定與登入歷史。 |
| `profile:security:update` | 變更密碼。 |
| `profile:security:revoke` | 撤銷其他裝置的登入會話。 |

### 4.2. UI 控制映射 (UI Mapping)
- **頁面存取**：整個「個人設定」頁面需由 `<RequirePermission permission="profile:info:read">` 包裹（最低權限）。
- **頁籤存取**：
  - 基本資訊頁籤：`profile:info:read`
  - 偏好設定頁籤：`profile:preferences:read`
  - 安全設定頁籤：`profile:security:read`
- **操作按鈕**：
  - 「儲存偏好設定」：`profile:preferences:update`
  - 「重置為預設」：`profile:preferences:update`
  - 「匯出偏好設定」：`profile:preferences:read`
  - 「更新密碼」：`profile:security:update`
  - 「登出其他裝置」：`profile:security:revoke`
- **目前狀態**：此頁面目前對所有登入使用者可見，未實現細粒度權限控制（FUTURE）。

---

## 五、觀測性與治理檢查（Observability & Governance）

| 項目 | 狀態 | 說明 |
|------|------|------|
| Logging/Tracing | ✅ | 所有操作（變更密碼、更新偏好、撤銷會話）需產生審計記錄，包含操作上下文與 auditId。 |
| Metrics & Alerts | ✅ | 記錄使用者偏好變更頻率、密碼更新頻率、會話撤銷次數，並上報至監控系統。 |
| RBAC | 🟡 | 部分實現。頁面目前對所有登入使用者可見，未實現細粒度權限控制（FUTURE）。 |
| i18n | 🟡 | 部分實現。profile-security 已實現，profile-info 與 profile-preference 需遷移。 |
| Theme Token | 🟡 | 部分實現。所有模組需重構為使用中央設計系統的 Theme Token，禁止直接使用 Tailwind 色票。 |
| [FUTURE] Import Preferences | ⚙️ | 支援匯入偏好設定功能（FR-P-011）。 |
| [FUTURE] Auto-save Draft | ⚙️ | 支援草稿自動儲存功能（FR-P-012）。 |
| [FUTURE] Backend Password Policy | ⚙️ | 後端強制執行密碼強度策略（FR-S-008）。 |

---

## 六、審查與驗收清單（Review & Acceptance Checklist）

- [x] 所有段落齊備且結構正確。
- [x] 無技術語句。
- [x] 所有 FR 具可測試性。
- [x] 無模糊或重疊需求。
- [x] 與 `.specify/memory/constitution.md` (v1.3.0) 一致。
- [x] 模板結構完整。
- [x] 已整合 `profile-info-spec.md`、`profile-preference-spec.md`、`profile-security-spec.md` 三份規格。

---

## 七、模糊與待確認事項（Clarifications）

| 項目 | 狀態 | 備註 |
|------|------|------|
| i18n 遷移 | [NEEDS CLARIFICATION] | profile-info 與 profile-preference 目前使用硬編碼中文，需全面遷移至 i18n 內容管理系統。profile-security 已實現。 |
| Theme Token 重構 | [NEEDS CLARIFICATION] | 所有模組廣泛使用 Tailwind CSS 的原子化 class（如 `bg-slate-800/60`），需重構為使用中央設計系統的 Theme Token。 |
| 自動主題偵測 | [NEEDS CLARIFICATION] | 需確認自動模式是否依據瀏覽器或作業系統層級的設定進行偵測，以及偵測機制的實現方式。 |
| 偏好設定同步 | [FUTURE] | 未來是否支援跨裝置同步偏好設定（例如使用者在不同電腦登入後保持相同外觀與語言）仍待確認。 |
| 本地使用者資訊編輯 | [FUTURE] | 對於本地使用者（非 IdP 管理），基本資訊頁面應提供連結或指引，將其導向獨立的流程來修改個人資訊（FR-I-007）。 |
| 密碼強度策略 | [FUTURE] | 後端應強制執行密碼強度策略，不得僅依賴前端驗證（FR-S-008），需確認策略內容（最小長度、字元類型要求）。 |
| 草稿自動儲存 | [FUTURE] | 偏好設定頁面應提供草稿自動儲存功能（FR-P-012），需確認自動儲存頻率與儲存策略。 |
| 匯入偏好設定 | [FUTURE] | 系統應支援匯入偏好設定功能（FR-P-011），需確認匯入時的驗證機制與衝突處理策略。 |

---
