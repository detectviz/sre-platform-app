# 歷史數據回放 (Backtesting) 任務提示詞

你是一位專精於 SRE 平台設計的資深工程師，任務是實作並優化「歷史數據回放 (Backtesting)」模組。請依以下任務清單逐步完成。

---

## 🎯 任務定位
- 提供驗證與模擬能力，讓使用者能根據過去的歷史數據回放告警規則，檢查正確性與合理性。
- 此模組屬於 **「智慧排查 (Analysis)」** 模組下的一個頁籤頁面，與分析總覽、日誌探索、容量規劃並列。

---

## 🔍 與告警引擎差異
- **告警引擎 (Alert Engine)**: 聚焦於「即時數據流」，持續判斷當下是否符合觸發條件並立即通知。
- **歷史數據回放 (Backtesting)**: 聚焦於「已存在的數據」，用於驗證規則在過去一段時間內是否會被觸發。

---

## ✅ 任務清單

1. **基本回放功能**
   - 實作功能：使用者可選擇一組告警規則與一段歷史資料，系統模擬運行並輸出觸發次數與觸發點時間。
   - 目前已支援的輸出結果包括：觸發次數、觸發率（觸發次數／數據點數）、數據點總數。

2. **簡易趨勢對照**
   - 實作功能：提供可視化圖表，顯示「規則 vs 數據」對照。
   - 圖表會顯示：指標（趨勢）線、閾值線、觸發點（標記）、事件標記區塊（顯示事件發生的時間範圍）。

3. **事件標記**
   - 實作功能：允許使用者新增、刪除或匯入實際事件，需輸入事件名稱與時間範圍，並顯示於圖表中（以區塊或標記方式呈現）。

---

## 📂 實作影響範圍
1. **前端 (UI)**
   - 在「智慧排查」模組中新增一個頁籤 `Backtesting`。
   - UI 現包含四大區塊：任務設定、數據趨勢圖、回放結果總覽、事件比對清單。
   - 強調避免冗餘輸入，只需規則選擇、時間範圍、事件標記。

2. **後端 API (openapi-specs/)**
   - 初版需 `POST /backtesting/run` 與 `GET /backtesting/results/{task_id}`。
   - 事件標記需提供新增、刪除 API，例如 `POST /backtesting/events` 用於新增事件標記，`DELETE /backtesting/events/{id}` 用於刪除事件標記。
   - Schema 定義涵蓋：規則 ID、時間範圍、模擬結果與事件標記。

3. **資料庫 (db_schema.sql)**
   - 新增 `backtesting_tasks` 表，用於存放回放任務參數與狀態。
   - 新增 `backtesting_results` 表，用於存放規則執行結果與觸發時間。
   - 新增 `backtesting_events` 表，用於存放使用者標記的實際事件。

---

## 📌 使用場景
- 驗證新建立或修改過的告警規則，確保合理性。
- 分析歷史事故，檢查當時規則是否能正確捕捉事件。
- 作為審計依據，提供規則設計與實際數據的比對證據。

- 目前可進行事件標記與圖表對照，支援將事件與觸發點進行可視化比對。
- Precision/Recall 與統計摘要等進階計算目前為預留，尚未正式支援。

---

> **初版重點：輕量化、先確保功能閉環**

---

**提示詞版本**: 1.3  
**最後更新**: 2025-10-04