---
description: 透過提出最多 5 個高度針對性的澄清問題，識別目前功能規格中不足說明的部分，並將答案編碼回規格中。
---

使用者輸入可以直接由 agent 提供或作為命令參數傳入 - 你**必須**在繼續提示前考慮該輸入（若不為空）。

使用者輸入：

$ARGUMENTS

目標：偵測並減少當前功能規格中的模糊或缺失決策點，並直接將澄清結果記錄於規格檔案中。

注意：此澄清工作流程預期在呼叫 `/plan` 之前執行並完成。若使用者明確表示跳過澄清（例如探索性 spike），可繼續，但必須警告後續重工風險增加。

執行步驟：

1. 從 repo root 執行 `.specify/scripts/bash/check-prerequisites.sh --json --paths-only` **一次**（結合 `--json --paths-only` 模式 / `-Json -PathsOnly`）。解析最小 JSON 載荷欄位：
   - `FEATURE_DIR`
   - `FEATURE_SPEC`
   - （可選擇捕捉 `IMPL_PLAN`、`TASKS` 以利未來鏈式流程。）
   - 若 JSON 解析失敗，中止並指示使用者重新執行 `/specify` 或確認 feature branch 環境。

2. 載入當前 spec 檔案。使用以下分類法進行結構化模糊與覆蓋掃描。對每個類別標記狀態：Clear / Partial / Missing。產生用於優先排序的內部覆蓋地圖（除非不會提出問題，否則不輸出原始地圖）。

   功能範圍與行為：
   - 核心使用者目標與成功標準
   - 明確的非範圍聲明
   - 使用者角色 / 人物差異化

   領域與資料模型：
   - 實體、屬性、關聯
   - 身份與唯一性規則
   - 生命週期 / 狀態轉換
   - 資料量 / 規模假設

   互動與 UX 流程：
   - 關鍵使用者旅程 / 序列
   - 錯誤 / 空狀態 / 載入狀態
   - 可存取性或在地化說明

   非功能性品質屬性：
   - 效能（延遲、吞吐量目標）
   - 可擴展性（水平 / 垂直、限制）
   - 可靠性與可用性（正常運作時間、復原期望）
   - 可觀察性（日誌、指標、追蹤訊號）
   - 安全性與隱私（認證 / 授權、資料保護、威脅假設）
   - 合規 / 法規限制（如有）

   整合與外部依賴：
   - 外部服務 / API 及失效模式
   - 資料匯入 / 匯出格式
   - 協定 / 版本假設

   邊界案例與失敗處理：
   - 負面情境
   - 限流 / 節流
   - 衝突解決（例如並發編輯）

   約束與權衡：
   - 技術約束（語言、儲存、主機）
   - 明確權衡或拒絕的替代方案

   術語與一致性：
   - 正式詞彙表術語
   - 避免使用的同義詞 / 已棄用詞彙

   完成訊號：
   - 驗收標準的可測試性
   - 可衡量的完成定義指標風格

   雜項 / 佔位符：
   - TODO 標記 / 未決定事項
   - 模糊形容詞（如「robust」、「intuitive」）缺乏量化

   對每個狀態為 Partial 或 Missing 的類別，加入候選澄清問題，除非：
   - 澄清對實作或驗證策略無實質影響
   - 資訊較適合延後至規劃階段（內部註記）

3. （內部）產生優先排序的候選澄清問題隊列（最多 5 個）。不要一次輸出全部問題。遵守以下限制：
    - 整個會話最多 5 個問題。
    - 每題答案必須是：
       * 短的多選擇（2–5 個明確、互斥選項），或
       * 一個字 / 短語答案（明確限制：「答案不超過 5 個字」）。
   - 僅包含對架構、資料建模、任務拆解、測試設計、UX 行為、運維準備或合規驗證有實質影響的問題。
   - 確保類別覆蓋平衡：優先涵蓋高影響未解決類別；避免兩個低影響問題取代一個高影響領域（例如安全狀態）。
   - 排除已回答的問題、瑣碎風格偏好或計劃層級執行細節（除非阻礙正確性）。
   - 偏好能減少下游重工風險或避免驗收測試錯誤對齊的澄清。
   - 若超過 5 個類別未解決，依 (影響 × 不確定性) 選出前 5。

4. 依序提問迴圈（互動）：
    - 每次精確呈現一題。
    - 多選題以 Markdown 表格呈現選項：

       | Option | Description |
       |--------|-------------|
       | A | <選項 A 說明> |
       | B | <選項 B 說明> |
       | C | <選項 C 說明> |（視需要增至 D/E，最多 5 個）
       | Short | 提供不同短答案（<=5 字）|（僅在適合自由格式時包含）

    - 短答題（無明確離散選項）在問題後輸出單行：`Format: Short answer (<=5 words)`。
    - 使用者回答後：
       * 驗證答案是否對應選項或符合 <=5 字限制。
       * 若模糊，請求快速澄清（計數仍屬同一題，勿前進）。
       * 確認妥當後記錄於工作記憶（尚不寫檔），並進入下一題。
    - 停止提問條件：
       * 所有關鍵模糊點提前解決（剩餘問題非必要）
       * 使用者表示完成（「done」、「good」、「no more」）
       * 已提問達 5 題
    - 永不提前揭露後續問題。
    - 若起始無有效問題，立即回報無關鍵模糊點。

5. 每接受一答案後整合（增量更新）：
    - 保持記憶中 spec 表示（啟動時載入一次）及原始檔案內容。
    - 本會話首次整合答案時：
       * 確保存在 `## Clarifications` 區段（若缺，於最高層上下文/總覽節點後建立）。
       * 在該區段下建立（若無）`### Session YYYY-MM-DD` 子標題，日期為當天。
    - 接受答案後立即附加一行子彈：`- Q: <問題> → A: <最終答案>`。
    - 立即將澄清套用至最適合區段：
       * 功能模糊 → 更新或新增功能需求中的子彈
       * 使用者互動 / 角色區別 → 更新 User Stories 或 Actors 子節（若有）以明確角色、限制或場景
       * 資料形態 / 實體 → 更新 Data Model（新增欄位、型別、關聯）並保持順序；簡潔註記新增限制
       * 非功能約束 → 在 Non-Functional / Quality Attributes 區段新增/修改可衡量標準（將模糊形容詞轉為指標或明確目標）
       * 邊界案例 / 負向流程 → 在 Edge Cases / Error Handling 新增子彈（或建立該子節）
       * 術語衝突 → 在規格中統一用詞；必要時保留原詞一次並加註 `(formerly referred to as "X")`
    - 若澄清使先前模糊陳述失效，取代該陳述，避免重複；勿留過時矛盾文字。
    - 每次整合後立即儲存 spec 檔案，降低上下文遺失風險（原子覆寫）。
    - 保持格式：不重排無關區段，維持標題階層。
    - 使每個插入澄清簡潔且可測試（避免敘事偏移）。

6. 驗證（每次寫入後及最終）：
   - 澄清會話中每個接受答案有且只有一行子彈（無重複）。
   - 總提問（接受）數 ≤ 5。
   - 更新區段不留新答案欲解決的模糊佔位符。
   - 無矛盾先前陳述（掃描並移除失效替代選項）。
   - Markdown 結構有效；新增標題僅限 `## Clarifications`、`### Session YYYY-MM-DD`。
   - 術語一致性：所有更新區段使用相同正式詞彙。

7. 將更新後的 spec 寫回 `FEATURE_SPEC`。

8. 報告完成（提問迴圈結束或提前終止後）：
   - 已提問和回答問題數。
   - 更新後 spec 路徑。
   - 觸及區段列表。
   - 覆蓋摘要表，列出每個分類狀態：Resolved（原 Partial/Missing 且已解決）、Deferred（超出提問配額或較適合規劃階段）、Clear（已足夠）、Outstanding（仍 Partial/Missing 但低影響）。
   - 若有 Outstanding 或 Deferred，建議是否繼續執行 `/plan` 或稍後於規劃後再執行 `/clarify`。
   - 建議下一步命令。

行為規則：
- 若無重大模糊點（或所有潛在問題皆低影響），回應：「No critical ambiguities detected worth formal clarification.」並建議繼續。
- 若缺少 spec 檔案，指示使用者先執行 `/specify`（此處不建立新 spec）。
- 不得超過 5 題問題（同一題重試不計入）。
- 避免推測技術棧問題，除非缺失阻礙功能清晰。
- 尊重使用者提前終止訊號（「stop」、「done」、「proceed」）。
- 若無提問因完全覆蓋，輸出精簡覆蓋摘要（全部 Clear）並建議前進。
- 若達配額但仍有高影響未解決類別，明確標示 Deferred 並說明理由。

優先排序上下文：$ARGUMENTS
