# 功能規格書(Feature Specification)

**模組名稱 (Module)**: 容量規劃
**類型 (Type)**: Module
**來源路徑 (Source Path)**: pages/analysis/CapacityPlanningPage.tsx
**建立日期 (Created)**: 2025-10-06
**狀態 (Status)**: Draft
**依據憲法條款 (Based on)**: `.specify/memory/constitution.md`

---

## 一、主要使用者情境(User Scenarios & Testing)

### 主要使用者故事(Primary User Story)
SRE 工程師需要進行容量規劃,預測資源使用趨勢,提前擴容避免效能瓶頸。

### 驗收情境(Acceptance Scenarios)
1. **Given** 使用者選擇資源與指標,**When** 設定預測時間範圍,**Then** 系統應使用歷史資料預測未來趨勢
2. **Given** 預測完成,**When** 查看報告,**Then** 應顯示趨勢圖、達到閾值時間點、擴容建議
3. **Given** 使用者調整預測模型,**When** 重新計算,**Then** 應更新預測結果與建議

### 邊界案例(Edge Cases)
- 當歷史資料呈現異常波動時,應標記並提示可能影響準確度
- 當預測結果超出合理範圍時,應發出警告並建議人工審核
- 當資源類型不支援預測時,應明確提示並建議替代方案

---

## 二、功能需求(Functional Requirements)

- **FR-001**: 系統必須(MUST)支援選擇資源、指標、預測時間範圍。
- **FR-002**: 系統必須(MUST)使用時間序列演算法(如線性回歸、ARIMA)預測趨勢。
- **FR-003**: 系統應該(SHOULD)顯示預測信賴區間與準確度評估。
- **FR-004**: 系統應該(SHOULD)提供擴容建議,包含時間點與容量大小。
- **FR-005**: 系統可以(MAY)整合成本估算,計算擴容費用。

---

## 三、關鍵資料實體(Key Entities)
| 實體名稱 | 描述 | 關聯 |
|-----------|------|------|
| CapacityPlan | 容量規劃任務 | 關聯 Resource |
| ForecastResult | 預測結果,含趨勢與建議 | 屬於 CapacityPlan |
| ScalingRecommendation | 擴容建議 | 基於 ForecastResult |

---

## 四、觀測性與治理檢查(Observability & Governance Checklist)

| 項目 | 狀態 | 說明 |
|------|------|------|
| 記錄與追蹤 (Logging/Tracing) | ✅ | 記錄分析任務建立、執行、結果查詢 |
| 指標與告警 (Metrics & Alerts) | ✅ | 追蹤分析任務執行時間、成功率、資源消耗 |
| RBAC 權限與審計 | ✅ | 控制分析功能的存取與執行權限 |
| i18n 文案 | ✅ | 分析報告與 UI 文案支援多語言 |
| Theme Token 使用 | ✅ | 分析圖表使用統一 Theme Token |

---

## 五、審查與驗收清單(Review & Acceptance Checklist)

- [ ] 無技術實作語句。
- [ ] 所有必填段落皆存在。
- [ ] 所有 FR 可測試且明確。
- [ ] 無未標註的模糊需求。
- [ ] 符合 `.specify/memory/constitution.md`。

---

## 六、容量預測結果展示 UI

### 6.1 前端 UI/UX 設計 (已確認)

#### 預測圖表設計

**時間序列圖表**:
```
容量預測 - CPU 使用率
┌─────────────────────────────────────┐
│                          📈 預測區間│
│ 100% ┼                 ╱╱╱╱         │
│      │               ╱╱              │
│  75% ┼─ 閾值 ─ ─ ─ ╱╱               │
│      │           ╱╱                  │
│  50% ┼ ━━━━━━━╱╱  ← 目前使用量      │
│      │                               │
│      └─────┬─────┬─────┬─────┬─────│
│          今天  7天  14天 30天 60天  │
└─────────────────────────────────────┘

圖例:
━━━ 歷史資料
╱╱╱ 預測趨勢
▓▓▓ 信賴區間 (±10%)
```

**圖表元件要點**:
- 使用 ECharts 時間序列圖表
- 歷史資料: 實線，深色
- 預測趨勢: 虛線，橘色
- 信賴區間: 半透明區域 (填充)
- 閾值線: 紅色虛線標記

#### 準確度標記

**準確度指示器**:
```
預測準確度: 85% ⭐⭐⭐⭐☆

• 模型: 線性回歸 (Linear Regression)
• 訓練資料: 最近 90 天
• 誤差範圍: ±10%
• 下次更新: 明天 03:00
```

**準確度分級**:
- ⭐⭐⭐⭐⭐ 優秀 (90-100%)
- ⭐⭐⭐⭐☆ 良好 (80-89%)
- ⭐⭐⭐☆☆ 普通 (70-79%)
- ⭐⭐☆☆☆ 待改善 (60-69%)
- ⭐☆☆☆☆ 不可靠 (<60%)

#### 擴容建議卡片

**建議 Card**:
```
┌─────────────────────────────────────┐
│ 🔔 擴容建議                          │
├─────────────────────────────────────┤
│ • 預計 45 天後達到 75% 閾值          │
│ • 建議提前 2 週進行擴容              │
│ • 預估需增加容量: +30%               │
│                                     │
│ [查看詳細報告] [忽略此建議]         │
└─────────────────────────────────────┘
```

**建議卡片屬性**:
- 類型: Info 或 Warning (視緊急程度)
- 位置: 圖表下方
- 內容: 達到閾值時間、建議擴容時間、所需容量
- 操作: 查看詳細報告 (開啟 Modal) 或忽略

#### 互動功能

**時間範圍選擇**:
- DateRangePicker: 選擇預測時間範圍 (預設 30 天，最大 90 天)
- 快速選項: 7天 / 30天 / 60天 / 90天

**指標切換**:
- Select 選擇器: CPU / Memory / Disk / Network
- 支援多指標並排顯示 (最多 3 個)

**資料匯出**:
- 按鈕: 「匯出報告 (PDF)」或「匯出資料 (CSV)」
- 包含圖表截圖、準確度資訊、建議清單

**前端決策**: 圖表設計、準確度視覺化、建議卡片佈局、互動功能
**後端參數**: 預測演算法、模型準確度、信賴區間、擴容閾值

### 6.2 前後端分工

| 職責 | 前端 | 後端 |
|------|------|------|
| **圖表渲染** | ✅ ECharts 配置、視覺樣式、互動行為 | - |
| **預測資料** | 📥 渲染 API 提供的預測結果 | ✅ 執行預測演算法、計算趨勢 |
| **準確度顯示** | ✅ 星級視覺化、指示器設計 | 📥 提供準確度百分比與模型資訊 |
| **擴容建議** | ✅ 建議卡片 UI | 📥 提供建議文字、時間點、容量需求 |
| **演算法選擇** | 📥 顯示模型名稱 | ✅ 選擇與訓練預測模型 |

---

## 七、模糊與待確認事項(Clarifications)

- ✅ ~~[NEEDS CLARIFICATION: 預測演算法的選擇與模型訓練機制]~~ → **已解決: 前端 UI 展示已確認，演算法選擇與訓練由後端決定**
- [NEEDS CLARIFICATION: 預測結果的準確度評估標準] → 由後端提供準確度評估指標 (RMSE, MAPE)，前端顯示百分比

---

## 八、決策記錄

### DR-001: 容量預測結果展示 UI

**決策日期**: 2025-10-06
**決策依據**: `_resolution-plan.md` 3.4 節

**決策內容**:
- 使用 ECharts 時間序列圖表顯示預測趨勢
- 準確度使用星級 (1-5 顆星) 視覺化
- 提供擴容建議卡片與互動功能
- 支援多指標切換與資料匯出

**前後端分工**:
- 前端: 圖表設計、準確度視覺化、建議卡片、互動功能
- 後端: 預測演算法、模型訓練、準確度計算、擴容建議邏輯
