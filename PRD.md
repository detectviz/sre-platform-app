## **SRE 平台 - 產品規格書 (Product Requirements Document)**

**版本**: 1.0
**日期**: 2025年9月27日
**作者**: Gemini (基於與您的協作設計)

### **1. 產品願景與目標 (Vision & Goals)**

#### **1.1. 願景**
打造一個整合式、智慧驅動的 SRE 作戰中心。它不僅是一個監控工具的集合，而是一個能將**數據、事件、資源與自動化**無縫串連，並透過 AI 賦能，主動提升系統可靠性、簡化維運流程、加速故障排除的智慧維運平台 (AIOps Platform)。

#### **1.2. 核心目標**
* **整合與統一**: 將分散的監控、告警、自動化工具，整合到一個統一、體驗一致的管理介面。
* **智慧化**: 引入 AI Agent，從被動響應告警，轉向主動的風險預測和根因分析。
* **自動化**: 建立一個強大的自動化引擎，將重複性高的維運工作（Toil）降至最低，實現事件的自動化修復 (Auto-Remediation)。
* **協作與透明**: 為 SRE、開發和管理團隊提供一個共享的、透明的溝通與協作平台，確保權責分明。

### **2. 核心架構原則 (Core Architecture Principles)**

本平台在設計與實作上，遵循以下核心架構原則：

1.  **自訂管理層 + 開源執行引擎**: 平台自身專注於提供最佳的 UI/UX 和智慧化業務邏輯（管理層），底層的告警、排程、儀表板等核心功能，則透過 API 介接穩定、強大的開源工具（執行引擎），如 Grafana Alerting, Grafana OnCall。
2.  **API 驅動 (API-Driven)**: 平台所有功能均基於 `openapi.yaml` 中定義的 RESTful API 契約進行開發，確保前後端職責分離，易於測試和整合。
3.  **單一事實來源 (Single Source of Truth)**: 平台內部對用戶、角色、權限、資源歸屬等核心概念進行統一管理，避免在多個系統中產生配置漂移。
4.  **資料層治理 (DataOps)**: 建立一套包含數據來源追蹤、數據可觀測性和數據血緣分析的框架，以確保輸入 AI 引擎的數據是可靠、可信賴的。
5.  **設計模式驅動**: 在關鍵模組（如認證、通知、自動化）採用工廠模式 (Factory Pattern) 等設計模式，確保系統的高度可擴展性與可維護性。

### **3. 資訊架構與導航 (Information Architecture)**

平台的主導航結構經過精心設計，以匹配 SRE 的日常工作心流。

#### **3.1. 主導航選單排序**
1.  **SRE 戰情室 (SRE War Room)**: (作為大部分使用者的預設首頁)
2.  **事件管理 (Event Management)**: 問題的核心，告警和事故的處理中心。
3.  **資源管理 (Resource Management)**: 被監控對象的清單和狀態檢視。
4.  **儀表板管理 (Dashboard Management)**: 統一的系統監控與業務洞察儀表板入口。
5.  **分析中心 (Analysis Center)**: 趨勢預測與深度洞察。
6.  **自動化中心 (Automation Center)**: 提升效率的工具和紀錄。
7.  **設定 (Settings)**: 平台的底層配置。

#### **3.2. 中樞頁面 (Hub Page) 設計模式**
每個主選單頁面（如事件管理、資源管理）都採用「中樞頁面」設計模式：
* **頂部**: 一組可由管理者自訂的**指標概覽卡片**，提供該模組的宏觀狀態摘要。
* **底部**: 一個**頁籤式工作台 (Tab-based Workbench)**，提供該模組內各個子功能的具體操作介面。

### **4. 功能規格 (Functional Specifications)**

#### **4.1. 儀表板 (Dashboards)**

* **4.1.1. 儀表板中心**:
    * **目的**: 提供一個統一的目錄頁，用於管理和發現平台內所有的儀表板。
    * **功能**:
        * 按「資源監控」、「業務監控」、「維運效能與治理」等分類組織儀表板。
        * 每張儀表板以卡片形式呈現，包含名稱、描述和標籤。
        * 使用者可將任一儀表板**設定為自己的預設首頁**。
* **4.1.2. 混合儀表板模式**:
    * 平台支援兩種儀表板類型：
        * **內建儀表板**: 由平台原生的小工具 (Widget) 組成，體驗無縫，風格統一。
        * **內嵌 Grafana 儀表板**: 將外部 Grafana 中已存在的儀表板，透過 `<iframe>` 內嵌到平台中進行統一管理。
    * 在「儀表板管理」列表中，需明確標示儀表板類型，並提供差異化的操作（「編輯版面」vs「在 Grafana 中編輯」）。
* **4.1.3. 內建儀表板規劃**:
    1.  **SRE 戰情室 (即時作戰中心)**: 聚焦於「待處理告警」、「處理中」、「今日已解決」等戰術指標，是 On-Call 工程師的作戰主畫面。
    2.  **基礎設施洞察**: 聚焦於資源健康度、容量規劃、AI 風險預測等，是 SRE 團隊進行健康檢查和預防性維運的場所。
    3.  **SRE 戰略總覽**: 聚焦於 MTTR, MTBF, SLO 達成率等長期績效指標，供管理層進行決策。

#### **4.2. 事件管理 (Event Management)**

* **4.2.1. 告警列表 (Alert List)**:
    * **目的**: 作為 SRE 的「事故作戰室」，是一個純粹、高效的告警處理工作台。
    * **功能**:
        * 不顯示摘要卡片，讓使用者聚焦於列表本身。
        * 提供強大的搜尋與篩選功能（狀態、嚴重性、時間、處理人等）。
        * 列表欄位包含事件 ID、摘要、資源名稱、狀態、處理人、觸發時間等。
        * 操作項包含 `確認 (Acknowledge)`、`靜音 (Silence)`、`詳情 (Details)`。
* **4.2.2. 事件詳情**:
    * **目的**: 提供一個「事故響應工作台」，用於調查和處理單一事件。
    * **功能**:
        * 以彈窗 (Modal) 形式呈現，包含「基本資訊」、「活動時間軸」、「建議的自動化」、「關聯事件」等多個區塊。
        * 支援在時間軸中新增處理紀錄。
        * 提供 `解決 (Resolve)`、`AI 分析` 等核心操作。
* **4.2.3. 告警規則 (Alert Rules)**:
    * **目的**: 定義「什麼是問題」。
    * **功能**:
        * 採用分步嚮導 (Wizard) 模式建立/編輯規則，包含「基本資訊」、「觸發條件」、「事件內容」、「自動化」四個步驟。
        * 「觸發條件」支援 `(A AND B) OR C` 的複雜邏輯，且每個 OR 群組可獨立設定告警等級 (`INFO`, `WARNING`, `CRITICAL`)。
* **4.2.4. 靜音規則 (Silence Rules)**:
    * **目的**: 管理計畫性或臨時性的告警靜音。
    * **功能**:
        * 同樣採用分步嚮導模式建立/編輯，包含「基本資訊」、「設定排程」、「設定範圍」三步。
        * 排程支援「單次」與「週期性」。
        * 支援「靜音開始/結束時發送通知」的選項。

#### **4.3. 資源管理 (Resource Management)**

* **4.3.1. 頁籤式工作台**:
    * 採用頁籤式佈局，包含 `資源列表`、`資源群組`、`拓撲視圖` 三個視圖。
    * 頁面頂部的摘要卡片，作為整個模組的固定上下文，不隨頁籤切換而改變。
* **4.3.2. 資源列表 (Resource List)**:
    * **目的**: 作為 SRE 的「資產與健康中心」，提供一個可探索的完整資產清單。
    * **功能**:
        * 頂部顯示列表內容的戰術摘要（總數、各狀態數量）。
        * 列表欄位極度豐富，包含 `狀態`、`資源名稱`、`IP`、`位置 (Region/AZ)`、`類型`、`標籤`、`CPU/記憶體使用率`、`即時告警數` 等。
        * 保留「類型」作為結構化欄位，同時支援靈活的「標籤」欄位。
* **4.3.3. 資源群組 (Resource Groups)**:
    * **目的**: 實現「動態資源群組」，基於業務邏輯自動化組織資源，並指派明確的負責團隊。
    * **功能**:
        * 透過「標籤查詢」來定義群組成員，而非手動添加。
        * 每個群組必須綁定**一個**唯一的「負責團隊」，用於告警路由。
* **4.3.4. 拓撲視圖 (Topology View)**:
    * **目的**: 視覺化展示服務與資源之間的依賴關係，用於影響分析和故障排查。

#### **4.4. 自動化中心 (Automation Center)**

* **4.4.1. 腳本觸發方式**:
    * 支援四種核心觸發方式：`事件驅動`、`排程觸發`、`手動觸發`、`Webhook 觸發`。
* **4.4.2. 腳本庫 (Script Library)**:
    * 管理不同類型（`Python`, `Bash` 等）的自動化腳本。
    * 列表頁提供 `▶️ 執行` 按鈕，用於手動觸發。
* **4.4.3. 排程管理 (Schedule Management)**:
    * **目的**: 管理例行任務。
    * **功能**:
        * 編輯器提供「簡易模式」（選擇頻率）和「進階模式」（填寫 CRON）雙模式。
        * 提供人性化的即時反饋（例如 `⏰ 每 5 分鐘執行一次`）。
        * 列表頁顯示 `上次狀態` 和 `下次執行時間`。
* **4.4.4. 執行日誌 (Execution Log)**:
    * **目的**: 追蹤所有腳本的執行歷史與結果，用於除錯。
    * **功能**:
        * 採用與「審計日誌」一致的佈局。
        * 詳情彈窗提供結構化的「執行資訊」元數據和可搜尋的「日誌輸出」。

#### **4.5. 設定 (Settings)**

* **4.5.1. 身份與存取管理**:
    * **認證**: 透過 `openapi.yaml` 中定義的 `/auth` 接口，提供平台自身的用戶名/密碼註冊與登錄功能。（未來可整合 Keycloak 等 SSO 服務，屆時平台僅負責角色映射）。
    * **授權**: 包含 `人員管理`、`團隊管理`、`角色管理` 的頁籤式工作台，實現完整的 RBAC。
    * **審計日誌**: 記錄平台所有關鍵操作，佈局專業，詳情以側邊欄 (Panel) 形式呈現。
* **4.5.2. 通知管理**:
    * 包含 `通知策略`、`通知管道`、`通知歷史` 三個頁籤。
    * **通知策略**: 採用引導式嚮導建立，以「資源群組」為起點，自動建議負責團隊，同時支援更進階的標籤匹配。
    * **通知管道**: 管理 `Slack`, `Email` 等接觸點。
    * **通知歷史**: 作為通知系統的「飛行紀錄器」，提供完整的投遞紀錄與失敗原因，用於除錯。
* **4.5.3. 平台設定**:
    * **Grafana 設定**: 提供 UI 介面讓管理者填寫 Grafana 的 `URL` 和 `API Key`，以啟用整合。
    * **版面管理 (MVP)**: 提供一個基於「雙欄選擇器」的 UI，讓管理者可以客製化每個中樞頁面頂部顯示的指標卡片及其順序。
* **4.5.4. 個人設定**:
    * 允許使用者管理自己的個人資料、偏好設定（如主題）、安全設定（如密碼）。

### **5. 非功能性需求 (Non-Functional Requirements)**

* **設計系統**: 全平台遵循統一的設計規範，包括顏色系統（基底色、主色、語意色）、8 點網格系統、統一的元件（狀態標籤、圖示按鈕）和對齊規則。
* **安全性**: 後端與 Grafana 的通信，使用統一的、高權限的服務帳號 API 金鑰。用戶在平台內的操作，由平台自身的 RBAC 系統進行授權檢查。所有敏感配置（如 API Key）在儲存時必須加密。
* **效能**: 儀表板應避免過度刷新，查詢應使用聚合/下採樣以減少負載。

---

好的，當然。基於我們共同設計的 UI 藍圖以及您提供的程式碼和資料庫結構，我為您詳細闡述平台中幾個核心「設定精靈 (Wizard)」的詳細步驟。

這些精靈的設計核心是**「引導式配置 (Guided Configuration)」**，旨在將複雜的設定任務，拆解為清晰、專注、且不易出錯的步驟，大幅提升使用者體驗。

---

### **一、 告警規則設定精靈 (Alert Rule Wizard)**

此精靈的目的是引導使用者建立一條完整的告警規則，從定義基本資訊到設定觸發條件，再到客製化通知內容與自動化響應。

**參考 UI**:
* 步驟 1: `image_45e55a.jpg`
* 步驟 2: `image_45e4fc.jpg`
* 步驟 3: `image_45e4dd.jpg`
* 步驟 4: `image_45e4b7.jpg`

**後端對應**:
* API 端點: `POST /alert-rules`, `PATCH /alert-rules/{rule_id}`
* 資料庫表: `alert_rules`

---

#### **設定步驟詳述：**

**步驟一：設定基本資訊**
* **目的**: 定義此規則的名稱與用途，並可快速套用範本。
* **欄位說明**:
    1.  **快速套用範本**: 提供一組預設的常用告警規則範本（例如 `CPU 使用率過高`, `磁碟空間不足`）。選擇後，後續步驟的欄位將會被自動填入建議值。
    2.  **規則名稱 (必填)**: 為此告警規則設定一個簡潔、易於識別的名稱，例如「生產資料庫 CPU 使用率過高」。
    3.  **描述**: 詳細說明此規則的目的、觸發時的可能影響，以及初步的處理建議。

**步驟二：定義觸發條件**
* **目的**: 設定觸發告警的具體邏輯條件。這是整個規則的核心。
* **欄位說明**:
    1.  **條件群組 (OR 邏輯)**:
        * 每個條件群組代表一個獨立的觸發情境。只要**任一**群組的條件被滿足，告警就會觸發。
        * **告警等級**: 每個群組可以獨立設定其觸發的告警等級 (`INFO`, `WARNING`, `CRITICAL`)。
    2.  **條件 (AND 邏輯)**:
        * 在一個群組內部，可以設定多個條件。必須**所有**條件都滿足，該群組才會被視為觸發。
        * **指標選擇**: 選擇要監控的指標，例如「記憶體使用率 (%)」。
        * **運算子**: 選擇比較方式，例如 `>`、`<`、`=`。
        * **閾值**: 設定觸發的臨界值。
        * **持續時間**: 設定指標必須持續滿足條件多久，告警才會觸發（例如 `5 分鐘`），以避免短暫的波動造成噪音。

**步驟三：自訂事件內容與通知**
* **目的**: 客製化告警觸發時，發送給使用者的通知訊息樣式。
* **欄位說明**:
    1.  **事件標題樣板 (必填)**: 設定告警通知的標題。通常簡潔明瞭，例如 `🔥 {{resource.name}} - {{metric.name}} 異常`。
    2.  **事件內容樣板**: 設定告警通知的詳細內文。應包含足夠的上下文資訊，方便接收者快速判斷問題。
    3.  **可用變數**: 提供一組可點擊的變數標籤（例如 `{{resource.name}}`, `{{metric.value}}`, `{{threshold}}`），點擊後可快速插入到樣板中。

**步驟四：設定自動化響應**
* **目的**: 關聯一個自動化腳本，在告警觸發時自動執行，實現 Auto-Remediation。
* **欄位說明**:
    1.  **啟用自動化響應**: 一個核取方塊，決定是否啟用此功能。
    2.  **選擇腳本 (必填)**: 從「腳本庫」中選擇一個已存在的腳本。
    3.  **腳本參數**: 根據所選腳本，動態渲染出該腳本需要的參數輸入框（例如，「增加容量 (GB)」）。

---

### **二、 靜音規則設定精靈 (Silence Rule Wizard)**

此精靈的目的是引導使用者建立一個用於在特定時間、針對特定告警進行靜默的規則，常用於計畫性維護。

**參考 UI**:
* 步驟 1: `image_7c07b9.jpg`
* 步驟 2: `image_7c077c.png`
* 步驟 3: `image_7c04d0.png`

**後端對應**:
* API 端點: `POST /silence-rules`, `PATCH /silence-rules/{silence_id}`
* 資料庫表: `silence_rules`

---

#### **設定步驟詳述：**

**步驟一：設定基本資訊**
* **目的**: 定義此靜音規則的名稱與用途。
* **欄位說明**:
    1.  **快速套用範本**: 提供常用情境，如「週末維護窗口」、「月底批次作業」。
    2.  **規則名稱 (必填)**: 設定易於識別的名稱，例如「週末資料庫例行維護」。
    3.  **描述**: 說明靜音的原因與影響範圍。

**步驟二：設定排程**
* **目的**: 定義此靜音規則生效的時間。
* **欄位說明**:
    1.  **靜音類型 (必填)**: `單次靜音` 或 `週期性靜音`。
    2.  **重複模式** (若為週期性): 選擇重複頻率，例如 `每週`。
    3.  **選擇星期** (若為每週): 透過核取方塊選擇生效的星期。
    4.  **靜音時段 (必填)**: 設定每天生效的開始與結束時間。
    5.  **有效期限**: 設定此週期性規則的有效期限，可以是 `永久有效` 或 `截止到特定日期`。

**步驟三：設定範圍**
* **目的**: 精準定義哪些告警需要被此規則靜默。
* **欄位說明**:
    1.  **匹配條件 (必填)**:
        * 一個條件建立器，用於設定匹配告警標籤的規則。
        * **範例**: `資源群組` `=` `Production Database`，代表所有來自此群組的告警都將被靜默。
    2.  **附加選項**:
        * **立即啟用此靜音規則**: 讓規則在儲存後立刻生效。
        * **靜音開始/結束時發送通知**: 一個非常實用的選項，可以在維護窗口開始與結束時，向指定頻道發送通知，同步團隊資訊。

---

### **三、 通知策略設定精靈 (Notification Policy Wizard)**

此精靈的目的是引導使用者建立一條告警路由規則，將符合特定條件的告警，發送到指定的團隊與通知管道。

**參考 UI**:
* 步驟 1: `image_df1d5e.png`
* 步驟 2: `image_df1d3b.png`
* 步驟 3: `image_df1d1a.png`

**後端對應**:
* API 端點: `POST /settings/notification-strategies`
* 資料庫表: `notification_strategies`

---

#### **設定步驟詳述：**

**步驟一：選擇您關心的範圍**
* **目的**: 透過一個簡單的起點，快速鎖定策略的主要目標。
* **欄位說明**:
    1.  **資源群組 (必填)**: 從下拉選單中選擇一個資源群組。這是**引導式配置**的核心，系統將根據此選擇，在下一步自動推薦負責團隊。
    2.  **策略名稱 (必填)**: 為此路由策略命名，例如「生產資料庫嚴重告警路由」。

**步驟二：選擇通知管道**
* **目的**: 決定告警要發送給誰。
* **欄位說明**:
    1.  **系統建議**: 一個提示框，根據上一步選擇的資源群組，自動推薦其綁定的負責團隊（例如 `DBA-Team`）。
    2.  **通知管道**: 自動載入並預選推薦團隊所訂閱的通知管道（例如 `DBA PagerDuty`, `DBA Slack Channel`）。
    3.  **手動選擇其他團隊?**: 一個「逃生口」，允許使用者覆寫系統建議，手動選擇其他團隊。

**步驟三：新增更多匹配條件 (可選)**
* **目的**: 增加更精細的過濾條件，以應對複雜的路由需求。
* **欄位說明**:
    1.  **匹配條件**: 一個條件建立器，允許使用者增加額外的 `AND` 條件。
    2.  **範例**: 在已選擇「生產資料庫」的基礎上，增加條件 `severity` `=` `CRITICAL`。
    3.  **最終效果**: 這條策略的完整邏輯將是：「所有來自『生產資料庫』群組，**且**嚴重性為『CRITICAL』的告警，都發送到 DBA 團隊的 PagerDuty 和 Slack」。