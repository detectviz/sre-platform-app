# SRE 平台功能規格 v2.20

本文件旨在記錄 SRE 平台在持續開發過程中的重要功能規格與架構決策，作為開發與測試的依據。

---

## 1. 功能: 頁面版面配置 API 化 (Page Layout Customization API Integration)

-   **模組**: 平台 (Platform)
-   **版本**: v2.1
-   **狀態**: ✅ 已完成

### 1.1 使用者故事

**身為** 一名平台管理員，
**我想要** 自訂各個主要頁面上顯示的關鍵效能指標 (KPI) 卡片，
**使得** 這些設定能夠被儲存在伺服器上，以便在不同裝置和瀏覽器間保持一致，提升我的工作效率。

### 1.2 行為變更

-   **數據獲取**: 「版面管理」頁面 (`LayoutSettingsPage.tsx`) 現在會在載入時，向 `/api/v1/settings/layouts` 端點發起 `GET` 請求，以獲取所有頁面的最新版面配置，而非從 `localStorage` 或靜態常數初始化。
-   **數據持久化**: 當使用者儲存對某個頁面版面的修改時，前端會向 `/api/v1/settings/layouts` 端點發起 `PUT` 請求，將**完整的**、更新後的版面配置物件傳送至後端進行儲存。
-   **本地快取與即時更新**: 為了在不刷新頁面的情況下，讓其他頁面（尤其是 `PageKPIs.tsx` 元件）能即時反應版面變更，在成功儲存到後端後，前端會同時更新 `localStorage` 中的版面配置副本，並觸發一個 `storage` 事件。這提供了一種高效能的樂觀更新機制。
-   **使用者體驗**: 頁面新增了載入中 (Loading) 與錯誤 (Error) 狀態的視覺回饋，提升了非同步操作的健壯性。

### 1.3 使用的 API 端點

-   `GET /api/v1/settings/layouts`: 用於讀取當前所有頁面的版面配置。
-   `PUT /api/v1/settings/layouts`: 用於儲存更新後的完整版面配置。

---

## 2. 功能: 資源拓撲圖動態化 (Resource Topology View API Integration)

-   **模組**: 資源 (Resource)
-   **版本**: v2.1
-   **狀態**: ✅ 已完成

### 2.1 使用者故事

**身為** 一名 SRE 工程師，
**我想要** 查看一個即時、由後端數據驅動的資源依賴拓撲圖，
**使得** 我能快速理解系統的真實架構，並在發生事件時迅速評估潛在的影響範圍。

### 2.2 行為變更

-   **數據獲取**: 「拓撲視圖」頁面 (`ResourceTopologyPage.tsx`) 現在會向新建立的 `GET /api/v1/resources/topology` 端點發起請求，以獲取拓撲圖所需的節點（資源）與連結（依賴關係）數據。
-   **動態視覺化**: 拓撲圖現在完全基於 API 回傳的數據進行動態渲染，確保了其內容的即時性與準確性。
-   **API 契約擴充**: `openapi.yaml` 文件中新增了 `/resources/topology` 端點的定義。
-   **使用者體驗**: 頁面同樣增加了載入中與錯誤狀態的處理，確保在數據獲取過程中提供清晰的視覺回饋。

### 2.3 使用的 API 端點

-   `GET /api/v1/resources/topology`: (新增) 用於一次性獲取所有資源節點及其依賴關係連結。

---

## 3. 功能: 個人設定模組 API 化 (Profile Module API Integration)

-   **模組**: 個人設定 (Profile)
-   **版本**: v2.2
-   **狀態**: ✅ 已完成

### 3.1 使用者故事

**身為** 一名已登入的使用者，
**我想要** 我的個人資訊、安全設定（如登入歷史）以及偏好設定都能從後端 API 動態載入並儲存，
**使得** 我的設定能夠在所有裝置間保持同步，並確保數據的準確性與安全性。

### 3.2 行為變更

-   **個人資訊 (`PersonalInfoPage`)**: 頁面不再讀取靜態模擬數據，而是向 `/api/v1/me` 發起 `GET` 請求，以獲取當前登入使用者的資訊。
-   **安全設定 (`SecuritySettingsPage`)**: 頁面中的「登入歷史」列表，現在透過向 `/api/v1/me/login-history` 發起 `GET` 請求來動態獲取，並支援分頁。
-   **偏好設定 (`PreferenceSettingsPage`)**:
    -   **數據獲取**: 頁面載入時，會向 `/api/v1/me/preferences` 發起 `GET` 請求來獲取使用者的偏好設定，取代了原有的 `localStorage` 讀取邏輯。
    -   **數據持久化**: 當使用者儲存設定時，會向同一個端點發起 `PUT` 請求，將更新後的設定持久化到後端。
-   **使用者體驗**: 所有相關頁面都增加了完整的載入中與錯誤狀態的處理，提升了非同步操作的健壯性。

### 3.3 使用的 API 端點

-   `GET /api/v1/me`: (新增) 取得當前登入者的個人資訊。
-   `GET /api/v1/me/login-history`: (新增) 取得登入者的登入歷史紀錄。
-   `GET /api/v1/me/preferences`: (新增) 取得使用者的偏好設定。
-   `PUT /api/v1/me/preferences`: (新增) 更新使用者的偏好設定。

---

## 4. 功能: 智慧排查數據動態化 (Intelligent Investigation API Integration)

-   **模組**: 智慧排查 (Intelligent Investigation)
-   **版本**: v2.2
-   **狀態**: ✅ 已完成

### 4.1 使用者故事

**身為** 一名 SRE 或開發人員，
**我想要** 在「日誌探索」頁面中，能夠查詢和瀏覽來自後端的即時數據，
**使得** 我可以對系統的真實運行狀況進行深入分析，快速定位問題。

### 4.2 行為變更

-   **日誌探索 (`LogExplorerPage`)**: 頁面不再使用 `MOCK_LOGS` 靜態數據。現在，它會向 `GET /api/v1/logs` 端點發起請求，獲取日誌數據。
-   **使用者體驗**: 所有相關頁面都增加了完整的載入中與錯誤狀態的處理，並提供了更豐富的 UI 互動（如日誌展開、時間軸選擇）。

### 4.3 使用的 API 端點

-   `GET /api/v1/logs`: (新增) 取得日誌數據列表。

---

## 5. 功能: AI Copilot 智慧化整合 (AI Copilot Integration)

-   **模組**: SRE 戰情室、事件、自動化
-   **版本**: v2.5
-   **狀態**: ✅ 已完成

### 5.1 使用者故事

**身為** 一名 SRE 工程師，
**我想要** 平台能透過 AI 自動分析數據、總結事件、甚至生成自動化腳本，
**使得** 我可以從繁瑣的重複性工作中解放出來，更專注於高價值的策略性任務，並加速問題的解決。

### 5.2 行為變更

-   **API 請求升級**: 大部分對 Gemini API 的請求，都從純文字 prompt 升級為使用 `responseSchema`，以獲取結構化的 JSON 回應。
-   **前端元件重構**:
    -   **`AIAnalysisDisplay.tsx`**: 建立了一個可重用的元件，專門用於渲染結構化的 AI 分析報告，支援單一事件和多事件兩種模式。
    -   **`SREWarRoomPage.tsx`**: 將 AI 簡報從單一文字塊重構為三個語意清晰的卡片：「穩定性摘要」、「關鍵異常」和「建議操作」。
-   **新功能整合**:
    -   **`LogExplorerPage.tsx`**: 新增「AI 總結日誌」功能，調用 `/ai/logs/summarize` 端點，並透過 `LogAnalysisModal.tsx` 展示結構化分析報告。
    -   **`AutomationPlaybookEditModal.tsx`**: 新增「使用 AI 生成」功能，允許使用者透過自然語言描述生成自動化腳本。

### 5.3 使用的 API 端點

-   `GET /api/v1/ai/briefing`: 取得 SRE 戰情室簡報。
-   `POST /api/v1/ai/incidents/analyze`: 分析單一或多個事件。
-   `POST /api/v1/ai/automation/generate-script`: 根據自然語言提示生成自動化腳本。
-   `POST /api/v1/ai/logs/summarize`: 總結日誌。

---

## 10. 模組功能總覽 (Module Functional Overview)

本章節旨在提供一個全面的功能基準，按照平台導航結構，詳細描述每一個頁面的核心定位與功能。

### 10.1 SRE 戰情室 (`SREWarRoomPage`)

-   **定位**: 平台的核心儀表板，提供系統健康度的「駕駛艙視圖」。
-   **核心功能**:
    1.  **AI 每日簡報**: 由 AI 自動生成的系統狀態摘要，包含「穩定性總結」、「關鍵異常」和「建議操作」三個部分，並提供可操作的連結。
    2.  **服務健康度熱力圖**: 視覺化展示各個服務在不同環境的健康狀態。
    3.  **資源群組狀態**: 條列展示各個資源群組的健康、警告、嚴重狀態分佈。
    4.  **互動式圖表**: 所有圖表均支援點擊鑽取，可跳轉至相關的資源或事件頁面。

### 10.2 事件 (Incidents)

#### 10.2.1 事件列表 (`IncidentListPage`)

-   **定位**: SRE 的「事故作戰室」，是一個高效的告警處理工作台。
-   **核心功能**:
    -   **列表檢視**: 以表格形式展示所有事件，包含摘要、狀態、嚴重性、處理人等關鍵資訊。
    -   **批次操作**: 支援對多個事件進行批次的「AI 分析」、「認領」和「解決」。
    -   **快速篩選**: 提供統一的搜尋與篩選入口，方便快速定位事件。
    -   **事件詳情**: 點擊單一事件，會以側邊抽屜 (Drawer) 的形式開啟「事故詳情」面板，進行深度調查與處理。
    -   **AI 分析**: 支援對單一或多個事件進行 AI 分析，自動生成根本原因與處理建議。

#### 10.2.2 告警規則 (`AlertRulePage`)

-   **定位**: 集中管理所有告警規則的入口，定義「什麼是問題」。
-   **核心功能**:
    -   **列表檢視**: 以表格形式展示所有告警規則，包含名稱、監控目標、觸發條件摘要、嚴重性、是否啟用自動化等關鍵資訊。
    -   **生命週期管理**: 支援規則的「新增」、「編輯」、「複製」與「刪除」。
    -   **快速啟用/停用**: 提供切換開關，可快速啟用或停用單一規則。
    -   **引導式建立/編輯 (Wizard)**:
        -   **目的**: 將複雜的規則設定拆解為清晰、專注的步驟，降低使用者的認知負擔。
        -   **編輯模式**: 在編輯現有規則時，精靈會直接從「步驟一：設定基本資訊」開始。
        -   **建立模式**:
            -   **步驟 0 - 選擇監控目標**:
                -   **介面**: 提供一個整合式的「範本市集」介面，左側為可篩選的「資源類型」，右側展示對應的告警範本卡片。
                -   **互動**: 使用者選擇一個範本（如「主機 CPU 使用率過高」）後，後續步驟的欄位將會被自動填入建議值，大幅簡化設定流程。
            -   **步驟 1 - 設定基本資訊**:
                -   定義規則的`名稱`、`描述`，並設定監控的`資源範圍`。
                -   監控範圍支援從「所有資源」、「特定資源群組」到「具體資源」的多層次選擇，並可附加標籤進行進一步篩選。
            -   **步驟 2 - 定義觸發條件**:
                -   設定告警的具體邏輯。支援 `(A AND B) OR C` 的複雜條件。
                -   每個 `OR` 條件群組可以獨立設定其觸發的`告警等級` (嚴重/警告/資訊)。
                -   每個 `AND` 條件包含`指標`、`運算子`、`閾值`和`持續時間`四個元素。
            -   **步驟 3 - 事件定義與通知**:
                -   客製化觸發事件時的`標題`和`內容`範本，支援使用 `{{變數}}`。
                -   為此規則及其產生的事件附加`標籤`，用於後續的通知路由和分類。
            -   **步驟 4 - 設定自動化響應 (可選)**:
                -   提供一個開關以`啟用自動化響應`。
                -   啟用後，使用者可以從下拉選單中選擇一個已存在的`自動化腳本`。
                -   若所選腳本包含參數，介面將動態呈現對應的輸入欄位，讓使用者可以為此規則配置固定的`參數值`。

#### 10.2.3 靜音規則 (`SilenceRulePage`)

-   **定位**: 管理用於在特定時間（如維護窗口）暫停告警通知的規則。
-   **核心功能**:
    -   **列表檢視**: 展示所有靜音規則，包含名稱、類型（單次/週期性）、靜音條件、排程與創建者。
    -   **生命週期管理**: 支援靜音規則的「新增」、「編輯」與「刪除」。
    -   **引導式建立/編輯**: 透過精靈引導使用者設定靜音規則的基本資訊、排程（支援單次時間區間或週期性的 CRON 表達式）以及要靜音的告警範圍（基於標籤匹配）。

### 10.3 資源 (Resources)

-   **定位**: 平台的「資產與健康中心」，提供一個可探索的完整資產清單。
-   **核心功能**:
    -   **頁籤式工作台**: 包含 `資源列表`、`資源群組`、`拓撲視圖` 三個視圖。
    -   **資源列表**: 提供豐富的欄位與篩選功能，並可點擊查看資源詳情。
    -   **資源群組**: 允許使用者基於標籤查詢，建立動態的資源集合，並指派負責團隊。
    -   **拓撲視圖**: 視覺化展示服務與資源之間的依賴關係，並支援右鍵上下文選單進行快捷操作。

### 10.4 儀表板 (Dashboard)

-   **定位**: 統一的系統監控與業務洞察儀表板入口。
-   **核心功能**:
    -   **混合儀表板支援**: 支援管理「內建儀表板」和連結外部「Grafana 儀表板」。
    -   **儀表板列表**: 以卡片形式展示所有儀表板，支援設定任一儀表板為個人首頁。
    -   **範本市集**: 提供一組預設的儀表板範本，使用者可以此為基礎快速建立新儀表板。
    -   **拖拽式編輯器**: 提供一個所見即所得的網格佈局編輯器，讓使用者可以自由拖動、縮放小工具，建立高度客製化的內建儀表板。

### 10.5 自動化 (Automation)

-   **定位**: 提升維運效率、降低重複性工作的核心。
-   **核心功能**:
    -   **腳本庫**: 統一管理 Shell, Python 等各類型的自動化腳本。支援「AI 輔助生成腳本」功能。
    -   **觸發器**: 管理觸發自動化腳本的規則。支援「排程」、「Webhook」、「事件」三種類型，並提供一個具備分頁和關鍵字搜尋功能的列表頁面。使用者可以對觸發器進行建立、編輯、啟用/停用和刪除操作，同時支援批次處理。
    -   **運行歷史**: 提供所有腳本執行的詳細日誌與結果，用於審計與除錯。
    
### 10.6 智慧排查 (Intelligent Investigation)

-   **定位**: 平台的智慧大腦，提供從宏觀到微觀的深度洞察與趨勢預測。
-   **核心功能**:
    -   **總覽 (`AnalysisOverviewPage`)**: 整合式的智慧化分析中樞。此頁面將最重要的 AI 洞察前置，包括「系統健康評分儀表板」、「AI 異常檢測」和「主動優化建議」。下方則展示「事件關聯分析」和「日誌探索」工具，形成一個從宏觀到微觀的無縫分析流程。
    -   **日誌探索 (`LogExplorerPage`)**: 提供強大的日誌搜尋、篩選與即時串流功能，並支援「AI 日誌總結」。
    -   **容量規劃 (`CapacityPlanningPage`)**: 基於歷史數據和 AI 預測模型，提供對未來資源需求的預測和優化建議。

### 10.7 設定 (Settings)

#### 10.7.1 身份與存取管理 (IAM)

-   **定位**: 平台的權限與安全核心。
-   **核心功能**:
    -   **人員管理**: 管理平台的所有使用者帳號，支援分頁、進階搜尋與批次操作。
    -   **團隊管理**: 建立團隊並指派成員。支援分頁、關鍵字搜尋與批次操作。
    -   **角色管理**: 建立角色並分配細粒度的模組操作權限 (RBAC)。支援分頁、關鍵字搜尋與批次操作。
    -   **審計日誌**: 記錄平台內所有關鍵操作的日誌，用於安全審計。

#### 10.7.2 通知 (Notification)

-   **定位**: 負責將告警與事件，準確、可靠地送達給正確的人。
-   **核心功能**:
    -   **通知策略**: 告警路由中心，定義「什麼樣的告警」要「通知給誰」。透過引導式精靈建立，從選擇資源群組開始，自動建議負責團隊，並可附加更精細的標籤匹配條件。
    -   **通知管道**: 管理具體的通知接觸點，如 Email、Slack、Webhook 等。在編輯彈窗中內建「發送測試」功能，提供即時配置驗證。
    -   **發送歷史**: 通知系統的「飛行紀錄器」，提供所有通知的發送審計紀錄，並支援對失敗的通知進行「重新發送」。

#### 10.7.3 平台 (Platform)

-   **定位**: 管理平台的全域性配置。
-   **核心功能**:
    -   **標籤管理**: 定義平台內所有資源可用的標籤鍵 (Tag Key) 及其允許的值，建立標籤治理的基礎。
    -   **郵件設定**: 配置用於發送系統郵件的 SMTP 伺服器。
    -   **身份驗證**: 顯示當前整合的身份提供商 (IdP) 資訊。
    -   **版面管理**: 允許管理者客製化各個主要頁面上顯示的 KPI 卡片及其順序。
    -   **Grafana 設定**: 配置與 Grafana 實例的連接。

### 10.8 個人設定 (Profile)

-   **定位**: 使用者個人化的配置中心。
-   **核心功能**:
    -   **個人資訊**: 檢視與個人帳號相關的基本資訊。
    -   **安全設定**: 變更密碼、檢視登入歷史。
    -   **偏好設定**: 客製化個人化的平台體驗，如介面主題、預設首頁、語言和時區。