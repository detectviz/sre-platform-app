# Analysis & AI Schemas
components:
  schemas:
    # ===================
    # Common Analysis Types
    # ===================
    Recommendation:
      type: object
      description: A recommended action to take.
      required: [description]
      properties:
        description:
          type: string
          example: "Increase database connection pool size."
        action_text:
          type: string
          example: "Run Playbook"
        action_link:
          type: string
          format: uri
          example: "/automation/playbooks/play-db-restart"
        playbook_id:
          type: string
          example: "play-db-restart"

    GroupActionRecommendation:
      allOf:
        - $ref: '#/components/schemas/Recommendation'
        - type: object
          properties:
            target_incident_ids:
              type: array
              items:
                type: string
              example: ["INC-001", "INC-005"]

    # ===================
    # Incident Analysis
    # ===================
    IncidentAnalysis:
      type: object
      description: AI-driven analysis for a single incident.
      readOnly: true
      required: [summary, root_causes, recommendations]
      properties:
        summary:
          type: string
          example: "The incident appears to be caused by a database connection issue."
        root_causes:
          type: array
          items:
            type: string
          example: ["Database connection pool exhausted", "High query latency on the users table"]
        recommendations:
          type: array
          items:
            $ref: '#/components/schemas/Recommendation'

    MultiIncidentAnalysis:
      type: object
      description: AI-driven analysis for multiple related incidents.
      readOnly: true
      required: [summary, common_patterns, group_actions]
      properties:
        summary:
          type: string
          example: "All selected incidents are related to the 'api-gateway' resource and show similar high latency patterns."
        common_patterns:
          type: array
          items:
            type: string
          example: ["All incidents occurred during peak traffic hours.", "All incidents point to a bottleneck in the authentication service."]
        group_actions:
          type: array
          items:
            $ref: '#/components/schemas/GroupActionRecommendation'

    # ===================
    # Resource Analysis
    # ===================
    ResourceRisk:
      type: object
      description: Describes a specific risk identified for a resource.
      required: [resource_id, resource_name, risk_level, reason, recommendation]
      properties:
        resource_id:
          type: string
        resource_name:
          type: string
        risk_level:
          type: string
          enum: [high, medium, low]
        reason:
          type: string
          example: "Sustained high CPU usage may lead to performance degradation during peak hours."
        recommendation:
          type: string
          example: "Consider upgrading the instance type or implementing auto-scaling."

    OptimizationSuggestion:
      type: object
      description: A suggestion for optimizing a resource.
      required: [resource_id, resource_name, suggestion, type]
      properties:
        resource_id:
          type: string
        resource_name:
          type: string
        suggestion:
          type: string
          example: "The instance is over-provisioned. Consider changing from m5.xlarge to m5.large."
        type:
          type: string
          enum: [cost, performance, security]
          example: cost

    ResourceAnalysisReport:
      type: object
      description: A comprehensive analysis report for a resource.
      readOnly: true
      required: [summary, risk_analysis, optimization_suggestions]
      properties:
        summary:
          type: string
          example: "The resource is stable but has opportunities for cost optimization."
        risk_analysis:
          type: array
          items:
            $ref: '#/components/schemas/ResourceRisk'
        optimization_suggestions:
          type: array
          items:
            $ref: '#/components/schemas/OptimizationSuggestion'

    # ===================
    # Log Analysis
    # ===================
    LogAnalysis:
      type: object
      description: An analysis of log entries over a given time range.
      readOnly: true
      required: [summary, patterns, recommendations]
      properties:
        summary:
          type: string
          example: "Log analysis reveals a spike in 'connection timeout' errors, suggesting a network or downstream service issue."
        patterns:
          type: array
          items:
            type: object
            required: [description, count, level]
            properties:
              description:
                type: string
                example: "Database connection timeout"
              count:
                type: integer
                example: 152
              level:
                type: string
                enum: [info, warning, error, debug]
                example: error
        recommendations:
          type: array
          items:
            type: string
          example: ["Investigate network connectivity to the main database.", "Check the health of the authentication service."]

    # ===================
    # Dashboard-related Analysis Data
    # ===================
    ServiceHealthData:
      type: object
      required: [heatmap_data, x_axis_labels, y_axis_labels]
      properties:
        heatmap_data:
          type: array
          description: Heatmap matrix represented as [rowIndex, columnIndex, value]
          items:
            type: array
            minItems: 3
            maxItems: 3
            items:
              - type: integer
              - type: integer
              - type: number
          example:
            - [0, 0, 98]
            - [1, 2, 92]
        x_axis_labels:
          type: array
          items:
            type: string
          example: [us-east-1, us-west-2, eu-central-1, ap-northeast-1]
        y_axis_labels:
          type: array
          items:
            type: string
          example: [API Gateway, RDS Database, EKS Cluster, Kubernetes]

    ResourceGroupStatusSeries:
      type: object
      required: [key, label, data]
      properties:
        key:
          type: string
          enum: [healthy, warning, critical]
        label:
          type: string
          example: 健康
        data:
          type: array
          items:
            type: integer
          example: [12, 8, 5, 10, 22]

    ResourceGroupStatusData:
      type: object
      required: [group_names, series]
      properties:
        group_names:
          type: array
          items:
            type: string
          example:
            - Production Web Servers
            - Core Databases
            - Cache Cluster
            - Logging Stack
            - API Services
        series:
          type: array
          items:
            $ref: '#/components/schemas/ResourceGroupStatusSeries'

    # ===================
    # Top-level Analysis Schemas
    # ===================
    AnalysisOverviewData:
      type: object
      required: [health_score, anomalies, suggestions, event_correlation_data, recent_logs]
      properties:
        health_score:
          $ref: '#/components/schemas/HealthScore'
        anomalies:
          type: array
          items:
            $ref: '#/components/schemas/Anomaly'
        suggestions:
          type: array
          items:
            $ref: '#/components/schemas/Suggestion'
        event_correlation_data:
          type: object
        recent_logs:
          type: array
          items:
            $ref: '#/components/schemas/LogEntry'

    HealthScore:
      type: object
      properties:
        score:
          type: integer
        summary:
          type: string

    Anomaly:
      type: object
      properties:
        severity:
          type: string
          enum: [critical, warning, info]
        description:
          type: string
        timestamp:
          type: string
          format: date-time

    Suggestion:
      type: object
      properties:
        title:
          type: string
        impact:
          type: string
          enum: [高, 中, 低]
        effort:
          type: string
          enum: [高, 中, 低]
        details:
          type: string
        action_button_text:
          type: string
        action_link:
          type: string
          format: uri

    CapacityPlanningData:
      type: object
      properties:
        trends:
          type: object
        forecast_model:
          type: object
        suggestions:
          type: array
          items:
            $ref: '#/components/schemas/CapacityPlanningSuggestion'
        resource_analysis:
          type: array
          items:
            $ref: '#/components/schemas/CapacityPlanningResourceInsight'
        options:
          type: object

    CapacityPlanningSuggestion:
      type: object
      properties:
        id:
          type: string
        title:
          type: string
        impact:
          type: string
        effort:
          type: string
        details:
          type: string
        detected_at:
          type: string
          format: date-time
        resource_id:
          type: string

    CapacityPlanningResourceInsight:
      type: object
      properties:
        id:
          type: string
        resource_id:
          type: string
        resource_name:
          type: string
        current_utilization:
          type: number
        forecast_utilization:
          type: number
        recommendation:
          type: object
        cost_impact:
          type: object
        lastEvaluated_at:
          type: string
          format: date-time

    IncidentPrediction:
      type: object
      properties:
        predictions:
          type: array
          items:
            $ref: '#/components/schemas/PredictedIncident'
        analysis_timestamp:
          type: string
          format: date-time

    PredictedIncident:
      type: object
      properties:
        resource_id:
          type: string
        resource_name:
          type: string
        predicted_issue:
          type: string
        probability:
          type: number
          format: float
        estimated_time:
          type: string
          format: date-time
        severity:
          type: string
          enum: [critical, warning, info]
        preventive_actions:
          type: array
          items:
            type: string

    AnomalyDetection:
      type: object
      properties:
        anomalies:
          type: array
          items:
            $ref: '#/components/schemas/DetectedAnomaly'
        summary:
          type: object

    DetectedAnomaly:
      type: object
      properties:
        resource_id:
          type: string
        resource_name:
          type: string
        metric:
          type: string
        timestamp:
          type: string
          format: date-time
        actual_value:
          type: number
        expected_range:
          type: object
        severity:
          type: string
        description:
          type: string

    CapacityPrediction:
      type: object
      properties:
        resource_id:
          type: string
        resource_name:
          type: string
        predictions:
          type: array
          items:
            $ref: '#/components/schemas/MetricPrediction'
        analysis_timestamp:
          type: string
          format: date-time

    MetricPrediction:
      type: object
      properties:
        metric:
          type: string
        current_value:
          type: number
        predicted_values:
          type: array
          items:
            type: object
        threshold_breach_date:
          type: string
          format: date
          nullable: true
        recommendation:
          type: string

    LogEntry:
      type: object
      properties:
        id:
          type: string
        timestamp:
          type: string
          format: date-time
        level:
          type: string
          enum: [info, warning, error, debug]
        service:
          type: string
        message:
          type: string
        details:
          type: object
          additionalProperties: true