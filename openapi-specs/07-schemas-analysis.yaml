# Analysis & AI Schemas
components:
  schemas:
    # ===================
    # Common Analysis Types
    # ===================
    Recommendation:
      type: object
      description: A recommended action to take.
      required: [description]
      properties:
        description:
          type: string
          example: "Increase database connection pool size."
        action_text:
          type: string
          example: "Run Playbook"
        action_link:
          type: string
          format: uri
          example: "/automation/playbooks/play-db-restart"
        playbook_id:
          type: string
          example: "play-db-restart"

    GroupActionRecommendation:
      allOf:
        - $ref: '#/components/schemas/Recommendation'
        - type: object
          properties:
            target_incident_ids:
              type: array
              items:
                type: string
              example: ["INC-001", "INC-005"]

    # ===================
    # Incident Analysis
    # ===================
    IncidentAnalysis:
      type: object
      description: AI-driven analysis for a single incident.
      readOnly: true
      required: [summary, root_causes, recommendations]
      properties:
        summary:
          type: string
          example: "The incident appears to be caused by a database connection issue."
        root_causes:
          type: array
          items:
            type: string
          example: ["Database connection pool exhausted", "High query latency on the users table"]
        recommendations:
          type: array
          items:
            $ref: '#/components/schemas/Recommendation'

    MultiIncidentAnalysis:
      type: object
      description: AI-driven analysis for multiple related incidents.
      readOnly: true
      required: [summary, common_patterns, group_actions]
      properties:
        summary:
          type: string
          example: "All selected incidents are related to the 'api-gateway' resource and show similar high latency patterns."
        common_patterns:
          type: array
          items:
            type: string
          example: ["All incidents occurred during peak traffic hours.", "All incidents point to a bottleneck in the authentication service."]
        group_actions:
          type: array
          items:
            $ref: '#/components/schemas/GroupActionRecommendation'

    # ===================
    # Resource Analysis
    # ===================
    ResourceRisk:
      type: object
      description: Describes a specific risk identified for a resource.
      required: [resource_id, resource_name, risk_level, reason, recommendation]
      properties:
        resource_id:
          type: string
        resource_name:
          type: string
        risk_level:
          type: string
          enum: [high, medium, low]
        reason:
          type: string
          example: "Sustained high CPU usage may lead to performance degradation during peak hours."
        recommendation:
          type: string
          example: "Consider upgrading the instance type or implementing auto-scaling."

    OptimizationSuggestion:
      type: object
      description: A suggestion for optimizing a resource.
      required: [resource_id, resource_name, suggestion, type]
      properties:
        resource_id:
          type: string
        resource_name:
          type: string
        suggestion:
          type: string
          example: "The instance is over-provisioned. Consider changing from m5.xlarge to m5.large."
        type:
          type: string
          enum: [cost, performance, security]
          example: cost

    ResourceAnalysisReport:
      type: object
      description: A comprehensive analysis report for a resource.
      readOnly: true
      required: [summary, risk_analysis, optimization_suggestions]
      properties:
        summary:
          type: string
          example: "The resource is stable but has opportunities for cost optimization."
        risk_analysis:
          type: array
          items:
            $ref: '#/components/schemas/ResourceRisk'
        optimization_suggestions:
          type: array
          items:
            $ref: '#/components/schemas/OptimizationSuggestion'

    BatchResourceAnalysisReport:
      type: object
      description: Aggregated analysis results for multiple resources.
      readOnly: true
      required: [summary, analyzed_resources]
      properties:
        summary:
          type: string
          example: "Analyzed 12 resources. 3 require immediate attention."
        analyzed_resources:
          type: array
          items:
            type: object
            required: [resource_id, resource_name, risk_level]
            properties:
              resource_id:
                type: string
              resource_name:
                type: string
              risk_level:
                type: string
                enum: [high, medium, low]
              report:
                $ref: '#/components/schemas/ResourceAnalysisReport'

    RuleAnalysisEvaluatedRule:
      type: object
      required: [id, name, status]
      properties:
        id:
          type: string
        name:
          type: string
        status:
          type: string
        severity:
          type: string
          enum: [low, medium, high]
        type:
          type: string

    RuleAnalysisMetric:
      type: object
      required: [label, value]
      properties:
        label:
          type: string
        value:
          type: string
        description:
          type: string

    RuleAnalysisInsight:
      type: object
      required: [title, detail, severity]
      properties:
        title:
          type: string
        detail:
          type: string
        severity:
          type: string
          enum: [low, medium, high]

    RuleAnalysisRecommendation:
      type: object
      required: [action, description, priority]
      properties:
        action:
          type: string
        description:
          type: string
        priority:
          type: string
          enum: [low, medium, high]

    RuleAnalysisReport:
      type: object
      description: AI-generated evaluation report for alert or silence rules.
      readOnly: true
      required: [report_type, summary, evaluated_rules, metrics, insights, recommendations]
      properties:
        report_type:
          type: string
          enum: [alert, silence]
        summary:
          type: string
        evaluated_rules:
          type: array
          items:
            $ref: '#/components/schemas/RuleAnalysisEvaluatedRule'
        metrics:
          type: array
          items:
            $ref: '#/components/schemas/RuleAnalysisMetric'
        insights:
          type: array
          items:
            $ref: '#/components/schemas/RuleAnalysisInsight'
        recommendations:
          type: array
          items:
            $ref: '#/components/schemas/RuleAnalysisRecommendation'

    # ===================
    # Log Analysis
    # ===================
    LogAnalysis:
      type: object
      description: An analysis of log entries over a given time range.
      readOnly: true
      required: [summary, patterns, recommendations]
      properties:
        summary:
          type: string
          example: "Log analysis reveals a spike in 'connection timeout' errors, suggesting a network or downstream service issue."
        patterns:
          type: array
          items:
            type: object
            required: [description, count, level]
            properties:
              description:
                type: string
                example: "Database connection timeout"
              count:
                type: integer
                example: 152
              level:
                type: string
                enum: [info, warning, error, debug]
                example: error
        recommendations:
          type: array
          items:
            type: string
          example: ["Investigate network connectivity to the main database.", "Check the health of the authentication service."]

    # ===================
    # Dashboard-related Analysis Data
    # ===================
    ServiceHealthData:
      type: object
      required: [heatmap_data, x_axis_labels, y_axis_labels]
      properties:
        heatmap_data:
          type: array
          description: Heatmap matrix represented as [rowIndex, columnIndex, value]
          items:
            type: array
            minItems: 3
            maxItems: 3
            items:
              - type: integer
              - type: integer
              - type: number
          example:
            - [0, 0, 98]
            - [1, 2, 92]
        x_axis_labels:
          type: array
          items:
            type: string
          example: [us-east-1, us-west-2, eu-central-1, ap-northeast-1]
        y_axis_labels:
          type: array
          items:
            type: string
          example: [API Gateway, RDS Database, EKS Cluster, Kubernetes]

    ResourceGroupStatusSeries:
      type: object
      required: [key, label, data]
      properties:
        key:
          type: string
          enum: [healthy, warning, critical]
        label:
          type: string
          example: 健康
        data:
          type: array
          items:
            type: integer
          example: [12, 8, 5, 10, 22]

    ResourceGroupStatusData:
      type: object
      required: [group_names, series]
      properties:
        group_names:
          type: array
          items:
            type: string
          example:
            - Production Web Servers
            - Core Databases
            - Cache Cluster
            - Logging Stack
            - API Services
        series:
          type: array
          items:
            $ref: '#/components/schemas/ResourceGroupStatusSeries'

    # ===================
    # Top-level Analysis Schemas
    # ===================
    AnalysisOverviewData:
      type: object
      required: [health_score, anomalies, suggestions, event_correlation_data, recent_logs]
      properties:
        health_score:
          $ref: '#/components/schemas/HealthScore'
        anomalies:
          type: array
          items:
            $ref: '#/components/schemas/Anomaly'
        suggestions:
          type: array
          items:
            $ref: '#/components/schemas/Suggestion'
        event_correlation_data:
          type: object
        recent_logs:
          type: array
          items:
            $ref: '#/components/schemas/LogEntry'

    HealthScore:
      type: object
      properties:
        score:
          type: integer
        summary:
          type: string

    Anomaly:
      type: object
      properties:
        severity:
          type: string
          enum: [critical, warning, info]
        description:
          type: string
        timestamp:
          type: string
          format: date-time

    Suggestion:
      type: object
      properties:
        title:
          type: string
        impact:
          type: string
          enum: [高, 中, 低]
        effort:
          type: string
          enum: [高, 中, 低]
        details:
          type: string
        action_button_text:
          type: string
        action_link:
          type: string
          format: uri

    CapacityPlanningData:
      type: object
      properties:
        trends:
          type: object
        forecast_model:
          type: object
        suggestions:
          type: array
          items:
            $ref: '#/components/schemas/CapacityPlanningSuggestion'
        resource_analysis:
          type: array
          items:
            $ref: '#/components/schemas/CapacityPlanningResourceInsight'
        options:
          type: object

    CapacityPlanningSuggestion:
      type: object
      properties:
        id:
          type: string
        title:
          type: string
        impact:
          type: string
        effort:
          type: string
        details:
          type: string
        detected_at:
          type: string
          format: date-time
        resource_id:
          type: string

    CapacityPlanningResourceInsight:
      type: object
      properties:
        id:
          type: string
        resource_id:
          type: string
        resource_name:
          type: string
        current_utilization:
          type: number
        forecast_utilization:
          type: number
        recommendation:
          type: object
        cost_impact:
          type: object
        lastEvaluated_at:
          type: string
          format: date-time

    IncidentPrediction:
      type: object
      properties:
        predictions:
          type: array
          items:
            $ref: '#/components/schemas/PredictedIncident'
        analysis_timestamp:
          type: string
          format: date-time

    PredictedIncident:
      type: object
      properties:
        resource_id:
          type: string
        resource_name:
          type: string
        predicted_issue:
          type: string
        probability:
          type: number
          format: float
        estimated_time:
          type: string
          format: date-time
        severity:
          type: string
          enum: [critical, warning, info]
        preventive_actions:
          type: array
          items:
            type: string

    AnomalyDetection:
      type: object
      properties:
        anomalies:
          type: array
          items:
            $ref: '#/components/schemas/DetectedAnomaly'
        summary:
          type: object

    DetectedAnomaly:
      type: object
      properties:
        resource_id:
          type: string
        resource_name:
          type: string
        metric:
          type: string
        timestamp:
          type: string
          format: date-time
        actual_value:
          type: number
        expected_range:
          type: object
        severity:
          type: string
        description:
          type: string

    CapacityPrediction:
      type: object
      properties:
        resource_id:
          type: string
        resource_name:
          type: string
        predictions:
          type: array
          items:
            $ref: '#/components/schemas/MetricPrediction'
        analysis_timestamp:
          type: string
          format: date-time

    MetricPrediction:
      type: object
      properties:
        metric:
          type: string
        current_value:
          type: number
        predicted_values:
          type: array
          items:
            type: object
        threshold_breach_date:
          type: string
          format: date
          nullable: true
        recommendation:
          type: string

    LogEntry:
      type: object
      properties:
        id:
          type: string
        timestamp:
          type: string
          format: date-time
        level:
          type: string
          enum: [info, warning, error, debug]
        service:
          type: string
        message:
          type: string
        details:
          type: object
          additionalProperties: true

    BacktestingTaskStatus:
      type: string
      enum: [queued, pending, running, completed, failed]

    BacktestingMatchStatus:
      type: string
      description: Comparison outcome between replay trigger and ground truth annotation.
      enum: [true_positive, false_positive, false_negative, unknown]

    BacktestingTimeRange:
      type: object
      required: [start_time, end_time]
      properties:
        start_time:
          type: string
          format: date-time
        end_time:
          type: string
          format: date-time

    BacktestingActualEvent:
      type: object
      required: [label, start_time]
      properties:
        id:
          type: string
          description: Optional identifier provided by clients for idempotency.
        label:
          type: string
          description: Display name for the incident or maintenance window.
        start_time:
          type: string
          format: date-time
        end_time:
          type: string
          format: date-time
          nullable: true
        severity:
          $ref: '#/components/schemas/IncidentSeverity'
        notes:
          type: string
          description: Additional context for the event comparison.
        tags:
          type: array
          description: Labeled attributes of the incident for downstream correlation.
          items:
            type: string
        match_status:
          $ref: '#/components/schemas/BacktestingMatchStatus'
        matched_trigger_point_id:
          type: string
          nullable: true
          description: Identifier of the detected trigger that matched this ground truth event.
        detection_time:
          type: string
          format: date-time
          nullable: true
          description: Timestamp when the rule detected the event, if any.
        detection_delay_seconds:
          type: number
          format: float
          nullable: true
          description: Time difference in seconds between the annotated start and detection time.

    BacktestingTaskOptions:
      type: object
      properties:
        datasource_id:
          type: string
          description: Datasource identifier for metrics replay.
        evaluation_window_minutes:
          type: integer
          minimum: 1
          default: 15
        sensitivity:
          type: string
          enum: [conservative, balanced, aggressive]
          default: balanced
        include_recommendations:
          type: boolean
          default: true

    BacktestingRunRequest:
      type: object
      required: [rule_ids, time_range]
      properties:
        rule_ids:
          type: array
          minItems: 1
          items:
            type: string
        time_range:
          $ref: '#/components/schemas/BacktestingTimeRange'
        actual_events:
          type: array
          items:
            $ref: '#/components/schemas/BacktestingActualEvent'
        options:
          $ref: '#/components/schemas/BacktestingTaskOptions'

    BacktestingRunResponse:
      type: object
      required: [task_id, status, submitted_at, rule_count]
      properties:
        task_id:
          type: string
        status:
          $ref: '#/components/schemas/BacktestingTaskStatus'
        submitted_at:
          type: string
          format: date-time
        rule_count:
          type: integer
          minimum: 1
        estimated_completion_time:
          type: string
          format: date-time
          nullable: true

    BacktestingMetricPoint:
      type: object
      required: [timestamp, value]
      properties:
        timestamp:
          type: string
          format: date-time
        value:
          type: number
        threshold:
          type: number
          nullable: true
        baseline:
          type: number
          nullable: true

    BacktestingTriggerPoint:
      type: object
      required: [timestamp, value, condition_summary]
      properties:
        timestamp:
          type: string
          format: date-time
        value:
          type: number
        condition_summary:
          type: string
        duration_minutes:
          type: integer
          minimum: 0
        match_status:
          $ref: '#/components/schemas/BacktestingMatchStatus'
        ground_truth_event_id:
          type: string
          nullable: true
          description: Matched ground truth event identifier.
        ground_truth_event_label:
          type: string
          nullable: true
          description: Display name of the matched ground truth event.
        tags:
          type: array
          items:
            type: string
          description: Tags carried over from the triggering datapoints or alert metadata.
        notes:
          type: string
          description: Additional diagnostic notes for this trigger.
        detection_delay_seconds:
          type: number
          format: float
          nullable: true
          description: Detection delay (seconds) relative to the annotated event.

    BacktestingRecommendation:
      type: object
      required: [type, title, description]
      properties:
        type:
          type: string
          enum: [threshold, duration, sensitivity, automation]
        title:
          type: string
        description:
          type: string
        impact:
          type: string
          enum: ['高', '中', '低']
        suggested_threshold:
          type: number
          nullable: true
        suggested_duration_minutes:
          type: integer
          nullable: true
        suggested_sensitivity:
          type: string
          enum: [conservative, balanced, aggressive]
          nullable: true

    BacktestingRuleResult:
      type: object
      required:
        - rule_id
        - rule_name
        - triggered_count
        - trigger_points
        - metric_series
        - actual_events
        - false_positive_count
        - false_negative_count
        - recommendations
      properties:
        rule_id:
          type: string
        rule_name:
          type: string
        triggered_count:
          type: integer
          minimum: 0
        trigger_points:
          type: array
          items:
            $ref: '#/components/schemas/BacktestingTriggerPoint'
        metric_series:
          type: array
          items:
            $ref: '#/components/schemas/BacktestingMetricPoint'
        actual_events:
          type: array
          items:
            $ref: '#/components/schemas/BacktestingActualEvent'
        false_positive_count:
          type: integer
          minimum: 0
        false_negative_count:
          type: integer
          minimum: 0
        precision:
          type: number
          nullable: true
        recall:
          type: number
          nullable: true
        recommendations:
          type: array
          items:
            $ref: '#/components/schemas/BacktestingRecommendation'
        suggested_threshold:
          type: number
          nullable: true
        suggested_duration_minutes:
          type: integer
          nullable: true
        execution_time_ms:
          type: integer
          nullable: true

    BacktestingBatchSummary:
      type: object
      required: [total_rules, total_triggers, recommendations]
      properties:
        total_rules:
          type: integer
          minimum: 1
        total_triggers:
          type: integer
          minimum: 0
        false_positive_rate:
          type: number
          nullable: true
        false_negative_rate:
          type: number
          nullable: true
        average_precision:
          type: number
          nullable: true
        average_recall:
          type: number
          nullable: true
        recommendations:
          type: array
          items:
            $ref: '#/components/schemas/BacktestingRecommendation'

    BacktestingResultsResponse:
      type: object
      required: [task_id, status, requested_at, rule_results]
      properties:
        task_id:
          type: string
        status:
          $ref: '#/components/schemas/BacktestingTaskStatus'
        requested_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
          nullable: true
        duration_seconds:
          type: number
          nullable: true
        rule_results:
          type: array
          items:
            $ref: '#/components/schemas/BacktestingRuleResult'
        batch_summary:
          $ref: '#/components/schemas/BacktestingBatchSummary'
        message:
          type: string
          nullable: true
