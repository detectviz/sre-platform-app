# Core Entity Schemas
components:
  schemas:
    # ===================
    # Dashboard
    # ===================
    Dashboard:
      type: object
      required: [id, name, type, created_at]
      properties:
        id:
          type: string
          example: dash-prod-overview
        name:
          type: string
          example: Production Overview
        type:
          type: string
          enum: [built-in, custom, grafana]
          example: grafana
        category:
          type: string
          example: 基礎設施
        description:
          type: string
          example: 生產環境全局監控儀表板
        owner:
          type: string
          example: SRE 平台團隊
        path:
          type: string
          example: /dashboard/production-overview
        grafana_url:
          type: string
          format: uri
          example: https://grafana.example.com/d/prod-overview
        grafana_dashboard_uid:
          type: string
          example: prod-overview-uid
        grafana_folder_uid:
          type: string
          example: infra-folder
        resource_ids:
          type: array
          items:
            type: string
          example: [res-001, res-002, res-003]
        team_id:
          type: string
          example: team-sre
        owner_id:
          type: string
          example: usr-001
        created_at:
          type: string
          format: date-time
          example: "2024-01-01T00:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2024-01-15T10:30:00Z"
        deleted_at:
          type: string
          format: date-time
          nullable: true
          example: null

    DashboardCreate:
      type: object
      required: [name, type, category]
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 200
        type:
          type: string
          enum: [built-in, custom, grafana]
        category:
          type: string
          description: Logical grouping for dashboards used to populate defaults
        description:
          type: string
        owner:
          type: string
        team_id:
          type: string
        grafana_dashboard_uid:
          type: string
        grafana_folder_uid:
          type: string
        resource_ids:
          type: array
          items:
            type: string

    DashboardUpdate:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        category:
          type: string
        resource_ids:
          type: array
          items:
            type: string
        grafana_dashboard_uid:
          type: string
        grafana_folder_uid:
          type: string

    DashboardTemplate:
      type: object
      required: [id, name, description, icon, category]
      properties:
        id:
          type: string
          example: tpl-001
        name:
          type: string
          example: 微服務健康度
        description:
          type: string
          example: 監控延遲、流量、錯誤率與資源飽和度的預設儀表板模板
        icon:
          type: string
          example: server
        category:
          type: string
          example: 應用程式

    InfraInsightsOptions:
      type: object
      required: [time_options, risk_levels, refresh_options, tv_mode_options, theme_options]
      properties:
        time_options:
          type: array
          items:
            $ref: '#/components/schemas/LabeledValueOption'
        risk_levels:
          type: array
          items:
            $ref: '#/components/schemas/ColoredValueOption'
        refresh_options:
          type: array
          items:
            $ref: '#/components/schemas/LabeledValueOption'
        tv_mode_options:
          type: array
          items:
            $ref: '#/components/schemas/LabeledValueOption'
        theme_options:
          type: array
          items:
            $ref: '#/components/schemas/LabeledValueOption'

    LabeledValueOption:
      type: object
      required: [label, value]
      properties:
        label:
          type: string
          example: 最近 30 分鐘
        value:
          type: string
          example: now-30m

    ColoredValueOption:
      allOf:
        - $ref: '#/components/schemas/LabeledValueOption'
        - type: object
          required: [color]
          properties:
            color:
              type: string
              example: '#dc2626'

    # ===================
    # Incident
    # ===================
    Incident:
      type: object
      required:
        [id, summary, resource, resource_id, rule_id, status, severity, impact, created_at]
      properties:
        id:
          type: string
          example: INC-001
        summary:
          type: string
          example: API 延遲超過閾值
        resource:
          type: string
          example: api-server-01
        resource_id:
          type: string
          example: res-001
        rule:
          type: string
          example: API 延遲規則
        rule_id:
          type: string
          example: rule-002
        status:
          type: string
          enum: [new, acknowledged, resolved, silenced]
          description: 事件目前的生命週期狀態；`silenced` 代表事件已被靜音且暫停通知。
          example: new
        severity:
          type: string
          enum: [critical, warning, info]
          example: warning
        impact:
          type: string
          enum: [high, medium, low]
          example: high
        priority:
          type: string
          enum: [p0, p1, p2, p3]
          example: p1
        category:
          type: string
          enum: [application, infrastructure, other]
          example: application
        assignee:
          type: string
          example: 張三
        team_id:
          type: string
          example: team-001
        owner_id:
          type: string
          example: usr-001
        tags:
          type: object
          additionalProperties:
            type: string
          example:
            env: production
            service: api-gateway
            team: "SRE Platform"
        occurred_at:
          type: string
          format: date-time
          example: "2024-01-15T10:30:00Z"
        created_at:
          type: string
          format: date-time
          example: "2024-01-15T10:30:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2024-01-15T10:35:00Z"
        acknowledged_at:
          type: string
          format: date-time
          nullable: true
          example: null
        resolved_at:
          type: string
          format: date-time
          nullable: true
          example: null
        silenced_by:
          type: string
          nullable: true
          example: null
        notifications_sent:
          type: array
          description: Records of notification attempts for this incident
          items:
            $ref: '#/components/schemas/NotificationRecord'
        ai_analysis:
          $ref: '#/components/schemas/IncidentAnalysis'
        history:
          type: array
          items:
            type: object
            properties:
              timestamp:
                type: string
                format: date-time
              user:
                type: string
              action:
                type: string
              details:
                type: string
          example:
            - timestamp: "2024-01-15T10:30:00Z"
              user: "System"
              action: "Created"
              details: "Incident created from rule 'API 延遲規則'"
        deleted_at:
          type: string
          format: date-time
          nullable: true
          example: null

    IncidentCreate:
      type: object
      required: [resource_id, rule_id, summary, severity, impact]
      properties:
        resource_id:
          type: string
        rule_id:
          type: string
        summary:
          type: string
          minLength: 1
          maxLength: 500
        severity:
          type: string
          enum: [critical, warning, info]
        impact:
          type: string
          enum: [high, medium, low]
        tags:
          type: object
          additionalProperties:
            type: string

    IncidentUpdate:
      type: object
      properties:
        status:
          type: string
          enum: [new, acknowledged, resolved, silenced]
          description: 更新事件狀態；`silenced` 可用於暫時停用通知。
        assignee:
          type: string
        tags:
          type: object
          additionalProperties:
            type: string

    # ===================
    # Alert Rule
    # ===================
    AlertRule:
      type: object
      required:
        [id, name, resource_type, metric_name, enabled, severity, created_at]
      properties:
        id:
          type: string
          example: rule-cpu-high
        name:
          type: string
          example: CPU 使用率過高規則
        resource_type:
          type: string
          example: host
        metric_name:
          type: string
          example: cpu_usage_percent
        enabled:
          type: boolean
          example: true
        severity:
          type: string
          enum: [critical, warning, info]
          example: critical
        conditions_summary:
          type: string
          example: "CPU usage > 80% for 5 minutes"
        automation_enabled:
          type: boolean
          example: true
        target_resource_ids:
          type: array
          items:
            type: string
          example: [res-001, res-002]
        target_scope:
          type: string
          enum: [specific, group, tag]
          example: specific
        notification_strategy_ids:
          type: array
          items:
            type: string
          example: [ns-critical, ns-warning]
        triggered_count:
          type: integer
          example: 15
        version:
          type: integer
          example: 2
        condition_groups:
          type: array
          items:
            $ref: '#/components/schemas/AlertRuleConditionGroup'
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        deleted_at:
          type: string
          format: date-time
          nullable: true

    AlertRuleCreate:
      type: object
      required: [name, resource_type, metric_name, severity]
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 200
        resource_type:
          type: string
        metric_name:
          type: string
        enabled:
          type: boolean
          default: true
        severity:
          type: string
          enum: [critical, warning, info]
        conditions_summary:
          type: string
        automation_enabled:
          type: boolean
          default: false
        target_resource_ids:
          type: array
          items:
            type: string
        notification_strategy_ids:
          type: array
          items:
            type: string
        condition_groups:
          type: array
          items:
            $ref: "#/components/schemas/AlertRuleConditionGroup"

    AlertRuleUpdate:
      type: object
      properties:
        name:
          type: string
        resource_type:
          type: string
        metric_name:
          type: string
        enabled:
          type: boolean
        severity:
          type: string
          enum: [critical, warning, info]
        automation_enabled:
          type: boolean
        notification_strategy_ids:
          type: array
          items:
            type: string
        condition_groups:
          type: array
          items:
            $ref: "#/components/schemas/AlertRuleConditionGroup"

    AlertRuleConditionGroup:
      type: object
      required: [logic, severity, conditions]
      properties:
        logic:
          type: string
          enum: [and, or]
        severity:
          type: string
          enum: [critical, warning, info]
        conditions:
          type: array
          minItems: 1
          items:
            type: object
            required: [metric, operator, threshold, duration_minutes]
            properties:
              metric:
                type: string
              operator:
                type: string
                enum: ['>', '>=', '<', '<=']
              threshold:
                type: number
              duration_minutes:
                type: integer
                minimum: 0

    # ===================
    # Resource
    # ===================
    Resource:
      type: object
      required: [id, name, status, type, provider, region, owner, created_at, updated_at]
      properties:
        id:
          type: string
          example: res-001
        name:
          type: string
          example: api-gateway-prod-01
        status:
          type: string
          enum: [healthy, warning, critical, offline, unknown]
          example: healthy
        type:
          type: string
          example: API Gateway
        provider:
          type: string
          example: AWS
        region:
          type: string
          example: us-east-1
        owner:
          type: string
          example: SRE Team
        team_id:
          type: string
          example: team-001
        owner_id:
          type: string
          example: usr-001
        tags:
          type: object
          additionalProperties:
            type: string
          description: 自定義資源標籤
          example:
            env: production
            service: api-gateway
        monitoring_agent:
          type: string
          example: agent-prometheus
        datasource_id:
          type: string
          example: ds-001
        discovered_by_job_id:
          type: string
          example: dj-003
        last_check_in_at:
          type: string
          format: date-time
          example: "2024-01-15T10:45:00Z"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        deleted_at:
          type: string
          format: date-time
          nullable: true

    ResourceCreate:
      type: object
      required: [name, type, status, provider, region, owner]
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 200
        type:
          type: string
        status:
          type: string
          enum: [healthy, warning, critical, offline, unknown]
        provider:
          type: string
        region:
          type: string
        owner:
          type: string
        team_id:
          type: string
        owner_id:
          type: string
        tags:
          type: object
          additionalProperties:
            type: string
        monitoring_agent:
          type: string
        datasource_id:
          type: string
        discovered_by_job_id:
          type: string

    ResourceUpdate:
      type: object
      properties:
        name:
          type: string
        status:
          type: string
          enum: [healthy, warning, critical, offline, unknown]
        owner:
          type: string
        team_id:
          type: string
        owner_id:
          type: string
        tags:
          type: object
          additionalProperties:
            type: string
        monitoring_agent:
          type: string
        datasource_id:
          type: string

    # ===================
    # Batch Result
    # ===================
    BatchResult:
      type: object
      required: [success, updated]
      properties:
        success:
          type: boolean
          example: true
        updated:
          type: integer
          example: 5
        skipped_ids:
          type: array
          items:
            type: string
          example: [INC-003, INC-005]
        message:
          type: string
          example: "Successfully updated 5 items, skipped 2"
