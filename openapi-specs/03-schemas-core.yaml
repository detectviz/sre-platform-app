# Core Entity Schemas
components:
  schemas:
    # ===================
    # Dashboard
    # ===================
    Dashboard:
      type: object
      description: Represents a dashboard for visualizing data.
      required:
        - id
        - name
        - type
        - category
        - owner
        - created_at
        - updated_at
        - path
      properties:
        id:
          type: string
          readOnly: true
          example: dash-prod-overview
        name:
          type: string
          example: Production Overview
        type:
          type: string
          enum: [built-in, custom, grafana]
          example: grafana
        category:
          type: string
          example: 基礎設施
        description:
          type: string
          example: 生產環境全局監控儀表板
        owner:
          type: string
          readOnly: true
          description: Name of the owner user or team, derived from owner_id or team_id.
          example: SRE 平台團隊
        path:
          type: string
          readOnly: true
          example: /dashboard/production-overview
        layout:
          type: array
          description: Describes the layout of widgets on the dashboard.
          items:
            $ref: '#/components/schemas/DashboardLayoutItem'
        grafana_url:
          type: string
          format: uri
          example: https://grafana.example.com/d/prod-overview
        grafana_dashboard_uid:
          type: string
          example: prod-overview-uid
        grafana_folder_uid:
          type: string
          example: infra-folder
        resource_ids:
          type: array
          items:
            type: string
          example: [res-001, res-002, res-003]
        team_id:
          type: string
          example: team-sre
        owner_id:
          type: string
          example: usr-001
        created_at:
          type: string
          format: date-time
          readOnly: true
          example: "2024-01-01T00:00:00Z"
        updated_at:
          type: string
          format: date-time
          readOnly: true
          example: "2024-01-15T10:30:00Z"
        deleted_at:
          type: string
          format: date-time
          readOnly: true
          nullable: true
          example: null

    DashboardLayoutItem:
      type: object
      description: Defines the position and size of a widget on a dashboard grid.
      required: [i, x, y, w, h]
      properties:
        i:
          type: string
          description: The ID of the widget.
          example: widget-cpu-usage
        x:
          type: integer
          description: The horizontal position of the widget on the grid.
        y:
          type: integer
          description: The vertical position of the widget on the grid.
        w:
          type: integer
          description: The width of the widget.
        h:
          type: integer
          description: The height of the widget.

    DashboardCreate:
      type: object
      required: [name, type, category]
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 200
        type:
          type: string
          enum: [built-in, custom, grafana]
        category:
          type: string
          description: Logical grouping for dashboards used to populate defaults
        description:
          type: string
        team_id:
          type: string
          description: ID of the team that will own the dashboard.
        owner_id:
          type: string
          description: ID of the user that will own the dashboard.
        grafana_dashboard_uid:
          type: string
        grafana_folder_uid:
          type: string
        resource_ids:
          type: array
          items:
            type: string

    DashboardUpdate:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        category:
          type: string
        team_id:
          type: string
        owner_id:
          type: string
        resource_ids:
          type: array
          items:
            type: string
        grafana_dashboard_uid:
          type: string
        grafana_folder_uid:
          type: string

    DashboardTemplate:
      type: object
      required: [id, name, description, icon, category]
      properties:
        id:
          type: string
          example: tpl-001
        name:
          type: string
          example: 微服務健康度
        description:
          type: string
          example: 監控延遲、流量、錯誤率與資源飽和度的預設儀表板模板
        icon:
          type: string
          example: server
        category:
          type: string
          example: 應用程式

    InfraInsightsOptions:
      type: object
      required: [time_options, risk_levels, refresh_options, tv_mode_options, theme_options]
      properties:
        time_options:
          type: array
          items:
            $ref: '#/components/schemas/LabeledValueOption'
        risk_levels:
          type: array
          items:
            $ref: '#/components/schemas/ColoredValueOption'
        refresh_options:
          type: array
          items:
            $ref: '#/components/schemas/LabeledValueOption'
        tv_mode_options:
          type: array
          items:
            $ref: '#/components/schemas/LabeledValueOption'
        theme_options:
          type: array
          items:
            $ref: '#/components/schemas/LabeledValueOption'

    LabeledValueOption:
      type: object
      required: [label, value]
      properties:
        label:
          type: string
          example: 最近 30 分鐘
        value:
          type: string
          example: now-30m

    ColoredValueOption:
      allOf:
        - $ref: '#/components/schemas/LabeledValueOption'
        - type: object
          required: [color]
          properties:
            color:
              type: string
              example: '#dc2626'

    # ===================
    # Incident
    # ===================
    Incident:
      type: object
      required:
        - id
        - summary
        - resource
        - resource_id
        - rule_id
        - status
        - severity
        - impact
        - created_at
        - updated_at
        - occurred_at
        - history
      properties:
        id:
          type: string
          readOnly: true
          example: INC-001
        summary:
          type: string
          example: API 延遲超過閾值
        resource:
          type: string
          readOnly: true
          example: api-server-01
        resource_id:
          type: string
          example: res-001
        rule:
          type: string
          readOnly: true
          example: API 延遲規則
        rule_id:
          type: string
          example: rule-002
        status:
          type: string
          enum: [new, acknowledged, resolved, silenced]
          description: 事件目前的生命週期狀態；`silenced` 代表事件已被靜音且暫停通知。
          example: new
        severity:
          type: string
          enum: [critical, warning, info]
          example: warning
        impact:
          type: string
          enum: [high, medium, low]
          example: high
        priority:
          type: string
          enum: [p0, p1, p2, p3]
          example: p1
        category:
          type: string
          enum: [infrastructure, application, network, security, other]
          example: application
        assignee:
          type: string
          example: 張三
        team_id:
          type: string
          example: team-001
        owner_id:
          type: string
          example: usr-001
        tags:
          type: object
          additionalProperties:
            type: string
          example:
            env: production
            service: api-gateway
            team: "SRE Platform"
        occurred_at:
          type: string
          format: date-time
          readOnly: true
          example: "2024-01-15T10:30:00Z"
        created_at:
          type: string
          format: date-time
          readOnly: true
          example: "2024-01-15T10:30:00Z"
        updated_at:
          type: string
          format: date-time
          readOnly: true
          example: "2024-01-15T10:35:00Z"
        acknowledged_at:
          type: string
          format: date-time
          readOnly: true
          nullable: true
          example: null
        resolved_at:
          type: string
          format: date-time
          readOnly: true
          nullable: true
          example: null
        silenced_by:
          type: string
          readOnly: true
          nullable: true
          example: null
        notifications_sent:
          type: array
          readOnly: true
          description: Records of notification attempts for this incident
          items:
            $ref: '#/components/schemas/NotificationRecord'
        ai_analysis:
          $ref: '#/components/schemas/IncidentAnalysis'
          readOnly: true
        history:
          type: array
          readOnly: true
          items:
            type: object
            properties:
              timestamp:
                type: string
                format: date-time
              user:
                type: string
              action:
                type: string
              details:
                type: string
          example:
            - timestamp: "2024-01-15T10:30:00Z"
              user: "System"
              action: "Created"
              details: "Incident created from rule 'API 延遲規則'"
        deleted_at:
          type: string
          format: date-time
          readOnly: true
          nullable: true
          example: null

    IncidentCreate:
      type: object
      required: [resource_id, rule_id, summary, severity, impact]
      properties:
        resource_id:
          type: string
        rule_id:
          type: string
        summary:
          type: string
          minLength: 1
          maxLength: 500
        severity:
          type: string
          enum: [critical, warning, info]
        impact:
          type: string
          enum: [high, medium, low]
        assignee:
          type: string
        team_id:
          type: string
        owner_id:
          type: string
        tags:
          type: object
          additionalProperties:
            type: string

    IncidentUpdate:
      type: object
      properties:
        summary:
          type: string
        status:
          type: string
          enum: [new, acknowledged, resolved, silenced]
          description: 更新事件狀態；`silenced` 可用於暫時停用通知。
        severity:
          type: string
          enum: [critical, warning, info]
        impact:
          type: string
          enum: [high, medium, low]
        priority:
          type: string
          enum: [p0, p1, p2, p3]
        category:
          type: string
          enum: [infrastructure, application, network, security, other]
        assignee:
          type: string
        team_id:
          type: string
        owner_id:
          type: string
        tags:
          type: object
          additionalProperties:
            type: string

    # ===================
    # Alert Rule
    # ===================
    AlertRule:
      type: object
      description: Represents an alert rule that defines conditions for triggering an incident.
      required:
        - id
        - name
        - enabled
        - target
        - conditions_summary
        - severity
        - automation_enabled
        - creator
        - created_at
        - updated_at
      properties:
        id:
          type: string
          description: Unique identifier for the alert rule.
          readOnly: true
          example: rule-cpu-high-95
        name:
          type: string
          description: A human-readable name for the alert rule.
          example: "High CPU Usage on Core Services"
        description:
          type: string
          description: A detailed description of the alert rule's purpose.
          example: "Triggers a critical alert if CPU usage on any core service exceeds 95% for 5 minutes."
        enabled:
          type: boolean
          description: Indicates if the alert rule is currently active.
          example: true
        target:
          type: string
          description: A description of the target resources or metrics this rule applies to.
          example: "service:api-gateway, service:auth-service"
        conditions_summary:
          type: string
          description: A human-readable summary of the rule's conditions.
          readOnly: true
          example: "avg(cpu.usage) > 95 for 5m"
        severity:
          type: string
          enum: [critical, warning, info]
          example: critical
        automation_enabled:
          type: boolean
          description: Indicates if an automated action is linked to this rule.
          readOnly: true
          example: false
        creator:
          type: string
          description: The name of the user who created the rule.
          readOnly: true
          example: "sre-admin"
        team_id:
          type: string
          description: The ID of the team that owns this rule.
          example: "team-sre-core"
        owner_id:
          type: string
          description: The ID of the user who owns this rule.
          example: "usr-jane-doe"
        tags:
          type: object
          additionalProperties:
            type: string
          example:
            priority: "high"
        created_at:
          type: string
          format: date-time
          readOnly: true
        updated_at:
          type: string
          format: date-time
          readOnly: true
        labels:
          type: array
          items:
            type: string
          example: ["cpu", "critical-path"]
        condition_groups:
          type: array
          items:
            $ref: '#/components/schemas/AlertRuleConditionGroup'
        title_template:
          type: string
          description: "Template for the generated incident's title."
          example: "Critical CPU Alert on {{resource.name}}"
        content_template:
          type: string
          description: "Template for the generated incident's content."
          example: "CPU usage for {{resource.name}} is at {{metric.value}}%, exceeding the threshold of 95%."
        automation:
          $ref: '#/components/schemas/AlertRuleAutomationSetting'
        target_resource_ids:
          type: array
          items:
            type: string
          example: ["res-api-gw-1", "res-auth-svc-1"]
        target_scope:
          type: string
          enum: [specific, group, tag]
          example: specific
        triggered_count:
          type: integer
          readOnly: true
          example: 42
        version:
          type: integer
          readOnly: true
          example: 3
        deleted_at:
          type: string
          format: date-time
          readOnly: true
          nullable: true

    AlertRuleCreate:
      type: object
      description: Payload for creating a new alert rule.
      required: [name, severity, condition_groups]
      properties:
        name:
          type: string
        description:
          type: string
        enabled:
          type: boolean
          default: true
        target:
          type: string
        severity:
          type: string
          enum: [critical, warning, info]
        team_id:
          type: string
        owner_id:
          type: string
        tags:
          type: object
          additionalProperties:
            type: string
        labels:
          type: array
          items:
            type: string
        condition_groups:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/AlertRuleConditionGroup'
        title_template:
          type: string
        content_template:
          type: string
        automation:
          $ref: '#/components/schemas/AlertRuleAutomationSetting'
        target_resource_ids:
          type: array
          items:
            type: string
        target_scope:
          type: string
          enum: [specific, group, tag]
          default: specific

    AlertRuleUpdate:
      type: object
      description: Payload for updating an existing alert rule. All fields are optional.
      properties:
        name:
          type: string
        description:
          type: string
        enabled:
          type: boolean
        target:
          type: string
        severity:
          type: string
          enum: [critical, warning, info]
        team_id:
          type: string
        owner_id:
          type: string
        tags:
          type: object
          additionalProperties:
            type: string
        labels:
          type: array
          items:
            type: string
        condition_groups:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/AlertRuleConditionGroup'
        title_template:
          type: string
        content_template:
          type: string
        automation:
          $ref: '#/components/schemas/AlertRuleAutomationSetting'
        target_resource_ids:
          type: array
          items:
            type: string
        target_scope:
          type: string
          enum: [specific, group, tag]

    AlertRuleConditionGroup:
      type: object
      required: [logic, conditions]
      properties:
        logic:
          type: string
          enum: [and, or]
          default: and
        conditions:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/AlertRuleCondition'
        severity:
          type: string
          enum: [critical, warning, info]
          description: Overrides the main rule severity if this group's conditions are met.

    AlertRuleCondition:
      type: object
      required: [metric, operator, threshold, duration_minutes]
      properties:
        metric:
          type: string
          example: "cpu.usage.percent"
        operator:
          type: string
          enum: ['>', '<', '>=', '<=']
          example: '>'
        threshold:
          type: number
          example: 95
        duration_minutes:
          type: integer
          minimum: 0
          example: 5

    AlertRuleAutomationSetting:
      type: object
      required: [enabled]
      properties:
        enabled:
          type: boolean
        script_id:
          type: string
          description: "ID of the automation playbook to run."
          example: "playbook-auto-restart-pod"
        parameters:
          type: object
          additionalProperties:
            type: any
          description: "Parameters to pass to the automation playbook."
          example:
            namespace: "production"

    # ===================
    # Silence Rule
    # ===================
    SilenceMatcher:
      type: object
      required: [key, operator, value]
      properties:
        key:
          type: string
          example: env
        operator:
          type: string
          enum: ['=', '!=', '~=']
          example: '='
        value:
          type: string
          example: staging

    SilenceSchedule:
      type: object
      required: [type]
      properties:
        type:
          type: string
          enum: [single, recurring]
          example: recurring
        starts_at:
          type: string
          format: date-time
          example: "2025-09-20T22:00:00Z"
        ends_at:
          type: string
          format: date-time
          example: "2025-09-21T06:00:00Z"
        cron:
          type: string
          example: "0 22 * * 5"
        cron_description:
          type: string
          example: 每週五 22:00
        timezone:
          type: string
          example: Asia/Taipei

    SilenceRule:
      type: object
      description: Defines conditions for silencing alert notifications.
      required: [id, name, enabled, type, matchers, schedule, creator, created_at, updated_at]
      properties:
        id:
          type: string
          readOnly: true
          example: sil-001
        name:
          type: string
          example: 週末維護窗口
        description:
          type: string
          example: 週末例行維護期間靜音 staging 環境告警。
        enabled:
          type: boolean
          example: true
        type:
          type: string
          enum: [single, repeat, condition]
          example: repeat
        matchers:
          type: array
          items:
            $ref: '#/components/schemas/SilenceMatcher'
        schedule:
          $ref: '#/components/schemas/SilenceSchedule'
        creator:
          type: string
          readOnly: true
          example: Admin User
        created_at:
          type: string
          format: date-time
          readOnly: true
        updated_at:
          type: string
          format: date-time
          readOnly: true
        deleted_at:
          type: string
          format: date-time
          readOnly: true
          nullable: true

    SilenceRuleCreate:
      type: object
      required: [name, enabled, type, matchers, schedule]
      properties:
        name:
          type: string
        description:
          type: string
        enabled:
          type: boolean
        type:
          type: string
          enum: [single, repeat, condition]
        matchers:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/SilenceMatcher'
        schedule:
          $ref: '#/components/schemas/SilenceSchedule'
        creator:
          type: string
          description: Optional creator name; defaults to the authenticated user if omitted.

    SilenceRuleUpdate:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        enabled:
          type: boolean
        type:
          type: string
          enum: [single, repeat, condition]
        matchers:
          type: array
          items:
            $ref: '#/components/schemas/SilenceMatcher'
        schedule:
          $ref: '#/components/schemas/SilenceSchedule'
        creator:
          type: string

    SilenceRuleTemplate:
      type: object
      required: [id, name, data]
      properties:
        id:
          type: string
          example: srt-001
        name:
          type: string
          example: Staging Maintenance
        data:
          type: object
          description: Partial silence rule payload used to pre-fill new rules.
          additionalProperties: true
          example:
            name: Staging Maintenance
            matchers:
              - key: env
                operator: '='
                value: staging
            schedule:
              type: recurring
              cron: 0 22 * * 5

    # ===================
    # Resource
    # ===================
    Resource:
      type: object
      required:
        - id
        - name
        - status
        - type
        - provider
        - region
        - owner
        - created_at
        - updated_at
        - last_check_in_at
      properties:
        id:
          type: string
          readOnly: true
          example: res-001
        name:
          type: string
          example: api-gateway-prod-01
        status:
          type: string
          enum: [healthy, warning, critical, offline, unknown]
          example: healthy
        type:
          type: string
          example: API Gateway
        provider:
          type: string
          example: AWS
        region:
          type: string
          example: us-east-1
        owner:
          type: string
          readOnly: true
          description: The name of the owning user or team.
          example: SRE Team
        team_id:
          type: string
          example: team-001
        owner_id:
          type: string
          example: usr-001
        tags:
          type: array
          description: 自定義資源標籤，以鍵值陣列形式呈現。
          items:
            $ref: '#/components/schemas/KeyValueTag'
          example:
            - id: tag-env-prod
              key: env
              value: production
            - id: tag-service-api
              key: service
              value: api-gateway
        monitoring_agent:
          type: string
          example: agent-prometheus
        datasource_id:
          type: string
          example: ds-001
        discovered_by_job_id:
          type: string
          readOnly: true
          example: dj-003
        last_check_in_at:
          type: string
          format: date-time
          readOnly: true
          example: "2024-01-15T10:45:00Z"
        created_at:
          type: string
          format: date-time
          readOnly: true
        updated_at:
          type: string
          format: date-time
          readOnly: true
        deleted_at:
          type: string
          format: date-time
          readOnly: true
          nullable: true

    ResourceCreate:
      type: object
      required: [name, type, status, provider, region]
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 200
        type:
          type: string
        status:
          type: string
          enum: [healthy, warning, critical, offline, unknown]
        provider:
          type: string
        region:
          type: string
        team_id:
          type: string
        owner_id:
          type: string
        tags:
          type: array
          items:
            $ref: '#/components/schemas/KeyValueTag'
        monitoring_agent:
          type: string
        datasource_id:
          type: string

    ResourceUpdate:
      type: object
      properties:
        name:
          type: string
        status:
          type: string
          enum: [healthy, warning, critical, offline, unknown]
        team_id:
          type: string
        owner_id:
          type: string
        tags:
          type: array
          items:
            $ref: '#/components/schemas/KeyValueTag'
        monitoring_agent:
          type: string
        datasource_id:
          type: string

    # ===================
    # Batch Result
    # ===================
    BatchResult:
      type: object
      required: [success, updated]
      properties:
        success:
          type: boolean
          example: true
        updated:
          type: integer
          example: 5
        skipped_ids:
          type: array
          items:
            type: string
          example: [INC-003, INC-005]
        message:
          type: string
          example: "Successfully updated 5 items, skipped 2"
