# SRE 平台憲法

## 核心原則

### 一、觀測性與可靠性優先
所有功能必須可觀測：指標、記錄、告警三位一體。每項畫面與流程須定義健康檢查與錯誤回饋。任何新增功能不得降低穩定性或掩蓋故障訊號。

### 二、資料治理與血緣追蹤
資料從來源到消費必須可追溯。任何轉換、儲存、輸出需具備血緣紀錄與審計軌跡。以治理先於洞察與自動化，確保可驗證與可回溯。

### 三、安全性與多租戶隔離
租戶資料嚴格隔離。所有操作遵循 RBAC 與審計記錄。安全檢查先於資料操作，並符合既定標準（GDPR、ISO27001）。

### 四、自動化與可解釋智慧
自動化需可審計、可回滾、可人工干預。AI/Insight 需提供可解釋依據與血緣連結，任何自動化決策皆可追蹤與覆核。

### 五、標準化與一致性
程式碼、API、資料結構與 UI 風格遵循統一標準：命名規則、驗證、錯誤模型、色票、表格模式。重大變更需遷移計畫與文件更新。

---

## 技術標準

### 技術棧與版本（前端）
- **React 19**、**TypeScript 5**、**Vite 6**
- **Ant Design 5**（重置樣式為主）、**Tailwind（CDN）**
- **ECharts 6**（CDN）、**dayjs 1.11**、**axios 1.12**、**React Router 7**

### 應用組件與規約
- 路由：僅由集中設定管理；禁止硬寫路徑字串。
- 狀態：Context 與自訂 hooks 為主；避免 props drilling。
- 圖表：統一 `useChartTheme()` 與預設 grid/tooltip 配置；禁止頁面內硬寫色彩陣列。
- 表單與表格：採統一的 **表格基底**、**排序表頭**、**分頁容器**。

### API 與錯誤模型
- `services/api.ts` 為唯一入口；前綴 `/api/v1` 固化於設定。
- 統一錯誤模型：`{ code, message, details? }`；UI 僅讀取標準欄位。
- 任何 API 變更需同步更新 Mock 與合約測試。

### 命名與型別
- TypeScript **禁用隱式 `any`**；新增型別需置於 `types/` 或模組內 `types.ts`。
- 枚舉與常數集中：`constants/`（狀態鍵、圖示鍵、路由、訊息鍵）。
- 檔名與元件：`PascalCase` 元件、`kebab-case` 路徑、明確後綴 `Page/Modal/Drawer`。

---

## UI / UX 設計原則

### 一致性優先
所有介面與互動行為必須遵循統一設計系統。UI 元件與樣式不可任意定義，需透過中央設計系統或共用元件庫取得。

### 語義導向
顏色、圖示、狀態、標籤皆必須以語義 token 命名與存取。禁止於程式碼中硬寫樣式、顏色值或數值常量。

### 可調適性
UI 元件必須支援主題切換（深色 / 淺色）與自訂化 token。任何視覺調整應能透過 Theme Token 實現，不得以內嵌樣式覆蓋。

### 無障礙與可視性
文字、色彩對比度與互動範圍應符合 WCAG AA 標準，確保可讀性與可操作性。  
所有按鈕、表單、圖表皆需有輔助說明（ARIA 標籤或說明文字）。

### 設計文件分層
- **原則層（本文件）**：僅定義設計哲學與治理原則。  
- **規範層（`specs/common/ui-guideline-spec.md`）**：定義設計準則、組件尺寸與交互行為。  
- **實作層（`/frontend/theme/`）**：定義具體 token 值、CSS class 與樣式表。

---

## 前端工程規範

### 內容與 i18n
- 禁止硬寫文案；所有文字進入 `content/{locale}.json` 或 `useContent()`。
- 錯誤訊息、按鈕文字、時間範圍、狀態標籤全部以 **鍵** 存取。

### 顏色與樣式
- 禁止直接硬寫 `text-slate-* / bg-*-*/xx` 作為語義色；以 **Theme Token** 與 **設計系統色票** 存取。
- KPI 與圖表色由 token 供應；頁面不得自定義隨機色。

### 常數與枚舉
- 狀態鍵、圖示鍵、路由、錯誤碼、時間格式統一於 `constants/`。
- 僅在 constants 定義合法值；頁面以 map 取 label 與樣式。

### 程式品質
- 導入 ESLint + Prettier 規則；CI 中必須通過 Lint 與型別檢查。
- 新增程式碼不得新增 `any`；必要時以 `unknown` + 縮小。

---

## Mock 與 API 合約

### Mock 原則
- Mock 伺服器與正式 API **共享合約**；路由、回傳欄位、錯誤模型一致。
- 任何頁面所需的新欄位（如 `metrics.cpu`、`event_count`）須先在 Mock 補齊。

### 合約測試
- 在 CI 以合約測試驗證 `services/api.ts` 對每個端點的序列化與錯誤處理。
- SDK/Hook 以最小可行回傳型別保證（避免頁面型別重複）。

---

## 開發工作流程

### 結構化階段（P0–P3）
- **P0**：關鍵修復、可靠性/觀測性缺口
- **P1**：安全與驗證、常數化與 i18n 抽離
- **P2**：功能完整與 API 標準化、表格/色票一致化
- **P3**：效能與 UX 細化、可維護性優化

### 品質關卡
- PR 模板需勾選：觀測性、治理、UI 一致性、i18n、token 使用、無硬編碼。
- 關鍵路徑測試覆蓋率 **100%**；含整合測試（列表 → 詳情 → 回到列表）。
- 任何 API/行為變更需同步更新文件與 Mock。

### 測試紀律
- 合約測試先於實作；UI 端到端測試覆蓋主要工作流程。
- 安全測試含權限繞過與多租戶隔離驗證。
- 效能測試依 SLI/SLO 監控，表格渲染與查詢作為關鍵量測。

---

## 版本治理與依賴
- CDN 版本需對齊本地型別（React、Tailwind、ECharts）。
- 升版與鎖版策略文件化；重大升版需風險評估與回滾方案。

---

## AI 生成與規格合規

所有 AI 生成的文件（spec、plan、task、review）皆需以本憲法為唯一約束來源。  

規格文件 (`.specify/specs/`) 必須：
1. 引用 `.specify/memory/constitution.md` 為上位規範。  
2. 通過以下五項自動檢查：  
   - **觀測性**：是否描述記錄、指標、告警。  
   - **安全性**：是否描述 RBAC、審計、隔離要求。  
   - **一致性**：是否使用統一命名、Theme Token、表格格式。  
   - **i18n 與常數化**：是否無硬字串與硬枚舉。  
   - **資料閉環**：是否包含輸入、處理、輸出、回饋、審計完整流程。  

AI 若偵測違反上述任一項，應標記 `[VIOLATION: <條款名稱>]` 並於 `_review.md` 彙整。

---

## 文件層級對應

| 類別 | 文件位置 | 職責 | 版本對應 |
|------|------------|--------|-----------|
| 憲法 (Constitution) | `.specify/memory/constitution.md` | 統一原則與審查標準 | v1.x |
| 模板 (Template) | `.specify/templates/spec-template.md` | 定義規格結構與格式 | 與憲法同版 |
| 模組規格 (Specs) | `.specify/specs/modules/` | 描述 WHAT / WHY | 對應 Template 與 Constitution 版本一致 |
| 審查報告 (Review) | `.specify/specs/_review.md` | 驗證規格合規與完整性 | 自動標註憲法版本 |

---

## 治理
憲法優先於所有其他指引。所有 PR 必須證明符合本憲法。修正案流程：
1. 說明變更動機與目標
2. 影響分析（功能、相依、風險）
3. 遷移計畫（程式碼、Mock、文件）
4. 技術審議通過
5. 文件更新與團隊告知

所有 AI 生成文件（spec / plan / review）須自動嵌入本憲法版本號以利稽核。

定期合規審查確保持續遵守；違規將阻擋部署直至修正。原則上偏好簡單可驗證解法，複雜度需被正當化。

**版本**：1.2.0 | **通過日期**：2025-10-06 | **最後修訂**：2025-10-06