# 功能規格書(Feature Specification)

**模組名稱 (Module)**: 事件列表管理
**類型 (Type)**: Module
**來源路徑 (Source Path)**: pages/incidents/IncidentListPage.tsx
**建立日期 (Created)**: 2025-10-06
**狀態 (Status)**: Draft
**依據憲法條款 (Based on)**: `.specify/memory/constitution.md`

---

## 一、主要使用者情境(User Scenarios & Testing)

### 主要使用者故事(Primary User Story)
SRE 工程師需要查看、篩選、管理系統事件，以快速定位問題並進行處置。支援批次操作、AI 分析、認領指派等功能。

### 驗收情境(Acceptance Scenarios)
1. **Given** 使用者進入事件列表頁面，**When** 系統載入事件資料，**Then** 應顯示包含狀態、嚴重性、影響範圍、負責人等資訊的表格
2. **Given** 使用者選擇一個或多個事件，**When** 點擊「認領」按鈕，**Then** 系統應將事件指派給當前使用者並更新狀態
3. **Given** 使用者選擇多個事件，**When** 點擊「AI 分析」，**Then** 系統應生成包含根因分析和建議的報告

### 邊界案例(Edge Cases)
- 當事件數量超過 1000 筆時，系統應使用分頁或虛擬滾動以保持效能
- 當事件已被其他使用者認領時,應顯示衝突提示並拒絕重複認領
- 當 API 回傳錯誤時,應顯示友善錯誤訊息並提供重試選項

---

## 二、功能需求(Functional Requirements)

- **FR-001**: 系統必須(MUST)支援依狀態、嚴重性、時間範圍、負責人等條件篩選事件。
- **FR-002**: 系統必須(MUST)支援批次認領、解決、靜音操作,且需記錄操作者與時間戳記。
- **FR-003**: 系統必須(MUST)提供事件詳情抽屜,顯示完整資訊、時間線、關聯資源。
- **FR-004**: 系統應該(SHOULD)支援欄位自訂顯示與排序,並儲存使用者偏好。
- **FR-005**: 系統應該(SHOULD)整合 AI 分析功能,提供多事件關聯分析與根因推斷。
- **FR-006**: 系統必須(MUST)支援 CSV 匯入匯出,含欄位驗證與錯誤回報。
- **FR-007**: 系統可以(MAY)提供事件趨勢圖表,協助識別異常模式。

---

## 三、關鍵資料實體(Key Entities)
| 實體名稱 | 描述 | 關聯 |
|-----------|------|------|
| Incident | 事件實體,包含狀態、嚴重性、影響、負責人等屬性 | 關聯 AlertRule, Resource, User |
| AlertRule | 觸發事件的告警規則 | 被 Incident 參照 |
| User | 事件負責人或操作者 | 與 Incident 多對多關聯 |
| SilenceRule | 靜音規則,可抑制特定事件 | 透過 matcher 關聯 Incident |

---

## 四、觀測性與治理檢查(Observability & Governance Checklist)

| 項目 | 狀態 | 說明 |
|------|------|------|
| 記錄與追蹤 (Logging/Tracing) | ✅ | 記錄所有事件狀態變更、批次操作、AI 分析請求 |
| 指標與告警 (Metrics & Alerts) | ✅ | 追蹤事件數量、處理時長、認領率等指標 |
| RBAC 權限與審計 | ✅ | 依角色控制查看、編輯、刪除權限,審計所有操作 |
| i18n 文案 | ✅ | 所有文案透過 useContent 存取,無硬編碼 |
| Theme Token 使用 | ✅ | 狀態標籤、圖示使用 Theme Token 與語義色 |

---

## 五、審查與驗收清單(Review & Acceptance Checklist)

- [ ] 無技術實作語句。
- [ ] 所有必填段落皆存在。
- [ ] 所有 FR 可測試且明確。
- [ ] 無未標註的模糊需求。
- [ ] 符合 `.specify/memory/constitution.md`。

---

## 六、事件狀態變更 UI 提示

### 6.1 前端 UI/UX 設計 (已確認)

#### 即時通知 (WebSocket 推送)

**Toast 通知**:
- 類型: Info (藍色)
- 標題: "事件 {incident_id} 已自動關閉"
- 描述: "原因: {close_reason}" (如「告警已恢復超過 5 分鐘」)
- 操作按鈕: 「查看詳情」(導航至事件詳情頁)
- 顯示時長: 5 秒

**觸發時機**:
- WebSocket 收到事件狀態變更訊息
- 適用狀態: 自動關閉、自動解決、手動變更

#### 列表頁面標記

**自動關閉標記**:
```
INC-001  ⏱️ 自動關閉 2 分鐘前
嚴重度: Low | 負責人: Alice
📝 關閉原因: 告警已恢復
```

**手動關閉標記**:
```
INC-002  👤 手動關閉 10 分鐘前
嚴重度: High | 負責人: Bob
📝 關閉原因: 已部署修復
```

**視覺區分**:
- 自動操作: 使用時鐘圖示 (⏱️) + 灰色標籤
- 手動操作: 使用使用者圖示 (👤) + 藍色標籤

#### 詳情頁時間軸

**時間軸格式**:
```
⏱️ 2025-10-06 14:30  系統自動關閉
   └─ 原因: 告警持續恢復超過 5 分鐘
   └─ 關聯告警: ALR-123 (已解決)

👤 2025-10-06 14:00  Alice 確認處理
   └─ 備註: 已重啟服務

🔔 2025-10-06 13:55  告警觸發
   └─ CPU 使用率 > 90%
```

**前端輪詢策略**:
- 列表頁: 使用 WebSocket 優先，斷線時降級為輪詢 (間隔由 API 提供，預設 30 秒)
- 詳情頁: WebSocket 即時更新
- 使用者離開頁面: 停止輪詢與 WebSocket 連線

**前端決策**: Toast 樣式、時間軸佈局、圖示選擇
**後端參數**: 自動關閉策略、輪詢間隔 (pollingInterval)、WebSocket 推送規則

### 6.2 前後端分工

| 職責 | 前端 | 後端 |
|------|------|------|
| **通知 UI** | ✅ Toast 顯示、時間軸渲染 | - |
| **自動關閉策略** | 📥 顯示關閉原因 (由 API 提供) | ✅ 定義自動關閉條件與時長 |
| **即時推送** | ✅ WebSocket 連線管理與訊息處理 | ✅ WebSocket 推送機制 |
| **輪詢間隔** | 📥 使用 API 提供的間隔值 | ✅ 提供 pollingInterval 參數 |

---

## 七、模糊與待確認事項(Clarifications)

- ✅ ~~[NEEDS CLARIFICATION: 事件自動關閉策略 - 解決後多久自動歸檔？]~~ → **已解決: 前端 UI 提示已確認，自動關閉策略由 API 決定**
- [NEEDS CLARIFICATION: AI 分析的回應時間 SLA 與逾時處理機制] → 由後端提供 SLA 參數，前端顯示逾時提示
- [NEEDS CLARIFICATION: 批次操作的數量上限與並行處理策略] → 由後端 API 提供 maxBatchSize 與 maxConcurrent 參數

---

## 八、決策記錄

### DR-001: 事件狀態變更 UI 提示

**決策日期**: 2025-10-06
**決策依據**: `_resolution-plan.md` 3.1 節

**決策內容**:
- 使用 WebSocket 推送即時通知 (Toast)
- 列表顯示自動/手動操作視覺區分
- 詳情頁使用時間軸呈現完整歷史

**前後端分工**:
- 前端: Toast UI、時間軸、WebSocket 連線、降級輪詢
- 後端: 自動關閉策略、WebSocket 推送、輪詢間隔配置
