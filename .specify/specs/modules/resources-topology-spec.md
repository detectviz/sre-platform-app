# 功能規格書(Feature Specification)

**模組名稱 (Module)**: 資源拓撲圖
**類型 (Type)**: Module
**來源路徑 (Source Path)**: pages/resources/ResourceTopologyPage.tsx
**建立日期 (Created)**: 2025-10-06
**狀態 (Status)**: Draft
**依據憲法條款 (Based on)**: `.specify/memory/constitution.md`

---

## 一、主要使用者情境(User Scenarios & Testing)

### 主要使用者故事(Primary User Story)
SRE 工程師需要視覺化檢視資源拓撲關係,快速理解系統架構與依賴連結。

### 驗收情境(Acceptance Scenarios)
1. **Given** 使用者進入拓撲頁面,**When** 系統載入資源關係,**Then** 應以圖形方式顯示資源節點與連線
2. **Given** 使用者點擊資源節點,**When** 選中節點,**Then** 應高亮該節點及其相關連線,並顯示詳情面板
3. **Given** 使用者篩選資源類型,**When** 勾選類型,**Then** 圖形應僅顯示選定類型的資源

### 邊界案例(Edge Cases)
- 當資源數量超過 50 個時,應提供縮放與平移功能
- 當資源無任何連線時,應顯示為孤立節點
- 當拓撲圖過於複雜時,應提供分層或聚合視圖

---

## 二、功能需求(Functional Requirements)

- **FR-001**: 系統必須(MUST)以圖形化方式展示資源節點與依賴連線。
- **FR-002**: 系統必須(MUST)支援節點顏色依狀態區分(正常/警告/危險)。
- **FR-003**: 系統應該(SHOULD)支援拖曳調整節點位置,並儲存布局設定。
- **FR-004**: 系統應該(SHOULD)提供篩選器,依類型、狀態、團隊篩選顯示。
- **FR-005**: 系統可以(MAY)支援拓撲圖匯出為圖片或 JSON 格式。

---

## 三、關鍵資料實體(Key Entities)
| 實體名稱 | 描述 | 關聯 |
|-----------|------|------|
| TopologyNode | 拓撲節點,代表資源 | 對應 Resource |
| TopologyEdge | 拓撲連線,代表依賴關係 | 連接兩個 TopologyNode |
| LayoutConfig | 布局設定,儲存節點位置 | 使用者偏好設定 |

---

## 四、觀測性與治理檢查(Observability & Governance Checklist)

| 項目 | 狀態 | 說明 |
|------|------|------|
| 記錄與追蹤 (Logging/Tracing) | ✅ | 記錄資源 CRUD 操作、狀態變更事件 |
| 指標與告警 (Metrics & Alerts) | ✅ | 追蹤資源數量、狀態分布、效能指標 |
| RBAC 權限與審計 | ✅ | 依團隊與角色控制資源存取權限 |
| i18n 文案 | ✅ | 所有文案透過 Content Context 存取 |
| Theme Token 使用 | ✅ | 狀態標籤、圖表使用 Theme Token |

---

## 五、審查與驗收清單(Review & Acceptance Checklist)

- [ ] 無技術實作語句。
- [ ] 所有必填段落皆存在。
- [ ] 所有 FR 可測試且明確。
- [ ] 無未標註的模糊需求。
- [ ] 符合 `.specify/memory/constitution.md`。

---

## 六、拓撲圖更新提示 UI

### 6.1 前端 UI/UX 設計 (已確認)

#### 即時更新狀態指示器

**右上角狀態列**:
```
🟢 即時更新 | 最後更新: 2 秒前
ℹ️ 資料來源: APM 追蹤 (5分鐘) + 人工標註 (即時)
```

**狀態指示器元件**:
- 位置: 拓撲圖右上角
- 圖示: 綠色圓點 (動態脈衝動畫) 表示即時連線
- 文字: 顯示連線狀態 + 最後更新時間
- Tooltip: 滑鼠懸停顯示「透過 WebSocket 即時同步依賴關係變更」

#### 依賴關係置信度顯示

**拓撲圖連線樣式**:
```
API Gateway
  ↓ ━━━ 高置信度 (APM 追蹤)
  ├─→ Auth Service
  ├─→ User Service
  │
  ↓ ╍╍╍ 中置信度 (配置檔)
  └─→ Database
      │
      ↓ ┄┄┄ 低置信度 (人工標註)
      └─→ Redis
```

**圖例設計**:
- 高置信度: 實線 (━━━)，深色
- 中置信度: 虛線 (╍╍╍)，中等色
- 低置信度: 點線 (┄┄┄)，淡色
- 顯示圖例說明於左下角

#### 手動刷新選項

**工具列控制**:
- 刷新按鈕: 「🔄 手動刷新」，點擊重新載入拓撲資料
- 載入狀態: 按鈕顯示 loading 動畫
- 更新模式選擇器:
  - 選項 1: 「自動更新 (推薦)」- WebSocket 即時更新
  - 選項 2: 「手動更新」- 關閉自動更新，僅手動刷新

#### 資料過時警告

**警告 Banner**:
```
⚠️ 資料可能過時
   最後同步時間: 15 分鐘前
   [立即刷新] [忽略]
```

**觸發條件**:
- WebSocket 斷線超過 5 分鐘
- 最後更新時間超過 10 分鐘 (閾值由 API 提供)

**前端輪詢策略**:
- WebSocket 連線成功: 停止輪詢
- WebSocket 斷線: 降級為輪詢 (間隔由 API 提供，預設 60 秒)
- 使用者離開頁面: 停止所有更新

**前端決策**: 狀態指示器 UI、置信度顏色、圖例設計、警告樣式
**後端參數**: 資料來源、更新頻率 (updateInterval)、置信度演算法

### 6.2 前後端分工

| 職責 | 前端 | 後端 |
|------|------|------|
| **狀態指示器** | ✅ UI 顯示、脈衝動畫、時間格式化 | - |
| **置信度視覺化** | ✅ 連線樣式 (實線/虛線)、圖例設計 | 📥 提供置信度值 (high/medium/low) |
| **資料來源** | 📥 顯示來源標籤 | ✅ 提供資料來源資訊 |
| **更新頻率** | 📥 使用 API 提供的輪詢間隔 | ✅ 提供 updateInterval、staleThreshold 參數 |
| **WebSocket** | ✅ 連線管理、降級處理 | ✅ WebSocket 推送機制 |

---

## 七、模糊與待確認事項(Clarifications)

- ✅ ~~[NEEDS CLARIFICATION: 依賴關係的資料來源與更新機制]~~ → **已解決: 前端 UI 提示已確認，資料來源與更新頻率由 API 提供**
- [NEEDS CLARIFICATION: 拓撲圖的自動布局演算法選擇] → 前端使用 D3.js force-directed 佈局，可配置參數由 API 提供

---

## 八、決策記錄

### DR-001: 拓撲圖更新提示 UI

**決策日期**: 2025-10-06
**決策依據**: `_resolution-plan.md` 3.3 節

**決策內容**:
- 顯示即時更新狀態指示器 (綠點 + 時間)
- 使用連線樣式區分置信度 (實線/虛線/點線)
- 提供手動刷新與更新模式選擇
- 資料過時時顯示警告 Banner

**前後端分工**:
- 前端: 狀態 UI、置信度視覺化、WebSocket 連線、降級輪詢
- 後端: 資料來源、置信度計算、更新頻率配置、WebSocket 推送
