# Feature Specification: Dashboards Management

**Feature Branch**: `[dashboards-management]`  
**Created**: 2025-10-10  
**Status**: Draft  
**Input**: "提供統一的儀表板管理介面，支援內建與外部 Grafana 儀表板兩種模式。使用者可從經 `.specify/specs/modules/platform-grafana-spec.md` 驗證的 Grafana 連線中，透過下拉選單選擇外部儀表板進行連結。"

---

## 一、主要使用者情境（User Scenarios & Testing）

### Primary User Story
作為 SRE 或平台管理員，我需要在平台內快速切換與管理多個儀表板，包括平台內建儀表板（官方維護版本）與連結的 Grafana 儀表板（自訂或外部擴充），以便觀察系統狀態並根據需要擴展分析能力。

#### 具體情境:
- **日常監控**: 登入平台後，我需要立即看到預設的系統概覽儀表板，快速評估所有關鍵服務的健康狀態。
- **深度分析**: 當發現異常指標時，我需要切換至專門的效能分析或錯誤追蹤儀表板，進行根因分析。
- **自訂擴展**: 當平台內建儀表板無法滿足特定需求時，我需要連結團隊在 Grafana 中已建立的自訂儀表板，並將其整合至平台選單中，方便全團隊存取。
- **簡報展示**: 在向管理層或客戶展示系統狀態時，我需要使用全螢幕模式移除所有導覽元素，專注呈現關鍵數據與視覺化圖表。
- **變數調整**: 在分析特定時間範圍或服務實例的問題時，我需要快速調整儀表板變數（如時間範圍、環境、服務名稱），並確保設定在切換顯示模式後仍然保持。

#### 現有痛點:
- 若無統一管理介面，團隊成員需記憶多個不同的 Grafana URL，增加操作複雜度。
- 內建與外部儀表板混雜時，容易誤編輯或覆蓋官方維護的版本，導致平台升級時設定丟失。
- 缺乏預設首頁設定時，每次登入都需手動導航至常用儀表板，浪費時間。

### Acceptance Scenarios

#### 場景群組 A：儀表板清單管理
1. **Given** 我在儀表板管理頁面中，  
   **When** 我查看儀表板清單，  
   **Then** 系統應顯示所有「內建」與「外部」儀表板，並以標籤區分來源。

2. **Given** 我想比較內建與外部儀表板的差異，  
   **When** 我打開儀表板資訊側欄，  
   **Then** 系統應顯示版本、來源、上次同步時間與授權資訊。

3. **Given** 我瀏覽儀表板清單，  
   **When** 點擊書籤圖示，  
   **Then** 該儀表板應被標記為我的個人書籤，並顯示於清單頂部。

#### 場景群組 B：外部 Grafana 儀表板連結
4. **Given** 我需要新增外部 Grafana 儀表板，  
   **When** 我輸入 Grafana UID 或完整 URL 並確認，  
   **Then** 系統應驗證儀表板是否存在並成功建立連結，  
   **And Then** 該儀表板可立即載入顯示。

5. **Given** 我希望使用平台提供的「主機監控」儀表板作為首頁，  
   **When** 我在設定中選擇該內建儀表板，  
   **Then** 系統應允許將其設為首頁或顯示於選單中，內建儀表板不可編輯或複製。  

#### 場景群組 C：顯示模式與偏好設定
6. **Given** 我想在首頁自動顯示常用儀表板，  
   **When** 我設定「預設儀表板」並儲存，  
   **Then** 登入後首頁應自動導向該儀表板。

7. **Given** 我需要依不同場景切換儀表板呈現方式，  
   **When** 我切換「顯示模式」為「標準」、「全螢幕」或「聚焦面板」，  
   **Then** 系統應即時重新渲染視圖並記住我的選擇，  
   **And Then** 再次開啟時應還原上次的顯示模式。

8. **Given** 我切換排序為「最近使用」，  
   **When** 我重新開啟儀表板管理頁，  
   **Then** 系統應自動保留我的排序偏好設定。

#### 場景群組 D：整合情境與跨裝置同步
9. **Given** 我在不同裝置登入同帳號，  
   **When** 開啟儀表板清單，  
   **Then** 書籤狀態應同步出現在同一帳號的所有登入環境中。

---

## 二、功能需求（Functional Requirements）

### 2.1. 儀表板類型與清單管理 (Dashboard Types & List Management)
| 編號 | 說明 |
|------|------|
| **FR-D-001** | 系統必須（MUST）支援兩種類型的儀表板：「內建（Platform Built-in）」與「外部（Linked Grafana）」。 |
| **FR-D-002** | 內建儀表板必須（MUST）標示版本與維護者，僅可檢視，不可編輯或複製，使用者僅可將其設為首頁或定義於側邊選單。 |
| **FR-D-003** | 系統必須（MUST）以標籤或徽章清晰區分儀表板來源（內建 vs. 外部），並在儀表板清單中顯示。 |
| **FR-D-004** | 儀表板清單必須（MUST）支援搜尋、排序（名稱、建立時間、最近使用、書籤優先）與分頁功能。 |
| **FR-D-005** | 使用者可（MAY）依來源或標籤過濾儀表板清單，快速找到特定類型的儀表板。 |
| **FR-D-006** | 系統應（SHOULD）提供「預覽」功能，以快速檢視儀表板內容而不完全載入。 |

### 2.2. 外部 Grafana 儀表板連結 (External Grafana Integration)
| 編號 | 說明 |
|------|------|
| **FR-G-001** | 系統必須（MUST）允許透過 Grafana UID 或完整 URL 快速新增外部 Grafana 儀表板連結。 |
| **FR-G-002** | 新增外部儀表板時，系統必須（MUST）驗證儀表板是否存在且可存取，並返回驗證結果（成功/失敗）。 |
| **FR-G-003** | 外部 Grafana 儀表板經驗證後，使用者可（MAY）選擇將其定義於側邊選單或設為個人預設首頁，但內容不可由平台端修改或覆蓋。 |
| **FR-G-004** | 若使用者於 Grafana 端具備編輯權限，系統應（SHOULD）於儀表板資訊面板顯示「外部導覽連結」，可直接開啟對應 Grafana 儀表板的編輯介面。 |
| **FR-G-005** | 當 Grafana 端儀表板版本更新時，系統必須（MUST）提示使用者是否同步，並記錄同步歷史。 |
| **FR-G-006** | 系統必須（MUST）區分「平台維護版」與「使用者自訂版」，防止誤覆蓋或衝突。 |

### 2.3. 顯示模式與視圖控制 (Display Modes & View Control)
| 編號 | 說明 |
|------|------|
| **FR-V-001** | 系統必須（MUST）提供三種顯示模式：**標準模式**（含導覽與工具列）、**全螢幕模式**（隱藏導覽與工具列）、**聚焦面板模式**（單一視覺元件放大檢視）。 |
| **FR-V-002** | 顯示模式的實際命名（例如 `standard` / `fullscreen` / `panel-focus`）必須（MUST）與現行 MVP 規格定義保持一致，以確保前後端一致性。 |
| **FR-V-003** | 在全螢幕模式下，系統應（SHOULD）提供顯示控制觸發器，可暫時顯示或隱藏工具列，避免遮蔽內容。 |
| **FR-V-004** | 系統必須（MUST）提供「變數列（Variables Bar）」的顯示／收合控制，並在模式切換後保持狀態一致。 |
| **FR-V-005** | 系統必須（MUST）提供自動刷新（Auto-Refresh）間隔設定，並顯示目前更新狀態與上次更新時間。 |
| **FR-V-006** | 使用者切換顯示模式後，系統必須（MUST）立即更新偏好並在後續會話中還原該模式。 |

### 2.4. 個人偏好設定與書籤 (User Preferences & Bookmarks)
| 編號 | 說明 |
|------|------|
| **FR-P-001** | 使用者必須（MUST）可設定個人預設儀表板，登入後首頁自動導向該儀表板。 |
| **FR-P-002** | 使用者可（MAY）將任何儀表板標記為「書籤 (Bookmark)」，以便於清單頂部快速存取。 |
| **FR-P-003** | 書籤狀態必須（MUST）屬於個人偏好設定，需與使用者 Profile 綁定並在登入後還原。 |
| **FR-P-004** | 使用者切換排序方式後，系統必須（MUST）記錄該偏好，於下次開啟頁面時自動套用。 |
| **FR-P-005** | 書籤狀態與排序設定不得（MUST NOT）影響全域顯示（即僅為個人層級設定）。 |
| **FR-P-006** | 書籤狀態必須（MUST）在同一帳號的所有登入環境（跨裝置）中同步顯示。 |

### 2.5. 審計與版本控制 (Audit & Version Control)
| 編號 | 說明 |
|------|------|
| **FR-A-001** | 系統必須（MUST）記錄每次新增、刪除、同步儀表板的操作，包含操作者、時間戳記、變更內容。 |
| **FR-A-002** | 系統應（SHOULD）提供審計日誌查詢介面，讓管理員追蹤儀表板變更歷史。 |
| **FR-A-003** | 內建儀表板版本更新時，系統應（SHOULD）自動記錄版本變更並通知相關使用者。 |

### 2.6. 未來擴展 (Future Enhancements)
| 編號 | 說明 |
|------|------|
| **FR-F-001** | [FUTURE] 支援場景：整合 Grafana Scenes Dashboard 為內建儀表板。 |
| **FR-F-002** | [FUTURE] 支援儀表板共用設定匯出／匯入（JSON / YAML）。 |

---

## 三、關鍵資料實體（Key Entities）

| 實體名稱 | 描述 | 關聯 |
|-----------|------|------|
| **Dashboard** | 儀表板主體物件，包含名稱、UID、來源、版本、可見性設定。 | - |
| **DashboardSource** | 定義儀表板類型（Platform / Grafana）。 | 屬於 Dashboard |
| **DashboardPreference** | 儲存使用者偏好（預設儀表板、顯示模式）。 | 關聯至 User Profile |
| **DashboardPreference** | `bookmarked` | Boolean，是否已加書籤 |
| **DashboardPreference** | `sort_order` | String，記錄個人偏好排序方式（如 `"alphabetical"`、`"recent"`、`"bookmark_first"`） |

---

## 四、權限控制（RBAC）

| 權限字串 | 描述 |
|-----------|------|
| `dashboards:read` | 檢視儀表板清單與內容。 |
| `dashboards:edit` | 修改或複製內建儀表板。 |
| `dashboards:link` | 新增外部 Grafana 儀表板連結。 |
| `dashboards:delete` | 刪除使用者自訂或外部儀表板。 |
| `dashboards:sync` | 同步外部 Grafana 儀表板內容。 |

---

## 五、觀測性與治理檢查（Observability & Governance）

| 項目 | 狀態 | 說明 |
|------|------|------|
| Logging / Audit | ✅ | 所有新增、同步、刪除操作須記錄審計。 |
| Metrics | ✅ | 記錄儀表板使用頻率與平均載入時間。 |
| RBAC | ✅ | 嚴格依使用者角色顯示與控制操作權限。 |
| Theme / i18n | ✅ | 使用多語系與語義化樣式。 |
| [FUTURE] Integration | ⚙️ | 未來版本支援 Grafana Scenes 整合。 |

---

## 六、審查與驗收清單（Review Checklist）

- [x] 模板結構符合 `.specify/templates/spec-template.md`。  
- [x] 無實作語句（技術中立）。  
- [x] 所有功能皆可測試。  
- [x] 與憲法條款 (v1.3.0) 一致。  
- [x] 已取代舊版 `dashboards-list` 與 `dashboards-template` 模組。  

---

## 七、模糊與待確認事項（Clarifications）

| 項目 | 狀態 | 備註 |
|------|------|------|
| Grafana UID 驗證機制 | [NEEDS CLARIFICATION] | 需確認是透過 API 驗證或延後至首次載入檢查。 |
| 自訂儀表板權限 | [FUTURE] | 是否支援共用／權限繼承需待確認。 |
| Platform Built-in 更新策略 | [NEEDS CLARIFICATION] | 當平台版本更新時，是否自動同步內建儀表板結構。 |
| 顯示模式命名一致性 | [CLARIFY] | 顯示模式名稱應與現行 MVP 規格中定義的常數一致（例如 `VIEW`, `FULLSCREEN`, `FOCUS` 等），具體命名由產品規格層確認。 |
| 內建儀表板權限限制 | [CLARIFY] | 內建儀表板僅可設為首頁或於側邊選單顯示，無法編輯、刪除或建立副本。 |
| 外部儀表板選單顯示 | [CLARIFY] | 外部 Grafana 儀表板可定義於側邊選單中顯示，但僅以連結方式嵌入，不提供修改或同步。 |
| 外部導覽連結顯示條件 | [CLARIFY] | 僅當使用者於 Grafana 端具備編輯權限時，平台才顯示外部導覽連結，以便快速導向原始 Grafana 編輯頁面。 |
| 外部儀表板同步機制 | [NEEDS CLARIFICATION] | 需確認外部 Grafana 儀表板版本同步是否為自動觸發或需使用者手動執行，以避免未經授權的內容更新。 |
| 書籤同步策略 | [CLARIFY] | 書籤資料應儲存於使用者 Profile 層級，非瀏覽器快取，以確保跨裝置一致性。 |
| 排序與篩選關係 | [CLARIFY] | 排序應在篩選條件生效後再應用，避免干擾搜尋結果。 |