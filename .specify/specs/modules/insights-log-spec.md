# 功能規格書（Feature Specification）

**模組名稱 (Module)**: insights-log
**類型 (Type)**: Module
**建立日期 (Created)**: 2025-10-06
**狀態 (Status)**: Draft
**依據憲法條款 (Based on)**: `.specify/memory/constitution.md` (v1.3.0)

---

## 一、主要使用者情境（User Scenarios & Testing）

### 主要使用者故事（Primary User Story）
作為一名 SRE 或開發人員，我需要一個強大的日誌探索與分析工具，讓我能夠：
1. **快速定位問題** - 根據關鍵字、時間範圍、服務名稱等條件快速篩選相關日誌
2. **視覺化日誌趨勢** - 透過時間序列直方圖快速識別異常時段和日誌量突增點
3. **深度分析根因** - 利用 AI 功能對大量日誌進行摘要和模式分析，加速問題定位
4. **即時監控系統狀態** - 在發佈或事件期間持續觀察最新日誌輸出
5. **追蹤分散式請求** - 透過 trace_id 關聯不同服務間的日誌，還原完整請求鏈

以便快速排查生產環境問題、縮短故障恢復時間（MTTR）、提升系統可觀測性。

#### 具體情境:
- **緊急故障排查**: 凌晨收到告警，某服務錯誤率突增。需要快速篩選出相關錯誤日誌，透過直方圖定位問題開始時間，並使用 AI 總結功能找出共同模式（如特定 API 端點失敗、資料庫連線超時等）。
- **發佈監控**: 正在進行新版本的滾動發佈，需要開啟「即時日誌」模式持續監控新版本實例的日誌輸出，一旦發現異常（如新的錯誤訊息、效能下降）可立即回滾。
- **跨服務問題追蹤**: 使用者回報訂單失敗，需要透過訂單 ID 找到前端服務的初始請求，再透過 trace_id 追蹤後續經過的所有服務（API Gateway → Order Service → Payment Service → Inventory Service），定位具體失敗點。
- **容量規劃與趨勢分析**: 需要分析過去一週特定服務的日誌量趨勢，識別高峰時段，結合錯誤率變化進行容量規劃。
- **合規審計**: 需要匯出特定時間範圍內包含敏感操作（如資料刪除、權限變更）的日誌，提供給合規團隊進行審計。

#### 現有痛點:
- **資訊過載**: 生產環境每秒產生數千條日誌，人工閱讀效率極低，難以快速定位關鍵資訊
- **搜尋效率低**: 缺乏強大的篩選和搜尋功能，需要在大量無關日誌中尋找特定條目
- **缺乏視覺化**: 無法快速識別日誌量異常時段，需要逐頁翻閱才能發現問題
- **分散式追蹤困難**: 在微服務架構下，同一請求的日誌分散在多個服務中，難以關聯和追蹤
- **即時性不足**: 靜態日誌查詢無法滿足發佈監控等即時場景需求
- **模式識別困難**: 面對大量相似錯誤日誌，難以人工總結出根本原因和共同模式

### 驗收情境（Acceptance Scenarios）

#### 場景群組 A：日誌搜尋與篩選（Log Search & Filtering）
1. **Given** 我正在排查一個使用者回報的訂單失敗問題
   **When** 我在搜尋框中輸入訂單 ID，並點擊快速時間範圍按鈕「過去 1 小時」
   **Then** 頁面應顯示所有包含該訂單 ID 的日誌
   **And Then** 頂部的時間序列直方圖應同步更新，顯示該訂單 ID 在選定時間範圍內的日誌分佈

2. **Given** 我需要根據多個條件進行複合篩選
   **When** 我在篩選器中設定多個條件（例如服務名稱為 `checkout` 且日誌級別為 `ERROR`）
   **Then** 系統應回傳同時符合所有條件的日誌結果
   **And Then** 在搜尋框中顯示完整條件字串（如 `service:checkout AND level:ERROR`）以利後續調整

3. **Given** 我需要查看特定時間段的日誌
   **When** 我在時間選擇器中自訂時間範圍（如 2025-10-08 14:00 到 15:00）
   **Then** 系統應載入該時間範圍內的所有日誌
   **And Then** 如果日誌數量超過限制（如 200 筆），應顯示提示訊息建議縮小搜尋範圍

#### 場景群組 B：即時日誌追蹤（Live Tailing）
4. **Given** 我正在監控一個新功能的上線過程
   **When** 我開啟「即時日誌」開關
   **Then** 頁面應每隔 5 秒自動載入新的日誌並顯示在列表頂部
   **And Then** 系統應顯示即時模式指示器（如跳動的圓點）

5. **Given** 即時日誌模式已開啟，系統正在持續載入新日誌
   **When** 我在搜尋框中變更篩選條件
   **Then** 即時模式應保持啟動狀態
   **And Then** 後續載入的新日誌應自動套用新的篩選條件

6. **Given** 即時日誌模式已開啟，但後端 API 請求失敗
   **When** 系統嘗試載入新的日誌但遇到網路錯誤
   **Then** 系統應在背景靜默重試，不中斷使用者介面
   **And Then** 如果連續失敗超過 3 次，應顯示錯誤提示並暫停即時模式

#### 場景群組 C：AI 分析與視覺化（AI Analysis & Visualization）
7. **Given** 我面對成千上萬條錯誤日誌，難以快速找到根本原因
   **When** 我點擊「AI 總結」按鈕
   **Then** 系統應彈出一個模態框，顯示載入中狀態
   **And Then** 當 AI 分析完成後，應在模態框中顯示分析結果（如錯誤模式、頻率最高的錯誤類型、建議的排查方向）

8. **Given** 我正在查看日誌列表，頂部顯示時間序列直方圖
   **When** 我在直方圖上點擊某個時間柱狀條
   **Then** 系統應自動調整時間範圍，聚焦到該時間段
   **And Then** 日誌列表應更新顯示該時間段的詳細日誌

#### 場景群組 D：分散式追蹤與深度分析（Distributed Tracing & Deep Analysis）
9. **Given** 我在日誌詳細檢視中看到 `trace_id` 欄位
   **When** 我點擊該欄位的追蹤鏈接
   **Then** 系統應開啟新的檢視區，展示與該 `trace_id` 關聯的所有日誌
   **And Then** 日誌應按時間順序排列，並標示不同服務來源，讓使用者可分析請求在不同服務間的傳遞順序

10. **Given** 我需要查看單筆日誌的完整結構化資訊
    **When** 我點擊展開某條日誌
    **Then** 系統應展開並顯示該日誌的完整 JSON 內容
    **And Then** 即使 JSON 結構非常複雜（如巢狀物件、大型陣列），頁面也應能正常渲染並提供折疊/展開功能

#### 場景群組 E：資料匯出與整合情境（Data Export & Integrated Scenarios）
11. **Given** 我已篩選出需要提交給合規團隊的日誌
    **When** 我點擊「匯出報表」按鈕
    **Then** 系統應下載一個 CSV 檔案，包含當前檢視的所有日誌（或前 N 筆）
    **And Then** CSV 檔案應包含主要欄位（如時間戳、服務名稱、日誌級別、訊息、trace_id 等）

12. **Given** 我透過 URL 分享特定的日誌查詢給團隊成員
    **When** 團隊成員開啟包含查詢參數的 URL（如 `?q=service:checkout&level=ERROR&from=2025-10-08T14:00:00`）
    **Then** 系統應自動載入並顯示對應的日誌查詢結果
    **And Then** 篩選條件應自動填入搜尋框和篩選器中

### 邊界案例（Edge Cases）
- 當「即時日誌」模式開啟時，如果 API 請求失敗，應在背景靜默重試，不中斷使用者介面。
- 當使用者點擊展開一條日誌查看其詳細 JSON 內容時，即使 JSON 結構非常複雜，頁面也應能正常渲染。
- 當沒有任何日誌符合篩選條件時，列表區域是空白的。

---

## 二、功能需求（Functional Requirements）

### 2.1. 日誌搜尋與篩選（Search & Filtering）
| 編號 | 說明 |
|------|------|
| **FR-S-001** | 系統必須（MUST）提供一個搜尋介面，允許使用者輸入關鍵字搜尋日誌內容。 |
| **FR-S-002** | 系統必須（MUST）支援條件組合搜尋（複合查詢），可同時根據多個欄位進行篩選（如服務名稱、日誌級別、trace_id、時間範圍等）。 |
| **FR-S-003** | 系統必須（MUST）提供快速時間範圍選擇器（如過去 15 分鐘、過去 1 小時、過去 24 小時、過去 7 天）。 |
| **FR-S-004** | 系統必須（MUST）提供自訂時間範圍選擇功能，允許使用者指定精確的開始和結束時間。 |
| **FR-S-005** | 系統必須（MUST）在搜尋框中顯示當前生效的完整篩選條件字串（如 `service:checkout AND level:ERROR`）。 |
| **FR-S-006** | 系統應該（SHOULD）在日誌數量超過限制時顯示提示訊息，建議使用者縮小搜尋範圍。 |

### 2.2. 日誌視覺化（Visualization）
| 編號 | 說明 |
|------|------|
| **FR-V-001** | 系統必須（MUST）在頁面頂部提供一個時間序列直方圖，以視覺化方式展示日誌在時間軸上的分佈。 |
| **FR-V-002** | 系統必須（MUST）在直方圖上支援點擊互動，點擊時間柱狀條時自動調整時間範圍並重新載入日誌。 |
| **FR-V-003 (AS-IS)** | 直方圖是透過客戶端對已載入的日誌（最多 200 筆）進行聚合來計算和渲染的。 |
| **FR-V-004** | 系統必須（MUST）在直方圖中顯示日誌量的數值標籤，讓使用者快速識別異常時段。 |

### 2.3. 即時日誌追蹤（Live Tailing）
| 編號 | 說明 |
|------|------|
| **FR-L-001** | 系統必須（MUST）提供一個「即時日誌 (Live Tailing)」模式，持續載入最新的日誌。 |
| **FR-L-002 (AS-IS)** | 「即時日誌」模式採用 5 秒輪詢機制，每次獲取最新的 5 筆資料。 |
| **FR-L-003** | 系統必須（MUST）在即時模式啟動時顯示明確的視覺指示器（如跳動的圓點或「即時」標籤）。 |
| **FR-L-004** | 系統必須（MUST）在即時模式下，當使用者變更篩選條件時，保持即時模式啟動並自動套用新條件於後續載入的日誌。 |
| **FR-L-005** | 系統必須（MUST）在即時模式下遇到 API 請求失敗時，在背景靜默重試，不中斷使用者介面。 |
| **FR-L-006** | 系統應該（SHOULD）在即時模式下連續失敗超過 3 次時，顯示錯誤提示並暫停即時模式。 |

### 2.4. 日誌詳情與分析（Detail & Analysis）
| 編號 | 說明 |
|------|------|
| **FR-D-001** | 系統必須（MUST）允許使用者點擊單筆日誌，展開並查看其完整的、結構化的 JSON 內容。 |
| **FR-D-002** | 系統必須（MUST）在展開的 JSON 內容中提供折疊/展開功能，支援複雜巢狀結構的瀏覽。 |
| **FR-D-003** | 系統必須（MUST）提供一個「AI 總結」功能，對當前查詢結果進行智能分析並以模態框形式呈現結果。 |
| **FR-D-004** | 系統必須（MUST）在 AI 分析結果中包含錯誤模式識別、頻率統計、建議的排查方向等資訊。 |

### 2.5. 分散式追蹤（Distributed Tracing）
| 編號 | 說明 |
|------|------|
| **FR-T-001** | 系統必須（MUST）支援日誌追蹤鏈（Trace Linking），允許使用者點擊 trace_id 欄位查看關聯的所有日誌。 |
| **FR-T-002** | 系統必須（MUST）在追蹤鏈檢視中，按時間順序排列日誌並標示不同服務來源。 |
| **FR-T-003** | 系統應該（SHOULD）在追蹤鏈檢視中提供時間線視覺化，顯示請求在不同服務間的傳遞時間和延遲。 |

### 2.6. 資料匯出與分享（Export & Sharing）
| 編號 | 說明 |
|------|------|
| **FR-E-001** | 系統必須（MUST）提供將當前檢視的日誌匯出為 CSV 檔案的功能。 |
| **FR-E-002** | 系統必須（MUST）在 CSV 匯出中包含主要欄位（時間戳、服務名稱、日誌級別、訊息、trace_id 等）。 |
| **FR-E-003** | 系統必須（MUST）支援透過 URL 查詢參數（如 `?q=`, `?from=`, `?to=`, `?service=`）來預先填寫搜尋條件。 |
| **FR-E-004** | 系統必須（MUST）在使用者透過 URL 開啟頁面時，自動載入並顯示對應的日誌查詢結果。 |

### 2.7. 權限與安全（FUTURE）
| 編號 | 說明 |
|------|------|
| **FR-P-001 (FUTURE)** | 系統必須（MUST）根據使用者的權限，動態顯示或禁用對應的操作介面（如 AI 總結、匯出功能）。 |
| **FR-P-002 (FUTURE)** | 系統必須（MUST）在後端 API 層面根據使用者權限過濾可查詢的日誌範圍（如僅能查看所屬團隊的服務日誌）。 |

---

## 三、關鍵資料實體（Key Entities）
| 實體名稱 | 描述 | 關聯 |
|-----------|------|------|
| **LogEntry** | 核心資料實體，代表一筆獨立的日誌紀錄。 | - |
| **LogExplorerFilters** | 用於篩選日誌的一組條件集合。 | - |
| **LogAnalysis** | 對目前查詢結果進行 AI 分析後的報告。 | LogEntry |

---

## 四、權限控制 (Role-Based Access Control)

**[FUTURE REQUIREMENT]** 以下權限模型描述了產品的最終設計目標，尚未在當前 MVP 中實現。

### 4.1. 權限定義 (Permissions)
| 權限字串 | 描述 |
|---|---|
| `logs:read` | 允許使用者查看日誌探索頁面並執行查詢。 |
| `logs:analyze` | 允許使用者觸發「AI 總結」功能。 |
| `logs:export` | 允許使用者匯出日誌資料。 |

### 4.2. UI 控制與後端資料過濾
- **頁面存取**: `LogExplorerPage` 的根元件需由 `<RequirePermission permission="logs:read">` 包裹。
- **資料過濾 (後端核心職責)**: 後端 API (`/logs`) **必須**根據發起請求的使用者權限，來過濾其可查詢的日誌範圍。
- **工具列按鈕**:
  - 「AI 總結」按鈕需具備 `logs:analyze` 權限。
  - 「匯出報表」按鈕需具備 `logs:export` 權限。

---

## 五、觀測性與治理檢查（Observability & Governance Checklist）

**標記說明**：
- ✅ 已完整實現
- 🟡 部分實現或待完善
- ⚙️ 未來版本實現（FUTURE）

| 項目 | 狀態 | 說明 |
|------|------|------|
| **記錄與追蹤 (Logging/Tracing)** | 🟡 | 需實現完整的結構化日誌記錄與分散式追蹤整合。 |
| **指標與告警 (Metrics & Alerts)** | 🟡 | 需實現業務指標收集（如查詢次數、AI 總結使用率、匯出次數）與告警機制。 |
| **RBAC 權限與審計** | ⚙️ | 需實現基於 `logs:read`, `logs:analyze`, `logs:export` 的權限控制與審計日誌。 |
| **i18n 文案** | 🟡 | 需完全遷移至 i18n 內容管理系統（如 `insights.log.toast.noDataToExport`），消除硬編碼文字。 |
| **Theme Token 使用** | 🟡 | 需使用中央設計系統的 Theme Token（如 `--color-primary`, `--color-error`），替代直接色票引用。 |

---

## 六、審查與驗收清單（Review & Acceptance Checklist）

- [x] 無技術實作語句。
- [x] 所有必填段落皆存在。
- [x] 所有 FR 可測試且明確。
- [x] 無未標註的模糊需求。
- [x] 符合 `.specify/memory/constitution.md`。（已標注待確認項）

---

## 七、模糊與待確認事項（Clarifications）

### 7.1. 已確認的設計決策
- **複合搜尋語法**: 使用結構化查詢語法（如 `service:checkout AND level:ERROR`），而非自然語言，以確保查詢精確性和可預測性。
- **直方圖實現 (AS-IS)**: 在前端對已載入的日誌進行聚合。當日誌量增大時，需改由後端進行時間聚合以提升效能和準確性。
- **即時日誌輪詢 (AS-IS)**: 採用 5 秒輪詢機制，適用於大部分監控場景。可考慮引入 WebSocket 或 Server-Sent Events (SSE) 實現真正的即時推送。

### 7.2. 待後續版本實現的功能 (FUTURE)
- **[FUTURE] i18n 完全遷移**: 需完全遷移至 i18n 內容管理系統（鍵值如 `insights.log.toast.noDataToExport`），消除所有硬編碼文字。
- **[FUTURE] Theme Token 重構**: 需使用中央設計系統的 Theme Token（如 `--color-primary-300`），替代原子化 CSS class 直接引用。
- **[FUTURE] 後端時間聚合**: 直方圖資料應改由後端 API 提供預聚合的時間序列資料，以支援大資料量場景（如查詢數萬或數十萬條日誌）。
- **[FUTURE] 追蹤鏈視覺化增強**: 可考慮以火焰圖（Flame Graph）、甘特圖（Gantt Chart）或序列圖（Sequence Diagram）方式呈現 trace 之間的時間順序與延遲分佈，提供更直觀的效能分析視角。
- **[FUTURE] 進階搜尋語法**: 支援正規表示式搜尋、萬用字元匹配（如 `service:checkout-*`）、欄位範圍查詢（如 `duration:[100 TO 500]`）等進階查詢功能。
- **[FUTURE] 日誌上下文展開**: 點擊單條日誌時，自動載入該日誌前後 N 秒的相關日誌（Context Logs），幫助使用者理解事件發生的完整上下文。
- **[FUTURE] 儲存與分享查詢**: 允許使用者儲存常用的日誌查詢條件（Saved Searches），並可分享給團隊成員或設定為告警規則的基礎查詢。