# Feature Specification: Insights Analysis

**模組代碼**: `insights-analysis`
**模組層級**: 核心功能
**憲法版本**: `.specify/memory/constitution.md` (v1.3.0)
**最後更新**: 2025-10-08
**狀態**: Ready for Technical Review

---

## 一、主要使用者情境（User Scenarios & Testing）

### Primary User Story

作為一名 SRE、容量規劃工程師或平台分析師，我需要一個集中化的系統分析與預測介面，讓我能夠：

1. **分析歷史趨勢** — 查詢與視覺化任意時間區間的資源使用率（CPU、記憶體、儲存、網路）
2. **回放關鍵事件** — 以時間線模式重現過往事件期間的系統行為、指標變化與告警序列
3. **預測容量瓶頸** — 根據歷史資料預測未來 1-4 週的資源需求，並標示潛在瓶頸
4. **比較不同時段** — 並排比較不同時間區間、節點群組或應用層級的資源使用模式
5. **產出分析報表** — 儲存分析設定、匯出報表（PDF/CSV），支援知識累積與決策依據

### 具體情境（Specific Scenarios）

#### 情境 A：事故後根因分析

**背景**：2025-09-15 凌晨 2:00 發生一次服務降級事故，持續 45 分鐘後恢復。

**流程**：
1. 我進入「Insights Analysis」模組，選擇「事件回放」功能
2. 輸入時間區間「2025-09-15 01:30 ~ 03:00」，系統自動關聯該時段的 Incident 記錄
3. 系統以時間軸形式重現當時的資源指標變化：CPU 使用率從 40% 飆升至 98%
4. 同時顯示該時段觸發的 5 條告警、2 次手動操作（重啟服務）
5. 我可以快進、暫停、倒帶，逐步分析關鍵時間點的系統行為
6. 系統自動建議：「02:05 時 Memory 使用率達 95%，可能觸發 OOM Kill」
7. 我儲存此次分析為「2025-09-15 服務降級根因分析」，團隊其他成員可隨時查閱

**價值**：快速定位根因，避免重複排查，形成知識庫。

---

#### 情境 B：每季容量規劃

**背景**：Q4 即將到來，預期業務流量增長 30%，需評估是否需要擴容。

**流程**：
1. 我進入「容量預測」功能，選擇「過去 90 天」歷史資料作為基礎
2. 系統自動識別週期性模式（工作日高峰、週末低谷）
3. 我選擇「未來 4 週預測」，系統產出 CPU、Memory、Storage 的預測曲線
4. 系統標示：「預計 Week 2 時 CPU 使用率將達 85%，建議提前擴容」
5. 預測結果包含信心區間（P50、P90、P99），協助風險評估
6. 我匯出「Q4 容量預測報表（PDF）」，提交給團隊與管理層審核
7. 系統自動建立「Q4 容量預測任務」，每週更新預測結果

**價值**：數據驅動的容量規劃，避免過度或不足擴容。

---

#### 情境 C：多維度效能比較

**背景**：近期對「訂單服務」進行了效能優化，需驗證優化前後的差異。

**流程**：
1. 我進入「比較模式（Compare Mode）」，選擇兩個時間區間：
   - 優化前：2025-09-01 ~ 09-07
   - 優化後：2025-09-15 ~ 09-21
2. 系統並排顯示兩時段的資源使用率、請求延遲、錯誤率
3. 系統自動計算差異：「平均回應時間減少 35%，CPU 使用率降低 20%」
4. 我可以切換維度（按節點、按應用、按區域）查看細部差異
5. 系統自動標示異常點：「優化後 Node-3 的記憶體使用反而增加 10%，建議進一步排查」
6. 我儲存此次比較為「訂單服務優化前後效能對比」，附上結論與建議

**價值**：量化優化效果，識別潛在迴歸問題。

---

#### 情境 D：自動化異常偵測

**背景**：我希望系統自動識別歷史資料中的異常模式，而非手動排查。

**流程**：
1. 我進入「異常偵測」功能，選擇「過去 30 天」資料
2. 系統自動掃描所有資源指標，識別異常時段（基於統計模型或自訂閾值）
3. 系統標示 5 個異常時段，每個標註原因：「2025-09-12 16:00 ~ 18:00，CPU 突增 200%」
4. 我點擊任一異常時段，系統自動跳轉至回放模式，重現當時情境
5. 系統關聯該時段的 Incident、告警、變更記錄，提供全景視圖
6. 我可以為每個異常時段添加標籤（例如：「已知問題」、「需追蹤」、「誤報」）
7. 系統根據我的標註自動優化異常偵測模型，減少誤報

**價值**：主動發現問題，減少被動響應，累積異常知識庫。

---

#### 情境 E：團隊協作與知識傳承

**背景**：新進 SRE 需要快速了解系統的容量模式與歷史事件。

**流程**：
1. 我進入「分析歷史（Analysis History）」頁面，看到過去 90 天的分析任務清單
2. 系統按類別分組：「事件回放 (12)」、「容量預測 (8)」、「效能比較 (5)」
3. 我點擊「2025-09-15 服務降級根因分析」，系統自動載入當時的設定與結果
4. 新進 SRE 可以看到完整的分析過程、結論與建議，快速理解事故脈絡
5. 系統記錄每次分析的執行者、時間、使用的模型版本、資料來源
6. 我可以將分析任務設為「團隊共享」，其他成員可以重新執行或基於此調整

**價值**：知識不隨人員流動而流失，加速新人上手。

---

### 現有痛點（Pain Points）

#### 痛點 1：歷史資料分散，缺乏統一分析介面

**問題**：資源指標存於 Prometheus，事件記錄存於事故管理系統，日誌存於 Elasticsearch。
**影響**：分析人員需在多個系統間切換，手動關聯資料，效率低下。
**解決**：整合多來源資料，提供統一時間軸與關聯視圖，一鍵查詢所有相關資訊。

---

#### 痛點 2：事故回放依賴人工記憶與筆記

**問題**：事故發生時，系統狀態快速變化，人工難以完整記錄。
**影響**：事後根因分析時，關鍵細節遺失，難以重現當時情境。
**解決**：自動化時間線回放，逐步重現指標、告警、操作序列，支援快進/暫停/倒帶。

---

#### 痛點 3：容量規劃依賴經驗與試算表

**問題**：傳統容量規劃依賴 Excel 試算表與主觀經驗，缺乏科學預測。
**影響**：過度擴容造成資源浪費，不足擴容導致服務中斷。
**解決**：基於歷史資料與統計模型（甚至 AI 模型）自動預測，提供信心區間與潛在瓶頸。

---

#### 痛點 4：優化效果難以量化

**問題**：效能優化後，缺乏系統化的前後對比工具。
**影響**：優化效果依賴主觀感受，無法量化改善幅度，難以說服管理層投入資源。
**解決**：並排比較模式，自動計算差異百分比，視覺化優化前後的資源使用與效能指標。

---

#### 痛點 5：分析結果無法累積與重用

**問題**：每次分析都是一次性操作，無法儲存設定與結果。
**影響**：相同分析需重複執行，知識無法傳承，新人重複踩坑。
**解決**：分析任務版本化管理，支援儲存、載入、重新執行、團隊共享。

---

## 二、驗收場景（Acceptance Scenarios）

### 場景群組 A：歷史趨勢分析（Historical Trend Analysis）

#### A1. 查詢特定時段資源使用率

1. **Given** 我在「Insights Analysis」頁面。
2. **When** 我選擇時間區間「2025-09-01 00:00 ~ 2025-09-07 23:59」，並勾選「CPU、Memory、Storage」。
3. **Then** 系統必須（MUST）顯示三條趨勢圖，X 軸為時間，Y 軸為使用率（%）。
4. **And** 我可以切換時間粒度（1m、5m、1h、1d），圖表即時更新。
5. **And** 系統必須（MUST）顯示該時段的平均值、峰值、谷值統計資訊。

---

#### A2. 多維度篩選資源指標

1. **Given** 我在歷史趨勢頁面。
2. **When** 我選擇篩選條件：「節點群組 = Production-Cluster-1」、「應用 = OrderService」。
3. **Then** 系統必須（MUST）僅顯示符合條件的資源指標。
4. **And** 圖表標題必須（MUST）標註篩選條件（例如：「OrderService @ Production-Cluster-1」）。
5. **And** 篩選條件必須（MUST）可儲存為「快速篩選器（Quick Filter）」，下次快速套用。

---

#### A3. 自訂閾值標示異常

1. **Given** 我在歷史趨勢頁面。
2. **When** 我設定自訂閾值：「CPU > 80%」、「Memory > 90%」。
3. **Then** 系統必須（MUST）在圖表上以紅色區域標示超過閾值的時段。
4. **And** 滑鼠懸停時，系統必須（MUST）顯示該時段的詳細數值與持續時間。
5. **And** 系統應該（SHOULD）自動建議：「此時段可能存在效能問題，建議查看相關告警」。

---

#### A4. 匯出歷史趨勢報表

1. **Given** 我完成歷史趨勢分析。
2. **When** 我點擊「匯出報表」，選擇格式「PDF」。
3. **Then** 系統必須（MUST）產出包含圖表、統計資訊、篩選條件的 PDF 報表。
4. **And** 報表必須（MUST）包含生成時間、執行者、資料來源版本。
5. **And** 系統必須（MUST）記錄匯出行為於稽核日誌（類別：`insights-export`）。

---

### 場景群組 B：事件回放（Event Backtesting）

#### B1. 自動關聯事件與時間區間

1. **Given** 2025-09-15 02:00 發生一次 Incident（ID: INC-1234）。
2. **When** 我進入「事件回放」頁面，選擇 Incident「INC-1234」。
3. **Then** 系統必須（MUST）自動載入該 Incident 的時間區間（前後各延伸 30 分鐘）。
4. **And** 系統必須（MUST）顯示該時段的資源指標、告警序列、操作記錄。
5. **And** 時間軸必須（MUST）標註 Incident 開始、結束、關鍵操作時間點。

---

#### B2. 時間線逐步回放

1. **Given** 我在事件回放頁面。
2. **When** 我點擊「播放（Play）」按鈕。
3. **Then** 系統必須（MUST）以 1 秒對應 1 分鐘的速度逐步重現資源指標變化。
4. **And** 系統必須（MUST）同步顯示該時刻觸發的告警、操作記錄。
5. **And** 我可以點擊「暫停（Pause）」、「快進（2x, 4x）」、「倒帶（Rewind）」控制回放速度。

---

#### B3. 標註關鍵時間點

1. **Given** 我在事件回放頁面，已播放至 02:15。
2. **When** 我點擊「標註（Annotate）」，輸入備註：「此時 Memory 達 95%，疑似 OOM Kill」。
3. **Then** 系統必須（MUST）在時間軸上標註此時間點，顯示我的備註。
4. **And** 標註必須（MUST）與該次回放任務關聯，其他使用者查看時可見。
5. **And** 系統必須（MUST）記錄標註行為於稽核日誌（類別：`insights-annotate`）。

---

#### B4. 儲存回放分析結果

1. **Given** 我完成事件回放分析。
2. **When** 我點擊「儲存分析」，輸入名稱：「2025-09-15 服務降級根因分析」。
3. **Then** 系統必須（MUST）建立 `BacktestRun` 記錄，包含時間區間、標註、結論。
4. **And** 系統必須（MUST）支援我隨時重新載入此次分析，完整重現當時設定。
5. **And** 系統必須（MUST）記錄儲存行為於稽核日誌（類別：`insights-save`）。

---

### 場景群組 C：容量預測（Capacity Forecasting）

#### C1. 基於歷史資料預測未來容量

1. **Given** 我在「容量預測」頁面。
2. **When** 我選擇「過去 90 天」作為歷史基礎，預測「未來 4 週」。
3. **Then** 系統必須（MUST）產出 CPU、Memory、Storage 的預測曲線。
4. **And** 預測曲線必須（MUST）包含 P50（中位數）、P90、P99 信心區間。
5. **And** 系統必須（MUST）標示潛在瓶頸（例如：「Week 2 時 CPU 將達 85%」）。

---

#### C2. 週期性模式識別

1. **Given** 我在容量預測頁面。
2. **When** 系統分析歷史資料。
3. **Then** 系統必須（MUST）自動識別週期性模式（例如：「工作日高峰，週末低谷」）。
4. **And** 系統應該（SHOULD）在預測曲線上標註週期性模式。
5. **And** 系統應該（SHOULD）建議：「根據週期性模式，建議在工作日前 1 天擴容」。

---

#### C3. 預測結果匯出與分享

1. **Given** 我完成容量預測。
2. **When** 我點擊「匯出報表」，選擇格式「PDF」。
3. **Then** 系統必須（MUST）產出包含預測曲線、信心區間、潛在瓶頸的 PDF 報表。
4. **And** 報表必須（MUST）包含模型版本、資料來源、執行時間、執行者。
5. **And** 系統必須（MUST）支援我將報表設為「團隊共享」，其他成員可查閱。

---

#### C4. 定期自動更新預測結果

1. **Given** 我建立一個容量預測任務：「Q4 容量預測」。
2. **When** 我設定「每週自動更新」。
3. **Then** 系統必須（MUST）每週重新執行預測，更新結果。
4. **And** 系統必須（MUST）保留歷史版本，支援比較不同週次的預測差異。
5. **And** 若預測結果顯示「未來 1 週內將達瓶頸」，系統應該（SHOULD）發送告警通知。

---

### 場景群組 D：比較模式（Comparison Mode）

#### D1. 並排比較不同時段

1. **Given** 我在「比較模式」頁面。
2. **When** 我選擇兩個時間區間：「2025-09-01 ~ 09-07」、「2025-09-15 ~ 09-21」。
3. **Then** 系統必須（MUST）並排顯示兩時段的資源使用率、請求延遲、錯誤率。
4. **And** 系統必須（MUST）自動計算差異百分比（例如：「平均回應時間減少 35%」）。
5. **And** 系統必須（MUST）標註異常點（例如：「Node-3 記憶體使用反而增加 10%」）。

---

#### D2. 切換比較維度

1. **Given** 我在比較模式頁面。
2. **When** 我切換維度至「按節點（By Node）」。
3. **Then** 系統必須（MUST）顯示每個節點的資源使用對比。
4. **And** 我可以進一步切換至「按應用（By Application）」、「按區域（By Region）」。
5. **And** 每次切換，系統必須（MUST）即時更新圖表與差異統計。

---

#### D3. 儲存比較分析結果

1. **Given** 我完成比較分析。
2. **When** 我點擊「儲存分析」，輸入名稱：「訂單服務優化前後效能對比」。
3. **Then** 系統必須（MUST）建立 `AnalysisJob` 記錄，包含兩時段設定、維度、結論。
4. **And** 系統必須（MUST）支援我隨時重新載入此次分析。
5. **And** 系統必須（MUST）記錄儲存行為於稽核日誌（類別：`insights-save`）。

---

### 場景群組 E：異常偵測（Anomaly Detection）

#### E1. 自動掃描歷史異常

1. **Given** 我在「異常偵測」頁面。
2. **When** 我選擇「過去 30 天」資料，點擊「掃描異常」。
3. **Then** 系統必須（MUST）自動識別異常時段（基於統計模型或自訂閾值）。
4. **And** 系統必須（MUST）標註每個異常時段的原因（例如：「CPU 突增 200%」）。
5. **And** 系統必須（MUST）提供異常時段清單，並支援排序（按嚴重程度、持續時間）。

---

#### E2. 跳轉至回放模式查看異常細節

1. **Given** 系統識別出 5 個異常時段。
2. **When** 我點擊任一異常時段。
3. **Then** 系統必須（MUST）自動跳轉至事件回放模式，重現該時段情境。
4. **And** 系統必須（MUST）關聯該時段的 Incident、告警、變更記錄。
5. **And** 系統必須（MUST）支援我為該異常添加標籤（例如：「已知問題」、「需追蹤」）。

---

#### E3. 優化異常偵測模型

1. **Given** 我為多個異常時段添加標籤（「誤報」、「真實問題」）。
2. **When** 系統累積足夠標籤資料（例如：>100 筆）。
3. **Then** 系統應該（SHOULD）根據我的標註自動優化異常偵測模型。
4. **And** 系統應該（SHOULD）顯示模型準確率變化（例如：「誤報率從 20% 降至 5%」）。
5. **And** 系統必須（MUST）記錄模型版本與訓練歷史。

---

## 三、功能需求（Functional Requirements）

### 3.1. 歷史趨勢分析（Historical Trend Analysis）

| 編號 | 說明 |
|------|------|
| **FR-HT-001** | 系統必須（MUST）支援查詢任意時間區間的資源使用率（CPU、Memory、Storage、Network）。 |
| **FR-HT-002** | 系統必須（MUST）支援切換時間粒度（1m、5m、1h、1d），並即時更新圖表。 |
| **FR-HT-003** | 系統必須（MUST）支援多維度篩選（節點群組、應用、區域）。 |
| **FR-HT-004** | 系統必須（MUST）顯示該時段的統計資訊（平均值、峰值、谷值）。 |
| **FR-HT-005** | 系統必須（MUST）支援自訂閾值標示異常時段。 |
| **FR-HT-006** | 系統必須（MUST）支援匯出歷史趨勢報表（PDF、CSV）。 |
| **FR-HT-007** | 系統必須（MUST）支援儲存篩選條件為「快速篩選器（Quick Filter）」。 |

---

### 3.2. 事件回放（Event Backtesting）

| 編號 | 說明 |
|------|------|
| **FR-EB-001** | 系統必須（MUST）支援自動關聯 Incident 與時間區間（前後各延伸 30 分鐘）。 |
| **FR-EB-002** | 系統必須（MUST）支援時間線逐步回放（播放、暫停、快進、倒帶）。 |
| **FR-EB-003** | 系統必須（MUST）同步顯示資源指標、告警序列、操作記錄。 |
| **FR-EB-004** | 系統必須（MUST）支援標註關鍵時間點，並與回放任務關聯。 |
| **FR-EB-005** | 系統必須（MUST）支援儲存回放分析結果，並支援重新載入。 |
| **FR-EB-006** | 系統必須（MUST）記錄回放執行歷程（執行者、時間、設定）。 |

---

### 3.3. 容量預測（Capacity Forecasting）

| 編號 | 說明 |
|------|------|
| **FR-CF-001** | 系統必須（MUST）支援基於歷史資料預測未來 1-4 週容量（CPU、Memory、Storage）。 |
| **FR-CF-002** | 系統必須（MUST）顯示預測曲線與信心區間（P50、P90、P99）。 |
| **FR-CF-003** | 系統必須（MUST）自動識別週期性模式（工作日/週末）。 |
| **FR-CF-004** | 系統必須（MUST）標示潛在瓶頸（例如：「Week 2 時 CPU 將達 85%」）。 |
| **FR-CF-005** | 系統必須（MUST）支援匯出容量預測報表（PDF），包含模型版本與資料來源。 |
| **FR-CF-006** | 系統必須（MUST）支援定期自動更新預測結果（每週、每月）。 |
| **FR-CF-007** | 系統應該（SHOULD）在預測顯示「未來 1 週內將達瓶頸」時發送告警通知。 |

---

### 3.4. 比較模式（Comparison Mode）

| 編號 | 說明 |
|------|------|
| **FR-CM-001** | 系統必須（MUST）支援並排比較不同時段的資源使用率、請求延遲、錯誤率。 |
| **FR-CM-002** | 系統必須（MUST）自動計算差異百分比（例如：「平均回應時間減少 35%」）。 |
| **FR-CM-003** | 系統必須（MUST）支援切換比較維度（按節點、按應用、按區域）。 |
| **FR-CM-004** | 系統必須（MUST）標註異常點（例如：「Node-3 記憶體使用反而增加 10%」）。 |
| **FR-CM-005** | 系統必須（MUST）支援儲存比較分析結果，並支援重新載入。 |

---

### 3.5. 異常偵測（Anomaly Detection）

| 編號 | 說明 |
|------|------|
| **FR-AD-001** | 系統必須（MUST）支援自動掃描歷史資料，識別異常時段。 |
| **FR-AD-002** | 系統必須（MUST）標註每個異常時段的原因（例如：「CPU 突增 200%」）。 |
| **FR-AD-003** | 系統必須（MUST）支援跳轉至回放模式查看異常細節。 |
| **FR-AD-004** | 系統必須（MUST）支援為異常時段添加標籤（已知問題、需追蹤、誤報）。 |
| **FR-AD-005** | 系統應該（SHOULD）根據使用者標註自動優化異常偵測模型。 |
| **FR-AD-006** | 系統必須（MUST）記錄模型版本與訓練歷史。 |

---

### 3.6. 知識累積與團隊協作（Knowledge Accumulation & Collaboration）

| 編號 | 說明 |
|------|------|
| **FR-KC-001** | 系統必須（MUST）支援儲存分析任務（包含設定、結果、結論）。 |
| **FR-KC-002** | 系統必須（MUST）支援重新載入歷史分析任務，完整重現當時設定。 |
| **FR-KC-003** | 系統必須（MUST）支援分析任務設為「團隊共享」，其他成員可查閱。 |
| **FR-KC-004** | 系統必須（MUST）記錄每次分析的執行者、時間、模型版本、資料來源。 |
| **FR-KC-005** | 系統必須（MUST）支援分析任務版本化管理，保留歷史版本。 |

---

### 3.7. 效能與擴展性（Performance & Scalability）

| 編號 | 說明 |
|------|------|
| **FR-PS-001** | 歷史趨勢查詢（90 天內、1h 粒度）必須（MUST）在 3 秒內返回結果。 |
| **FR-PS-002** | 事件回放載入時間必須（MUST）在 5 秒內完成（包含資料查詢與渲染）。 |
| **FR-PS-003** | 容量預測運算時間必須（MUST）在 10 秒內完成（基於 90 天歷史資料）。 |
| **FR-PS-004** | 系統必須（MUST）支援並行處理多個分析任務（最多 10 個並行）。 |

---

## 四、關鍵資料實體（Key Entities）

| 實體名稱 | 描述 | 關聯 |
|-----------|------|------|
| **AnalysisJob** | 單次分析任務，包含類型（趨勢/回放/預測/比較/異常）、時間區間、維度、模型設定、結果、結論。 | 與 User、Team 關聯 |
| **BacktestRun** | 回放任務，記錄事件重播步驟、標註、關鍵時間點。 | 屬於 AnalysisJob，關聯至 Incident |
| **CapacityForecast** | 預測結果資料，包含時間序列、信心區間（P50、P90、P99）、潛在瓶頸。 | 關聯至 AnalysisJob |
| **AnalysisReport** | 分析報表（PDF / CSV）匯出結果，包含圖表、統計、結論。 | 由 AnalysisJob 產生 |
| **AnomalyRecord** | 異常時段記錄，包含原因、嚴重程度、持續時間、使用者標籤。 | 關聯至 AnalysisJob |
| **QuickFilter** | 使用者自訂的快速篩選器，儲存篩選條件（節點群組、應用、區域）。 | 與 User 關聯 |

---

## 五、權限控制（RBAC）

| 權限字串 | 描述 |
|-----------|------|
| `insights:analysis:read` | 檢視歷史分析報表與結果。 |
| `insights:analysis:execute` | 執行歷史趨勢分析、事件回放、容量預測、比較、異常偵測任務。 |
| `insights:analysis:manage` | 管理分析設定、模型版本、快速篩選器。 |
| `insights:report:export` | 匯出分析報表（PDF、CSV）。 |
| `insights:model:manage` | 管理異常偵測模型、訓練歷史。 |

---

## 六、邊界案例（Edge Cases）

### 6.1. 時間區間過長導致資料量過大

**情境**：使用者選擇「過去 1 年」資料，且時間粒度為「1 分鐘」，導致資料點超過 50 萬筆。
**處理**：
- 系統必須（MUST）警告：「時間區間過長，建議調整粒度至 1 小時或 1 天」
- 系統應該（SHOULD）自動限制查詢範圍（最多 90 天 + 1 小時粒度）
- 若使用者堅持查詢，系統必須（MUST）採用分頁載入，避免前端渲染阻塞

---

### 6.2. 預測模型無法識別週期性模式

**情境**：系統資料量不足（< 30 天），或資料噪音過大，無法識別週期性模式。
**處理**：
- 系統必須（MUST）顯示提示：「歷史資料不足，無法識別週期性模式，預測結果僅供參考」
- 系統應該（SHOULD）提供「線性預測」作為備選方案
- 系統應該（SHOULD）建議使用者累積更多歷史資料後重新執行

---

### 6.3. 事件回放關聯不到 Incident 記錄

**情境**：使用者選擇時間區間，但該時段無任何 Incident 記錄。
**處理**：
- 系統必須（MUST）顯示提示：「該時段無關聯事件，將以純時間線模式回放」
- 系統必須（MUST）仍可回放資源指標與告警序列
- 系統應該（SHOULD）允許使用者手動關聯其他模組記錄（例如：變更記錄）

---

### 6.4. 異常偵測模型誤報率過高

**情境**：初始異常偵測模型誤報率達 30%，影響使用體驗。
**處理**：
- 系統必須（MUST）提供「調整靈敏度」選項（高、中、低）
- 系統必須（MUST）支援使用者標註誤報，並即時更新模型
- 系統應該（SHOULD）在累積足夠標註後（> 100 筆）自動優化模型

---

### 6.5. 分析任務執行時間過長

**情境**：容量預測任務執行時間超過 60 秒（例如：複雜 AI 模型）。
**處理**：
- 系統必須（MUST）顯示進度條與預估剩餘時間
- 系統必須（MUST）支援後台執行，使用者可關閉頁面，稍後查看結果
- 系統必須（MUST）發送通知（郵件或站內訊息）告知任務完成

---

### 6.6. 並排比較的兩時段資料結構不一致

**情境**：優化前後的節點數量不同（優化前 5 台，優化後 8 台）。
**處理**：
- 系統必須（MUST）顯示提示：「兩時段節點數量不一致，將以總量對比」
- 系統應該（SHOULD）提供「平均值對比」選項，消除節點數差異影響
- 系統應該（SHOULD）標註不一致項目（例如：「Node-6, Node-7, Node-8 為新增節點」）

---

## 七、觀測性與治理（Observability & Governance）

### 7.1. Logging & Tracing
- [ ] 所有分析任務執行記錄於結構化日誌（包含類型、時間區間、維度、執行者）
- [ ] 所有報表匯出行為記錄於稽核日誌（類別：`insights-export`）
- [ ] 所有標註行為記錄於稽核日誌（類別：`insights-annotate`）
- [ ] 所有分析任務儲存行為記錄於稽核日誌（類別：`insights-save`）
- [ ] 分散式追蹤（Trace ID）貫穿整個分析流程（資料查詢 → 運算 → 渲染）

### 7.2. Metrics & Alerts
- [ ] 監控分析任務執行次數（按類型：趨勢/回放/預測/比較/異常）
- [ ] 監控分析任務執行時間（P50、P90、P99）
- [ ] 監控報表匯出次數（按格式：PDF、CSV）
- [ ] 監控異常偵測模型準確率（誤報率、漏報率）
- [ ] 告警：若分析任務執行時間超過 60 秒，發送告警
- [ ] 告警：若異常偵測誤報率超過 20%，發送告警

### 7.3. RBAC
- [ ] 所有分析功能必須檢查 `insights:analysis:execute` 權限
- [ ] 報表匯出必須檢查 `insights:report:export` 權限
- [ ] 模型管理必須檢查 `insights:model:manage` 權限
- [ ] 團隊共享分析任務必須檢查團隊成員資格

### 7.4. i18n
- [ ] 所有 UI 文案支援 `zh-TW`、`en-US`
- [ ] 所有報表內容支援多語系輸出
- [ ] 所有錯誤訊息支援多語系

### 7.5. Theme Token
- [ ] 圖表顏色使用 Theme Token（例如：`primary-color`、`danger-color`）
- [ ] 異常標示顏色使用 Theme Token（例如：`warning-bg`、`error-border`）

---

## 八、審查與驗收清單（Review Checklist）

- [x] 文件結構符合憲法 v1.3.0 標準
- [x] Primary User Story 包含 5 個能力點、5 個具體情境、5 個痛點分析
- [x] Acceptance Scenarios 包含 15 個場景，分為 5 個群組（A-E）
- [x] Functional Requirements 包含 35 個需求，分為 7 個類別
- [x] 完整 RBAC 定義（5 個權限）
- [x] 完整邊界案例（6 個）
- [x] 完整觀測性與治理清單（Logging、Metrics、RBAC、i18n、Theme Token）
- [x] 移除所有技術實作細節，保持技術中立
- [x] 整合 backtesting 與 capacity 兩模組之功能

---

## 九、模糊與待確認事項（Clarifications）

| 項目 | 狀態 | 備註 |
|------|------|------|
| 預測模型來源 | [NEEDS CLARIFICATION] | 是否使用內建統計模型（ARIMA、Prophet）或外部 AI Framework（TensorFlow）。 |
| 回放速度與控制 | [RESOLVED] | 已明確支援播放、暫停、快進（2x, 4x）、倒帶控制。 |
| 報表格式 | [NEEDS CLARIFICATION] | 是否支援自訂報表樣板或與 Grafana 匯出整合。 |
| 資料保留期限 | [NEEDS CLARIFICATION] | 歷史資料是否有過期與刪除策略（建議：原始資料保留 90 天，聚合資料保留 1 年）。 |
| 異常偵測模型訓練頻率 | [NEEDS CLARIFICATION] | 模型是否定期自動重新訓練（例如：每週）或僅在使用者標註後手動觸發。 |
| 團隊共享權限控制 | [NEEDS CLARIFICATION] | 團隊共享分析任務是否支援細粒度權限（例如：僅特定團隊可見）。 |
