# Feature Specification: Identity Audit Logs

**模組代碼**: `identity-audit`
**模組層級**: 核心功能（安全與合規）
**憲法版本**: `.specify/memory/constitution.md` (v1.3.0)
**最後更新**: 2025-10-08
**狀態**: Ready for Technical Review

---

## 一、主要使用者情境（User Scenarios & Testing）

### Primary User Story

作為一名安全管理員、合規稽核人員或系統管理員，我需要一個不可變的審計日誌系統，讓我能夠：

1. **追蹤所有關鍵操作** — 記錄「誰（Who）」、「何時（When）」、「從哪裡（Where）」、「對什麼（What）」、「做了什麼（Action）」、「結果如何（Result）」
2. **快速查詢與篩選** — 按時間範圍、操作者、動作類型、目標物件、結果狀態多維度篩選日誌
3. **深入調查異常事件** — 查看操作的完整詳細資訊（包括 Before/After 快照、請求參數、回應結果）
4. **產出合規報表** — 匯出特定時段的審計日誌（CSV、JSON），支援季度/年度安全審查
5. **保障日誌不可篡改** — 確保審計日誌一旦產生，無法被修改或刪除（技術機制保護）

### 具體情境（Specific Scenarios）

#### 情境 A：調查權限異常提升事件

**背景**：監控系統發現凌晨 3:00 有一個一般使用者被提升為系統管理員，安全團隊需立即調查。

**流程**：
1. 我進入「審計日誌（Audit Logs）」頁面
2. 設定時間範圍：2025-10-08 02:00 ~ 04:00
3. 篩選動作類型：「角色更新（Role Updated）」
4. 系統即時顯示該時段的 2 筆角色變更記錄：
   - `03:12:45` - Admin (john@example.com) 更新 user-456 的角色：User → SystemAdmin
   - `03:15:20` - Admin (john@example.com) 更新 user-789 的角色：User → Auditor
5. 我點擊第一筆記錄，系統從右側滑出詳細資訊抽屜（Drawer），顯示：
   - **操作摘要**：角色更新（Role Updated）
   - **執行者**：john@example.com（IP: 192.168.1.100，地理位置：台北）
   - **目標使用者**：user-456（email: alice@example.com）
   - **變更內容**：
     - Before: `{ "roles": ["User"] }`
     - After: `{ "roles": ["SystemAdmin"] }`
   - **操作結果**：成功（Success）
   - **請求 ID**：`req-abc123`（可用於關聯系統日誌）
6. 我進一步查詢 john@example.com 的所有操作記錄，發現他在過去 7 天執行了 15 次權限變更
7. 我匯出該使用者的完整操作記錄（CSV），提交給安全團隊進行深入調查
8. 系統自動發送告警：「異常權限提升行為：john@example.com 在 24 小時內執行 5 次權限提升」

**價值**：快速定位安全事件，提供完整證據鏈，支援事後調查與追責。

---

#### 情境 B：合規稽核季度報表

**背景**：公司需符合 SOC 2 Type II 合規要求，每季度需提交所有特權操作的審計報表。

**流程**：
1. 我進入「審計日誌」頁面
2. 設定時間範圍：2025-Q3（2025-07-01 ~ 2025-09-30）
3. 篩選動作類型：「角色更新」、「使用者刪除」、「團隊刪除」、「權限變更」（多選）
4. 系統顯示該季度的 120 筆特權操作記錄
5. 我點擊「進階篩選」，進一步篩選：
   - 執行者角色：SystemAdmin、ComplianceOfficer
   - 結果狀態：成功（Success）
6. 篩選後剩餘 95 筆記錄
7. 我點擊「匯出」，選擇格式「CSV」，勾選「包含完整詳細資訊（Include Full Details）」
8. 系統產出 CSV 檔案，包含以下欄位：
   - Timestamp、Actor、Action、Target、Result、IP Address、Request ID、Before、After
9. 我將 CSV 提交給外部稽核公司，稽核公司驗證所有特權操作均有合法授權
10. 系統自動記錄稽核日誌：「Auditor (jane@example.com) 匯出 Q3 審計日誌（95 筆記錄）」

**價值**：自動化合規報表產出，節省人工整理時間，確保稽核證據完整性。

---

#### 情境 C：追蹤資料外洩事件

**背景**：發現有未授權人員存取敏感資源，需追蹤該資源的所有存取記錄。

**流程**：
1. 我進入「審計日誌」頁面
2. 設定目標物件篩選：「資源 ID = resource-sensitive-db-001」
3. 系統顯示該資源的所有存取記錄（過去 30 天，共 50 筆）
4. 我按時間排序，看到最近 5 天的存取頻率異常增高（從每天 2 次增至每天 10 次）
5. 我篩選「結果狀態：失敗（Failed）」，發現 15 筆存取失敗記錄
6. 點擊其中一筆失敗記錄，系統顯示詳細資訊：
   - **執行者**：unknown-user（IP: 203.0.113.45，地理位置：不明）
   - **動作**：資源存取（Resource Access）
   - **失敗原因**：權限不足（Insufficient Permissions）
   - **請求時間**：2025-10-05 14:32:10
7. 我點擊「檢視相同 IP 的所有操作」，系統自動篩選出該 IP 的所有記錄（共 20 筆，均為失敗）
8. 我匯出該 IP 的完整記錄，提交給安全團隊
9. 安全團隊將該 IP 加入黑名單，系統自動記錄：「IP 203.0.113.45 因多次未授權存取被封鎖」

**價值**：快速識別異常存取模式，提供完整存取軌跡，支援安全事件響應。

---

#### 情境 D：驗證變更操作的完整性

**背景**：使用者反映其團隊成員名單異常變更，需驗證變更記錄。

**流程**：
1. 我進入「審計日誌」頁面
2. 設定目標物件篩選：「團隊 ID = team-engineering」
3. 設定動作類型：「團隊成員新增」、「團隊成員移除」
4. 系統顯示該團隊的所有成員變更記錄（過去 7 天，共 8 筆）
5. 我點擊一筆「團隊成員移除」記錄，系統顯示詳細資訊：
   - **執行者**：team-lead@example.com
   - **目標成員**：user-bob@example.com
   - **變更時間**：2025-10-07 16:45:30
   - **變更內容**：
     - Before: `{ "members": ["alice@example.com", "bob@example.com", "charlie@example.com"] }`
     - After: `{ "members": ["alice@example.com", "charlie@example.com"] }`
   - **操作結果**：成功（Success）
6. 我驗證變更記錄與使用者反映的情況一致
7. 我匯出該團隊的完整變更歷史，提供給團隊 Lead 確認
8. 系統自動記錄：「Auditor (me@example.com) 查詢團隊 team-engineering 的變更歷史」

**價值**：提供完整變更歷史，支援使用者申訴與爭議解決，確保操作透明度。

---

#### 情境 E：監控批次操作的影響

**背景**：系統管理員執行了一次批次刪除使用者操作（刪除 100 個停用帳號），需驗證操作是否正確執行。

**流程**：
1. 我進入「審計日誌」頁面
2. 設定時間範圍：2025-10-08 10:00 ~ 11:00
3. 篩選動作類型：「使用者刪除（User Deleted）」
4. 系統顯示該時段的 100 筆刪除記錄
5. 我點擊「批次操作摘要」，系統自動聚合顯示：
   - **批次 ID**：`batch-del-2025100810`
   - **執行者**：admin@example.com
   - **操作時間**：2025-10-08 10:15:00
   - **總筆數**：100 筆
   - **成功**：98 筆
   - **失敗**：2 筆（user-abc 與 user-def 因仍有關聯資源而無法刪除）
6. 我點擊「檢視失敗記錄」，系統僅顯示 2 筆失敗記錄
7. 我逐一查看失敗原因，確認為預期行為（需先刪除關聯資源）
8. 我匯出批次操作摘要報表，提交給管理層確認批次清理完成

**價值**：支援批次操作的影響評估與驗證，提供聚合視圖，簡化大量記錄查詢。

---

### 現有痛點（Pain Points）

#### 痛點 1：審計日誌分散，難以集中查詢

**問題**：審計日誌分散在各模組（IAM、資源管理、事件管理），無統一查詢入口。
**影響**：調查安全事件時需在多個系統間切換，效率低下，容易遺漏關鍵資訊。
**解決**：集中化審計日誌管理，統一查詢介面，支援跨模組日誌關聯查詢。

---

#### 痛點 2：日誌詳細程度不足，缺乏 Before/After 快照

**問題**：僅記錄「誰做了什麼」，無法查看變更前後的完整狀態。
**影響**：調查時無法確認變更的具體內容，難以判斷操作是否符合預期。
**解決**：記錄變更前後的完整狀態快照（Before/After），支援變更對比視圖。

---

#### 痛點 3：缺乏多維度篩選，查詢效率低

**問題**：僅支援按時間範圍或操作者單一維度篩選，無法複合查詢。
**影響**：調查複雜事件時（例如：「特定 IP 在特定時段執行的失敗操作」）需多次篩選，耗時且易出錯。
**解決**：支援多維度複合篩選（時間、操作者、動作類型、目標物件、結果狀態、IP 地址），一次查詢精準定位。

---

#### 痛點 4：合規報表需手動整理，效率低下

**問題**：季度/年度合規報表需人工匯出日誌並手動整理格式。
**影響**：耗費大量人力時間，且容易遺漏關鍵記錄或格式錯誤。
**解決**：一鍵匯出合規報表（CSV、JSON），支援自訂欄位與時間範圍，自動包含所有必要資訊。

---

#### 痛點 5：審計日誌無防篡改機制，可信度存疑

**問題**：審計日誌存於普通資料庫，技術上可被修改或刪除。
**影響**：在法律訴訟或合規稽核時，日誌證據力不足，無法證明日誌未被篡改。
**解決**：採用日誌簽名、區塊鏈或 WORM（Write Once Read Many）儲存技術，確保日誌不可篡改。

---

## 二、驗收場景（Acceptance Scenarios）

### 場景群組 A：日誌查詢與篩選（Log Query & Filter）

#### A1. 按時間範圍查詢日誌

1. **Given** 我在「審計日誌」頁面。
2. **When** 我設定時間範圍「2025-10-01 00:00 ~ 2025-10-07 23:59」。
3. **Then** 系統必須（MUST）顯示該時段的所有審計日誌（分頁顯示，每頁 50 筆）。
4. **And** 系統必須（MUST）在頁面頂部顯示符合條件的總筆數（例如：「共 1,234 筆記錄」）。
5. **And** 日誌必須（MUST）按時間倒序排列（最新記錄在前）。

---

#### A2. 按操作者篩選日誌

1. **Given** 我在「審計日誌」頁面。
2. **When** 我在「操作者（Actor）」篩選框輸入 `john@example.com`。
3. **Then** 系統必須（MUST）即時過濾，僅顯示該使用者的操作記錄。
4. **And** 系統必須（MUST）支援模糊匹配（例如：輸入 `john` 可匹配 `john@example.com`、`johnny@example.com`）。
5. **And** 篩選條件必須（MUST）顯示於頁面頂部（例如：「操作者：john@example.com (120)」）。

---

#### A3. 按動作類型多選篩選

1. **Given** 我在「審計日誌」頁面。
2. **When** 我在「動作類型（Action）」下拉選單勾選「角色更新」、「使用者刪除」、「權限變更」（多選）。
3. **Then** 系統必須（MUST）顯示符合任一動作類型的日誌（OR 邏輯）。
4. **And** 系統必須（MUST）在篩選欄顯示已選擇的動作類型（例如：「動作：角色更新 + 使用者刪除 + 權限變更 (85)」）。
5. **And** 我可以清除任一篩選條件，系統必須（MUST）即時更新結果。

---

#### A4. 複合篩選（時間 + 操作者 + 動作類型 + 結果狀態）

1. **Given** 我在「審計日誌」頁面。
2. **When** 我設定以下篩選條件：
   - 時間範圍：2025-10-01 ~ 2025-10-07
   - 操作者：john@example.com
   - 動作類型：角色更新
   - 結果狀態：成功（Success）
3. **Then** 系統必須（MUST）顯示同時符合所有條件的日誌（AND 邏輯）。
4. **And** 系統必須（MUST）在頁面頂部顯示當前篩選條件摘要與結果筆數。
5. **And** 我可以一鍵清除所有篩選條件，恢復顯示全部日誌。

---

### 場景群組 B：日誌詳細資訊查看（Log Detail View）

#### B1. 查看操作的完整詳細資訊

1. **Given** 審計日誌列表顯示一筆「角色更新」記錄。
2. **When** 我點擊該筆記錄。
3. **Then** 系統必須（MUST）從右側滑出詳細資訊抽屜（Drawer）。
4. **And** 抽屜必須（MUST）顯示以下結構化資訊：
   - 操作摘要（Action Summary）
   - 執行者（Actor）：姓名、Email、IP 地址、地理位置
   - 目標物件（Target）：類型、ID、名稱
   - 變更內容（Changes）：Before/After 快照（以 JSON Diff 格式顯示）
   - 操作結果（Result）：成功/失敗 + 錯誤訊息（若失敗）
   - 請求 ID（Request ID）：可用於關聯系統日誌
   - 時間戳（Timestamp）：精確到毫秒

---

#### B2. 查看 JSON 格式的完整日誌

1. **Given** 詳細資訊抽屜已開啟。
2. **When** 我點擊「檢視完整 JSON」。
3. **Then** 系統必須（MUST）顯示該筆日誌的完整 JSON 格式（使用 JSON Viewer 元件，支援摺疊/展開）。
4. **And** JSON Viewer 必須（MUST）支援語法高亮（Syntax Highlighting）。
5. **And** 我可以複製整個 JSON 內容至剪貼簿（一鍵複製按鈕）。

---

#### B3. 查看變更對比（Before/After Diff）

1. **Given** 詳細資訊抽屜顯示一筆「團隊成員移除」記錄。
2. **When** 我點擊「檢視變更對比（View Diff）」。
3. **Then** 系統必須（MUST）以並排或統一 Diff 格式顯示 Before/After 差異。
4. **And** 系統必須（MUST）高亮變更部分（新增：綠色，刪除：紅色）。
5. **And** 若變更內容為 JSON 物件，系統應該（SHOULD）以結構化方式顯示（而非純文字）。

---

### 場景群組 C：日誌匯出（Log Export）

#### C1. 匯出當前篩選結果（CSV）

1. **Given** 我已篩選出 120 筆符合條件的日誌。
2. **When** 我點擊「匯出」按鈕，選擇格式「CSV」。
3. **Then** 系統必須（MUST）產出包含所有 120 筆記錄的 CSV 檔案。
4. **And** CSV 必須（MUST）包含以下欄位：Timestamp、Actor、Action、Target、Result、IP Address。
5. **And** 系統必須（MUST）記錄匯出行為於審計日誌（類別：`audit-log-export`，內容：匯出者、筆數、時間範圍）。

---

#### C2. 匯出包含完整詳細資訊的日誌（JSON）

1. **Given** 我已篩選出 50 筆符合條件的日誌。
2. **When** 我點擊「匯出」，選擇格式「JSON」，勾選「包含完整詳細資訊（Include Full Details）」。
3. **Then** 系統必須（MUST）產出包含所有 50 筆記錄的 JSON 檔案。
4. **And** 每筆記錄必須（MUST）包含完整的 `details` 欄位（Before/After、請求參數、回應結果）。
5. **And** JSON 檔案必須（MUST）格式化（Pretty Print），便於人工閱讀。

---

#### C3. 批次匯出大量日誌

1. **Given** 我需匯出 Q3 整季度的日誌（預估 10,000 筆）。
2. **When** 我設定時間範圍「2025-07-01 ~ 2025-09-30」，點擊「匯出」。
3. **Then** 系統必須（MUST）顯示進度提示：「正在準備匯出，預估 10,000 筆記錄...」。
4. **And** 系統應該（SHOULD）採用後台任務處理，避免前端阻塞。
5. **And** 匯出完成後，系統必須（MUST）發送通知（郵件或站內訊息）：「Q3 審計日誌匯出完成，請點擊下載」。
6. **And** 系統必須（MUST）記錄匯出行為於審計日誌。

---

### 場景群組 D：日誌關聯查詢（Log Correlation Query）

#### D1. 查詢相同 IP 的所有操作

1. **Given** 詳細資訊抽屜顯示一筆日誌，IP 地址為 `203.0.113.45`。
2. **When** 我點擊「檢視相同 IP 的所有操作」。
3. **Then** 系統必須（MUST）自動篩選出該 IP 地址的所有操作記錄。
4. **And** 系統必須（MUST）在篩選欄顯示當前條件：「IP 地址：203.0.113.45 (25)」。
5. **And** 我可以進一步疊加其他篩選條件（例如：僅顯示失敗記錄）。

---

#### D2. 查詢相同目標物件的所有操作

1. **Given** 詳細資訊抽屜顯示一筆「資源存取」日誌，目標物件為 `resource-db-001`。
2. **When** 我點擊「檢視相同目標物件的所有操作」。
3. **Then** 系統必須（MUST）自動篩選出該目標物件的所有操作記錄（包含建立、更新、刪除、存取）。
4. **And** 系統必須（MUST）按時間排序，顯示完整操作歷史。
5. **And** 我可以查看該物件的生命週期（從建立到刪除的所有操作）。

---

#### D3. 查詢批次操作的所有記錄

1. **Given** 詳細資訊抽屜顯示一筆「批次刪除使用者」日誌，批次 ID 為 `batch-del-2025100810`。
2. **When** 我點擊「檢視批次操作的所有記錄」。
3. **Then** 系統必須（MUST）自動篩選出該批次 ID 的所有操作記錄（100 筆）。
4. **And** 系統必須（MUST）顯示批次操作摘要：總筆數、成功筆數、失敗筆數、執行時間。
5. **And** 我可以分別查看「僅成功」或「僅失敗」記錄。

---

### 場景群組 E：日誌搜尋（Log Search）

#### E1. 全文搜尋日誌內容

1. **Given** 我在「審計日誌」頁面。
2. **When** 我在搜尋框輸入關鍵字 `user-456`。
3. **Then** 系統必須（MUST）搜尋所有日誌的以下欄位：Actor、Target、Details（JSON 內容）。
4. **And** 系統必須（MUST）顯示包含該關鍵字的所有記錄。
5. **And** 系統必須（MUST）高亮匹配的文字部分（例如：`**user-456**`）。

---

#### E2. 搜尋請求 ID（Request ID）

1. **Given** 我需追蹤特定請求的完整流程（跨多個操作）。
2. **When** 我在搜尋框輸入請求 ID `req-abc123`。
3. **Then** 系統必須（MUST）顯示該請求 ID 關聯的所有操作記錄（可能橫跨多個模組）。
4. **And** 系統必須（MUST）按時間排序，顯示請求的完整執行鏈。
5. **And** 我可以查看請求從接收到完成的所有操作步驟。

---

### 場景群組 F：日誌監控與告警（Log Monitoring & Alerting）

#### F1. 異常操作即時告警

1. **Given** 系統配置了告警規則：「任一使用者在 1 小時內執行超過 10 次權限變更，發送告警」。
2. **When** 使用者 john@example.com 在 1 小時內執行了 15 次角色更新操作。
3. **Then** 系統必須（MUST）自動發送告警：「異常權限變更行為：john@example.com 在 1 小時內執行 15 次權限變更」。
4. **And** 告警必須（MUST）包含操作摘要與快速查詢連結（點擊連結自動跳轉至相關日誌）。
5. **And** 系統必須（MUST）記錄告警行為於審計日誌（類別：`alert-triggered`）。

---

#### F2. 失敗操作趨勢監控

1. **Given** 系統配置了監控規則：「若 5 分鐘內失敗操作超過 20 次，發送告警」。
2. **When** 系統偵測到 5 分鐘內有 25 筆登入失敗記錄（來源：相同 IP）。
3. **Then** 系統必須（MUST）自動發送告警：「可能遭受暴力破解攻擊：IP 203.0.113.45 在 5 分鐘內嘗試登入 25 次」。
4. **And** 告警必須（MUST）包含該 IP 的所有失敗記錄清單。
5. **And** 系統應該（SHOULD）自動將該 IP 加入臨時黑名單（可設定持續時間）。

---

## 三、功能需求（Functional Requirements）

### 3.1. 日誌記錄（Log Recording）

| 編號 | 說明 |
|------|------|
| **FR-LR-001** | 系統必須（MUST）記錄所有關鍵操作的審計日誌（包括 IAM、資源管理、事件管理、標籤管理等模組）。 |
| **FR-LR-002** | 每筆日誌必須（MUST）包含以下核心欄位：時間戳（精確到毫秒）、執行者（Actor）、動作（Action）、目標物件（Target）、結果（Result）、IP 地址、請求 ID。 |
| **FR-LR-003** | 系統必須（MUST）記錄變更操作的 Before/After 快照（完整狀態或 JSON Diff）。 |
| **FR-LR-004** | 系統必須（MUST）記錄失敗操作的錯誤訊息（Error Message）與錯誤碼（Error Code）。 |
| **FR-LR-005** | 系統必須（MUST）為每筆日誌產生唯一的 Log ID，便於查詢與引用。 |

---

### 3.2. 日誌查詢與篩選（Log Query & Filter）

| 編號 | 說明 |
|------|------|
| **FR-QF-001** | 系統必須（MUST）支援按時間範圍查詢日誌（支援絕對時間與相對時間，例如：「過去 7 天」）。 |
| **FR-QF-002** | 系統必須（MUST）支援按操作者篩選日誌（支援模糊匹配）。 |
| **FR-QF-003** | 系統必須（MUST）支援按動作類型篩選日誌（支援多選，OR 邏輯）。 |
| **FR-QF-004** | 系統必須（MUST）支援按結果狀態篩選日誌（成功/失敗）。 |
| **FR-QF-005** | 系統必須（MUST）支援按 IP 地址篩選日誌。 |
| **FR-QF-006** | 系統必須（MUST）支援按目標物件篩選日誌（支援物件類型 + ID）。 |
| **FR-QF-007** | 系統必須（MUST）支援複合篩選（多個條件同時生效，AND 邏輯）。 |
| **FR-QF-008** | 系統必須（MUST）支援全文搜尋（搜尋 Actor、Target、Details 欄位）。 |

---

### 3.3. 日誌詳細資訊查看（Log Detail View）

| 編號 | 說明 |
|------|------|
| **FR-DV-001** | 系統必須（MUST）支援點擊任一筆日誌，從右側滑出詳細資訊抽屜（Drawer）。 |
| **FR-DV-002** | 抽屜必須（MUST）顯示結構化的操作摘要（Actor、Target、Changes、Result）。 |
| **FR-DV-003** | 抽屜必須（MUST）支援檢視完整 JSON 格式的日誌（使用 JSON Viewer，支援語法高亮與摺疊/展開）。 |
| **FR-DV-004** | 系統必須（MUST）支援檢視變更對比（Before/After Diff），高亮差異部分。 |
| **FR-DV-005** | 系統必須（MUST）支援一鍵複製完整 JSON 內容至剪貼簿。 |

---

### 3.4. 日誌匯出（Log Export）

| 編號 | 說明 |
|------|------|
| **FR-EX-001** | 系統必須（MUST）支援匯出當前篩選結果（CSV、JSON 格式）。 |
| **FR-EX-002** | CSV 匯出必須（MUST）包含核心欄位（Timestamp、Actor、Action、Target、Result、IP Address）。 |
| **FR-EX-003** | JSON 匯出必須（MUST）包含完整日誌內容（包括 Details 欄位）。 |
| **FR-EX-004** | 系統必須（MUST）支援自訂匯出欄位（使用者可選擇需要的欄位）。 |
| **FR-EX-005** | 系統必須（MUST）記錄所有匯出行為於審計日誌（類別：`audit-log-export`）。 |
| **FR-EX-006** | 大量匯出（> 1,000 筆）應該（SHOULD）採用後台任務處理，完成後發送通知。 |

---

### 3.5. 日誌關聯查詢（Log Correlation Query）

| 編號 | 說明 |
|------|------|
| **FR-CQ-001** | 系統必須（MUST）支援「查詢相同 IP 的所有操作」功能（一鍵篩選）。 |
| **FR-CQ-002** | 系統必須（MUST）支援「查詢相同目標物件的所有操作」功能（顯示物件完整生命週期）。 |
| **FR-CQ-003** | 系統必須（MUST）支援「查詢批次操作的所有記錄」功能（依 Batch ID 聚合）。 |
| **FR-CQ-004** | 系統必須（MUST）支援「查詢相同請求 ID 的所有操作」功能（追蹤跨模組請求鏈）。 |

---

### 3.6. 日誌監控與告警（Log Monitoring & Alerting）

| 編號 | 說明 |
|------|------|
| **FR-MA-001** | 系統必須（MUST）支援設定告警規則（例如：「1 小時內超過 N 次權限變更」）。 |
| **FR-MA-002** | 系統必須（MUST）在觸發告警時發送通知（郵件、站內訊息、Webhook）。 |
| **FR-MA-003** | 告警通知必須（MUST）包含操作摘要與快速查詢連結。 |
| **FR-MA-004** | 系統必須（MUST）記錄所有告警觸發行為於審計日誌（類別：`alert-triggered`）。 |

---

### 3.7. 日誌不可篡改性（Log Immutability）

| 編號 | 說明 |
|------|------|
| **FR-IM-001** | 系統必須（MUST）確保審計日誌一旦產生，無法被修改或刪除（使用技術機制保護，例如：日誌簽名、WORM 儲存）。 |
| **FR-IM-002** | 系統應該（SHOULD）為每筆日誌產生數位簽章（Digital Signature），確保完整性可驗證。 |
| **FR-IM-003** | 系統應該（SHOULD）定期產出日誌完整性驗證報告（Integrity Verification Report），證明日誌未被篡改。 |

---

### 3.8. 效能與擴展性（Performance & Scalability）

| 編號 | 說明 |
|------|------|
| **FR-PS-001** | 日誌列表載入時間必須（MUST）在 3 秒內完成（100 筆記錄）。 |
| **FR-PS-002** | 篩選操作響應時間必須（MUST）在 2 秒內完成（包含多維度複合篩選）。 |
| **FR-PS-003** | 全文搜尋響應時間必須（MUST）在 5 秒內完成（搜尋範圍：30 天內的日誌）。 |
| **FR-PS-004** | 系統必須（MUST）支援至少 1,000,000 筆日誌的查詢與篩選（採用分頁載入）。 |

---

## 四、關鍵資料實體（Key Entities）

| 實體名稱 | 描述 | 關聯 |
|-----------|------|------|
| **AuditLog** | 審計日誌記錄，包含時間戳、執行者、動作、目標物件、結果、IP 地址、請求 ID、詳細資訊（Details）。 | User (Actor)、Generic (Target) |
| **AuditLogDetails** | 日誌詳細資訊，包含 Before/After 快照、請求參數、回應結果、錯誤訊息。 | AuditLog |
| **AuditLogFilter** | 日誌篩選條件，包含時間範圍、操作者、動作類型、結果狀態、IP 地址、目標物件。 | - |
| **AuditLogExportTask** | 日誌匯出任務，記錄匯出者、匯出時間、匯出範圍、格式、狀態（處理中/完成/失敗）。 | User、AuditLog |

---

## 五、權限控制（RBAC）

| 權限字串 | 描述 |
|-----------|------|
| `audit-logs:read` | 檢視審計日誌清單與詳細資訊。 |
| `audit-logs:export` | 匯出審計日誌（CSV、JSON）。 |
| `audit-logs:alert-manage` | 管理告警規則（建立、修改、刪除）。 |
| `audit-logs:integrity-verify` | 檢視日誌完整性驗證報告。 |

---

## 六、邊界案例（Edge Cases）

### 6.1. 目標物件已刪除

**情境**：查詢一筆「使用者刪除」日誌，但該使用者已不存在於系統中。
**處理**：
- 系統必須（MUST）在日誌中保留該使用者的識別資訊（ID、Email、姓名）
- 系統必須（MUST）在目標物件欄位標註：「(已刪除)」
- 系統必須（MUST）仍可查詢該使用者的歷史操作記錄

---

### 6.2. 日誌 Details 欄位格式錯誤

**情境**：某筆日誌的 `details` 欄位為無效 JSON（例如：系統異常導致記錄不完整）。
**處理**：
- JSON Viewer 必須（MUST）優雅處理，顯示錯誤提示：「詳細資訊格式錯誤，無法解析」
- 系統必須（MUST）仍顯示其他核心欄位（時間戳、執行者、動作、結果）
- 系統應該（SHOULD）記錄日誌格式錯誤事件，通知技術團隊修復

---

### 6.3. 篩選後無任何日誌

**情境**：使用者設定的篩選條件過於嚴格，無任何日誌符合。
**處理**：
- 系統必須（MUST）顯示空狀態提示：「目前無符合篩選條件的審計記錄」
- 系統應該（SHOULD）建議放寬篩選條件（例如：「嘗試擴大時間範圍」）
- 系統必須（MUST）保留篩選條件，便於使用者調整後重新查詢

---

### 6.4. 匯出大量日誌超時

**情境**：使用者嘗試匯出 100,000 筆日誌，前端請求超時。
**處理**：
- 系統必須（MUST）自動轉為後台任務處理
- 系統必須（MUST）顯示提示：「大量匯出任務已建立，處理完成後將發送通知」
- 系統必須（MUST）在任務完成後發送郵件或站內訊息，包含下載連結
- 下載連結應該（SHOULD）設定有效期限（例如：7 天）

---

### 6.5. 批次操作聚合統計錯誤

**情境**：批次操作包含 1,000 筆記錄，但聚合統計顯示「成功：950，失敗：60」（總和 > 1,000）。
**處理**：
- 系統必須（MUST）驗證聚合統計的一致性（總和 = 總筆數）
- 若統計錯誤，系統必須（MUST）顯示警告：「統計資料異常，請聯繫技術團隊」
- 系統必須（MUST）記錄統計錯誤事件於系統日誌，便於排查

---

### 6.6. 審計日誌簽章驗證失敗

**情境**：系統定期驗證日誌完整性，發現某筆日誌的數位簽章無效。
**處理**：
- 系統必須（MUST）立即發送高優先級告警：「審計日誌完整性異常：Log ID xxx 簽章驗證失敗」
- 系統必須（MUST）標註該筆日誌為「可疑（Suspicious）」
- 系統應該（SHOULD）自動觸發安全事件響應流程，通知安全團隊調查

---

## 七、觀測性與治理（Observability & Governance）

### 7.1. Logging & Tracing
- [ ] 所有被審計的操作均產生審計日誌（類別：`identity-*`、`resource-*`、`incident-*`、`tag-*`）
- [ ] 所有日誌查詢操作記錄於系統日誌（包含查詢者、篩選條件、結果筆數）
- [ ] 所有日誌匯出操作記錄於審計日誌（類別：`audit-log-export`）
- [ ] 所有告警觸發記錄於審計日誌（類別：`alert-triggered`）
- [ ] 分散式追蹤（Trace ID）貫穿整個請求流程（從接收到完成，包含審計日誌記錄）

### 7.2. Metrics & Alerts
- [ ] 監控審計日誌總量（按日/週/月統計）
- [ ] 監控日誌查詢頻率（按操作者、時間段統計）
- [ ] 監控日誌匯出頻率（按格式、筆數統計）
- [ ] 監控失敗操作比例（按動作類型統計）
- [ ] 告警：若 5 分鐘內失敗操作超過 50 次，發送告警
- [ ] 告警：若審計日誌簽章驗證失敗，立即發送高優先級告警

### 7.3. RBAC
- [ ] 所有審計日誌查詢必須檢查 `audit-logs:read` 權限
- [ ] 所有日誌匯出必須檢查 `audit-logs:export` 權限
- [ ] 告警規則管理必須檢查 `audit-logs:alert-manage` 權限
- [ ] 日誌完整性驗證報告檢視必須檢查 `audit-logs:integrity-verify` 權限

### 7.4. i18n
- [ ] 所有 UI 文案支援 `zh-TW`、`en-US`
- [ ] 動作類型（Action）顯示標籤使用 i18n Key
- [ ] 結果狀態（Result）顯示標籤使用 i18n Key
- [ ] 所有錯誤訊息支援多語系

### 7.5. Theme Token
- [ ] 結果狀態標記顏色使用 Theme Token（成功：`success-badge-bg`，失敗：`error-badge-bg`）
- [ ] 操作風險等級標記顏色使用 Theme Token（高風險：`danger-badge-bg`，中風險：`warning-badge-bg`）

---

## 八、審查與驗收清單（Review Checklist）

- [x] 文件結構符合憲法 v1.3.0 標準
- [x] Primary User Story 包含 5 個能力點、5 個具體情境、5 個痛點分析
- [x] Acceptance Scenarios 包含 18 個場景，分為 6 個群組（A-F）
- [x] Functional Requirements 包含 43 個需求，分為 8 個類別
- [x] 完整 RBAC 定義（4 個權限）
- [x] 完整邊界案例（6 個）
- [x] 完整觀測性與治理清單（Logging、Metrics、RBAC、i18n、Theme Token）
- [x] 移除所有技術實作細節，保持技術中立

---

## 九、模糊與待確認事項（Clarifications）

| 項目 | 狀態 | 備註 |
|------|------|------|
| 日誌保留期限 | [NEEDS CLARIFICATION] | 審計日誌是否有保留期限（例如：保留 1 年或 7 年），過期後如何處理（歸檔或刪除）。 |
| 日誌簽章技術選型 | [NEEDS CLARIFICATION] | 採用何種技術確保日誌不可篡改（數位簽章、區塊鏈、WORM 儲存），需評估成本與可行性。 |
| 多租戶日誌隔離 | [NEEDS CLARIFICATION] | 多租戶環境下，日誌是否完全隔離（租戶 A 無法查詢租戶 B 的日誌），或提供跨租戶查詢權限（Super Admin）。 |
| 告警規則複雜度 | [NEEDS CLARIFICATION] | 告警規則是否支援複雜邏輯（例如：「若同一使用者在不同 IP 位址登入超過 5 次」），或僅支援簡單閾值規則。 |
| 日誌匯出檔案大小限制 | [NEEDS CLARIFICATION] | 單次匯出檔案是否有大小限制（例如：最多 100MB），超過限制如何處理（分批匯出或壓縮）。 |
