# 功能規格書（Feature Specification）

**模組名稱 (Module)**: automation-history  
**類型 (Type)**: Module  
**建立日期 (Created)**: 2025-10-06  
**版本 (Version)**: 1.1.0  
**狀態 (Status)**: In Review  
**依據憲法條款 (Based on)**: `.specify/memory/constitution.md` (v1.3.0)

---

## 一、主要使用者情境（User Scenarios & Testing）

### 主要使用者故事（Primary User Story）
作為一名 SRE 或平台管理員，我需要能夠追蹤與稽核所有自動化腳本的執行歷史，包含每次任務的觸發來源、執行者、結果與詳細日誌，以便於問題排查、效能分析與合規性檢視。

### 驗收情境（Acceptance Scenarios）
1. **Given** 我正在查看「自動化執行歷史」頁面，  
   **When** 我使用快速篩選器選擇「失敗」，  
   **Then** 系統應立即更新列表，只顯示失敗的紀錄。

2. **Given** 我想了解某次執行的詳細原因，  
   **When** 我點擊該筆紀錄，  
   **Then** 系統應打開右側詳情面板，顯示結構化日誌與步驟結果。

3. **Given** 一筆任務執行失敗且屬暫時性錯誤，  
   **When** 我在操作列點擊「重試」按鈕，  
   **Then** 系統應開啟重試確認框，允許輸入重試原因與自訂參數；  
   **And Then** 點擊確認後，新增一筆狀態為「執行中」的紀錄並開始追蹤執行進度。

4. **Given** 我想將最近 7 天的執行紀錄用於報告分析，  
   **When** 我點擊「匯出」按鈕，  
   **Then** 系統應生成一份 CSV 檔案供下載，並包含目前篩選條件下的紀錄。

5. **Given** 一筆任務正在執行中，  
   **When** 我查看執行狀態欄位，  
   **Then** 系統應每隔固定間隔更新狀態，直到任務完成或失敗。  
   → [FUTURE] 此功能需依後端事件流整合完成。

### 邊界案例（Edge Cases）
- 巨量日誌內容（>10MB）仍可逐段載入與虛擬化顯示。  
- 執行中任務不應允許重試操作。  
- 若 API 錯誤，應顯示明確錯誤提示並允許重新整理。  
- [FUTURE] 支援使用者選擇多筆紀錄進行批次重試。

---

## 二、功能需求（Functional Requirements）

| 編號 | 說明 |
|------|------|
| **FR-001** | 系統必須提供可分頁、可排序的執行歷史表格。 |
| **FR-002** | 表格中須包含：腳本名稱、狀態、觸發來源、執行者、開始時間、時長。 |
| **FR-003** | 使用者可透過快速篩選與進階搜尋組合查詢紀錄。 |
| **FR-004** | 點擊任一紀錄可開啟詳細面板檢視日誌內容與步驟摘要。 |
| **FR-005** | 對失敗任務提供「重試」操作，並記錄重試原因與輸入參數。 |
| **FR-006** | 支援將紀錄匯出為 CSV，包含使用中篩選條件。 |
| **FR-007** | 執行者欄位應渲染結構化資訊（例如使用者名稱、觸發來源）。 |
| **FR-008** | 詳細日誌需顯示分段步驟、時間戳與執行結果。 |
| **FR-009** | 所有文字必須使用 i18n Key。 |
| **FR-010** | 所有顏色與樣式應使用 Theme Token。 |
| **FR-011** | 系統須依 RBAC 控制「重試」與「匯出」操作可見性。 |
| **FR-012** | 資料保留期限為 90 天，逾期自動清除。 |
| **FR-013** | [FUTURE] 支援實時狀態更新（基於事件流或輪詢）。 |
| **FR-014** | [FUTURE] 支援批次匯出與批次重試操作。 |

---

## 三、關鍵資料實體（Key Entities）

| 實體名稱 | 描述 | 關聯 |
|-----------|------|------|
| **AutomationExecution** | 單次自動化執行紀錄，含任務 ID、狀態、觸發來源與結果摘要。 | 與 AutomationPlaybook、AutomationTrigger 關聯。 |
| **ExecutionLogDetail** | 包含執行過程、步驟、輸出與結構化日誌內容。 | 屬於 AutomationExecution。 |
| **AutomationHistoryFilters** | 搜尋條件集合，包含狀態、執行者、時間範圍與腳本名稱。 | - |

---

## 四、權限控制 (RBAC)

| 權限字串 | 描述 |
|-----------|------|
| `automation:history:read` | 檢視執行歷史與詳細日誌。 |
| `automation:history:retry` | 允許重試執行失敗的任務。 |
| `automation:history:export` | 允許匯出執行歷史資料。 |

- 系統應依使用者角色控制操作可見性。
- 後端 API 需依權限過濾可見紀錄。

---

## 五、觀測性與治理檢查（Observability & Governance）

| 項目 | 狀態 | 說明 |
|------|------|------|
| Logging/Tracing | ✅ | 所有操作（重試、匯出）需產生審計記錄。 |
| Metrics & Alerts | ✅ | 執行成功率與錯誤率應上報至監控系統。 |
| RBAC | ✅ | 介面與資料權限均依角色控管。 |
| i18n | ✅ | 全部文案由多語系內容管理。 |
| Theme Token | ✅ | 所有樣式遵循語義化色票。 |
| [FUTURE] Realtime Updates | ⚙️ | 需待事件流機制實現後測試。 |

---

## 六、審查與驗收清單（Review & Acceptance Checklist）

- [x] 所有段落齊備且結構正確。  
- [x] 無技術語句。  
- [x] 所有 FR 具可測試性。  
- [x] 無模糊或重疊需求。  
- [x] 與 `.specify/memory/constitution.md` (v1.3.0) 一致。  
- [x] 模板結構完整。  

---

## 七、模糊與待確認事項（Clarifications）

| 項目 | 狀態 | 備註 |
|------|------|------|
| 日誌匯出格式 | [FUTURE] | 預期為 CSV，尚需確定欄位順序。 |
| 即時狀態更新頻率 | [NEEDS CLARIFICATION] | 需確認事件流或輪詢週期。 |
| 批次重試行為 | [FUTURE] | 將於後期版本開放。 |

---