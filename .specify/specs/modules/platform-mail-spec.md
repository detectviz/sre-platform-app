# 功能規格書（Feature Specification）

**模組名稱 (Module)**: platform-mail
**類型 (Type)**: Module
**建立日期 (Created)**: 2025-10-06
**狀態 (Status)**: Draft
**依據憲法條款 (Based on)**: `.specify/memory/constitution.md` (v1.3.0)

---

## 一、主要使用者情境（User Scenarios & Testing）

### 主要使用者故事（Primary User Story）
作為一名平台管理員，我需要設定一個全局的 SMTP 郵件伺服器，以便平台能夠可靠地發送所有系統通知，包括告警郵件、使用者邀請和定時報告。我希望能方便地配置伺服器位址、埠號、加密方式和認證資訊，並能在儲存前進行測試，以確保設定無誤。

#### 具體情境:
- **初次配置**: 在平台部署初期，我需要設定公司的 SMTP 伺服器資訊（如 smtp.gmail.com），以便平台能發送告警郵件與使用者邀請通知。
- **測試驗證**: 設定完成後，我需要立即發送測試郵件到自己的信箱，確認伺服器位址、埠號、加密方式與認證憑證皆正確無誤。
- **憑證輪換**: 當 SMTP 密碼需要定期更新時，我需要修改密碼並重新測試，確保通知發送功能不中斷。
- **問題排查**: 當使用者回報未收到告警郵件時，我需要檢查 SMTP 設定並發送測試郵件，快速定位問題（如憑證錯誤、網路阻擋或 SMTP 伺服器故障）。
- **安全加固**: 在配置時，我需要選擇適當的加密方式（TLS/STARTTLS），確保郵件傳輸安全，符合資安政策要求。

#### 現有痛點:
- 若無測試功能，設定錯誤只能在實際發送通知時才發現，可能導致關鍵告警漏發。
- SMTP 密碼若以明文顯示，增加憑證外洩風險，違反安全規範。
- 缺乏明確的測試結果顯示時，難以判斷是設定問題還是網路或伺服器問題。

### 驗收情境（Acceptance Scenarios）

#### 場景群組 A：SMTP 設定管理
1.  **Given** 我首次設定平台的郵件功能。
    **When** 我進入「SMTP 郵件伺服器」設定頁面。
    **Then** 系統應顯示一個包含所有必要欄位的表單（SMTP 伺服器位址、埠號、加密方式、寄件人名稱、寄件人 Email、使用者名稱、密碼）。
    **And Then** 所有欄位應為空白或顯示預設值，密碼欄位應顯示為遮蔽狀態。

2.  **Given** 我已填寫完整的 SMTP 設定資訊。
    **When** 我點擊「儲存變更」按鈕。
    **Then** 系統應驗證所有必填欄位均已填寫，並成功保存設定至後端。
    **And Then** 系統應顯示「設定已成功儲存」的成功訊息。

3.  **Given** 我需要修改現有的 SMTP 設定。
    **When** 我重新進入設定頁面並變更 SMTP 伺服器位址或埠號。
    **Then** 系統應保留其他欄位的現有值，僅更新我修改的欄位。
    **And Then** 密碼欄位應顯示佔位符 `••••••••••`，表示已有密碼但不顯示明文。

#### 場景群組 B：連線測試與驗證
4.  **Given** 我已填寫 SMTP 設定但尚未儲存。
    **When** 我點擊「發送測試郵件」按鈕。
    **Then** 系統應立即使用當前表單中的設定值，向我的登入帳號 Email 發送測試郵件。
    **And Then** 系統應顯示「測試郵件已成功發送，請檢查您的收件匣」的訊息。

5.  **Given** 我輸入了錯誤的 SMTP 憑證（如錯誤的密碼）。
    **When** 我點擊「發送測試郵件」按鈕。
    **Then** 系統應返回錯誤訊息「測試失敗：認證失敗，請檢查使用者名稱與密碼」。
    **And Then** 連線健康狀態應顯示為「測試失敗」，並標記為紅色警示。

6.  **Given** 我輸入了無法連線的 SMTP 伺服器位址。
    **When** 我點擊「發送測試郵件」按鈕。
    **Then** 系統應在合理的超時時間（如 10 秒）後返回錯誤訊息「測試失敗：無法連線至 SMTP 伺服器，請檢查伺服器位址與網路設定」。
    **And Then** 連線健康狀態應顯示為「連線逾時」。

7.  **Given** 我測試連線成功後。
    **When** 我查看頁面上的「連線健康狀態」指示器。
    **Then** 系統應顯示綠色的「連線正常」標籤，並標註最後測試時間（如「最後測試：2025-10-08 14:32」）。

#### 場景群組 C：輸入驗證與錯誤處理
8.  **Given** 我輸入了一個無效的寄件人 Email 地址（如 `invalid-email`）。
    **When** 我移開焦點或嘗試儲存。
    **Then** 系統應立即在該輸入框下方顯示紅色錯誤訊息「請輸入有效的 Email 格式」。
    **And Then** 「儲存變更」與「發送測試郵件」按鈕應處於禁用狀態，直到錯誤修正。

9.  **Given** 我選擇了需要認證的 SMTP 伺服器，但未填寫使用者名稱或密碼。
    **When** 我嘗試儲存或測試連線。
    **Then** 系統應阻止操作並顯示錯誤訊息「使用者名稱與密碼為必填欄位」。

10. **Given** 我已修改設定但尚未儲存。
    **When** 我點擊「還原為已儲存設定」按鈕。
    **Then** 系統應撤銷所有未儲存的變更，還原至上次儲存的設定值。
    **And Then** 表單應顯示原始設定，並清除所有驗證錯誤訊息。

#### 場景群組 D：安全性與敏感資訊保護
11. **Given** 我正在查看已儲存的 SMTP 設定。
    **When** 頁面載入現有設定。
    **Then** 密碼欄位應顯示佔位符 `••••••••••`，而不是明文密碼。
    **And Then** 密碼欄位應提供「顯示/隱藏」切換按鈕，讓我暫時查看輸入的密碼。

12. **Given** 我需要更新 SMTP 密碼。
    **When** 我在密碼欄位輸入新密碼並儲存。
    **Then** 系統應僅在使用者輸入新值時，才在 API 請求中傳遞密碼欄位。
    **And Then** 若密碼欄位保持未修改（顯示佔位符），系統不應在 API 請求中傳遞密碼，保留後端現有密碼。

### 邊界案例（Edge Cases）
- 當 SMTP 伺服器需要驗證但使用者未提供密碼時，測試和儲存操作應被阻止。
- 當使用者修改了設定但尚未儲存時，點擊「還原為已儲存設定」按鈕應能撤銷所有未儲存的變更。
- 對於一個從未測試過的設定，連線健康狀態應顯示為「尚未測試」。

---

## 二、功能需求（Functional Requirements）

### 2.1. SMTP 設定管理 (Settings Management)
| 編號 | 說明 |
|------|------|
| **FR-S-001** | 系統必須（MUST）提供一個表單介面，允許管理員設定和編輯平台的全局 SMTP 郵件伺服器參數。 |
| **FR-S-002** | 設定參數必須（MUST）包括：SMTP 伺服器位址、埠號、加密方式（TLS/STARTTLS/None）、寄件人名稱、寄件人 Email、以及用於驗證的使用者名稱和密碼。 |
| **FR-S-003** | 系統必須（MUST）在儲存前驗證所有必填欄位均已填寫，並顯示清晰的必填標記（如 * 號）。 |
| **FR-S-004** | 系統必須（MUST）提供「儲存變更」與「還原為已儲存設定」按鈕，讓使用者可保存或撤銷變更。 |
| **FR-S-005** | 當設定成功儲存後，系統必須（MUST）顯示成功訊息並更新頁面狀態為「已儲存」。 |

### 2.2. 連線測試與驗證 (Connection Testing)
| 編號 | 說明 |
|------|------|
| **FR-T-001** | 系統必須（MUST）提供一個「發送測試郵件」功能，使用當前表單中的設定值進行測試（無論是否已儲存）。 |
| **FR-T-002** | 「發送測試郵件」功能必須（MUST）將測試郵件發送到**當前登入使用者**的電子郵件地址，主旨為「平台郵件測試」。 |
| **FR-T-003** | 系統必須（MUST）在 UI 上清晰地展示最近一次連線測試的結果，包含狀態（成功/失敗/尚未測試）與時間戳記。 |
| **FR-T-004** | 測試失敗時，系統必須（MUST）顯示詳細的錯誤訊息，說明失敗原因（如「認證失敗」、「連線逾時」、「網路錯誤」）。 |
| **FR-T-005** | 連線健康狀態應（SHOULD）使用視覺化指示器（如綠色✅「連線正常」、紅色❌「測試失敗」、灰色「尚未測試」）。 |
| **FR-T-006** | 測試郵件發送期間，系統應（SHOULD）在按鈕上顯示載入指示器，並禁用按鈕以防重複點擊。 |

### 2.3. 輸入驗證與錯誤處理 (Input Validation)
| 編號 | 說明 |
|------|------|
| **FR-V-001** | 系統必須（MUST）對寄件人 Email 欄位進行即時格式驗證，確保符合標準 Email 格式。 |
| **FR-V-002** | 系統必須（MUST）對 SMTP 埠號進行驗證，確保為 1-65535 之間的有效數字。 |
| **FR-V-003** | 當必填欄位未填寫或格式錯誤時，系統必須（MUST）在欄位下方顯示紅色錯誤訊息，並禁用「儲存變更」與「發送測試郵件」按鈕。 |
| **FR-V-004** | 系統應（SHOULD）提供即時驗證回饋，當使用者修正錯誤後立即移除錯誤訊息並啟用按鈕。 |

### 2.4. 敏感資訊保護 (Sensitive Data Protection)
| 編號 | 說明 |
|------|------|
| **FR-P-001** | 系統必須（MUST）為密碼欄位提供遮蔽功能，預設顯示為 `••••••••••`。 |
| **FR-P-002** | 密碼欄位必須（MUST）提供「顯示/隱藏」切換按鈕（眼睛圖示），讓使用者暫時查看輸入的密碼。 |
| **FR-P-003** | 當載入現有設定時，密碼欄位必須（MUST）顯示佔位符 `••••••••••`，而不是實際密碼明文。 |
| **FR-P-004** | 系統必須（MUST）僅在使用者輸入新密碼時，才在 API 請求中傳遞密碼欄位；若密碼欄位保持未修改，不應傳遞密碼，保留後端現有密碼。 |
| **FR-P-005** | 系統應（SHOULD）在使用者離開密碼欄位超過 30 秒後，自動重新遮蔽密碼（若處於顯示狀態）。 |

### 2.5. 權限控制與審計 (RBAC & Audit)
| 編號 | 說明 |
|------|------|
| **FR-R-001** | [FUTURE] 系統必須（MUST）根據使用者的權限（`settings:mail:read`, `settings:mail:update`, `settings:mail:test`），動態顯示或禁用對應的操作介面。 |
| **FR-R-002** | [FUTURE] 所有設定變更與測試操作必須（MUST）記錄審計日誌，包含操作者、時間戳記、變更內容與操作結果。 |

---

## 三、關鍵資料實體（Key Entities）
| 實體名稱 | 描述 | 關聯 |
|-----------|------|------|
| **MailSettings** | 核心資料實體，包含了平台用於發送郵件的全局 SMTP 設定。 | - |
| **MailTestResponse** | 執行郵件測試後，API 回傳的結果，包含成功狀態和訊息。 | - |

---

## 四、權限控制 (Role-Based Access Control)

**[FUTURE REQUIREMENT]** 以下權限模型描述了產品的最終設計目標，尚未在當前 MVP 中實現。

### 4.1. 權限定義 (Permissions)
| 權限字串 | 描述 |
|---|---|
| `settings:mail:read` | 允許使用者查看郵件設定。 |
| `settings:mail:update` | 允許使用者修改並儲存郵件設定。 |
| `settings:mail:test` | 允許使用者發送測試郵件。 |

### 4.2. UI 控制映射 (UI Mapping)
- **頁面存取**: `MailSettingsPage` 的根元件需由 `<RequirePermission permission="settings:mail:read">` 包裹。
- **表單欄位**: 整個表單的編輯功能需具備 `settings:mail:update` 權限，否則應為唯讀狀態。
- **操作按鈕**:
  - 「儲存變更」按鈕需具備 `settings:mail:update` 權限。
  - 「發送測試郵件」按鈕需具備 `settings:mail:test` 權限。

---

## 五、觀測性與治理檢查（Observability & Governance Checklist）

此部分描述當前 MVP 的狀態，作為未來迭代的基準。

**標記說明**:
- ✅ 已實現（Implemented）
- 🟡 部分實現（Partially Implemented）
- ⚙️ 未來需求（Future Requirement）

| 項目 | 狀態 | 說明 |
|------|------|------|
| 記錄與追蹤 (Logging/Tracing) | ⚙️ | 未來需求。建議記錄所有設定變更、測試操作與結果，包含操作者、時間戳記與變更內容。 |
| 指標與告警 (Metrics & Alerts) | ⚙️ | 未來需求。建議追蹤測試成功率、郵件發送失敗次數、平均回應時間，並在連續失敗時觸發告警。 |
| RBAC 權限與審計 | 🟡 | 部分實現。已定義權限模型（`settings:mail:read/update/test`），但當前 MVP 所有操作對任何登入使用者均可見。 |
| i18n 文案 | ⚙️ | 未來需求。當前 MVP 所有 UI 文字均為硬編碼的中文，未接入 i18n 內容管理系統。未來需全面遷移至多語系架構。 |
| Theme Token 使用 | 🟡 | 部分實現。UI 混用預定義樣式與直接的 Tailwind 色票，未來需統一使用 Design Token。 |

---

## 六、審查與驗收清單（Review & Acceptance Checklist）

- [x] 無技術實作語句。
- [x] 所有必填段落皆存在。
- [x] 所有 FR 可測試且明確。
- [x] 無未標註的模糊需求。
- [x] 符合 `.specify/memory/constitution.md`。（已標注待確認項）

---

## 七、模糊與待確認事項（Clarifications）

- **[NEEDS CLARIFICATION] i18n**: 目前 MVP 在此頁面完全使用硬編碼中文，例如 `'無法載入郵件設定，請稍後再試。'`，未來需全面遷移至 i18n 內容管理系統。
- **[NEEDS CLARIFICATION] Theming**: MVP 廣泛使用 Tailwind CSS 的原子化 class (如 `bg-sky-900/30`) 來定義語義顏色和樣式，未來需重構為使用中央設計系統的 Theme Token。
- **[NEEDS CLARIFICATION] Password Handling**: 密碼仍以明文形式在 API 請求中傳輸，未來應評估在後端進行加密儲存。