# 元件規格書 (Component Specification)

**元件名稱 (Component)**: 欄位設定模態框
**類型 (Type)**: Component
**來源路徑 (Source Path)**: components/ColumnSettingsModal.tsx
**建立日期 (Created)**: 2025-10-06
**狀態 (Status)**: Draft
**依據憲法條款 (Based on)**: `.specify/memory/constitution.md`
**使用次數**: 9 次
**使用模組**: incidents-list, alert-rules, resources-list, dashboards-list

---

## 一、功能概述 (Functional Overview)

允許使用者自訂表格欄位顯示與排序

---

## 二、操作邏輯 (User Flow)

### 主要使用流程
1. 使用者點擊「欄位設定」按鈕
2. 系統開啟模態框,顯示所有可用欄位與當前顯示狀態
3. 使用者勾選/取消勾選欄位,或拖曳調整順序
4. 使用者點擊「儲存」
5. 系統呼叫 API 儲存設定
6. 系統關閉模態框,父元件重新渲染表格

### 互動事件
- `onClose`: 關閉模態框
- `onSave`: 儲存欄位設定,回傳新欄位鍵值陣列
- 拖曳排序觸發內部狀態更新
- 勾選欄位觸發內部狀態更新

---

## 三、狀態管理 (State Management)

### 內部狀態
- `selectedColumns`: 當前選取的欄位鍵值陣列
- `isDragging`: 是否正在拖曳

### 外部控制
- `isOpen`: 控制顯示/隱藏
- `allColumns`: 所有可用欄位
- `visibleColumnKeys`: 當前顯示的欄位鍵值

---

## 四、可配置屬性 (Props)

| 屬性名稱 | 類型 | 必填 | 預設值 | 說明 |
|----------|------|------|--------|------|
| isOpen | boolean | ✅ | - | 控制顯示/隱藏 |
| onClose | () => void | ✅ | - | 關閉事件 |
| onSave | (keys: string[]) => void | ✅ | - | 儲存事件 |
| allColumns | TableColumn[] | ✅ | - | 所有欄位 |
| visibleColumnKeys | string[] | ✅ | - | 當前顯示欄位 |

---

## 五、錯誤與例外處理 (Error Handling)

- 當儲存設定 API 失敗時,顯示錯誤訊息並保持模態框開啟
- 當未選取任何欄位時,阻止儲存並提示至少選擇一個欄位
- 當拖曳排序失敗時,恢復原始順序

---

## 六、關聯模組 (Related Modules)

以下模組使用此元件:
- **incidents-list**
- **alert-rules**
- **resources-list**
- **dashboards-list**

---

## 七、設計原則遵循 (Design Principles)

| 項目 | 狀態 | 說明 |
|------|------|------|
| 可重用性 (Reusability) | ✅ | 元件設計為通用,可跨多個模組使用 |
| 一致性 (Consistency) | ✅ | 遵循統一的 UI 設計系統與互動模式 |
| 可存取性 (Accessibility) | ✅ | 支援鍵盤導航與 ARIA 屬性 |
| 主題支援 (Theme Support) | ✅ | 使用 Theme Token,支援深淺色主題 |
| i18n 支援 (i18n) | ✅ | 所有文案透過 useContent 存取 |

---

## 四、儲存位置選擇 (Storage Scope)

### 4.1 欄位設定的儲存範圍

欄位設定支援兩種儲存範圍,使用者可在儲存時選擇:

#### 儲存範圍選項

| 範圍 | 說明 | 權限要求 | 優先級 |
|------|------|----------|--------|
| 僅我自己 | 儲存至使用者偏好 | 無特殊要求 | 高 |
| 套用至整個團隊 | 儲存至團隊設定 | 需要團隊管理員權限 | 低 |

#### UI 設計

在欄位設定 Modal 底部新增「儲存範圍」選擇器:

```
┌─────────────────────────────────────┐
│ 欄位設定                        [✕] │
├─────────────────────────────────────┤
│ ☑ 事件 ID                          │
│ ☑ 狀態                             │
│ ☑ 嚴重性                           │
│ ☐ 建立時間                          │
│ ☑ 負責人                           │
├─────────────────────────────────────┤
│ 儲存範圍:                           │
│ ○ 僅我自己 (預設)                   │
│ ○ 套用至整個團隊                    │
│   [ℹ 需要團隊管理員權限]            │
├─────────────────────────────────────┤
│           [取消]  [儲存]            │
└─────────────────────────────────────┘
```

#### 載入優先級邏輯

系統按以下順序載入欄位設定:

1. **檢查使用者級設定** - 若存在,使用使用者設定
2. **檢查團隊級設定** - 若無使用者設定,使用團隊設定
3. **使用預設設定** - 若無任何設定,使用系統預設

#### 視覺化狀態指示

在工具列「欄位設定」按鈕旁顯示當前使用的設定來源:

- 使用者設定: 顯示「自訂設定」標籤
- 團隊設定: 顯示「團隊設定」標籤
- 預設設定: 顯示「預設設定」標籤

#### 前後端分工

| 項目 | 前端 | 後端 |
|------|------|------|
| UI 儲存範圍選擇器 | ✅ | - |
| 權限檢查與提示 | ✅ | ✅ |
| 使用者級設定 API | ✅ | ✅ (`PUT /api/v1/users/me/column-config/{pageKey}`) |
| 團隊級設定 API | ✅ | ✅ (`PUT /api/v1/teams/{teamId}/column-config/{pageKey}`) |
| 載入優先級邏輯 | ✅ | ✅ |
| 權限驗證 | - | ✅ |

---

## 五、排序持久化策略 (Sort Persistence)

### 5.1 欄位排序的儲存時機

採用**點擊「儲存」按鈕統一儲存**策略:

#### 儲存時機設計

- **不採用**: 每次拖曳後立即儲存 (避免頻繁 API 呼叫)
- **採用**: 使用者完成所有調整後,點擊「儲存」按鈕統一儲存

#### 互動流程

```
1. 使用者拖曳欄位調整順序
   ↓
2. UI 即時更新預覽 (本地狀態)
   ↓
3. 顯示「未儲存變更」提示
   ↓
4. 使用者點擊「儲存」
   ↓
5. 呼叫 API 儲存設定
   ↓
6. 顯示成功 Toast,關閉 Modal
```

#### 取消變更流程

```
1. 使用者點擊「取消」
   ↓
2. 若有未儲存變更,顯示確認對話框
   ↓
3. 使用者確認後,恢復原始順序
   ↓
4. 關閉 Modal
```

#### 未儲存變更提示

在 Modal 中顯示警告訊息:

```
┌─────────────────────────────────────┐
│ 欄位設定                        [✕] │
├─────────────────────────────────────┤
│ [拖曳調整後的欄位列表]              │
├─────────────────────────────────────┤
│ ⚠ 有未儲存的變更                   │
├─────────────────────────────────────┤
│           [取消]  [儲存]            │
└─────────────────────────────────────┘
```

#### 失敗回滾機制

若 API 儲存失敗,自動回滾至備份狀態:

- **儲存前**: 備份當前狀態
- **儲存失敗**: 恢復備份狀態
- **顯示錯誤**: 顯示錯誤 Toast,保持 Modal 開啟
- **允許重試**: 使用者可修正後重新儲存

#### 效能優化

- **本地預覽**: 拖曳時僅更新本地 state,不呼叫 API
- **批次儲存**: 所有變更一次性儲存,減少 API 呼叫
- **樂觀更新**: 儲存時先更新 UI,再呼叫 API

#### 前後端分工

| 項目 | 前端 | 後端 |
|------|------|------|
| 拖曳排序 UI | ✅ | - |
| 本地狀態管理 | ✅ | - |
| 未儲存提示 | ✅ | - |
| 確認對話框 | ✅ | - |
| 儲存 API 呼叫 | ✅ | ✅ |
| 回滾機制 | ✅ | - |
| 欄位配置驗證 | - | ✅ |
| 資料持久化 | - | ✅ |

---

## 六、關聯模組 (Related Modules)

以下模組使用此元件:
- **incidents-list**
- **alert-rules**
- **resources-list**
- **dashboards-list**

---

## 七、設計原則遵循 (Design Principles)

| 項目 | 狀態 | 說明 |
|------|------|------|
| 可重用性 (Reusability) | ✅ | 元件設計為通用,可跨多個模組使用 |
| 一致性 (Consistency) | ✅ | 遵循統一的 UI 設計系統與互動模式 |
| 可存取性 (Accessibility) | ✅ | 支援鍵盤導航與 ARIA 屬性 |
| 主題支援 (Theme Support) | ✅ | 使用 Theme Token,支援深淺色主題 |
| i18n 支援 (i18n) | ✅ | 所有文案透過 useContent 存取 |

---

## 八、待確認事項 (Clarifications)

- ✅ ~~[NEEDS CLARIFICATION: 欄位設定的儲存位置(使用者級或團隊級)]~~ → **已解決: 提供儲存範圍選擇器,支援使用者級與團隊級**
- ✅ ~~[NEEDS CLARIFICATION: 欄位排序的持久化策略]~~ → **已解決: 採用統一儲存策略,點擊「儲存」按鈕後呼叫 API**

---

## 九、決策記錄 (Decision Records)

### DR-001: 欄位設定儲存範圍

**決策日期**: 2025-10-06
**決策依據**: `_resolution-plan-phase2.md` § 1.2.1
**決策者**: Spec Architect

**決策內容**:
- 提供「僅我自己」與「套用至整個團隊」兩種儲存範圍
- 預設為「僅我自己」(使用者級)
- 團隊級設定需要團隊管理員權限
- 載入優先級: 使用者設定 > 團隊設定 > 預設設定

**理由**:
- 滿足個人化需求 (使用者級)
- 支援團隊標準化 (團隊級)
- 權限控制確保安全性
- 優先級邏輯清晰易懂

**前後端分工**:
- 前端: UI 選擇器、權限檢查、API 呼叫
- 後端: 權限驗證、資料儲存、載入邏輯

---

### DR-002: 欄位排序持久化策略

**決策日期**: 2025-10-06
**決策依據**: `_resolution-plan-phase2.md` § 1.2.2
**決策者**: Spec Architect

**決策內容**:
- 採用統一儲存策略 (點擊「儲存」按鈕)
- 拖曳時僅更新本地狀態,不呼叫 API
- 未儲存時顯示提示,取消時恢復原始順序
- 儲存失敗時自動回滾

**理由**:
- 避免頻繁 API 呼叫,提升效能
- 允許使用者取消變更,提升 UX
- 符合使用者心智模型 (明確儲存動作)
- 失敗回滾確保資料一致性

**前後端分工**:
- 前端: 拖曳 UI、本地狀態、回滾機制
- 後端: 欄位配置驗證、資料持久化
